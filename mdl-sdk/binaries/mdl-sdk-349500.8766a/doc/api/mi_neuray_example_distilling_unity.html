<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Example for Material Distilling and Baking for Unity</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="images/arcicon.ico" rel="shortcut icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_custom_stylesheet_1_8_4.css" rel="stylesheet" type="text/css"/>
<link rel='stylesheet' href='webfonts/librebaskerville/stylesheet.css' type='text/css'/>
<link rel='stylesheet' href='webfonts/sourcesanspro/stylesheet.css' type='text/css'/>
<!--ARC-->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="blackheader">
<span id="blackheader_title">MDL SDK API</span>
<span>
<img src="images/nvidia_logo_transpbg.gif" alt="nvidia_logo_transpbg.gif" style=" height:1.25em; width:6.806em;"/></span>
<span id="blackheader_uplink">
<a href='../index.html' class='top_page_nav'>Up</a>
</span>
</div>
<!--
<div id="titlearea">
   <span id="projectname">
     <a id="titlelink" href="../../index.html">
       MDL SDK API
     </a>
   </span>
     <a id="projectlogo" href="http://www.nvidia-arc.com">
       <img alt="NVIDIA logo" src="images/nvidia_logo.png" style="height:2em;">
       </a>
     <a href='../index.html' class='top_page_nav'>Up</a>
</div>
-->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mi_neuray_example_distilling_unity.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example for Material Distilling and Baking for Unity </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div align="right"> [<a class="el" href="mi_neuray_example_distilling.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_distilling_glsl.html">Next</a>] </div><p>This example introduces the distillation of MDL materials to <code>transmissive_pbr</code> target model and showcases how to compile all material expressions into one link unit and how to bake material sub-expressions to a texture that fits the texture channel layout for the Unity High Definition Render Pipeline (HDRP) material model.</p>
<h1><a class="anchor" id="example_distilling_unity_new"></a>
New Topics</h1>
<ul>
<li>Compiling into one link unit</li>
<li>Baking material to Unity texture channel layout</li>
</ul>
<h1><a class="anchor" id="example_distilling_unity_descr"></a>
Detailed Description</h1>
<dl>
<dt><b> Compiling all material expressions into one link unit </b> </dt>
<dd><p class="startdd"><br/>
 While the distilling part of the example is identical to <a class="el" href="mi_neuray_example_distilling.html">Example for Material Distilling and Baking</a>, the baking part invokes custom bakers (i.e. this example is not using <a class="el" href="classmi_1_1neuraylib_1_1IBaker.html" title="Allows to bake a varying or uniform expression of a compiled material into a texture or constant...">mi::neuraylib::IBaker</a>).</p>
<p>The class <code>Baker</code> is responsible for creating and invoking programs for GPU and CPU baking. In <code>Baker::init_function_descriptions()</code>, we first create a list of <code><a class="el" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a></code> from material sub-expressions required by the Unity material model.</p>
<p>In <code>Baker::build_baker_programs()</code>, we use <a class="el" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a> to generate the GPU and CPU code for all selected expressions in one go using an <a class="el" href="classmi_1_1neuraylib_1_1ILink__unit.html" title="Represents a link-unit of an MDL backend. ">mi::neuraylib::ILink_unit</a>.</p>
<p>The resulting <a class="el" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a> can then be used in the routine <code>Baker::bake()</code> to invoke the custom baking codes.</p>
<p class="enddd"></p>
</dd>
<dt><b> Baking material to Unity material texture channel layout </b> </dt>
<dd><p class="startdd"><br/>
 The routine <code>Baker::bake_native()</code> implements baking on the CPU while <code>Baker::bake_cuda_ptx()</code> implements baking on the GPU.</p>
<p>Baking results are stored in textures following the Unity texture channel layout. The Unity High Definition Render Pipeline (HDRP) uses channel-packed Textures to store multiple Material maps in a single Texture. Channel packing is efficient because it allows the renderer to sample up to four grayscale maps that use the same UV coordinates with a single Texture fetch. HDRP uses two types of channel-packed Textures: the Mask Map and the Detail Map. The Detail Map is not baked in this example.</p>
<p>Mask Map is a texture that packs different Material maps into each of its RGBA channels. </p>
<ul>
<li>
Red: Stores the metallic map. </li>
<li>
Green: Stores the ambient occlusion map. </li>
<li>
Blue: Stores the detail mask map. </li>
<li>
Alpha: Stores the smoothness map. </li>
</ul>
<p>In this example we store the result of the evaluation of <code>metallic</code> and <code>smoothness</code> expressions in the Mask Map. The mapping of the MDL <code>roughness</code> to Unity <code>smoothness</code> is done with the formula:</p>
<div class="fragment"><div class="line">smoothness = 1 - <a class="code" href="group__mi__math__color.html#ga1808c867ab42a518a11e11550f768223" title="Returns the square root of each element of c. ">sqrt</a>(roughness)</div>
</div><!-- fragment --><p> Green channel of the Mask Map is set to 1, Blue channel is set to 0.</p>
<p>An extra map, the Base map stores <code>base_color</code> and <code>opacity</code>. The <code>opacity</code> value is derived from <code>transparency</code> using the formula:</p>
<div class="fragment"><div class="line">opacity = 1 - transparency</div>
</div><!-- fragment --><p>In order to use the output maps, create an HDRP/Lit material shader in Unity and connect the Base map and the Mask map to the corresponding parameters.</p>
<p>Here are some examples of material expressions computed in this example using the <code>transmissive_pbr</code> target model:</p>
<table  border="1" cellpadding="3" cellspacing="3">
<tr valign="top">
<th>Expression Name</th><th>Expression </th></tr>
<tr valign="top">
<td class="indexkey">anisotropy  </td><td class="indexvalue">surface.scattering.base.layer.components.0.component.layer.roughness_u.s.r.anisotropy   </td></tr>
<tr valign="top">
<td class="indexkey">anisotropy_rotation  </td><td class="indexvalue">surface.scattering.base.layer.components.0.component.layer.roughness_u.s.r.rotation   </td></tr>
<tr valign="top">
<td class="indexkey">attenuation_color  </td><td class="indexvalue">volume.absorption_coefficient.s.v.attenuation   </td></tr>
<tr valign="top">
<td class="indexkey">attenuation_distance  </td><td class="indexvalue">volume.scattering_coefficient.s.v.distance   </td></tr>
<tr valign="top">
<td class="indexkey">base_color  </td><td class="indexvalue">surface.scattering.base.layer.components.1.component.tint   </td></tr>
<tr valign="top">
<td class="indexkey">clearcoat_normal  </td><td class="indexvalue">surface.scattering.normal   </td></tr>
<tr valign="top">
<td class="indexkey">clearcoat_roughness  </td><td class="indexvalue">surface.scattering.layer.roughness_u   </td></tr>
<tr valign="top">
<td class="indexkey">clearcoat_weight  </td><td class="indexvalue">surface.scattering.weight   </td></tr>
<tr valign="top">
<td class="indexkey">metallic  </td><td class="indexvalue">surface.scattering.base.layer.components.1.weight   </td></tr>
<tr valign="top">
<td class="indexkey">normal  </td><td class="indexvalue">surface.scattering.base.normal   </td></tr>
<tr valign="top">
<td class="indexkey">opacity  </td><td class="indexvalue">geometry.cutout_opacity   </td></tr>
<tr valign="top">
<td class="indexkey">roughness  </td><td class="indexvalue">surface.scattering.base.layer.components.0.component.layer.roughness_u.s.r.roughness   </td></tr>
<tr valign="top">
<td class="indexkey">specular  </td><td class="indexvalue">surface.scattering.base.layer.components.0.component.weight   </td></tr>
<tr valign="top">
<td class="indexkey">subsurface_color  </td><td class="indexvalue">volume.absorption_coefficient.s.v.subsurface   </td></tr>
<tr valign="top">
<td class="indexkey">transmission_color  </td><td class="indexvalue">surface.scattering.layer.components.0.component.base.components.1.component.tint   </td></tr>
<tr valign="top">
<td class="indexkey">transparency  </td><td class="indexvalue">surface.scattering.layer.components.0.component.base.components.1.weight   </td></tr>
<tr valign="top">
<td class="indexkey">volume_ior  </td><td class="indexvalue">ior   </td></tr>
<tr valign="top">
<td class="indexkey">...  </td><td class="indexvalue">...   </td></tr>
</table>
<p class="enddd"></p>
</dd>
</dl>
<h1><a class="anchor" id="example_distilling_unity"></a>
Example Source</h1>
<p><b>Source Code Location:</b> <code>examples/mdl_sdk/distilling_unity/example_distilling_unity.cpp</code></p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment"> * Copyright 2022 NVIDIA Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *****************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// examples/mdl_sdk/distilling_unity/example_distilling_unity.cpp</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Introduces the distillation of mdl materials to a fixed target model</span></div>
<div class="line"><span class="comment">// and showcases how to bake material paths to a texture</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;set&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;example_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;example_distilling_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;example_cuda_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;example_distilling_unity.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Lookup tables for baking oversampling</span></div>
<div class="line"><span class="keywordtype">float</span> RADINV2[] = { 0, 0.5f, 0.25f, 0.75f, 0.125f, 0.625f, 0.375f, 0.875f, 0.0625f, 0.5625f, 0.3125f, 0.8125f, 0.1875f, 0.6875f, 0.4375f };</div>
<div class="line"><span class="keywordtype">float</span> RADINV3[] = { 0, 0.333333f, 0.666667f, 0.111111f, 0.444444f, 0.777778f, 0.222222f, 0.555556f, 0.888889f, 0.037037f, 0.37037f, 0.703704f, 0.148148f, 0.481481f, 0.814815f };</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Logger;</div>
<div class="line"><a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;Logger&gt;</a> the_logger;</div>
<div class="line"><span class="keyword">class </span>Logger : <span class="keyword">public</span> <a class="code" href="classmi_1_1base_1_1Interface__implement.html" title="Mixin class template for deriving interface implementations. ">mi::base::Interface_implement</a>&lt;mi::base::ILogger&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Logger(<span class="keywordtype">int</span> level)</div>
<div class="line">    {</div>
<div class="line">        set_verbosity_level(level);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> message(</div>
<div class="line">        <a class="code" href="group__mi__base__ilogger.html#ga35cadb98d3212ad7941f401da374f28d" title="Constants for possible message severities. ">mi::base::Message_severity</a> level,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="comment">/*module_category*/</span>,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structmi_1_1base_1_1Message__details.html" title="Structured details to log messages. ">mi::base::Message_details</a>&amp; <span class="comment">/*details*/</span>,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* message)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (level &gt; m_level)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* severity = 0;</div>
<div class="line">        <span class="keywordflow">switch</span> (level) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28da243f28b6edeaf3f1f51258f830f0be69" title="A fatal error has occurred. ">mi::base::MESSAGE_SEVERITY_FATAL</a>:        severity = <span class="stringliteral">&quot;fatal: &quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dadaba4c0d57879faf349416dce0d3cb10" title="An error has occurred. ">mi::base::MESSAGE_SEVERITY_ERROR</a>:        severity = <span class="stringliteral">&quot;error: &quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28daac0321ddd7ad84942e8dd43e5a3383bc" title="A warning has occurred. ">mi::base::MESSAGE_SEVERITY_WARNING</a>:      severity = <span class="stringliteral">&quot;warn:  &quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad55ef3f9d5234a53fc346894b7490457" title="This is a normal operational message. ">mi::base::MESSAGE_SEVERITY_INFO</a>:         severity = <span class="stringliteral">&quot;info:  &quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>:      severity = <span class="stringliteral">&quot;verbose:  &quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28da4a3caf8e9a3bffa0e6072d671ee08740" title="This is debug message. ">mi::base::MESSAGE_SEVERITY_DEBUG</a>:        severity = <span class="stringliteral">&quot;debug:  &quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> mi::base::MESSAGE_SEVERITY_FORCE_32_BIT: <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;%s&quot;</span>, severity);</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;%s&quot;</span>, message);</div>
<div class="line">        putc(<span class="charliteral">&#39;\n&#39;</span>, stderr);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef MI_PLATFORM_WINDOWS</span></div>
<div class="line"><span class="preprocessor"></span>        fflush(stderr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> set_verbosity_level(<span class="keywordtype">int</span> level)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (level &gt;= 0 &amp;&amp; level &lt;= 6)</div>
<div class="line">        {</div>
<div class="line">            m_level = level;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="group__mi__math__color.html#gaa75298c105fdef6f24ec8ba780fcd116" title="Returns a color with elementwise natural logarithm of the color c. ">log</a>(<a class="code" href="group__mi__base__ilogger.html#ga35cadb98d3212ad7941f401da374f28d" title="Constants for possible message severities. ">mi::base::Message_severity</a> level, <span class="keyword">const</span> std::string &amp; str)</div>
<div class="line">    {</div>
<div class="line">        message(level, <span class="stringliteral">&quot;Distilling&quot;</span><span class="comment">/*module_category*/</span>, <a class="code" href="structmi_1_1base_1_1Message__details.html" title="Structured details to log messages. ">mi::base::Message_details</a>(), str.c_str());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// Logging level up to which messages are reported</span></div>
<div class="line">    <span class="comment">// level = 0 will disable all logging</span></div>
<div class="line">    <span class="comment">// level &gt;= 1 logs fatal messages</span></div>
<div class="line">    <span class="comment">// level &gt;= 2 logs error in addition</span></div>
<div class="line">    <span class="comment">// level &gt;= 3 logs warning in addition</span></div>
<div class="line">    <span class="comment">// level &gt;= 4 logs info in addition</span></div>
<div class="line">    <span class="comment">// level &gt;= 5 logs verbose in addition</span></div>
<div class="line">    <span class="comment">// level = 6 logs debug in addition</span></div>
<div class="line">    <span class="keywordtype">int</span>  m_level = 0;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Custom timing output </span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="keyword">struct </span>Timing</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">explicit</span> Timing(std::string operation)</div>
<div class="line">        : m_operation(operation)</div>
<div class="line">    {</div>
<div class="line">        m_start = std::chrono::steady_clock::now();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ~Timing()</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> stop = std::chrono::steady_clock::now();</div>
<div class="line">        std::chrono::duration&lt;double&gt; elapsed_seconds = stop - m_start;</div>
<div class="line">        std::stringstream strStream;</div>
<div class="line">        strStream &lt;&lt; m_operation.c_str() &lt;&lt; <span class="stringliteral">&quot; time: &quot;</span> &lt;&lt; elapsed_seconds.count() * 1000 &lt;&lt; <span class="stringliteral">&quot; ms.&quot;</span>;</div>
<div class="line">        the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad55ef3f9d5234a53fc346894b7490457" title="This is a normal operational message. ">mi::base::MESSAGE_SEVERITY_INFO</a>, strStream.str());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::string m_operation;</div>
<div class="line">    std::chrono::steady_clock::time_point m_start;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Small struct used to store the result of a texture baking process</span></div>
<div class="line"><span class="comment">// of a material sub expression</span></div>
<div class="line"><span class="keyword">struct </span>Material_parameter</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> void (Remap_func(<a class="code" href="classmi_1_1base_1_1IInterface.html" title="The basic extensible interface. ">mi::base::IInterface</a>*));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IData&gt;</a>                 value;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a>    texture;</div>
<div class="line"></div>
<div class="line">    std::string                                 value_type;</div>
<div class="line">    std::string                                 bake_path;</div>
<div class="line"></div>
<div class="line">    Remap_func*                                 remap_func;</div>
<div class="line"></div>
<div class="line">    Material_parameter() : remap_func(nullptr)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Material_parameter(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; value_type,</div>
<div class="line">        Remap_func* func = <span class="keyword">nullptr</span>)</div>
<div class="line">        : value_type(value_type)</div>
<div class="line">        , remap_func(func)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Material : <span class="keyword">public</span> std::map&lt;std::string, Material_parameter&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// Base Map</span></div>
<div class="line">    <span class="comment">// - RGB: Stores the base color</span></div>
<div class="line">    <span class="comment">// - Alpha : Stores the opacity</span></div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a> * get_base_color_map(<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api, <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> resolution)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!m_base_color_map.is_valid_interface())</div>
<div class="line">        {</div>
<div class="line">            m_base_color_map = <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a>(image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(<span class="stringliteral">&quot;Color&quot;</span>, resolution, resolution));</div>
<div class="line">        }</div>
<div class="line">        m_base_color_map-&gt;retain();</div>
<div class="line">        <span class="keywordflow">return</span> m_base_color_map.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> has_base_color_map()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_base_color_map.is_valid_interface();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Mask map</span></div>
<div class="line">    <span class="comment">// A Texture that packs different Material maps into each of its RGBA channels</span></div>
<div class="line">    <span class="comment">// - Red : Stores the metallic map</span></div>
<div class="line">    <span class="comment">// - Green : Stores the ambient occlusion map</span></div>
<div class="line">    <span class="comment">// - Blue : Stores the detail Mask Map</span></div>
<div class="line">    <span class="comment">// - Alpha : Stores the smoothness map</span></div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a> * get_mask_map(<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api, <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> resolution)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(! m_mask_map.is_valid_interface())</div>
<div class="line">        {</div>
<div class="line">            m_mask_map = <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a>(image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(<span class="stringliteral">&quot;Color&quot;</span>, resolution, resolution));</div>
<div class="line">        }</div>
<div class="line">        m_mask_map-&gt;retain();</div>
<div class="line">        <span class="keywordflow">return</span> m_mask_map.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> has_mask_map()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_mask_map.is_valid_interface();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Material_parameter * find_parameter(<span class="keyword">const</span> std::string &amp; name)</div>
<div class="line">    {</div>
<div class="line">        std::map&lt;std::string, Material_parameter&gt;::iterator it(find(name));</div>
<div class="line">        <span class="keywordflow">if</span> (it != end())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> &amp;(it-&gt;second);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">bool</span> is_base_map_parm(<span class="keyword">const</span> std::string&amp; param_name)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> (param_name == <span class="stringliteral">&quot;base_color&quot;</span> || param_name == <span class="stringliteral">&quot;transparency&quot;</span> || param_name == <span class="stringliteral">&quot;opacity&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> is_mask_map_parm(<span class="keyword">const</span> std::string&amp; param_name)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> (param_name == <span class="stringliteral">&quot;metallic&quot;</span> || param_name == <span class="stringliteral">&quot;roughness&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a> * get_texture_for_parameter(<span class="keyword">const</span> std::string &amp; param_name, <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api, <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> resolution)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (is_base_map_parm(param_name))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> get_base_color_map(image_api, resolution);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_mask_map_parm(param_name))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> get_mask_map(image_api, resolution);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            Material_parameter * p(find_parameter(param_name));</div>
<div class="line">            <span class="keywordflow">if</span> (p)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(p-&gt;value_type.c_str(), resolution, resolution);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> m_base_color_map;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> m_mask_map;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Log the messages of the given context.</span></div>
<div class="line"><span class="comment">// Returns true, if the context does not contain any error messages, false otherwise.</span></div>
<div class="line"><span class="keywordtype">bool</span> print_messages_local(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; context-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html#ac3caefb040df7e0d90232c56af259cfb" title="Returns the number of messages. ">get_messages_count</a>(); ++i) {</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IMessage&gt;</a> message(context-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html#a383fdfde26de9864632a48c7ae727f7e" title="Returns the message at index or NULL, if no such index exists. ">get_message</a>(i));</div>
<div class="line">        the_logger-&gt;log(message-&gt;get_severity(), message-&gt;get_string());</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> context-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html#a65f343d795e12da9a1ba79cbe4b3b123" title="Returns the number of error messages. ">get_error_messages_count</a>() == 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Creates an instance of the given material.</span></div>
<div class="line"><a class="code" href="classmi_1_1neuraylib_1_1IFunction__call.html" title="This interface represents a function call. ">mi::neuraylib::IFunction_call</a>* create_material_instance(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>* mdl_factory,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>* mdl_impexp_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; module_qualified_name,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; material_simple_name)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Load the module.</span></div>
<div class="line">    mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a5e195d80915190eb40c5995ccfeaa4c9" title="Loads an MDL module from disk (or a builtin module) into the database. ">load_module</a>(transaction, module_qualified_name.c_str(), context);</div>
<div class="line">    <span class="keywordflow">if</span> (!print_messages(context))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Loading module &#39;%s&#39; failed.&quot;</span>, module_qualified_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the database name for the module we loaded</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::IString&gt;</a> module_db_name(</div>
<div class="line">        mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a72a27c9e0d66e79391ff9a8e3ce4a119" title="Returns the DB name for the MDL name of a module (or file path for MDLE modules). ...">get_db_module_name</a>(module_qualified_name.c_str()));</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IModule&gt;</a> module(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IModule.html" title="This interface represents an MDL module. ">mi::neuraylib::IModule</a>&gt;(module_db_name-&gt;get_c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!module)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to access the loaded module.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Attach the material name</span></div>
<div class="line">    std::string material_db_name</div>
<div class="line">        = std::string(module_db_name-&gt;get_c_str()) + <span class="stringliteral">&quot;::&quot;</span> + material_simple_name;</div>
<div class="line">    material_db_name = mi::examples::mdl::add_missing_material_signature(</div>
<div class="line">        module.get(), material_db_name);</div>
<div class="line">    <span class="keywordflow">if</span> (material_db_name.empty())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to find the material %s in the module %s.&quot;</span>,</div>
<div class="line">            material_simple_name.c_str(), module_qualified_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the material definition from the database</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IFunction_definition&gt;</a> material_definition(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html" title="This interface represents a function definition. ">mi::neuraylib::IFunction_definition</a>&gt;(material_db_name.c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!material_definition)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Accessing definition &#39;%s&#39; failed.&quot;</span>, material_db_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a material instance from the material definition with the default arguments.</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result;</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IFunction__call.html" title="This interface represents a function call. ">mi::neuraylib::IFunction_call</a>* material_instance =</div>
<div class="line">        material_definition-&gt;create_function_call(0, &amp;result);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Instantiating &#39;%s&#39; failed.&quot;</span>, material_db_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> material_instance;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Compiles the given material instance in the given compilation modes and stores</span></div>
<div class="line"><span class="comment">// it in the DB.</span></div>
<div class="line"><a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compile_material_instance(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__call.html" title="This interface represents a function call. ">mi::neuraylib::IFunction_call</a>* material_instance,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keywordtype">bool</span> class_compilation)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> flags = class_compilation</div>
<div class="line">        ? <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959a7474d76ee055edda39a494edf06cfc36" title="Selects class compilation instead of instance compilation. ">mi::neuraylib::IMaterial_instance::CLASS_COMPILATION</a></div>
<div class="line">        : <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959afdcc06252ec8a89909ddd69006031766" title="Default compilation options (e.g., instance compilation). ">mi::neuraylib::IMaterial_instance::DEFAULT_OPTIONS</a>;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IMaterial_instance&gt;</a> material_instance2(</div>
<div class="line">        material_instance-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html" title="This interface represents a material instance. ">mi::neuraylib::IMaterial_instance</a>&gt;());</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compiled_material =</div>
<div class="line">        material_instance2-&gt;create_compiled_material(flags, context);</div>
<div class="line">    check_success(print_messages_local(context));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> compiled_material;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Distills the given compiled material to the requested target model, </span></div>
<div class="line"><span class="comment">// and returns it</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* create_distilled_material(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>* distiller_api,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compiled_material,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* target_model)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = 0;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> distilled_material(</div>
<div class="line">        distiller_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#aa36119af9e8090cc26b77816e0d2c335" title="Distills a material. ">distill_material</a>(compiled_material, target_model, <span class="keyword">nullptr</span>, &amp;result));</div>
<div class="line">    check_success(result == 0);</div>
<div class="line"></div>
<div class="line">    distilled_material-&gt;retain();</div>
<div class="line">    <span class="keywordflow">return</span> distilled_material.get();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// remap normal </span></div>
<div class="line"><span class="keywordtype">void</span> remap_normal(<a class="code" href="classmi_1_1base_1_1IInterface.html" title="The basic extensible interface. ">mi::base::IInterface</a>* icanvas)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> canvas(</div>
<div class="line">        icanvas-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>&gt;());</div>
<div class="line">    <span class="keywordflow">if</span>(!canvas)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    <span class="comment">// Convert normal values from the interval [-1.0,1.0] to [0.0, 1.0]</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile (canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* data = <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> n = canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#acd28f45b9d22b1cd1e24043aeda5c065" title="Returns the resolution of the canvas in x direction. ">get_resolution_x</a>() * canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#a51874ccdb54f6e03ff325b01d98dfefb" title="Returns the resolution of the canvas in y direction. ">get_resolution_y</a>() * 3;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> i=0; i&lt;n; ++i)</div>
<div class="line">    {</div>
<div class="line">        data[i] = (data[i] + 1.f) * 0.5f;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Setup material parameters and collect relevant bake paths</span></div>
<div class="line"><span class="keywordtype">void</span> setup_target_material(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm,</div>
<div class="line">    Material&amp; out_material)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Access surface.scattering function</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IExpression_direct_call&gt;</a> parent_call(</div>
<div class="line">        lookup_call(<span class="stringliteral">&quot;surface.scattering&quot;</span>, cm));</div>
<div class="line">    <span class="comment">// ... and get its semantic</span></div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51" title="All known semantics of functions definitions. ">mi::neuraylib::IFunction_definition::Semantics</a> semantic(</div>
<div class="line">        get_call_semantic(transaction, parent_call.get()));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Setup some material parameters</span></div>
<div class="line">    out_material[<span class="stringliteral">&quot;base_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Color&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;metallic&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;specular&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;roughness&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;normal&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">    out_material[<span class="stringliteral">&quot;clearcoat_weight&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;clearcoat_normal&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">    out_material[<span class="stringliteral">&quot;opacity&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line"></div>
<div class="line">    std::string path_prefix = <span class="stringliteral">&quot;surface.scattering.&quot;</span>;</div>
<div class="line"></div>
<div class="line">    out_material[<span class="stringliteral">&quot;anisotropy&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;anisotropy_rotation&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;transparency&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;transmission_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// uniform</span></div>
<div class="line">    out_material[<span class="stringliteral">&quot;attenuation_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;attenuation_distance&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;subsurface_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">    out_material[<span class="stringliteral">&quot;volume_ior&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// collect volume properties, they are guaranteed to exist</span></div>
<div class="line">    out_material[<span class="stringliteral">&quot;attenuation_color&quot;</span>].bake_path = <span class="stringliteral">&quot;volume.absorption_coefficient.s.v.attenuation&quot;</span>;</div>
<div class="line">    out_material[<span class="stringliteral">&quot;subsurface_color&quot;</span>].bake_path = <span class="stringliteral">&quot;volume.absorption_coefficient.s.v.subsurface&quot;</span>;</div>
<div class="line">    out_material[<span class="stringliteral">&quot;attenuation_distance&quot;</span>].bake_path = <span class="stringliteral">&quot;volume.scattering_coefficient.s.v.distance&quot;</span>;</div>
<div class="line">    out_material[<span class="stringliteral">&quot;volume_ior&quot;</span>].bake_path = <span class="stringliteral">&quot;ior&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check for a clearcoat layer, first. If present, it is the outermost layer</span></div>
<div class="line">    <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Setup clearcoat bake paths</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;clearcoat_weight&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;weight&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;clearcoat_normal&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;normal&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get clear-coat base layer</span></div>
<div class="line">        parent_call = lookup_call(<span class="stringliteral">&quot;base&quot;</span>, cm, parent_call.get());</div>
<div class="line">        <span class="comment">// Get clear-coat base layer semantic</span></div>
<div class="line">        semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">        <span class="comment">// Extend path prefix</span></div>
<div class="line">        path_prefix += <span class="stringliteral">&quot;base.&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check for a weighted layer. Sole purpose of this layer is the transportation of  </span></div>
<div class="line">    <span class="comment">// the under-clearcoat-normal. It contains an empty base and a layer with the</span></div>
<div class="line">    <span class="comment">// actual material body</span></div>
<div class="line">    <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51af0d7095ab62fadc99f6da2f081635491" title="The df::weighted_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_WEIGHTED_LAYER</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Collect under-clearcoat normal</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;normal&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Chain further</span></div>
<div class="line">        parent_call = lookup_call(<span class="stringliteral">&quot;layer&quot;</span>, cm, parent_call.get());</div>
<div class="line">        semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">        path_prefix += <span class="stringliteral">&quot;layer.&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Check for a normalized mix. This mix combines the metallic and dielectric parts</span></div>
<div class="line">    <span class="comment">// of the material</span></div>
<div class="line">    <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51aaadb2dea7ed283a586f5f996928a850e" title="The df::normalized_mix() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_NORMALIZED_MIX</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// The top-mix component is supposed to be a glossy bsdf</span></div>
<div class="line">        <span class="comment">// Collect metallic weight</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;metallic&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.weight&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// And other metallic parameters</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u.s.r.roughness&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;anisotropy&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u.s.r.anisotropy&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;anisotropy_rotation&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u.s.r.rotation&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Base_color can be taken from any of the leaf-bsdfs. It is supposed to</span></div>
<div class="line">        <span class="comment">// be the same.</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.tint&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Chain further</span></div>
<div class="line">        parent_call = lookup_call(</div>
<div class="line">            <span class="stringliteral">&quot;components.0.component&quot;</span>, cm, parent_call.get());</div>
<div class="line">        semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">        path_prefix += <span class="stringliteral">&quot;components.0.component.&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Collect specular parameters</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;specular&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;weight&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u.s.r.roughness&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;anisotropy&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u.s.r.anisotropy&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;anisotropy_rotation&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u.s.r.rotation&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Chain further</span></div>
<div class="line">        parent_call = lookup_call(<span class="stringliteral">&quot;base&quot;</span>, cm, parent_call.get());</div>
<div class="line">        semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">        path_prefix += <span class="stringliteral">&quot;base.&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51aaadb2dea7ed283a586f5f996928a850e" title="The df::normalized_mix() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_NORMALIZED_MIX</a>)</div>
<div class="line">    {</div>
<div class="line">        out_material[<span class="stringliteral">&quot;transparency&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.weight&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;transmission_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.tint&quot;</span>;</div>
<div class="line">        <span class="comment">// Chain further</span></div>
<div class="line">        parent_call = lookup_call(<span class="stringliteral">&quot;components.0.component&quot;</span>, cm, parent_call.get());</div>
<div class="line">        semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">        path_prefix += <span class="stringliteral">&quot;components.0.component.&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (semantic ==</div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a995acaeccbd4d42866de0e3fdf020ed3" title="The df::microfacet_ggx_vcavities() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_MICROFACET_GGX_VCAVITIES_BSDF</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (out_material[<span class="stringliteral">&quot;metallic&quot;</span>].bake_path.empty())</div>
<div class="line">            out_material[<span class="stringliteral">&quot;metallic&quot;</span>].value = create_value(transaction, <span class="stringliteral">&quot;Float32&quot;</span>, 1.0f);</div>
<div class="line">        <span class="keywordflow">if</span> (out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path.empty())</div>
<div class="line">            out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;roughness_u&quot;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path.empty())</div>
<div class="line">            out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;tint&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (semantic ==</div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a9ef0cefaf54499616b41d73482ed47b3" title="The df::diffuse_reflection_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_DIFFUSE_REFLECTION_BSDF</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path.empty())</div>
<div class="line">            out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;tint&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check for cutout-opacity</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IExpression&gt;</a> cutout(</div>
<div class="line">        cm-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#a873ecce34f04444dc3e0989526f3bd46" title="Looks up a sub-expression of the compiled material. ">lookup_sub_expression</a>(<span class="stringliteral">&quot;geometry.cutout_opacity&quot;</span>));</div>
<div class="line">    <span class="keywordflow">if</span> (cutout.is_valid_interface())</div>
<div class="line">        out_material[<span class="stringliteral">&quot;opacity&quot;</span>].bake_path = <span class="stringliteral">&quot;geometry.cutout_opacity&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Function_descriptions</span></div>
<div class="line"><span class="comment">// Helper class which holds a vector of Target_function_description</span></div>
<div class="line"><span class="comment">// and allows to query a specific function description for a given expression (aka description) or for a given parameter name</span></div>
<div class="line"><span class="keyword">class </span>Function_descriptions : <span class="keyword">public</span> std::vector&lt;mi::neuraylib::Target_function_description&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> add_function(<span class="keyword">const</span> std::string &amp; parameter_name, <span class="keyword">const</span> std::string &amp; description)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!description.empty())</div>
<div class="line">        {</div>
<div class="line">            m_parms[parameter_name] = description;</div>
<div class="line">            emplace_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(description.c_str()));</div>
<div class="line">            <span class="comment">// TODO Set a name for each fct?</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> get_function_description(<span class="keyword">const</span> std::string &amp; description, <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a> &amp; function_description)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; fd : *<span class="keyword">this</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (fd.path == description)</div>
<div class="line">            {</div>
<div class="line">                function_description = fd;</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> get_function_description_from_parameter(<span class="keyword">const</span> std::string &amp; parameter_name, <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a> &amp; function_description)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        Parameter_map::const_iterator it(m_parms.find(parameter_name));</div>
<div class="line">        <span class="keywordflow">if</span> (it != m_parms.end())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> get_function_description(it-&gt;second, function_description);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">typedef</span> std::map&lt;std::string<span class="comment">/*parameter_name*/</span>, std::string <span class="comment">/*description*/</span>&gt; Parameter_map;</div>
<div class="line">    Parameter_map m_parms;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Baker</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Baker(</div>
<div class="line">        <a class="code" href="group__mi__neuray__mdl__misc.html#ga89a2ac433f88dff3f1a280612cdf1086" title="Identifies the resource(s) to be used by a baker. ">mi::neuraylib::Baker_resource</a> baker_resource</div>
<div class="line">        , <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction</div>
<div class="line">        , <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* material</div>
<div class="line">        , Material&amp; out_material</div>
<div class="line">        , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a> * context</div>
<div class="line">        , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>* mdl_backend_api</div>
<div class="line">    )</div>
<div class="line">        : m_out_material(out_material)</div>
<div class="line">        , m_transaction(mi::base::<a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">make_handle_dup</a>(transaction))</div>
<div class="line">        , m_context(mi::base::<a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">make_handle_dup</a>(context))</div>
<div class="line">        , m_mdl_backend_api(mi::base::<a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">make_handle_dup</a>(mdl_backend_api))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Determine how to bake: CPU || GPU || GPU with fallback</span></div>
<div class="line">        init_baker_resource(baker_resource);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Initialize function descriptions</span></div>
<div class="line">        init_function_descriptions();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Build, compile, code to bake params</span></div>
<div class="line">        build_baker_programs(material);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> bake(</div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api</div>
<div class="line">        , <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> baking_samples</div>
<div class="line">        , <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> baking_resolution</div>
<div class="line">        , <span class="keywordtype">bool</span> parallel</div>
<div class="line">    )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="comment">// Prepare for baking</span></div>
<div class="line">        Parm_list plist;</div>
<div class="line">        pre_bake(plist);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (m_bake_gpu)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (bake_cuda_ptx(image_api, baking_samples, baking_resolution, plist))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">// Will bake on CPU below if GPU fails and if BAKE_ON_GPU_WITH_CPU_FALLBACK was choosen</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (m_bake_cpu)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (bake_native(image_api, baking_samples, baking_resolution, plist))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    Function_descriptions m_descs;</div>
<div class="line">    Material &amp; m_out_material;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::ITransaction&gt;</a> m_transaction;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> m_context;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend_api&gt;</a> m_mdl_backend_api;</div>
<div class="line">    <span class="keywordtype">bool</span> m_bake_gpu = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> m_bake_cpu = <span class="keyword">false</span>;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;</a> m_native_code;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;</a> m_gpu_code;</div>
<div class="line">    <span class="comment">// The CUDA device ID.</span></div>
<div class="line">    <span class="keywordtype">int</span> m_cuda_device = 0;</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// Helper to sort the parameters to bake.</span></div>
<div class="line">    <span class="comment">// This is particularly useful for GPU baking.</span></div>
<div class="line">    <span class="keyword">struct </span>Parms</div>
<div class="line">    {</div>
<div class="line">        Parms(<span class="keyword">const</span> std::string &amp; name, Expression_type expr_type)</div>
<div class="line">            : m_name(name), m_expr_type(expr_type)</div>
<div class="line">        {}</div>
<div class="line">        std::string m_name;</div>
<div class="line">        Expression_type m_expr_type = EXT_UNKNOWN;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keyword">class </span>Parm_list : <span class="keyword">public</span> std::vector&lt;Parms&gt;</div>
<div class="line">    {</div>
<div class="line">        std::set&lt;std::string&gt; m_added;</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        <span class="keywordtype">void</span> add_parm(<span class="keyword">const</span> std::string &amp; name, Expression_type expr_type = EXT_UNKNOWN)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (m_added.find(name) == m_added.end())</div>
<div class="line">            {</div>
<div class="line">                m_added.insert(name);</div>
<div class="line">                emplace_back(Parms(name, expr_type));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordtype">void</span> add_parms(<span class="keyword">const</span> Material &amp; m)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp; p : m)</div>
<div class="line">            {</div>
<div class="line">                add_parm(p.first);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Build ordered list of material parameters</span></div>
<div class="line">    <span class="keywordtype">void</span> pre_bake(Parm_list &amp; plist)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="comment">// WARNING: Order of the following maps is important</span></div>
<div class="line">        plist.add_parm(<span class="stringliteral">&quot;roughness&quot;</span>, EXT_ROUGHNESS);</div>
<div class="line">        plist.add_parm(<span class="stringliteral">&quot;metallic&quot;</span>, EXT_METALLIC);</div>
<div class="line">        plist.add_parm(<span class="stringliteral">&quot;base_color&quot;</span>, EXT_BASE_COLOR);</div>
<div class="line">        plist.add_parm(<span class="stringliteral">&quot;transparency&quot;</span>, EXT_TRANSPARENCY);</div>
<div class="line">        plist.add_parm(<span class="stringliteral">&quot;opacity&quot;</span>, EXT_OPACITY);</div>
<div class="line">        <span class="comment">// Add all other parameters</span></div>
<div class="line">        plist.add_parms(m_out_material);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">bool</span> bake_native(</div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api</div>
<div class="line">        , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>&amp; baking_samples</div>
<div class="line">        , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>&amp; baking_resolution</div>
<div class="line">        , <span class="keyword">const</span> Parm_list&amp; plist</div>
<div class="line">    )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> bake_native_function = [](</div>
<div class="line">            <span class="keywordtype">size_t</span> index</div>
<div class="line">            , <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> num_rows_per_frag</div>
<div class="line">            , <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> num_frags_with_extra_row</div>
<div class="line">            , <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> tex_width</div>
<div class="line">            , <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* texture</div>
<div class="line">            , <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> num_samples</div>
<div class="line">            , <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> du</div>
<div class="line">            , <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> dv</div>
<div class="line">            , <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a>* code</div>
<div class="line">            , <span class="keyword">const</span> <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>&amp; function_description</div>
<div class="line">            , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>&amp; components_per_pixel</div>
<div class="line">            , Expression_type expr_type</div>
<div class="line">            , <span class="keywordtype">float</span> metallic</div>
<div class="line">            )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> start_row = <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>(</div>
<div class="line">                index * num_rows_per_frag +</div>
<div class="line">                ((index &lt; num_frags_with_extra_row) ? index : num_frags_with_extra_row));</div>
<div class="line"></div>
<div class="line">            <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> end_row = <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>(</div>
<div class="line">                start_row + num_rows_per_frag - 1 +</div>
<div class="line">                ((index &lt; num_frags_with_extra_row) ? 1 : 0));</div>
<div class="line"></div>
<div class="line">            <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> start_col = 0;</div>
<div class="line">            <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> end_col = tex_width - 1;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html" title="The MDL material state structure inside the MDL SDK is a representation of the renderer state as defi...">mi::neuraylib::Shading_state_material</a> state;</div>
<div class="line"></div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a15070527df93cd94367857a36cc087ac" title="The result of state::normal(). ">normal</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0, 0, 1);</div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a9fb450fd7fe6457e79ddbafb32322ace" title="The result of state::geometry_normal(). ">geom_normal</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0, 0, 1);</div>
<div class="line">            <span class="comment">//state.position        = mi::Float32_3(0, 0, 0);</span></div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a836abb5d4dd3a154ed980f4b5d62894a" title="The result of state::animation_time(). ">animation_time</a> = 0;</div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a1ca1b3be098d3cae597c7f2772537f1e" title="A pointer to a read-only data segment. ">ro_data_segment</a> = 0;</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> max_tex_spaces = 4;</div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tex_coords[max_tex_spaces];</div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tangent_u[max_tex_spaces];</div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tangent_v[max_tex_spaces];</div>
<div class="line"></div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a699b385395320bd9d31b2a898cc41a94" title="An array containing the results of state::texture_coordinate(i). ">text_coords</a> = tex_coords;</div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#ab2328f82a194b7d7807ce5c8bbc6fe81" title="An array containing the results of state::texture_tangent_u(i). ">tangent_u</a> = tangent_u;</div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a3a6f534c71c30c6d67da8244b3924242" title="An array containing the results of state::texture_tangent_v(i). ">tangent_v</a> = tangent_v;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ts = 0; ts &lt; max_tex_spaces; ++ts)</div>
<div class="line">            {</div>
<div class="line">                tangent_u[ts] = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1, 0, 0);</div>
<div class="line">                tangent_v[ts] = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0, 1, 0);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// text result are currently unused</span></div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#aed5ec70445ecfd586edfeffa6d41de05" title="The texture results lookup table. ">text_results</a> = 0;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// we have no uniform state here</span></div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> world_to_obj(1.0f);</div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> obj_to_world(1.0f);</div>
<div class="line"></div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a3892e6ffcd47871db4c0c95f1b945580" title="A 4x4 transformation matrix in row-major order transforming from world to object coordinates. ">world_to_object</a> = &amp;world_to_obj[0];</div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a3c531d1d3f38dbdf3b5169d09a62c88e" title="A 4x4 transformation matrix in row-major order transforming from object to world coordinates. ">object_to_world</a> = &amp;obj_to_world[0];</div>
<div class="line">            state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a246d80fa072361aa866effaef347b2a0" title="The result of state::object_id(). ">object_id</a> = 0;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile(texture-&gt;get_tile());</div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_4</a> pixel_data;</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Atom32.html" title="A 32-bit unsigned counter with atomic arithmetic, increments, and decrements. ">mi::base::Atom32</a> failure;</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span>* data = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span>*<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line">            <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> i = start_row; i &lt;= end_row; i++)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> j = start_col; j &lt;= end_col; j++)</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_4</a> pixel(0.0f, 0.0f, 0.0f, 1.0f);</div>
<div class="line">                    pixel_data = pixel;</div>
<div class="line"></div>
<div class="line">                    check_success(num_samples &lt;= 16);</div>
<div class="line">                    <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> k = 0; k &lt; num_samples; k++)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> y = (i + <a class="code" href="group__mi__math__color.html#ga0e58b3172d6dd2896af2fdce02afe6e9" title="Returns a color with the elementwise positive fractional part of the color c. ">mi::math::frac</a>(RADINV3[k] + 0.5f)) * dv;</div>
<div class="line">                        <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> x = (j + <a class="code" href="group__mi__math__color.html#ga0e58b3172d6dd2896af2fdce02afe6e9" title="Returns a color with the elementwise positive fractional part of the color c. ">mi::math::frac</a>(RADINV2[k] + 0.5f)) * du;</div>
<div class="line"></div>
<div class="line">                        state.<a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html#a2cfd2481510acbb6bd947dcfc3b1bcaa" title="The result of state::position(). ">position</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(x, y, 0);</div>
<div class="line">                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ts = 0; ts &lt; max_tex_spaces; ++ts)</div>
<div class="line">                        {</div>
<div class="line">                            tex_coords[ts] = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(x, y, 0);</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">if</span> (code-&gt;execute(</div>
<div class="line">                            function_description.function_index, state, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>, (<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*)&amp;pixel.x) != 0)</div>
<div class="line">                        {</div>
<div class="line">                            failure.<a class="code" href="classmi_1_1base_1_1Atom32.html#ac913e63557fd48764c3f0f02424d10a1" title="Assigns rhs to the counter and returns the old value of counter. ">swap</a>(1);</div>
<div class="line">                            <span class="keywordflow">return</span>;</div>
<div class="line">                        }</div>
<div class="line">                        pixel_data += pixel;</div>
<div class="line">                    }</div>
<div class="line">                    pixel_data /= num_samples;</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (expr_type == EXT_BASE_COLOR)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// Gamma correction </span></div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">float</span> gammainv(1 / 2.2f);</div>
<div class="line">                        pixel_data.x = powf(pixel_data.x, gammainv);</div>
<div class="line">                        pixel_data.y = powf(pixel_data.y, gammainv);</div>
<div class="line">                        pixel_data.z = powf(pixel_data.z, gammainv);</div>
<div class="line">                        pixel_data.w = 1.0f;</div>
<div class="line">                        tile-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITile.html#ac637a5b78ac82abc1ce243b4d209e2bf" title="Stores a certain pixel at the given coordinates. ">set_pixel</a>(j, i, (<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*)&amp;pixel_data.x);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (expr_type == EXT_TRANSPARENCY)</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* <span class="keyword">const</span> pixel = data + (j + i * <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a><span class="keyword">&gt;</span>(tex_width)) * components_per_pixel;</div>
<div class="line">                        pixel[3] *= 1 - pixel_data.x;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (expr_type == EXT_OPACITY)</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* <span class="keyword">const</span> pixel = data + (j + i * <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a><span class="keyword">&gt;</span>(tex_width)) * components_per_pixel;</div>
<div class="line">                        pixel[3] *= pixel_data.x;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (expr_type == EXT_METALLIC)</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* <span class="keyword">const</span> pixel = data + (j + i * <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a><span class="keyword">&gt;</span>(tex_width)) * components_per_pixel;</div>
<div class="line">                        <span class="comment">// Red : Stores the metallic map.</span></div>
<div class="line">                        pixel[0] = pixel_data.x;</div>
<div class="line">                        <span class="comment">// Green : Stores the ambient occlusion map.</span></div>
<div class="line">                        pixel[1] = 1.0f;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (expr_type == EXT_ROUGHNESS)</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* <span class="keyword">const</span> pixel = data + (j + i * <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a><span class="keyword">&gt;</span>(tex_width)) * components_per_pixel;</div>
<div class="line">                        <span class="comment">// Alpha: Stores the smoothness map.</span></div>
<div class="line">                        <span class="comment">// smoothness = 1 - sqrt(roughness)</span></div>
<div class="line">                        pixel[3] = 1 - sqrtf(pixel_data.x);</div>
<div class="line">                        <span class="comment">// Green : Stores the ambient occlusion map.</span></div>
<div class="line">                        pixel[1] = 1.0f;</div>
<div class="line">                        <span class="comment">// If metallic has no bake_path, need to set its value here</span></div>
<div class="line">                        <span class="keywordflow">if</span> (metallic &gt; 0)</div>
<div class="line">                        {</div>
<div class="line">                            pixel[0] = metallic;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        tile-&gt;set_pixel(j, i, (<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*)&amp;pixel_data.x);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!m_native_code)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">float</span> metallic(-1); <span class="comment">// no need to set metallic unless bake_path is not set</span></div>
<div class="line">        {</div>
<div class="line">            Material_parameter* param = m_out_material.find_parameter(<span class="stringliteral">&quot;metallic&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (param &amp;&amp; param-&gt;bake_path.empty())</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (param-&gt;value_type == <span class="stringliteral">&quot;Float32&quot;</span> &amp;&amp; param-&gt;value)</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32&gt;</a> value(param-&gt;value-&gt;get_interface&lt;<a class="code" href="classmi_1_1IFloat32.html" title="This interface represents mi::Float32. ">mi::IFloat32</a>&gt;());</div>
<div class="line">                    value-&gt;get_value(metallic);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Determine whether base map is uniform</span></div>
<div class="line">        std::set&lt;std::string&gt; base_map_parm = {<span class="stringliteral">&quot;base_color&quot;</span>, <span class="stringliteral">&quot;transparency&quot;</span> , <span class="stringliteral">&quot;opacity&quot;</span>};</div>
<div class="line">        <span class="keywordtype">bool</span> is_base_map_uniform(parms_are_uniform(base_map_parm, m_native_code.get()));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Determine whether Mask Map is uniform</span></div>
<div class="line">        std::set&lt;std::string&gt; mask_map_parm = {<span class="stringliteral">&quot;metallic&quot;</span>, <span class="stringliteral">&quot;roughness&quot;</span>};</div>
<div class="line">        <span class="keywordtype">bool</span> is_mask_map_uniform(parms_are_uniform(mask_map_parm, m_native_code.get()));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; p : plist)</div>
<div class="line">        {</div>
<div class="line">            Material_parameter* param = m_out_material.find_parameter(p.m_name);</div>
<div class="line">            <span class="keywordflow">if</span> (!param)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a> function_description;</div>
<div class="line">            <span class="keywordflow">if</span> (!m_descs.get_function_description(param-&gt;bake_path, function_description))</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Did not find function description</span></div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> samples(baking_samples);</div>
<div class="line">            <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> resolution(baking_resolution);</div>
<div class="line">            <span class="comment">// Determine if need to bake texture or constant</span></div>
<div class="line">            <span class="keywordtype">bool</span> uniform(is_uniform(m_native_code.get(), function_description.<a class="code" href="group__mi__neuray__mdl__compiler.html#ga8f445c30b199c4f4e2698a9da94f1e71" title="The index of the generated function for accessing the callable function information of the link unit ...">function_index</a>));</div>
<div class="line">            <span class="keywordflow">if</span> (m_out_material.is_base_map_parm(p.m_name))</div>
<div class="line">            {</div>
<div class="line">                uniform = is_base_map_uniform;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_out_material.is_mask_map_parm(p.m_name))</div>
<div class="line">            {</div>
<div class="line">                uniform = is_mask_map_uniform;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (uniform)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// 1 pixel canvas</span></div>
<div class="line">                samples = 1;</div>
<div class="line">                resolution = 1;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Bake texture for expression</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> texture(m_out_material.get_texture_for_parameter(p.m_name, image_api, resolution));</div>
<div class="line">            <span class="keywordflow">if</span> (!texture)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            Expression_type expr_type(p.m_expr_type);</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> tex_width(texture-&gt;get_resolution_x());</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> tex_height(texture-&gt;get_resolution_y());</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> du((<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>)(1.0 / tex_width));</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> dv((<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>)(1.0 / tex_height));</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> num_fragments(tex_height);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> num_rows_per_frag(tex_height / (<span class="keywordtype">int</span>)num_fragments);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> num_frags_with_extra_row(tex_height - num_rows_per_frag * (<span class="keywordtype">int</span>)num_fragments);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> components_per_pixel(get_components_per_pixel(<a class="code" href="group__mi__base__iinterface.html#ga18f61a252409bb61d7b686868aebfef9" title="Returns a handle that holds the interface pointer passed in as argument. ">mi::base::make_handle</a>(texture-&gt;get_tile())-&gt;get_type()));</div>
<div class="line"></div>
<div class="line">            std::vector&lt;std::thread&gt; threads;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> index = 0; index &lt; num_fragments; index++)</div>
<div class="line">            {</div>
<div class="line">                threads.emplace_back(std::thread(</div>
<div class="line">                    bake_native_function</div>
<div class="line">                    , index</div>
<div class="line">                    , num_rows_per_frag</div>
<div class="line">                    , num_frags_with_extra_row</div>
<div class="line">                    , tex_width</div>
<div class="line">                    , texture.get()</div>
<div class="line">                    , samples</div>
<div class="line">                    , du</div>
<div class="line">                    , dv</div>
<div class="line">                    , m_native_code.get()</div>
<div class="line">                    , function_description</div>
<div class="line">                    , components_per_pixel</div>
<div class="line">                    , expr_type</div>
<div class="line">                    , metallic</div>
<div class="line">                ));</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; t : threads)</div>
<div class="line">            {</div>
<div class="line">                t.join();</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (param-&gt;remap_func)</div>
<div class="line">                param-&gt;remap_func(texture.get());</div>
<div class="line"></div>
<div class="line">            param-&gt;texture = texture;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">   </div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> get_components_per_pixel(<span class="keyword">const</span> std::string &amp; pixel_type)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> 3;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> 3;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;Color&quot;</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> 4;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> bake_cuda_ptx(</div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api</div>
<div class="line">        , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> &amp; baking_samples</div>
<div class="line">        , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> &amp; baking_resolution</div>
<div class="line">        , <span class="keyword">const</span> Parm_list &amp; plist</div>
<div class="line">    )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> bake_cuda_ptx_function = [](</div>
<div class="line">            <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* texture</div>
<div class="line">            , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> &amp; baking_samples</div>
<div class="line">            , <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> &amp; components_per_pixel</div>
<div class="line">            , CUdeviceptr &amp; device_outbuf</div>
<div class="line">            , CUdeviceptr &amp; device_tc_data_list</div>
<div class="line">            , CUdeviceptr &amp; device_arg_block_list</div>
<div class="line">            , CUfunction &amp; cuda_function</div>
<div class="line">            , <span class="keyword">const</span> <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a> &amp; function_description</div>
<div class="line">            , Expression_type expr_type</div>
<div class="line">            , <span class="keywordtype">float</span> metallic</div>
<div class="line">            )</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> res_x = texture-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#acd28f45b9d22b1cd1e24043aeda5c065" title="Returns the resolution of the canvas in x direction. ">get_resolution_x</a>();</div>
<div class="line">            <span class="keywordtype">int</span> res_y = texture-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#a51874ccdb54f6e03ff325b01d98dfefb" title="Returns the resolution of the canvas in y direction. ">get_resolution_y</a>();</div>
<div class="line">            <span class="keywordtype">int</span> num_samples = baking_samples;</div>
<div class="line">            <span class="keywordtype">size_t</span> function_index(function_description.function_index);</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cpp(components_per_pixel);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Launch kernel for the whole image</span></div>
<div class="line">            dim3 threads_per_block(16, 16);</div>
<div class="line">            dim3 num_blocks((res_x + 15) / 16, (res_y + 15) / 16);</div>
<div class="line">            <span class="keywordtype">void</span> *kernel_params[] = {</div>
<div class="line">                &amp;device_outbuf,</div>
<div class="line">                &amp;device_tc_data_list,</div>
<div class="line">                &amp;device_arg_block_list,</div>
<div class="line">                &amp;res_x,</div>
<div class="line">                &amp;res_y,</div>
<div class="line">                &amp;num_samples,</div>
<div class="line">                &amp;function_index,</div>
<div class="line">                &amp;cpp,</div>
<div class="line">                &amp;expr_type,</div>
<div class="line">                &amp;metallic</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            check_cuda_success(cuLaunchKernel(</div>
<div class="line">                cuda_function,</div>
<div class="line">                num_blocks.x, num_blocks.y, num_blocks.z,</div>
<div class="line">                threads_per_block.x, threads_per_block.y, threads_per_block.z,</div>
<div class="line">                0, <span class="keyword">nullptr</span>, kernel_params, <span class="keyword">nullptr</span>));</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile(texture-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">            <span class="keywordtype">float</span> *data = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span> *<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line">            check_cuda_success(cuMemcpyDtoH(</div>
<div class="line">                data, device_outbuf, res_x * res_y * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * components_per_pixel));</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        check_success(m_transaction.is_valid_interface());</div>
<div class="line">        <span class="keywordflow">if</span> (!m_gpu_code)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        CUcontext cuda_context = init_cuda(m_cuda_device);</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Build the full CUDA kernel with all the generated code</span></div>
<div class="line">            CUfunction  cuda_function;</div>
<div class="line">            <span class="keywordtype">char</span> <span class="keyword">const</span> *ptx_name = <span class="stringliteral">&quot;example_distilling_unity.ptx&quot;</span>;</div>
<div class="line"></div>
<div class="line">            std::vector &lt;mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;&gt; target_codes;</div>
<div class="line">            target_codes.emplace_back(m_gpu_code);</div>
<div class="line"></div>
<div class="line">            CUmodule    cuda_module = build_linked_kernel(</div>
<div class="line">                target_codes,</div>
<div class="line">                (mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + ptx_name).c_str(),</div>
<div class="line">                <span class="stringliteral">&quot;evaluate_mat_expr&quot;</span>,</div>
<div class="line">                &amp;cuda_function);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Prepare the needed data of all target codes for the GPU</span></div>
<div class="line">            std::vector&lt;size_t&gt; arg_block_indices;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; d : m_descs)</div>
<div class="line">            {</div>
<div class="line">                arg_block_indices.emplace_back(d.argument_block_index);</div>
<div class="line">            }</div>
<div class="line">            Material_gpu_context material_gpu_context(<span class="keyword">false</span><span class="comment">/*options.enable_derivatives*/</span>);</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0, num_target_codes = target_codes.size(); i &lt; num_target_codes; ++i)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (!material_gpu_context.prepare_target_code_data(</div>
<div class="line">                    m_transaction.get(), image_api, target_codes[i].get(), arg_block_indices))</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            CUdeviceptr device_tc_data_list = material_gpu_context.get_device_target_code_data_list();</div>
<div class="line">            CUdeviceptr device_arg_block_list =</div>
<div class="line">                material_gpu_context.get_device_target_argument_block_list();</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Allocate GPU output buffer</span></div>
<div class="line">            <span class="keywordtype">int</span> res_x = baking_resolution;</div>
<div class="line">            <span class="keywordtype">int</span> res_y = baking_resolution;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Create an output buffer large enough to contain data for all the possible expressions</span></div>
<div class="line">            CUdeviceptr device_outbuf;</div>
<div class="line">            check_cuda_success(cuMemAlloc(&amp;device_outbuf, res_x * res_y * <span class="keyword">sizeof</span>(float4)));</div>
<div class="line">          </div>
<div class="line">            <span class="keywordtype">float</span> metallic(-1); <span class="comment">// no need to set metallic unless bake_path is not set</span></div>
<div class="line">            {</div>
<div class="line">                Material_parameter * param = m_out_material.find_parameter(<span class="stringliteral">&quot;metallic&quot;</span>);</div>
<div class="line">                <span class="keywordflow">if</span> (param &amp;&amp; param-&gt;bake_path.empty())</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (param-&gt;value_type == <span class="stringliteral">&quot;Float32&quot;</span> &amp;&amp; param-&gt;value)</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32&gt;</a> value(param-&gt;value-&gt;get_interface&lt;<a class="code" href="classmi_1_1IFloat32.html" title="This interface represents mi::Float32. ">mi::IFloat32</a>&gt;());</div>
<div class="line">                        value-&gt;get_value(metallic);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Determine whether base map is uniform</span></div>
<div class="line">            std::set&lt;std::string&gt; base_map_parm = {<span class="stringliteral">&quot;base_color&quot;</span>, <span class="stringliteral">&quot;transparency&quot;</span> , <span class="stringliteral">&quot;opacity&quot;</span>};</div>
<div class="line">            <span class="keywordtype">bool</span> is_base_map_uniform(parms_are_uniform(base_map_parm, m_gpu_code.get()));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Determine whether Mask Map is uniform</span></div>
<div class="line">            std::set&lt;std::string&gt; mask_map_parm = {<span class="stringliteral">&quot;metallic&quot;</span>, <span class="stringliteral">&quot;roughness&quot;</span>};</div>
<div class="line">            <span class="keywordtype">bool</span> is_mask_map_uniform(parms_are_uniform(mask_map_parm, m_gpu_code.get()));</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span>(<span class="keyword">auto</span> &amp; p : plist)</div>
<div class="line">            {</div>
<div class="line">                Material_parameter * param = m_out_material.find_parameter(p.m_name);</div>
<div class="line">                <span class="keywordflow">if</span> (!param)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">                <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a> function_description;</div>
<div class="line">                <span class="keywordflow">if</span> (!m_descs.get_function_description(param-&gt;bake_path, function_description))</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Did not find function description</span></div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> samples(baking_samples);</div>
<div class="line">                <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> resolution(baking_resolution);</div>
<div class="line">                <span class="comment">// Determine if need to bake texture or constant</span></div>
<div class="line">                <span class="keywordtype">bool</span> uniform(is_uniform(m_gpu_code.get(), function_description.<a class="code" href="group__mi__neuray__mdl__compiler.html#ga8f445c30b199c4f4e2698a9da94f1e71" title="The index of the generated function for accessing the callable function information of the link unit ...">function_index</a>));</div>
<div class="line">                <span class="keywordflow">if</span> (m_out_material.is_base_map_parm(p.m_name))</div>
<div class="line">                {</div>
<div class="line">                    uniform = is_base_map_uniform;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_out_material.is_mask_map_parm(p.m_name))</div>
<div class="line">                {</div>
<div class="line">                    uniform = is_mask_map_uniform;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (uniform)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// 1 pixel canvas</span></div>
<div class="line">                    samples = 1;</div>
<div class="line">                    resolution = 1;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Bake texture for expression</span></div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> texture(m_out_material.get_texture_for_parameter(p.m_name, image_api, resolution));</div>
<div class="line">                <span class="keywordflow">if</span> (!texture)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">                Expression_type expr_type(p.m_expr_type);</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> components_per_pixel(get_components_per_pixel(<a class="code" href="group__mi__base__iinterface.html#ga18f61a252409bb61d7b686868aebfef9" title="Returns a handle that holds the interface pointer passed in as argument. ">mi::base::make_handle</a>(texture-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>())-&gt;get_type()));</div>
<div class="line">                check_success(components_per_pixel &gt; 0 &amp;&amp; components_per_pixel &lt;= 4);</div>
<div class="line"></div>
<div class="line">                bake_cuda_ptx_function(</div>
<div class="line">                    texture.get()</div>
<div class="line">                    , baking_samples</div>
<div class="line">                    , components_per_pixel</div>
<div class="line">                    , device_outbuf</div>
<div class="line">                    , device_tc_data_list</div>
<div class="line">                    , device_arg_block_list</div>
<div class="line">                    , cuda_function</div>
<div class="line">                    , function_description</div>
<div class="line">                    , expr_type</div>
<div class="line">                    , metallic</div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (param-&gt;remap_func)</div>
<div class="line">                    param-&gt;remap_func(texture.get());</div>
<div class="line"></div>
<div class="line">                param-&gt;texture = texture;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Cleanup resources not handled by Material_gpu_context</span></div>
<div class="line">            check_cuda_success(cuMemFree(device_outbuf));</div>
<div class="line">            check_cuda_success(cuModuleUnload(cuda_module));</div>
<div class="line">        }</div>
<div class="line">    </div>
<div class="line">        uninit_cuda(cuda_context);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> init_baker_resource(<a class="code" href="group__mi__neuray__mdl__misc.html#ga89a2ac433f88dff3f1a280612cdf1086" title="Identifies the resource(s) to be used by a baker. ">mi::neuraylib::Baker_resource</a> baker_resource)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">switch</span> (baker_resource)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086af15d69862ab55cad12d75dc4974faab8" title="Use only the GPU for texture baking. ">mi::neuraylib::BAKE_ON_GPU</a>:</div>
<div class="line">            m_bake_gpu = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086a145f36f183764f4e8ac8a83c3f9f8022" title="Use only the CPU for texture baking. ">mi::neuraylib::BAKE_ON_CPU</a>:</div>
<div class="line">            m_bake_cpu = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086a5fbec67c9f064e81aa346eb35a90757e" title="Prefer using the GPU for texture baking, use the CPU as fallback. ">mi::neuraylib::BAKE_ON_GPU_WITH_CPU_FALLBACK</a>:</div>
<div class="line">            m_bake_gpu = <span class="keyword">true</span>;</div>
<div class="line">            m_bake_cpu = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> init_function_descriptions()</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Build function description list</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; m : m_out_material)</div>
<div class="line">        {</div>
<div class="line">            Material_parameter&amp; param = m.second;</div>
<div class="line">            m_descs.add_function(m.first, param.bake_path);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a>* build_baker_programs_for_backend_kind(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* material</div>
<div class="line">        , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend.html" title="MDL backends allow to transform compiled material instances or function calls into target code...">mi::neuraylib::IMdl_backend</a> * backend</div>
<div class="line">    )</div>
<div class="line">    {</div>
<div class="line">        check_success(m_transaction.is_valid_interface());</div>
<div class="line">        check_success(m_context.is_valid_interface());</div>
<div class="line">        <span class="comment">// Link unit</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// Create a link unit</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ILink_unit&gt;</a> link_unit(backend-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga2a47cff09fe1b7ac157f32b168fa93d2" title="Creates a new link unit. ">create_link_unit</a>(m_transaction.get(), m_context.get()));</div>
<div class="line">        check_success(link_unit.is_valid_interface());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Add all expressions to the link unit</span></div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = link_unit-&gt;add_material(material, m_descs.data(), m_descs.size(), m_context.get());</div>
<div class="line">        check_success(0 == result);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Use backend to translate link unit to target code</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// Translate link unit</span></div>
<div class="line">        <span class="keywordflow">return</span> backend-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#gab2db03209c55985f122e47977364d8cf" title="Transforms a link unit to target code. ">translate_link_unit</a>(link_unit.get(), m_context.get());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> build_baker_programs(<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* material)</div>
<div class="line">    {</div>
<div class="line">        check_success(m_mdl_backend_api.is_valid_interface());</div>
<div class="line">        <span class="keywordflow">if</span> (m_bake_cpu)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Get a backend</span></div>
<div class="line">            <span class="comment">//</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend&gt;</a> backend(m_mdl_backend_api-&gt;get_backend(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a28a914c7c51dd45974b16fa189a77b46a353b866fa7aac285667aded4b8dba94b" title="Generate native code. ">mi::neuraylib::IMdl_backend_api::MB_NATIVE</a>));</div>
<div class="line">            check_success(backend.is_valid_interface());</div>
<div class="line"></div>
<div class="line">            m_native_code = build_baker_programs_for_backend_kind(material, backend.get());</div>
<div class="line">            check_success(m_native_code.<a class="code" href="classmi_1_1base_1_1Handle.html#a38bb173f0dba8b83ac6fcf8f08cda05b" title="Returns true if the interface is valid. ">is_valid_interface</a>());        </div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (m_bake_gpu)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend&gt;</a> backend(m_mdl_backend_api-&gt;get_backend(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a28a914c7c51dd45974b16fa189a77b46a9050e3f647dae4f4b39e207399ebf322" title="Generate CUDA PTX code. ">mi::neuraylib::IMdl_backend_api::MB_CUDA_PTX</a>));</div>
<div class="line">            check_success(backend.is_valid_interface());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Set backend options</span></div>
<div class="line">            check_success(backend-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga1301dec05ba862ca7745814367811f15" title="Sets a backend option. ">set_option</a>(<span class="stringliteral">&quot;num_texture_spaces&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>) == 0);</div>
<div class="line">            check_success(backend-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga1301dec05ba862ca7745814367811f15" title="Sets a backend option. ">set_option</a>(<span class="stringliteral">&quot;tex_lookup_call_mode&quot;</span>, <span class="stringliteral">&quot;direct_call&quot;</span>) == 0);</div>
<div class="line">            check_success(backend-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga1301dec05ba862ca7745814367811f15" title="Sets a backend option. ">set_option</a>(<span class="stringliteral">&quot;enable_ro_segment&quot;</span>, <span class="stringliteral">&quot;off&quot;</span>) == 0);</div>
<div class="line">            check_success(backend-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga1301dec05ba862ca7745814367811f15" title="Sets a backend option. ">set_option</a>(<span class="stringliteral">&quot;fast_math&quot;</span>, <span class="stringliteral">&quot;off&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line">            m_gpu_code = build_baker_programs_for_backend_kind(material, backend.get());</div>
<div class="line">            check_success(m_gpu_code.<a class="code" href="classmi_1_1base_1_1Handle.html#a38bb173f0dba8b83ac6fcf8f08cda05b" title="Returns true if the interface is valid. ">is_valid_interface</a>());</div>
<div class="line"></div>
<div class="line">            <span class="comment">//std::cout &lt;&lt; &quot;Dumping CUDA PTX code:\n\n&quot; &lt;&lt; m_gpu_code-&gt;get_code() &lt;&lt; std::endl;</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> is_uniform(<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a> * code, <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> &amp; function_index)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        mi::neuraylib::ITarget_code::State_usage render_state_usage =</div>
<div class="line">            code-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#gac6a4de58d38e90b5b8a483e73fbe32c2" title="Returns the potential render state usage of callable function in the target code. ...">get_callable_function_render_state_usage</a>(function_index);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// everything but state::texture_coordinate() and state::position() is constant for baking</span></div>
<div class="line">        <span class="keywordflow">return</span> ((render_state_usage &amp;</div>
<div class="line">            (<a class="code" href="group__mi__neuray__mdl__compiler.html#gga1b7292a23785a582f0beac3c33b9b91ca6b693d1371ffbad0514691cd6b62d729" title="uses state::texture_coordinate() ">mi::neuraylib::ITarget_code::SU_TEXTURE_COORDINATE</a> |</div>
<div class="line">                <a class="code" href="group__mi__neuray__mdl__compiler.html#gga1b7292a23785a582f0beac3c33b9b91ca884b4e7c9971814e63834180d47702c0" title="uses state::position() ">mi::neuraylib::ITarget_code::SU_POSITION</a>)) == 0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> parms_are_uniform(<span class="keyword">const</span> std::set&lt;std::string&gt; parms, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a>* code)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pname : parms)</div>
<div class="line">        {</div>
<div class="line">            Material_parameter* param = m_out_material.find_parameter(pname);</div>
<div class="line">            <span class="keywordflow">if</span> (!param)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a> function_description;</div>
<div class="line">            <span class="keywordflow">if</span> (!m_descs.get_function_description(param-&gt;bake_path, function_description))</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Did not find function description</span></div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (!is_uniform(code, function_description.<a class="code" href="group__mi__neuray__mdl__compiler.html#ga8f445c30b199c4f4e2698a9da94f1e71" title="The index of the generated function for accessing the callable function information of the link unit ...">function_index</a>))</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Return as soon as one of the parms is not uniform</span></div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> bake_target_material_inputs(</div>
<div class="line">    <a class="code" href="group__mi__neuray__mdl__misc.html#ga89a2ac433f88dff3f1a280612cdf1086" title="Identifies the resource(s) to be used by a baker. ">mi::neuraylib::Baker_resource</a> baker_resource</div>
<div class="line">    , <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> baking_samples</div>
<div class="line">    , <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> baking_resolution</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction</div>
<div class="line">    , <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* material</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api</div>
<div class="line">    , Material&amp; out_material</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a> * context</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>* mdl_backend_api</div>
<div class="line">    , <span class="keywordtype">bool</span> parallel</div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">    Baker baker(baker_resource, transaction, material, out_material, context, mdl_backend_api);</div>
<div class="line">    check_success(baker.bake(image_api, baking_samples, baking_resolution, parallel));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Helper class to export canvases either sequentially or in parallel threads</span></div>
<div class="line"><span class="keyword">class </span>Canvas_exporter</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> m_in_parallel = <span class="keyword">true</span>;</div>
<div class="line">    std::map&lt;std::string<span class="comment">/*filename*/</span>, <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a>&gt; m_canvases;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Canvas_exporter(<span class="keywordtype">bool</span> parallel)</div>
<div class="line">        : m_in_parallel(parallel)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">void</span> add_canvas(<span class="keyword">const</span> std::string&amp; filename, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas)</div>
<div class="line">    {</div>
<div class="line">        m_canvases[filename] = <a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">mi::base::make_handle_dup</a>(canvas);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> do_export(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a> * mdl_impexp_api)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> export_canvas = [mdl_impexp_api](<span class="keyword">const</span> <span class="keywordtype">char</span>* filename, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas)</div>
<div class="line">        {</div>
<div class="line">            check_success(mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a1b544c77874b97eae0003c39e27e2103" title="Exports a canvas to a file on disk. ">export_canvas</a>(filename, canvas) == 0);</div>
<div class="line">        };</div>
<div class="line">        std::vector&lt;std::thread&gt; threads;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; canvas_file : m_canvases)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> * filename(canvas_file.first.c_str());</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas(canvas_file.second.get());</div>
<div class="line">            <span class="keywordflow">if</span> (m_in_parallel)</div>
<div class="line">            {</div>
<div class="line">                threads.emplace_back(</div>
<div class="line">                    std::thread(export_canvas, filename, canvas)</div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                export_canvas(filename, canvas);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; t : threads)</div>
<div class="line">        {</div>
<div class="line">            t.join();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Print some information about baked material parameters to the console and</span></div>
<div class="line"><span class="comment">// save the baked textures to disk</span></div>
<div class="line"><span class="keywordtype">void</span> process_target_material(</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; target_model,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; material_name,</div>
<div class="line">    <span class="keyword">const</span> Material&amp; material,</div>
<div class="line">    <span class="keywordtype">bool</span> save_baked_textures,</div>
<div class="line">    <span class="keywordtype">bool</span> parallel,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>* impexp_api)</div>
<div class="line">{</div>
<div class="line">    the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, std::string(<span class="stringliteral">&quot;Material model: &quot;</span> + target_model));</div>
<div class="line"></div>
<div class="line">    Canvas_exporter canvas_exporter(parallel);</div>
<div class="line">    <span class="keywordflow">for</span>(Material::const_iterator it = material.begin();</div>
<div class="line">        it != material.end(); ++it)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; param_name = it-&gt;first;</div>
<div class="line">        <span class="keyword">const</span> Material_parameter&amp; param = it-&gt;second;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> mask_map(<span class="keyword">false</span>);</div>
<div class="line">        <span class="keywordtype">bool</span> base_map(<span class="keyword">false</span>);</div>
<div class="line">        <span class="comment">// Do not save redundant textures</span></div>
<div class="line">        <span class="keywordflow">if</span> (param_name == <span class="stringliteral">&quot;transparency&quot;</span> &amp;&amp; material.has_base_color_map())</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// We skip transparency if a Base Map exists since the Base Map contains transparency value</span></div>
<div class="line">            the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, <span class="stringliteral">&quot;Skip transparency stored in Base Map&quot;</span>);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (param_name == <span class="stringliteral">&quot;opacity&quot;</span> &amp;&amp; material.has_base_color_map())</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// We skip opacity if a Base Map exists since the Base Map contains opacity value combined with transparency</span></div>
<div class="line">            the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, <span class="stringliteral">&quot;Skip opacity stored in Base Map&quot;</span>);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (param_name == <span class="stringliteral">&quot;roughness&quot;</span> &amp;&amp; material.has_mask_map())</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// We skip roughness if a Mask Map exists since the Mask Map contains roughness value</span></div>
<div class="line">            the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, <span class="stringliteral">&quot;Skip roughness stored in Mask Map&quot;</span>);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (param_name == <span class="stringliteral">&quot;metallic&quot;</span> &amp;&amp; material.has_mask_map())</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Here is the Mask Map</span></div>
<div class="line">            mask_map = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param_name == <span class="stringliteral">&quot;base_color&quot;</span> &amp;&amp; material.has_base_color_map())</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Here is the Base Map</span></div>
<div class="line">            base_map = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::stringstream log_message;</div>
<div class="line">        <span class="keywordflow">if</span>(param.texture)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">bool</span> skip_uniform(<span class="keyword">false</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (param.texture-&gt;get_resolution_x() == 1 &amp;&amp; param.texture-&gt;get_resolution_y() == 1)</div>
<div class="line">            {</div>
<div class="line">                skip_uniform = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">if</span> (mask_map)</div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; <span class="stringliteral">&quot;Mask Map (metallic, ao, detail, smoothness) constant &quot;</span>;</div>
<div class="line">                    skip_uniform = <span class="keyword">false</span>; <span class="comment">// Do save the Mask Map</span></div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (base_map)</div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; <span class="stringliteral">&quot;Base Map (base_color, opacity) constant &quot;</span>;</div>
<div class="line">                    skip_uniform = <span class="keyword">false</span>; <span class="comment">// Do save the Base Map</span></div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; param_name &lt;&lt; <span class="stringliteral">&quot; baked to constant &quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_4</a> pixel_data;</div>
<div class="line">                param.texture-&gt;get_tile()-&gt;get_pixel(0, 0, (<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*)&amp;pixel_data.x);</div>
<div class="line">                std::string type(param.texture-&gt;get_type());</div>
<div class="line">                <span class="keywordflow">if</span> (type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; <span class="stringliteral">&quot;color: (&quot;</span></div>
<div class="line">                        &lt;&lt; pixel_data[0] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[1] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[2] &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; <span class="stringliteral">&quot;float: &quot;</span> &lt;&lt; pixel_data[0];</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; <span class="stringliteral">&quot;vector: (&quot;</span></div>
<div class="line">                        &lt;&lt; pixel_data[0] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[1] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[2] &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">&quot;Color&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    log_message &lt;&lt; <span class="stringliteral">&quot;color: (&quot;</span></div>
<div class="line">                        &lt;&lt; pixel_data[0] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[1] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[2] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; pixel_data[3] &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line">                    <span class="keywordflow">if</span> (base_map)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span> (pixel_data[0] &gt;= 0 &amp;&amp; pixel_data[0] &lt;= 1 &amp;&amp;</div>
<div class="line">                            pixel_data[1] &gt;= 0 &amp;&amp; pixel_data[1] &lt;= 1 &amp;&amp;</div>
<div class="line">                            pixel_data[2] &gt;= 0 &amp;&amp; pixel_data[2] &lt;= 1)</div>
<div class="line">                        {</div>
<div class="line">                            log_message &lt;&lt; <span class="stringliteral">&quot; (hexadecimal color: &quot;</span></div>
<div class="line">                                &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; int(pixel_data[0] * 255)</div>
<div class="line">                                &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; int(pixel_data[1] * 255)</div>
<div class="line">                                &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; int(pixel_data[2] * 255) &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28daac0321ddd7ad84942e8dd43e5a3383bc" title="A warning has occurred. ">mi::base::MESSAGE_SEVERITY_WARNING</a>, std::string(<span class="stringliteral">&quot;Unsupported data type&quot;</span>));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (!log_message.str().empty())</div>
<div class="line">                {</div>
<div class="line">                    the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, log_message.str());</div>
<div class="line">                }</div>
<div class="line">                log_message = std::stringstream();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (save_baked_textures &amp;&amp; !skip_uniform)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// write texture to disc</span></div>
<div class="line">                std::stringstream file_name;</div>
<div class="line">                <span class="keywordflow">if</span> (mask_map)</div>
<div class="line">                {</div>
<div class="line">                    file_name &lt;&lt; material_name &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; <span class="stringliteral">&quot;mask_map&quot;</span> &lt;&lt; <span class="stringliteral">&quot;.png&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (base_map)</div>
<div class="line">                {</div>
<div class="line">                    file_name &lt;&lt; material_name &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; <span class="stringliteral">&quot;base_map&quot;</span> &lt;&lt; <span class="stringliteral">&quot;.png&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    file_name &lt;&lt; material_name &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; param_name &lt;&lt; <span class="stringliteral">&quot;.png&quot;</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                log_message &lt;&lt; param_name &lt;&lt; <span class="stringliteral">&quot; baked to texture : &quot;</span> &lt;&lt; file_name.str();</div>
<div class="line"></div>
<div class="line">                canvas_exporter.add_canvas(file_name.str(), param.texture.get());</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (!log_message.str().empty())</div>
<div class="line">        {</div>
<div class="line">            the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, log_message.str());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Export canvases</span></div>
<div class="line">    canvas_exporter.do_export(impexp_api);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Prints program usage</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    std::cout</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;usage: &quot;</span> &lt;&lt; name &lt;&lt; <span class="stringliteral">&quot; [options] [&lt;material_name1&gt; ...]\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;-h                      print this text\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--verbosity             verbosity level (0: no messages, 1: fatal, 2: error, 3: warning, 4: info, 5: verbose, 6: debug)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--baker_resource        baking device: gpu|cpu|gpu_with_cpu_fallback (default: cpu)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--samples               baking samples (default: 4, max: 16)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--resolution            baking resolution (default: 1024)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--material_file &lt;file&gt;  file containing fully qualified names of materials to distill\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--do_not_save_textures  if set, avoid saving baked textures to file\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--module &lt;module_name&gt;  distill all materials from the module, can occur multiple times\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--no_parallel           do not save texture files in parallel threads\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--mdl_path &lt;path&gt;       mdl search path, can occur multiple times.\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    exit(EXIT_FAILURE);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> load_materials_from_file(<span class="keyword">const</span> std::string &amp; material_file, std::vector&lt;std::string&gt; &amp; material_names)</div>
<div class="line">{</div>
<div class="line">    std::fstream file;</div>
<div class="line">    file.open(material_file, std::fstream::in);</div>
<div class="line">    <span class="keywordflow">if</span> (!file)</div>
<div class="line">    {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid file: &quot;</span> + material_file;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    std::string fn;</div>
<div class="line">    <span class="keywordflow">while</span> (getline(file, fn))</div>
<div class="line">    {</div>
<div class="line">        material_names.emplace_back(fn);</div>
<div class="line">    }</div>
<div class="line">    file.close();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> load_materials_from_modules(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a> * mdl_factory</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a> * transaction</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a> * mdl_impexp_api</div>
<div class="line">    , <span class="keyword">const</span> std::vector&lt;std::string&gt; &amp; module_names</div>
<div class="line">    , std::vector&lt;std::string&gt; &amp; material_names)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> context(mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a78a9a6489592c90ea49e0fe0ac8be235" title="Creates an execution context. ">create_execution_context</a>());</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> module_name : module_names)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Sanity check</span></div>
<div class="line">        <span class="keywordflow">if</span> (module_name.find(<span class="stringliteral">&quot;::&quot;</span>) != 0)</div>
<div class="line">        {</div>
<div class="line">            module_name = std::string(<span class="stringliteral">&quot;::&quot;</span>) + module_name;</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> rtn(mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a5e195d80915190eb40c5995ccfeaa4c9" title="Loads an MDL module from disk (or a builtin module) into the database. ">load_module</a>(transaction, module_name.c_str(), context.get()));</div>
<div class="line">        check_success(rtn == 0 || rtn == 1);</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::IString&gt;</a> db_module_name(</div>
<div class="line">            mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a72a27c9e0d66e79391ff9a8e3ce4a119" title="Returns the DB name for the MDL name of a module (or file path for MDLE modules). ...">get_db_module_name</a>(module_name.c_str()));</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IModule&gt;</a> module(</div>
<div class="line">            transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IModule.html" title="This interface represents an MDL module. ">mi::neuraylib::IModule</a>&gt;(db_module_name-&gt;get_c_str()));</div>
<div class="line">        check_success(module.is_valid_interface());</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> material_count = module-&gt;get_material_count();</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; material_count; i++)</div>
<div class="line">        {</div>
<div class="line">            std::string mname(module-&gt;get_material(i));</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IFunction_definition&gt;</a> material(</div>
<div class="line">                transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html" title="This interface represents a function definition. ">mi::neuraylib::IFunction_definition</a>&gt;(mname.c_str()));</div>
<div class="line">            material_names.push_back(std::string(material-&gt;get_mdl_module_name()) + <span class="stringliteral">&quot;::&quot;</span> + std::string(material-&gt;get_mdl_simple_name()));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> MAIN_UTF8(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    std::string                     target_model = <span class="stringliteral">&quot;transmissive_pbr&quot;</span>;</div>
<div class="line">    <a class="code" href="group__mi__neuray__mdl__misc.html#ga89a2ac433f88dff3f1a280612cdf1086" title="Identifies the resource(s) to be used by a baker. ">mi::neuraylib::Baker_resource</a>   baker_resource = <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086a145f36f183764f4e8ac8a83c3f9f8022" title="Use only the CPU for texture baking. ">mi::neuraylib::BAKE_ON_CPU</a>;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>                      baking_samples = 4;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>                      baking_resolution = 1024;</div>
<div class="line">    <span class="keywordtype">bool</span>                            parallel = <span class="keyword">true</span>;</div>
<div class="line">    std::vector&lt;std::string&gt;        material_names;</div>
<div class="line">    std::vector&lt;std::string&gt;        module_names;</div>
<div class="line">    std::string material_file;</div>
<div class="line">    <span class="keywordtype">bool</span> save_baked_textures(<span class="keyword">true</span>);</div>
<div class="line">    <span class="keywordtype">int</span> verbosity_level(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>);</div>
<div class="line">    the_logger = <span class="keyword">new</span> Logger(verbosity_level);</div>
<div class="line"></div>
<div class="line">    mi::examples::mdl::Configure_options configure_options;</div>
<div class="line">    configure_options.add_admin_space_search_paths = <span class="keyword">false</span>;</div>
<div class="line">    configure_options.add_user_space_search_paths = <span class="keyword">false</span>;</div>
<div class="line">    configure_options.add_example_search_path = <span class="keyword">false</span>;</div>
<div class="line">    configure_options.logger = the_logger.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Collect command line arguments, if any</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; argc; ++i) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *opt = argv[i];</div>
<div class="line">        <span class="keywordflow">if</span> (opt[0] == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">            <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--mdl_path&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    configure_options.additional_mdl_paths.push_back(argv[++i]);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--baker_resource&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1) {</div>
<div class="line">                    std::string res = argv[++i];</div>
<div class="line">                    <span class="keywordflow">if</span> (res == <span class="stringliteral">&quot;gpu&quot;</span>)</div>
<div class="line">                        baker_resource = <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086af15d69862ab55cad12d75dc4974faab8" title="Use only the GPU for texture baking. ">mi::neuraylib::BAKE_ON_GPU</a>;</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <span class="stringliteral">&quot;gpu_with_cpu_fallback&quot;</span>)</div>
<div class="line">                        baker_resource = <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086a5fbec67c9f064e81aa346eb35a90757e" title="Prefer using the GPU for texture baking, use the CPU as fallback. ">mi::neuraylib::BAKE_ON_GPU_WITH_CPU_FALLBACK</a>;</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res != <span class="stringliteral">&quot;cpu&quot;</span>)</div>
<div class="line">                        usage(argv[0]);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--samples&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> val(atoi(argv[++i]));</div>
<div class="line">                    <span class="keywordflow">if</span> (val &gt; 0 &amp;&amp; val &lt;= 16)</div>
<div class="line">                        baking_samples = val;</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid number of samples ignored\n&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--resolution&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> val(atoi(argv[++i]));</div>
<div class="line">                    <span class="keywordflow">if</span> (val &gt; 0)</div>
<div class="line">                        baking_resolution = val;</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid resolution ignored\n&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--verbosity&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> val(atoi(argv[++i]));</div>
<div class="line">                    <span class="keywordflow">if</span> (val &gt;= 0 &amp;&amp; val &lt;= 6)</div>
<div class="line">                        verbosity_level = val;</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid verbosity ignored\n&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--material_file&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    material_file = argv[++i];</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--do_not_save_textures&quot;</span>) == 0) {</div>
<div class="line">                save_baked_textures = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--no_parallel&quot;</span>) == 0) {</div>
<div class="line">                parallel = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--module&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    module_names.emplace_back(argv[++i]);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                usage(argv[0]);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            material_names.push_back(opt);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Update verbosity level after processing command line arguments</span></div>
<div class="line">    the_logger-&gt;set_verbosity_level(verbosity_level);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (configure_options.additional_mdl_paths.empty())</div>
<div class="line">        configure_options.add_example_search_path = <span class="keyword">true</span>;</div>
<div class="line">    if (!material_file.empty())</div>
<div class="line">        load_materials_from_file(material_file, material_names);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Access the MDL SDK</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::INeuray&gt;</a> neuray(mi::examples::mdl::load_and_get_ineuray());</div>
<div class="line">    <span class="keywordflow">if</span> (!neuray.is_valid_interface())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::configure(neuray.get(), configure_options))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load the distilling plugin</span></div>
<div class="line">    <span class="keywordflow">if</span> (mi::examples::mdl::load_plugin(neuray.get(), <span class="stringliteral">&quot;mdl_distiller&quot;</span> <a class="code" href="group__mi__base__config.html#gad7232312ea690f7c9fd39ee34794d073" title="The operating system specific default filename extension for shared libraries (DLLs) ...">MI_BASE_DLL_FILE_EXT</a>) != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the mdl_distiller plugin.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Start the MDL SDK</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> ret = neuray-&gt;start();</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK. Result code: %d&quot;</span>, ret);</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        Timing timing(<span class="stringliteral">&quot;Total elapsed&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get MDL Import/Export API</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_impexp_api&gt;</a> mdl_impexp_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get MDL backend API</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend_api&gt;</a> mdl_backend_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get MDL factory</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::IMdl_factory&gt;</a> mdl_factory(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Create a transaction</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IDatabase&gt;</a> database(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IDatabase.html" title="This interface is used to interact with the distributed database. ">mi::neuraylib::IDatabase</a>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IScope&gt;</a> scope(database-&gt;get_global_scope());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::ITransaction&gt;</a> transaction(scope-&gt;create_transaction());</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!module_names.empty())</div>
<div class="line">        {</div>
<div class="line">            load_materials_from_modules(mdl_factory.get(), transaction.get(), mdl_impexp_api.get(), module_names, material_names);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (material_names.empty())</div>
<div class="line">        {</div>
<div class="line">            material_names.push_back(</div>
<div class="line">                <span class="stringliteral">&quot;::nvidia::sdk_examples::tutorials_distilling::example_distilling1&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordtype">size_t</span> n_materials_done(0);</div>
<div class="line">        <span class="keywordtype">size_t</span> n_materials_todo(material_names.size());</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; m : material_names)</div>
<div class="line">        {</div>
<div class="line">            Timing timing(<span class="stringliteral">&quot;Elapsed&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// split module and material name</span></div>
<div class="line">            std::string module_qualified_name, material_simple_name;</div>
<div class="line">            <span class="keywordflow">if</span> (!mi::examples::mdl::parse_cmd_argument_material_name(</div>
<div class="line">                m, module_qualified_name, material_simple_name, <span class="keyword">true</span>))</div>
<div class="line">                exit_failure();</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Create an execution context</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> context(</div>
<div class="line">                mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a78a9a6489592c90ea49e0fe0ac8be235" title="Creates an execution context. ">create_execution_context</a>());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Load mdl module and create a material instance</span></div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IFunction_call&gt;</a> instance(</div>
<div class="line">                create_material_instance(</div>
<div class="line">                    mdl_factory.get(),</div>
<div class="line">                    transaction.get(),</div>
<div class="line">                    mdl_impexp_api.get(),</div>
<div class="line">                    context.get(),</div>
<div class="line">                    module_qualified_name,</div>
<div class="line">                    material_simple_name));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Compile the material instance</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> compiled_material(</div>
<div class="line">                compile_material_instance(instance.get(), context.get(), <span class="keyword">false</span>));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Acquire distilling api used for material distilling and baking</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_distiller_api&gt;</a> distilling_api(</div>
<div class="line">                neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Distill compiled material to diffuse/glossy material model</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> distilled_material(</div>
<div class="line">                create_distilled_material(</div>
<div class="line">                    distilling_api.get(),</div>
<div class="line">                    compiled_material.get(),</div>
<div class="line">                    target_model.c_str()));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Acquire image api needed to create a canvas for baking</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api(</div>
<div class="line">                neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">            Material out_material;</div>
<div class="line">            <span class="comment">// Setup result material parameters and collect bake paths</span></div>
<div class="line">            setup_target_material(</div>
<div class="line">                transaction.get(),</div>
<div class="line">                distilled_material.get(),</div>
<div class="line">                out_material);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Bake material inputs</span></div>
<div class="line">            bake_target_material_inputs(</div>
<div class="line">                baker_resource,</div>
<div class="line">                baking_samples,</div>
<div class="line">                baking_resolution,</div>
<div class="line">                transaction.get(),</div>
<div class="line">                distilled_material.get(),</div>
<div class="line">                image_api.get(),</div>
<div class="line">                out_material,</div>
<div class="line">                context.get(),</div>
<div class="line">                mdl_backend_api.get(),</div>
<div class="line">                parallel);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Process resulting material, in this case we simply</span></div>
<div class="line">            <span class="comment">// print some information about the baked parameters</span></div>
<div class="line">            <span class="comment">// and save the textures to disk, if any</span></div>
<div class="line">            process_target_material(</div>
<div class="line">                target_model,</div>
<div class="line">                material_simple_name,</div>
<div class="line">                out_material,</div>
<div class="line">                save_baked_textures,</div>
<div class="line">                parallel,</div>
<div class="line">                mdl_impexp_api.get());</div>
<div class="line"></div>
<div class="line">            the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, std::string(<span class="stringliteral">&quot;Distilled material: &quot;</span>) + material_simple_name);</div>
<div class="line"></div>
<div class="line">            n_materials_done++;</div>
<div class="line"></div>
<div class="line">            std::stringstream strStream;</div>
<div class="line">            strStream &lt;&lt; <span class="stringliteral">&quot;Progress: &quot;</span> &lt;&lt; (float(n_materials_done) / n_materials_todo) * 100 &lt;&lt; <span class="stringliteral">&quot; % (&quot;</span> &lt;&lt; n_materials_done &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; n_materials_todo &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line">            the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, strStream.str());</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, std::string(<span class="stringliteral">&quot;Transaction commit&quot;</span>));</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#aa4ff8152107db238986b364273bceb0c" title="Commits the transaction. ">commit</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Shut down the MDL SDK</span></div>
<div class="line">    the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, std::string(<span class="stringliteral">&quot;Shuting down the SDK&quot;</span>));</div>
<div class="line">    <span class="keywordflow">if</span> (neuray-&gt;shutdown() != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to shutdown the SDK.&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Unload the MDL SDK</span></div>
<div class="line">    the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, std::string(<span class="stringliteral">&quot;Unloading the SDK&quot;</span>));</div>
<div class="line">    neuray = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::unload())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to unload the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    the_logger-&gt;log(<a class="code" href="group__mi__base__ilogger.html#gga35cadb98d3212ad7941f401da374f28dad5c53d19cf1b9d1dbb963d00c66dda7f" title="This is a more verbose message. ">mi::base::MESSAGE_SEVERITY_VERBOSE</a>, std::string(<span class="stringliteral">&quot;Exiting&quot;</span>));</div>
<div class="line">    exit_success();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert command line arguments to UTF8 on Windows</span></div>
<div class="line">COMMANDLINE_TO_UTF8</div>
</div><!-- fragment --><div align="right"> [<a class="el" href="mi_neuray_example_distilling.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_distilling_glsl.html">Next</a>] </div> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path">
<span class="footeritem">5&#160;April&#160;2022,&#160;20:40, rev.358266</span>
<span class="footeritem"><a href="https://www.nvidia.com/en-us/about-nvidia/legal-info/" target="_blank" shape="rect">&copy; 2022 NVIDIA&nbsp;Corporation.</a> All rights reserved.</span>
</div>
</body>
</html>
