<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Example for Inlining MDL Code into Shaders (OptiX 7)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="images/arcicon.ico" rel="shortcut icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_custom_stylesheet_1_8_4.css" rel="stylesheet" type="text/css"/>
<link rel='stylesheet' href='webfonts/librebaskerville/stylesheet.css' type='text/css'/>
<link rel='stylesheet' href='webfonts/sourcesanspro/stylesheet.css' type='text/css'/>
<!--ARC-->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="blackheader">
<span id="blackheader_title">MDL SDK API</span>
<span>
<img src="images/nvidia_logo_transpbg.gif" alt="nvidia_logo_transpbg.gif" style=" height:1.25em; width:6.806em;"/></span>
<span id="blackheader_uplink">
<a href='../index.html' class='top_page_nav'>Up</a>
</span>
</div>
<!--
<div id="titlearea">
   <span id="projectname">
     <a id="titlelink" href="../../index.html">
       MDL SDK API
     </a>
   </span>
     <a id="projectlogo" href="http://www.nvidia-arc.com">
       <img alt="NVIDIA logo" src="images/nvidia_logo.png" style="height:2em;">
       </a>
     <a href='../index.html' class='top_page_nav'>Up</a>
</div>
-->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mi_neuray_example_optix7.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example for Inlining MDL Code into Shaders (OptiX 7) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div align="right"> [<a class="el" href="mi_neuray_example_dxr.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] </div><p>This example shows how to inline the generated MDL code into the closest hit shader of an OptiX 7 example. This makes it possible to get rid of most MDL state related memory reads and writes, leading to much better performance at the cost of possibly higher compilation times.</p>
<h1><a class="anchor" id="example_optix7_new"></a>
New Topics</h1>
<ul>
<li>Execution of generated code (OptiX 7)</li>
<li>Linking and optimizing generated MDL code with renderer code</li>
<li>Limiting the number of exported PTX functions</li>
</ul>
<h1><a class="anchor" id="example_optix7_descr"></a>
Detailed Description</h1>
<dl>
<dt><b>Execution of generated code (OptiX 7)</b> </dt>
<dd><p class="startdd"><br/>
 For OptiX 7, you use the CUDA PTX backend with the <code>"direct_call"</code> texture lookup call mode (see <a class="el" href="mi_neuray_ptx_texture_lookup_call_modes.html">Texture lookup call modes of the PTX backend </a>).</p>
<p>The example shows two ways to execute the generated code: </p>
<ul>
<li>
Using one closest hit shader program which calls different sets of callable programs for each material ("direct-call mode"), and </li>
<li>
using several closest hit shader programs (one per material) where the generated material-specific MDL code has been inlined ("no-direct-call mode"). </li>
</ul>
<p>You can choose between the two ways by defining or not defining the <code>"NO_DIRECT_CALL"</code> macro in <code>optix7_mdl.h</code>.</p>
<p>To illustrate the execution of both DF (distribution function) and non-DF expressions, we will use <code>"surface.scattering"</code> and <code>"thin_walled"</code> for each material.</p>
<p>For the direct-call mode, one hitgroup program group is created for the closest hit shader, which will call the generated MDL functions using <code>"optixDirectCall"</code>. The indices of the functions to be called depend on the hitgroup data of the object hit by the current ray. For each material, the above expressions are translated into PTX code using the MDL SDK, turned into an OptiX module and one callable program is created for each generated function (<code>init</code>, <code>sample</code>, <code>evaluate</code>, <code>pdf</code> and <code>thin_walled</code>).</p>
<p>Sadly, this causes a lot of memory reads and writes as the MDL state has to be completely materialized in memory and provided to the generated functions via pointers. This makes this mode pretty slow.</p>
<p>For the no-direct-call mode, the example provides an LLVM bitcode version of the closest hit shader to the MDL SDK and instructs the MDL SDK to inline and optimize all generated code together with the closest hit shader, resulting in one specialized closest hit shader program per material. Thus, only the part of the MDL state, which is actually used, has to be calculated (the rest is optimized away), and can usually be stored in registers, avoiding most memory reads and writes. </p>
<p class="enddd"></p>
</dd>
<dt><b>Linking and optimizing generated MDL code with renderer code</b> </dt>
<dd><p class="startdd"><br/>
 For the no-direct-call mode, the closest hit shader of the renderer in this example contains calls to <code>extern</code> declared functions which the MDL SDK will generate.</p>
<p>To create the LLVM bitcode of the closest hit shader, we use Clang in a version matching the version used by the MDL SDK. Currently, this has to be Clang 7.0.0, which needs a CUDA 8 installation to be able to compile the closest hit shader. CUDA 8 will not be used at runtime. On the command line, you should provide these options to ensure fast code and good compatibility with the generated code: </p>
<div class="fragment"><div class="line">-O3 -ffast-math -fcuda-flush-denormals-to-zero -fno-vectorize</div>
</div><!-- fragment --><p>The resulting <code></code>.bc file is then loaded as a binary file and provided to the CUDA PTX backend via the binary option <code>"llvm_renderer_module"</code> using the <a class="el" href="group__mi__neuray__mdl__compiler.html#gad6fe1c39e6bff9ef2db9d3755b69dadd" title="Sets a binary backend option. ">mi::neuraylib::IMdl_backend::set_option_binary()</a> function. With this option set, the given module will be linked and optimized with the generated code.</p>
<p>Additionally, the example sets the <code>"inline_aggressively"</code> backend option using <a class="el" href="group__mi__neuray__mdl__compiler.html#ga1301dec05ba862ca7745814367811f15" title="Sets a backend option. ">mi::neuraylib::IMdl_backend::set_option()</a> to inline all functions, if possible. This also allows to inline the renderer provided texture runtime into the generated code, usually removing all the complex wrapping and cropping logic.</p>
<p>For each material instance, the closest hit shader is thus "instantiated" and specialized, when generating target code. From this target code, the example then creates the material-specific hitgroup program group for the closest hit shader. </p>
<p class="enddd"></p>
</dd>
<dt><b>Limiting the number of exported PTX functions</b> </dt>
<dd><p class="startdd"><br/>
 If you looked at the generated PTX code, you would notice, that the code contains the <code>init</code>, <code>sample</code>, <code>evaluate</code>, <code>pdf</code> and <code>thin_walled</code> functions, although nobody calls them anymore, because they were inlined into the closest hit function. So generating and processing all this PTX code is just a waste of time.</p>
<p>With the backend option <code>"visible_functions"</code>, you can instruct the backend to try to avoid emitting PTX code for unneeded functions by making all other functions internal. This example only requests PTX code for the <code>"__closesthit__radiance"</code> function. </p>
<p class="enddd"></p>
</dd>
<dt><b>Additional notes</b> </dt>
<dd><p class="startdd"><br/>
 As OptiX 7 is using CUDA, the example can reuse the texture runtime of the CUDA examples. But vtable support has to be disabled, as you are not allowed to take function pointers in OptiX 7.</p>
<p>Also, the example disables the dummy scene data support and provides a set of simple own functions allowing to access example vertex colors and vertex row/column values of the generated sphere mesh.</p>
<p class="enddd">To be able to compile the texture runtime with Clang 7.0.0, a set of <code>__itex*</code> functions is required in <code>optix7_mdl_closest_hit_radiance.cu</code> to map the texture functions to the correct PTX assembler instructions.  </p>
</dd>
</dl>
<h1><a class="anchor" id="example_optix7"></a>
Example Source</h1>
<p>To compile the source code, you need OptiX 7.0 or higher (<a href="https://developer.nvidia.com/designworks/optix/download">https://developer.nvidia.com/designworks/optix/download</a>), Clang 7.0.0 (<a href="http://releases.llvm.org/download.html#7.0.0">http://releases.llvm.org/download.html#7.0.0</a>), CUDA 8 (<a href="https://developer.nvidia.com/cuda-toolkit-archive">https://developer.nvidia.com/cuda-toolkit-archive</a>), GLFW, and GLEW. For detailed instructions, please refer to the <a class="el" href="mi_neuray_getting_started.html">Getting Started </a> section.</p>
<p><b>Source Code Location:</b> <code>examples/mdl_sdk/optix7</code></p>
<div align="right"> [<a class="el" href="mi_neuray_example_dxr.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] </div> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path">
<span class="footeritem">5&#160;April&#160;2022,&#160;20:40, rev.358266</span>
<span class="footeritem"><a href="https://www.nvidia.com/en-us/about-nvidia/legal-info/" target="_blank" shape="rect">&copy; 2022 NVIDIA&nbsp;Corporation.</a> All rights reserved.</span>
</div>
</body>
</html>
