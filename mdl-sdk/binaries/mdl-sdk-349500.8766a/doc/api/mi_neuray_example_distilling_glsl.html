<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Example for Using Distilled Materials in OpenGL</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="images/arcicon.ico" rel="shortcut icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_custom_stylesheet_1_8_4.css" rel="stylesheet" type="text/css"/>
<link rel='stylesheet' href='webfonts/librebaskerville/stylesheet.css' type='text/css'/>
<link rel='stylesheet' href='webfonts/sourcesanspro/stylesheet.css' type='text/css'/>
<!--ARC-->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="blackheader">
<span id="blackheader_title">MDL SDK API</span>
<span>
<img src="images/nvidia_logo_transpbg.gif" alt="nvidia_logo_transpbg.gif" style=" height:1.25em; width:6.806em;"/></span>
<span id="blackheader_uplink">
<a href='../index.html' class='top_page_nav'>Up</a>
</span>
</div>
<!--
<div id="titlearea">
   <span id="projectname">
     <a id="titlelink" href="../../index.html">
       MDL SDK API
     </a>
   </span>
     <a id="projectlogo" href="http://www.nvidia-arc.com">
       <img alt="NVIDIA logo" src="images/nvidia_logo.png" style="height:2em;">
       </a>
     <a href='../index.html' class='top_page_nav'>Up</a>
</div>
-->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mi_neuray_example_distilling_glsl.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example for Using Distilled Materials in OpenGL </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div align="right"> [<a class="el" href="mi_neuray_example_distilling.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_traversal.html">Next</a>] </div><p>This example shows how an MDL material distilled to the UE4 target can be mapped to a predefined GLSL PBR shader to render a sphere in an OpenGL window.</p>
<h1><a class="anchor" id="example_distilling_glsl_new"></a>
New Topics</h1>
<ul>
<li>Mapping distilled materials to a GLSL shader</li>
</ul>
<h1><a class="anchor" id="example_distilling_glsl_descr"></a>
Detailed Description</h1>
<dl>
<dt><b> Baking versus code generation </b> </dt>
<dd><p class="startdd"><br/>
 To feed the parameters of the target GLSL shader for a renderer you can either bake the input functions of the distilled material into textures or generate GLSL code to calculate them at runtime. The former has the advantage of a fixed cost: in order to evaluate the parameter only one texture lookup is needed. However, since baking is done on a 2D plane, your target geometry will need a suitable UV-layout. Furthermore, if the texture function graph makes use of world or object space transformations, those will be fixed to the [0,1] x [0,1] range. Generating GLSL code from the texture function graph does not suffer from those limitations, all information is preserved. This comes at a potentially high runtime cost as the graphs may contain many functions and/or functions that are expensive to evaluate (e.g. noise functions).</p>
<p class="enddd"></p>
</dd>
<dt><b> Brief example overview </b> </dt>
<dd><p class="startdd"><br/>
 This example uses an UE4 like PBR shader with its typical <code>base_color</code>, <code>metallic</code>, <code>roughness</code>, <code>specular</code> and <code>normal</code> parameters plus an optional clearcoat (see <code>glsl/example_distilling_glsl.frag</code> for details). We wrap the access to those parameters into functions (e.g. get_base_color) rather than making them uniform inputs to the shader itself. This allows us to use the same code structure for both a baked and a GLSL representation of the distilled MDL materials` texture functions. At program runtime, those access-functions are generated, and, together with a texture runtime, assembled into the final fragment shader.</p>
<p>After parsing the command line and loading and configuring the MDL SDK, all given materials are distilled to the UE4 target and passed to the render_scene function. For every distilled material an instance of the class <code>Mdl_pbr_shader</code> is constructed. This class is responsible for setting up the final final GLSL shader.</p>
<p>In order to unify the handling of baked and code-based representations of the PBR parameters in the <code>Mdl_pbr_shader</code>, we encapsulate the actual conversion into the <code>Mdl_ue4</code> interface and its two specializations <code>Mdl_ue4_glsl</code> and <code>Mdl_ue4_baker</code>. <br/>
 The <code>Mdl_ue4_glsl</code> class uses the GLSL backend (see <a class="el" href="classmi_1_1neuraylib_1_1IMdl__backend.html" title="MDL backends allow to transform compiled material instances or function calls into target code...">mi::neuraylib::IMdl_backend</a>) to generate GLSL code. Upon construction the backend is acquired and configured and an <a class="el" href="classmi_1_1neuraylib_1_1ILink__unit.html" title="Represents a link-unit of an MDL backend. ">mi::neuraylib::ILink_unit</a> is created. Then, the base-class function <code>Mdl_ue4::add_ue4_material_expressions()</code> is called which walks the graph of a UE4-distilled MDL material and collects relevant input expression graphs (e.g. the one for <code>base_color</code>). For each such expression the virtual function <code>add_material_expression()</code> is called. In this function the expressions are fed into the <a class="el" href="classmi_1_1neuraylib_1_1ILink__unit.html" title="Represents a link-unit of an MDL backend. ">mi::neuraylib::ILink_unit</a> for later code generation.<br/>
 The <code>Mdl_ue4_baker</code> class uses the <a class="el" href="classmi_1_1neuraylib_1_1IBaker.html" title="Allows to bake a varying or uniform expression of a compiled material into a texture or constant...">mi::neuraylib::IBaker</a> for texture baking. It sets up a map holding the material parameters we want to extract from the distilled material and then also calls the base-class function <code>Mdl_ue4::add_ue4_material_expressions()</code>. The <code>Mdl_ue4_baker::add_material_expression()</code> specialization simply collects the expressions for baking and saves them into the map. Finally, the expressions are baked and the access-functions are generated.<br/>
 Depending on the original MDL material, the distilled MDL material may not contain texturing expressions for every parameters of the PBR shader. In this case, dummy functions returning a suitable default value are generated by both specializations.</p>
<p class="enddd">The constructor of <code>Mdl_pbr_shader</code> receives a pointer to either an <code>Mdl_ue4_baker</code> or an <code>Mdl_ue4_glsl</code> instance. In order to assemble the final fragment shader the generated code given in <code>Mdl_ue4</code> is combined with the static GLSL code found in <code>glsl/example_distilling_glsl.frag</code> and all textures are uploaded to the GPU. In the <code>Mdl_ue4_glsl</code> case this are all textures referenced by the generated GLSL code, in the <code>Mdl_ue4_baker</code> case, this are the baked textures.  </p>
</dd>
</dl>
<h1><a class="anchor" id="example_distilling_glsl"></a>
Example Source</h1>
<p>To compile the source code, you need GLEW available at <a href="http://glew.sourceforge.net/">http://glew.sourceforge.net/</a> and GLFW available at <a href="http://www.glfw.org/download.html">http://www.glfw.org/download.html</a>. Please refer to the <a class="el" href="mi_neuray_getting_started.html">Getting Started </a> section for details.</p>
<p><b>Source Code Location:</b> <code>examples/mdl_sdk/distilling_glsl/example_distilling_glsl.cpp</code></p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment"> * Copyright 2022 NVIDIA Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *****************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// examples/mdl_sdk/distilling_glsl/example_distilling_glsl.cpp</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Shows how to distill an MDL material to UE4 and use the distilling result in a GLSL</span></div>
<div class="line"><span class="comment">// PBR shader by generating GLSL code for the relevant material expressions.</span></div>
<div class="line"><span class="comment">// When more than one material is specified on the command line, you can use the</span></div>
<div class="line"><span class="comment">// left, right arrows to switch between them.</span></div>
<div class="line"><span class="comment">// Using the up and down arrows you can switch between baked and non-baked</span></div>
<div class="line"><span class="comment">// GLSL expressions.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;example_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;example_glsl_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;example_distilling_shared.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;GL/glew.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;GLFW/glfw3.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define _USE_MATH_DEFINES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="math_8h.html" title="Math API. ">math.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// This selects SSBO (Shader Storage Buffer Objects) mode for passing uniforms and MDL const data.</span></div>
<div class="line"><span class="comment">// Should not be disabled unless you only use materials with very small const data. The noise</span></div>
<div class="line"><span class="comment">// functions from the ::base module for example use lookup tables that account for a large amount</span></div>
<div class="line"><span class="comment">// of const data in the generated GLSL code.</span></div>
<div class="line"><span class="preprocessor">#if !defined(MI_PLATFORM_MACOSX) &amp;&amp; !defined(MI_ARCH_ARM_64)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define USE_SSBO</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// If defined, the GLSL backend remap these functions</span></div>
<div class="line"><span class="comment">//   float ::base::perlin_noise(float4 pos)</span></div>
<div class="line"><span class="comment">//   float ::base::mi_noise(float3 pos)</span></div>
<div class="line"><span class="comment">//   float ::base::mi_noise(int3 pos)</span></div>
<div class="line"><span class="comment">//   ::base::worley_return ::base::worley_noise(float3 pos, float jitter, int metric)</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// to lut-free alternatives. When enabled, you can avoid to set the USE_SSBO define for this</span></div>
<div class="line"><span class="comment">// example.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//#define REMAP_NOISE_FUNCTIONS</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Enable this to dump the generated GLSL code to stdout/file.</span></div>
<div class="line"><span class="comment">//#define DUMP_GLSL</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Application options</span></div>
<div class="line"><span class="keyword">struct </span>Options {</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> show_window;</div>
<div class="line">    <span class="keywordtype">bool</span> bake;</div>
<div class="line">    <span class="keywordtype">int</span> baking_resolution_x;</div>
<div class="line">    <span class="keywordtype">int</span> baking_resolution_y;</div>
<div class="line">    <span class="keywordtype">float</span> exposure;</div>
<div class="line">    std::vector&lt;std::string&gt; material_names;</div>
<div class="line">    std::string hdrfile;</div>
<div class="line">    std::string outputfile;</div>
<div class="line"></div>
<div class="line">    Options()</div>
<div class="line">        : show_window(true)</div>
<div class="line">        , bake(true)</div>
<div class="line">        , baking_resolution_x(2048)</div>
<div class="line">        , baking_resolution_y(2048)</div>
<div class="line">        , exposure(0.0f)</div>
<div class="line">        , hdrfile(<span class="stringliteral">&quot;nvidia/sdk_examples/resources/environment.hdr&quot;</span>)</div>
<div class="line">        , outputfile(<span class="stringliteral">&quot;output.exr&quot;</span>)</div>
<div class="line">        {}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Helper struct to ease passing commonly used objects around</span></div>
<div class="line"><span class="keyword">struct </span>Mdl_sdk_state</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::INeuray&gt;</a>          mdl_sdk;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_impexp_api&gt;</a>  mdl_impexp_api;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend_api&gt;</a> mdl_backend_api;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::IMdl_factory&gt;</a>     mdl_factory;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::ITransaction&gt;</a>     transaction;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert to floating point and transform to linear space if necessary</span></div>
<div class="line"><a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> adjust_canvas(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api,</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> canvas,</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> gamma)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// For simplicity we convert all textures to floating point and pre-apply gamma.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *pixel_type = canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#ab36d6bebb85da08e907eadbe7542c658" title="Returns the pixel type used by the canvas. ">get_type</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *target_type;</div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(pixel_type, <span class="stringliteral">&quot;Rgba&quot;</span>) == 0 ||</div>
<div class="line">        strcmp(pixel_type, <span class="stringliteral">&quot;Rgbea&quot;</span>) == 0 ||</div>
<div class="line">        strcmp(pixel_type, <span class="stringliteral">&quot;Rgba_16&quot;</span>) == 0 ||</div>
<div class="line">        strcmp(pixel_type, <span class="stringliteral">&quot;Color&quot;</span>) == 0)</div>
<div class="line">        target_type = <span class="stringliteral">&quot;Color&quot;</span>;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line">        strcmp(pixel_type, <span class="stringliteral">&quot;Sint8&quot;</span>) == 0 ||</div>
<div class="line">        strcmp(pixel_type, <span class="stringliteral">&quot;Sint32&quot;</span>) == 0 ||</div>
<div class="line">        strcmp(pixel_type, <span class="stringliteral">&quot;Float32&quot;</span>) == 0)</div>
<div class="line">        target_type = <span class="stringliteral">&quot;Float32&quot;</span>;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        target_type = <span class="stringliteral">&quot;Rgb_fp&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> type_conversion = strcmp(pixel_type, target_type) != 0;</div>
<div class="line">    <span class="comment">// Nothing to do?</span></div>
<div class="line">    <span class="keywordflow">if</span> (gamma == 1.0f &amp;&amp; !type_conversion)</div>
<div class="line">        <span class="keywordflow">return</span> canvas;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (gamma != 1.0f) {</div>
<div class="line">        <span class="comment">// Copy/convert, transform to linear space.</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> gamma_canvas(</div>
<div class="line">            image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a70bb55d4f633151d12664b078ddd6ebb" title="Converts a canvas to a different pixel type. ">convert</a>(canvas.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>(), target_type));</div>
<div class="line">        gamma_canvas-&gt;set_gamma(gamma);</div>
<div class="line">        image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#aef6f6c7994c60410b14d45a6cd0af7ce" title="Sets the gamma value of a canvas and adjusts the pixel data accordingly. ">adjust_gamma</a>(gamma_canvas.get(), 1.0f);</div>
<div class="line">        canvas = gamma_canvas;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type_conversion) {</div>
<div class="line">        <span class="comment">// Convert to expected format.</span></div>
<div class="line">        canvas = image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a70bb55d4f633151d12664b078ddd6ebb" title="Converts a canvas to a different pixel type. ">convert</a>(canvas.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>(), target_type);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> canvas;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Loads an image from file, convert to float and transform to linear space</span></div>
<div class="line"><a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> load_image_from_file(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* filename)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> result;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage&gt;</a> image(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ad1b8ce71d7a6fea1f59573325dba126c" title="Creates an object of the type type_name. ">create</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage.html" title="This interface represents a pixel image file. ">mi::neuraylib::IImage</a>&gt;(<span class="stringliteral">&quot;Image&quot;</span>));</div>
<div class="line">    <span class="keywordflow">if</span> (image-&gt;reset_file(filename) == 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// poor man&#39;s gamma guess</span></div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> gamma = 1.0f;</div>
<div class="line">        std::string t = image-&gt;get_type(0, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (t == <span class="stringliteral">&quot;Rgb&quot;</span> || t == <span class="stringliteral">&quot;Rgba&quot;</span>)</div>
<div class="line">            gamma = 2.2f;</div>
<div class="line"></div>
<div class="line">        result = adjust_canvas(</div>
<div class="line">            image_api, <a class="code" href="group__mi__base__iinterface.html#ga18f61a252409bb61d7b686868aebfef9" title="Returns a handle that holds the interface pointer passed in as argument. ">mi::base::make_handle</a>(image-&gt;get_canvas(0, 0, 0)), gamma);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns the canvas holding an image contained in the database</span></div>
<div class="line"><a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> load_image_from_db(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* texture_name)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITexture&gt;</a> texture(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1ITexture.html" title="Textures add image processing options to images. ">mi::neuraylib::ITexture</a>&gt;(texture_name));</div>
<div class="line">    <span class="keywordflow">if</span> (!texture)</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IImage&gt;</a> image(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage.html" title="This interface represents a pixel image file. ">mi::neuraylib::IImage</a>&gt;(texture-&gt;get_image()));</div>
<div class="line">    <span class="keywordflow">if</span> (!image)</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> canvas(image-&gt;get_canvas(0, 0, 0));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (image-&gt;is_uvtile() || image-&gt;is_animated()) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;The example does not support uvtile and/or animated textures!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> adjust_canvas(image_api, canvas, texture-&gt;get_effective_gamma(0, 0));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Saves the given GL texture to disc</span></div>
<div class="line"><a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> save_image(</div>
<div class="line">    <span class="keyword">const</span> Mdl_sdk_state&amp; state,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* filename,</div>
<div class="line">    GLuint texture,</div>
<div class="line">    GLuint w,</div>
<div class="line">    GLuint h)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api(</div>
<div class="line">        state.mdl_sdk-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle &lt;mi::neuraylib::ICanvas&gt;</a> canvas(image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(<span class="stringliteral">&quot;Rgb_fp&quot;</span>, w, h));</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile(canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">    <span class="keywordtype">void</span>* data = tile-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITile.html#a0c4de1ae0441a464da1fc605369469f5" title="Returns a pointer to the raw tile data according to the pixel type of the tile. ">get_data</a>();</div>
<div class="line">    glBindTexture(GL_TEXTURE_2D, texture);</div>
<div class="line">    glGetTexImage(GL_TEXTURE_2D, 0, GL_RGB, GL_FLOAT, data);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> state.mdl_impexp_api-&gt;export_canvas(filename, canvas.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns a GLSL function string of the given name that returns the given value</span></div>
<div class="line">std::string get_color_default(<span class="keyword">const</span> std::string&amp; name, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>&amp; value = <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>(0.0f))</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;vec3 &quot;</span> + name + <span class="stringliteral">&quot;(State state) {\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    return vec3(&quot;</span> + to_string(value.r) + +<span class="stringliteral">&quot;,&quot;</span> +</div>
<div class="line">        to_string(value.g) + <span class="stringliteral">&quot;, &quot;</span> + to_string(value.b) + <span class="stringliteral">&quot;);\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns a GLSL function string of the given name that returns the given value</span></div>
<div class="line">std::string get_float_default(<span class="keyword">const</span> std::string&amp; name, <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> value = 0.0f)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;float &quot;</span> + name + <span class="stringliteral">&quot;(State state) {\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    return float(&quot;</span> + to_string(value) + <span class="stringliteral">&quot;);\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns a GLSL function string of the given name that returns state::normal</span></div>
<div class="line">std::string get_normal_default(<span class="keyword">const</span> std::string&amp; name)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;vec3 &quot;</span> + name + <span class="stringliteral">&quot;(State state) {\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    return state.normal;\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns a GLSL function string of the given name that returns a texture at index</span></div>
<div class="line">std::string get_vector_texture_access(<span class="keyword">const</span> std::string&amp; name, <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;vec3 &quot;</span> + name + <span class="stringliteral">&quot;(State state) {\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    return texture(mdl_textures_2d[&quot;</span> +</div>
<div class="line">        to_string(index) + <span class="stringliteral">&quot;], state.texture_coordinate[0].rg).rgb;\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns a GLSL function string of the given name that returns a normal in world space</span></div>
<div class="line"><span class="comment">// read from the texture at index</span></div>
<div class="line">std::string get_normal_texture_access(<span class="keyword">const</span> std::string&amp; name, <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;vec3 &quot;</span> + name + <span class="stringliteral">&quot;(State state) {\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    vec3 n = texture(mdl_textures_2d[&quot;</span> +</div>
<div class="line">        to_string(index) + <span class="stringliteral">&quot;], state.texture_coordinate[0].rg).rgb;\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;return normalize(&quot;</span></div>
<div class="line">             <span class="stringliteral">&quot;state.texture_tangent_u[0] * n.x + &quot;</span></div>
<div class="line">             <span class="stringliteral">&quot;state.texture_tangent_v[0] * n.y + &quot;</span></div>
<div class="line">             <span class="stringliteral">&quot;state.normal * n.z);\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Returns a GLSL function string of the given name that returns a texture at index</span></div>
<div class="line">std::string get_float_texture_access(<span class="keyword">const</span> std::string&amp; name, <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;float &quot;</span> + name + <span class="stringliteral">&quot;(State state) {\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    return texture(mdl_textures_2d[&quot;</span> +</div>
<div class="line">        to_string(index) + <span class="stringliteral">&quot;], state.texture_coordinate[0].rg).r;\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// MDL-2-GLSL utility. Abstract base class, collects relevant material expressions from</span></div>
<div class="line"><span class="comment">// a UE4-distilled MDL material. Overriders decide what to do with those expressions (bake,</span></div>
<div class="line"><span class="comment">// generate code). See Mdl_ue4_GLSL and Mdl_ue4_baker for details.</span></div>
<div class="line"><span class="keyword">class </span>Mdl_ue4</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> ~Mdl_ue4() {}</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the GLSL code for this material</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_code() <span class="keyword">const</span> = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the number of textures of the GLSL material</span></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_texture_count() <span class="keyword">const</span> = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the texture at index</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* get_texture(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index) <span class="keyword">const</span> = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the number of read-only data segments used by the GLSL material</span></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_ro_data_segment_count()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the read-only data segment data at index</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_ro_data_segment_data(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the size of the read-only data segment data at index</span></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_ro_data_segment_size(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Returns the name of the read-only data segment data at index</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_ro_data_segment_name(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line"></div>
<div class="line">    <span class="comment">// add material expression for parameter parameter_name at path</span></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> add_material_expression(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> std::string&amp; path) = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_color_default(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>&amp; value = <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>(0.0f)) = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_float_default(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>&amp; value = <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>(0.0f)) = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_normal_default(<span class="keyword">const</span> std::string&amp; parameter_name) = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Traverses the distilled material and calls add_material_expression for each</span></div>
<div class="line">    <span class="comment">// expression relevant for the UE4 material model</span></div>
<div class="line">    <span class="keywordtype">void</span> add_ue4_material_expressions(</div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Access surface.scattering function</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IExpression_direct_call&gt;</a> parent_call(</div>
<div class="line">            lookup_call(<span class="stringliteral">&quot;surface.scattering&quot;</span>, cm));</div>
<div class="line">        <span class="comment">// ... and get its semantic</span></div>
<div class="line">        <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51" title="All known semantics of functions definitions. ">mi::neuraylib::IFunction_definition::Semantics</a> semantic(</div>
<div class="line">            get_call_semantic(transaction, parent_call.get()));</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> has_clearcoat = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span> has_metallic = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span> is_metallic = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span> has_base_color = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span> has_specular = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span> has_roughness = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span> has_normal = <span class="keyword">false</span>;</div>
<div class="line">        std::string path_prefix = <span class="stringliteral">&quot;surface.scattering.&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Check for a clearcoat layer, first. If present, it is the outermost layer</span></div>
<div class="line">        <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Add clearcoat expression paths</span></div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;clearcoat_weight&quot;</span>, path_prefix + <span class="stringliteral">&quot;weight&quot;</span>);</div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;clearcoat_color&quot;</span>, path_prefix + <span class="stringliteral">&quot;layer.tint&quot;</span>);</div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>, path_prefix + <span class="stringliteral">&quot;layer.roughness_u&quot;</span>);</div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;clearcoat_normal&quot;</span>, path_prefix + <span class="stringliteral">&quot;normal&quot;</span>);</div>
<div class="line"></div>
<div class="line">            has_clearcoat = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Get clear-coat base layer</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;base&quot;</span>, cm, parent_call.get());</div>
<div class="line">            <span class="comment">// Get clear-coat base layer semantic</span></div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            <span class="comment">// Extend path prefix</span></div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;base.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// Check for a weighted layer. Sole purpose of this layer is the transportation of</span></div>
<div class="line">        <span class="comment">// the under-clearcoat-normal. It contains an empty base and a layer with the</span></div>
<div class="line">        <span class="comment">// actual material body</span></div>
<div class="line">        <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51af0d7095ab62fadc99f6da2f081635491" title="The df::weighted_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_WEIGHTED_LAYER</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Collect under-clearcoat normal</span></div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;normal&quot;</span>, path_prefix + <span class="stringliteral">&quot;normal&quot;</span>);</div>
<div class="line">            has_normal = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;layer&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;layer.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// Check for a normalized mix. This mix combines the metallic and dielectric parts</span></div>
<div class="line">        <span class="comment">// of the material</span></div>
<div class="line">        <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51aaadb2dea7ed283a586f5f996928a850e" title="The df::normalized_mix() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_NORMALIZED_MIX</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// The top-mix component is supposed to be a glossy bsdf</span></div>
<div class="line">            <span class="comment">// Collect metallic weight</span></div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;metallic&quot;</span>, path_prefix + <span class="stringliteral">&quot;components.1.weight&quot;</span>);</div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;roughness&quot;</span>,</div>
<div class="line">                path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u&quot;</span>);</div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;base_color&quot;</span>, path_prefix + <span class="stringliteral">&quot;components.1.component.tint&quot;</span>);</div>
<div class="line"></div>
<div class="line">            has_roughness = <span class="keyword">true</span>;</div>
<div class="line">            has_metallic = <span class="keyword">true</span>;</div>
<div class="line">            has_base_color = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(</div>
<div class="line">                <span class="stringliteral">&quot;components.0.component&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;components.0.component.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Collect specular parameters</span></div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;specular&quot;</span>, path_prefix + <span class="stringliteral">&quot;weight&quot;</span>);</div>
<div class="line">            has_specular = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!has_roughness)</div>
<div class="line">            {</div>
<div class="line">                add_material_expression(<span class="stringliteral">&quot;roughness&quot;</span>, path_prefix + <span class="stringliteral">&quot;layer.roughness_u&quot;</span>);</div>
<div class="line">                has_roughness = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;base&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;base.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (semantic ==</div>
<div class="line">            <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a995acaeccbd4d42866de0e3fdf020ed3" title="The df::microfacet_ggx_vcavities() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_MICROFACET_GGX_VCAVITIES_BSDF</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (!has_metallic)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (!has_base_color)</div>
<div class="line">                {</div>
<div class="line">                    add_material_expression(<span class="stringliteral">&quot;base_color&quot;</span>, path_prefix + <span class="stringliteral">&quot;tint&quot;</span>);</div>
<div class="line">                    has_base_color = <span class="keyword">true</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (!has_roughness)</div>
<div class="line">                {</div>
<div class="line">                    add_material_expression(<span class="stringliteral">&quot;roughness&quot;</span>, path_prefix + <span class="stringliteral">&quot;roughness_u&quot;</span>);</div>
<div class="line">                    has_roughness = <span class="keyword">true</span>;</div>
<div class="line">                }</div>
<div class="line">                is_metallic = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (semantic ==</div>
<div class="line">            <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a9ef0cefaf54499616b41d73482ed47b3" title="The df::diffuse_reflection_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_DIFFUSE_REFLECTION_BSDF</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (!has_base_color)</div>
<div class="line">            {</div>
<div class="line">                add_material_expression(<span class="stringliteral">&quot;base_color&quot;</span>, path_prefix + <span class="stringliteral">&quot;tint&quot;</span>);</div>
<div class="line">                has_base_color = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (!has_normal)</div>
<div class="line">            add_material_expression(<span class="stringliteral">&quot;normal&quot;</span>, <span class="stringliteral">&quot;geometry.normal&quot;</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!has_base_color) <span class="comment">// should not happen</span></div>
<div class="line">            add_color_default(<span class="stringliteral">&quot;base_color&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!has_roughness)</div>
<div class="line">            add_float_default(<span class="stringliteral">&quot;roughness&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (!has_metallic)</div>
<div class="line">            add_float_default(<span class="stringliteral">&quot;metallic&quot;</span>, is_metallic ? 1.0f : 0.0f);</div>
<div class="line">        <span class="keywordflow">if</span> (!has_specular)</div>
<div class="line">            add_float_default(<span class="stringliteral">&quot;specular&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (!has_clearcoat)</div>
<div class="line">        {</div>
<div class="line">            add_color_default(<span class="stringliteral">&quot;clearcoat_color&quot;</span>);</div>
<div class="line">            add_float_default(<span class="stringliteral">&quot;clearcoat_weight&quot;</span>);</div>
<div class="line">            add_float_default(<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>);</div>
<div class="line">            add_normal_default(<span class="stringliteral">&quot;clearcoat_normal&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> m_cm;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Specialization of Mdl_ue4 which generates GLSL code for all relevant material</span></div>
<div class="line"><span class="comment">// expressions.</span></div>
<div class="line"><span class="keyword">class </span>Mdl_ue4_glsl : <span class="keyword">public</span> Mdl_ue4</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">    Mdl_ue4_glsl(<span class="keyword">const</span> Mdl_sdk_state&amp; state, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm)</div>
<div class="line">        : m_result(0)</div>
<div class="line">        , m_cm(mi::base::<a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">make_handle_dup</a>(cm))</div>
<div class="line">        , m_transaction(state.transaction)</div>
<div class="line">        , m_image_api(state.mdl_sdk-&gt;get_api_component&lt;mi::neuraylib::IImage_api&gt;())</div>
<div class="line">        , m_context(state.mdl_factory-&gt;create_execution_context())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Access GLSL backend</span></div>
<div class="line">        m_be_glsl = state.mdl_backend_api-&gt;get_backend(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a28a914c7c51dd45974b16fa189a77b46adc379cf50d7577910850602786ca2819" title="Generate GLSL code . ">mi::neuraylib::IMdl_backend_api::MB_GLSL</a>);</div>
<div class="line">        check_success(m_be_glsl);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Set backend options</span></div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;num_texture_spaces&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_SSBO</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// SSBO requires GLSL 4.30</span></div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_version&quot;</span>, <span class="stringliteral">&quot;430&quot;</span>) == 0);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_version&quot;</span>, <span class="stringliteral">&quot;330&quot;</span>) == 0);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_state_normal_mode&quot;</span>, <span class="stringliteral">&quot;field&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_state_position_mode&quot;</span>, <span class="stringliteral">&quot;field&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_state_texture_coordinate_mode&quot;</span>, <span class="stringliteral">&quot;field&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_state_texture_tangent_u_mode&quot;</span>, <span class="stringliteral">&quot;field&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_state_texture_tangent_v_mode&quot;</span>, <span class="stringliteral">&quot;field&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_state_texture_space_max_mode&quot;</span>, <span class="stringliteral">&quot;field&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_SSBO</span></div>
<div class="line"><span class="preprocessor"></span>        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_max_const_data&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_place_uniforms_into_ssbo&quot;</span>, <span class="stringliteral">&quot;on&quot;</span>) == 0);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_max_const_data&quot;</span>, <span class="stringliteral">&quot;1024&quot;</span>) == 0);</div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_place_uniforms_into_ssbo&quot;</span>, <span class="stringliteral">&quot;off&quot;</span>) == 0);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef REMAP_NOISE_FUNCTIONS</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// remap noise functions that access the constant tables</span></div>
<div class="line">        check_success(m_be_glsl-&gt;set_option(<span class="stringliteral">&quot;glsl_remap_functions&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;_ZN4base12perlin_noiseEu6float4=noise_float4&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;,_ZN4base12worley_noiseEu6float3fi=noise_worley&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;,_ZN4base8mi_noiseEu6float3=noise_mi_float3&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;,_ZN4base8mi_noiseEu4int3=noise_mi_int3&quot;</span>) == 0);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        <span class="comment">// Create link unit</span></div>
<div class="line">        m_link_unit = m_be_glsl-&gt;create_link_unit(m_transaction.get(), m_context.get());</div>
<div class="line"></div>
<div class="line">        add_ue4_material_expressions(m_transaction.get(), m_cm.get());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Generate code</span></div>
<div class="line">        m_target_code = m_be_glsl-&gt;translate_link_unit(m_link_unit.get(), m_context.get());</div>
<div class="line">        check_success(print_messages(m_context.get()));</div>
<div class="line"></div>
<div class="line">        m_code = m_target_code-&gt;get_code();</div>
<div class="line"><span class="preprocessor">#ifdef REMAP_NOISE_FUNCTIONS</span></div>
<div class="line"><span class="preprocessor"></span>        m_code += read_text_file(get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;noise_no_lut.glsl&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        m_code += m_defaults;</div>
<div class="line">        add_texture_runtime();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> ~Mdl_ue4_glsl()</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_color_default(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>&amp; value = <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>(0.0f))</div>
<div class="line">    {</div>
<div class="line">        m_defaults += get_color_default(<span class="stringliteral">&quot;get_&quot;</span> + parameter_name, value);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_float_default(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>&amp; value = <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>(0.0f))</div>
<div class="line">    {</div>
<div class="line">        m_defaults += get_float_default(<span class="stringliteral">&quot;get_&quot;</span> + parameter_name, value);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_normal_default(<span class="keyword">const</span> std::string&amp; parameter_name)</div>
<div class="line">    {</div>
<div class="line">        m_defaults += get_normal_default(<span class="stringliteral">&quot;get_&quot;</span> + parameter_name);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> add_material_expression(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> std::string&amp; path)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> std::string fct_name = <span class="stringliteral">&quot;get_&quot;</span> + parameter_name;</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = m_link_unit-&gt;add_material_expression(</div>
<div class="line">            m_cm.get(), path.c_str(), fct_name.c_str(), m_context.get());</div>
<div class="line">        print_messages(m_context.get());</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> result;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_code()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_code.c_str();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_texture_count()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_target_code-&gt;get_texture_count();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* get_texture(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> canvas =</div>
<div class="line">            load_image_from_db(</div>
<div class="line">                m_image_api.get(), m_transaction.get(), m_target_code-&gt;get_texture(index));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!canvas)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">        canvas-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#a2c52e362969ee0f56ab5f8655937402f" title="Increments the reference count. ">retain</a>();</div>
<div class="line">        <span class="keywordflow">return</span> canvas.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_ro_data_segment_count()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_target_code-&gt;get_ro_data_segment_count();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_ro_data_segment_data(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_target_code-&gt;get_ro_data_segment_data(index);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_ro_data_segment_size(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_target_code-&gt;get_ro_data_segment_size(index);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_ro_data_segment_name(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_target_code-&gt;get_ro_data_segment_name(index);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> m_result;</div>
<div class="line">    std::string m_defaults;</div>
<div class="line">    std::string m_code;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle &lt;const mi::neuraylib::ICompiled_material&gt;</a></div>
<div class="line">                                                        m_cm;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle &lt;mi::neuraylib::ITransaction&gt;</a>      m_transaction;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a>         m_image_api;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a></div>
<div class="line">                                                        m_context;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;</a> m_target_code;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ILink_unit&gt;</a>         m_link_unit;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend&gt;</a>       m_be_glsl;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create texture runtime</span></div>
<div class="line">    <span class="keywordtype">void</span> add_texture_runtime()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (m_target_code-&gt;get_texture_count() == 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        m_code += <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        m_code += <span class="stringliteral">&quot;#define MAX_TEXTURES &quot;</span> + to_string(</div>
<div class="line">            m_target_code-&gt;get_texture_count() - 1) + <span class="stringliteral">&quot;u\n&quot;</span>;</div>
<div class="line">        m_code += <span class="stringliteral">&quot;uniform sampler2D mdl_textures_2d[MAX_TEXTURES];\n&quot;</span>;</div>
<div class="line">        m_code +=</div>
<div class="line">            <span class="stringliteral">&quot;vec4 tex_lookup_2d(&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;uint tex, vec2 coord, int wrap_u, int wrap_v, vec2 crop_u, vec2 crop_v, float frame)\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;{\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    if (tex == 0u) return vec4(0);\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    if (tex &gt; MAX_TEXTURES) return vec4(0);\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    return texture(mdl_textures_2d[tex-1u], coord);\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;}\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;vec4 tex_texel_2d(uint tex, ivec2 coord, ivec2 uv_tile, float frame)\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;{\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    if (tex == 0u) return vec4(0);\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    if (tex &gt; MAX_TEXTURES) return vec4(0);\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    return texelFetch(mdl_textures_2d[tex - 1u], coord, 0);\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        std::string w_switch, h_switch;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 1; i &lt; m_target_code-&gt;get_texture_count(); ++i)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITexture&gt;</a> tex(</div>
<div class="line">                m_transaction-&gt;access&lt;<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITexture.html" title="Textures add image processing options to images. ">mi::neuraylib::ITexture</a>&gt;(</div>
<div class="line">                    m_target_code-&gt;get_texture(i)));</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IImage&gt;</a> image(</div>
<div class="line">                m_transaction-&gt;access&lt;<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1IImage.html" title="This interface represents a pixel image file. ">mi::neuraylib::IImage</a>&gt;(tex-&gt;get_image()));</div>
<div class="line">            w_switch += <span class="stringliteral">&quot;    case &quot;</span> + to_string(i) + <span class="stringliteral">&quot;u: return &quot;</span></div>
<div class="line">                + to_string(image-&gt;resolution_x(0, 0, 0)) + <span class="stringliteral">&quot;;\n&quot;</span>;</div>
<div class="line">            h_switch += <span class="stringliteral">&quot;    case &quot;</span> + to_string(i) + <span class="stringliteral">&quot;u: return &quot;</span></div>
<div class="line">                + to_string(image-&gt;resolution_y(0, 0, 0)) + <span class="stringliteral">&quot;;\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        m_code +=</div>
<div class="line">            <span class="stringliteral">&quot;int tex_width(uint tex, ivec2 uv_tile, float frame)&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;{\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    switch (tex) {\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    case 0u: return 0;\n&quot;</span></div>
<div class="line">            + w_switch +</div>
<div class="line">            <span class="stringliteral">&quot;    }\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;}\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;int tex_height(uint tex, ivec2 uv_tile, float frame)&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;{\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    switch (tex) {\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    case 0u: return 0;\n&quot;</span></div>
<div class="line">            + h_switch +</div>
<div class="line">            <span class="stringliteral">&quot;    }\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Helper struct that describes a material parameter for the target shader</span></div>
<div class="line"><span class="keyword">struct </span>Material_parameter</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> canvas_index;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IData&gt;</a> value;</div>
<div class="line">    std::string pixel_type;</div>
<div class="line">    std::string bake_path;</div>
<div class="line"></div>
<div class="line">    Material_parameter(<span class="keyword">const</span> std::string&amp; pixel_type)</div>
<div class="line">        : canvas_index(~0u), pixel_type(pixel_type) { }</div>
<div class="line"></div>
<div class="line">    Material_parameter()</div>
<div class="line">        : canvas_index(~0u) { }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Specialization of Mdl_ue4 which bakes all relevant material</span></div>
<div class="line"><span class="comment">// expressions into textures or constants</span></div>
<div class="line"><span class="keyword">class </span>Mdl_ue4_baker : <span class="keyword">public</span> Mdl_ue4</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">    Mdl_ue4_baker(</div>
<div class="line">        <span class="keyword">const</span> Mdl_sdk_state&amp; state,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm,</div>
<div class="line">        <span class="keywordtype">int</span> baking_resolution_x, <span class="keywordtype">int</span> baking_resolution_y)</div>
<div class="line">        : m_sdk_state(state)</div>
<div class="line">        , m_cm(mi::base::<a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">make_handle_dup</a>(cm))</div>
<div class="line">        , m_baking_resolution_x(baking_resolution_x)</div>
<div class="line">        , m_baking_resolution_y(baking_resolution_y)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// initialize material parameters</span></div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;base_color&quot;</span>]          = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;metallic&quot;</span>]            = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;specular&quot;</span>]            = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;roughness&quot;</span>]           = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;normal&quot;</span>]              = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>);</div>
<div class="line"></div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;clearcoat_color&quot;</span>]     = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;clearcoat_weight&quot;</span>]    = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        m_material_parameters[<span class="stringliteral">&quot;clearcoat_normal&quot;</span>]    = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// collect parameters from cm</span></div>
<div class="line">        add_ue4_material_expressions(m_sdk_state.transaction.get(), cm);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// bake</span></div>
<div class="line">        bake_expressions();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// generate access code</span></div>
<div class="line">        generate_glsl();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> ~Mdl_ue4_baker() { }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_color_default(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>&amp; value = <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>(0.0f))</div>
<div class="line">    {</div>
<div class="line">        Material_parameter_map::iterator param = m_material_parameters.find(parameter_name);</div>
<div class="line">        <span class="keywordflow">if</span> (param == m_material_parameters.end())</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        param-&gt;second.value = create_value(m_sdk_state.transaction.get(), <span class="stringliteral">&quot;Color&quot;</span>, value);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_float_default(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>&amp; value = <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>(0.0f))</div>
<div class="line">    {</div>
<div class="line">        Material_parameter_map::iterator param = m_material_parameters.find(parameter_name);</div>
<div class="line">        <span class="keywordflow">if</span> (param == m_material_parameters.end())</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        param-&gt;second.value = create_value(m_sdk_state.transaction.get(), <span class="stringliteral">&quot;Float32&quot;</span>, value);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_normal_default(<span class="keyword">const</span> std::string&amp; parameter_name)</div>
<div class="line">    {</div>
<div class="line">        Material_parameter_map::iterator param = m_material_parameters.find(parameter_name);</div>
<div class="line">        <span class="keywordflow">if</span> (param == m_material_parameters.end())</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        param-&gt;second.bake_path = <span class="stringliteral">&quot;geometry.normal&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> add_material_expression(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; parameter_name, <span class="keyword">const</span> std::string&amp; path)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">        Material_parameter_map::iterator param = m_material_parameters.find(parameter_name);</div>
<div class="line">        <span class="keywordflow">if</span> (param == m_material_parameters.end())</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        param-&gt;second.bake_path = path;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* get_code()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_code.c_str();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> get_texture_count()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_textures.size() ? m_textures.size() + 1 : 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* get_texture(<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> index)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">if</span> (index &lt; 1 || index &gt; m_textures.size())</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">        m_textures[index-1]-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#a2c52e362969ee0f56ab5f8655937402f" title="Increments the reference count. ">retain</a>();</div>
<div class="line">        <span class="keywordflow">return</span> m_textures[index-1].get();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"></div>
<div class="line">    std::string m_code;</div>
<div class="line">    <span class="keyword">typedef</span> std::map&lt;std::string, Material_parameter&gt; Material_parameter_map;</div>
<div class="line"></div>
<div class="line">    std::map&lt;std::string, Material_parameter&gt; m_material_parameters;</div>
<div class="line">    std::vector &lt;mi::base::Handle&lt;mi::neuraylib::ICanvas&gt; &gt; m_textures;</div>
<div class="line"></div>
<div class="line">    Mdl_sdk_state m_sdk_state;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> m_cm;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> m_baking_resolution_x;</div>
<div class="line">    <span class="keywordtype">int</span> m_baking_resolution_y;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// bake expressions to texture</span></div>
<div class="line">    <span class="keywordtype">void</span> bake_expressions()</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_distiller_api&gt;</a> distiller_api(</div>
<div class="line">            m_sdk_state.mdl_sdk-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api(</div>
<div class="line">            m_sdk_state.mdl_sdk-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (Material_parameter_map::iterator it = m_material_parameters.begin();</div>
<div class="line">            it != m_material_parameters.end(); ++it )</div>
<div class="line">        {</div>
<div class="line">            Material_parameter&amp; param = it-&gt;second;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Do not attempt to bake empty paths</span></div>
<div class="line">            <span class="keywordflow">if</span> (param.bake_path.empty())</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Create baker for current path</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IBaker&gt;</a> baker(distiller_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#af2405d4d9a184d64ccabf81ff4a5e06e" title="Creates a baker for texture baking. ">create_baker</a>(</div>
<div class="line">                m_cm.get(), param.bake_path.c_str(), <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086af15d69862ab55cad12d75dc4974faab8" title="Use only the GPU for texture baking. ">mi::neuraylib::BAKE_ON_GPU</a>));</div>
<div class="line">            check_success(baker.is_valid_interface());</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (baker-&gt;is_uniform())</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IData&gt;</a> value;</div>
<div class="line">                <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">                    param.value = create_value(</div>
<div class="line">                        m_sdk_state.transaction.get(), <span class="stringliteral">&quot;Color&quot;</span>, <a class="code" href="group__mi__neuray__compounds.html#gafd51fb3363c0ed0ee017797c9af110bd" title="RGBA color class. ">mi::Color</a>(0.f));</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">                    param.value = create_value(m_sdk_state.transaction.get(), <span class="stringliteral">&quot;Float32&quot;</span>, 0.f);</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">                    param.value = create_value(</div>
<div class="line">                        m_sdk_state.transaction.get(), <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f));</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;Ignoring unsupported value type &#39;&quot;</span> &lt;&lt; param.pixel_type</div>
<div class="line">                        &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Bake constant value</span></div>
<div class="line">                <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = baker-&gt;bake_constant(param.value.get());</div>
<div class="line">                check_success(result == 0);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Create a canvas</span></div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> canvas(</div>
<div class="line">                    image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(param.pixel_type.c_str(),</div>
<div class="line">                        m_baking_resolution_x, m_baking_resolution_y));</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Bake texture</span></div>
<div class="line">                <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = baker-&gt;bake_texture(canvas.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>(), 1);</div>
<div class="line">                check_success(result == 0);</div>
<div class="line"></div>
<div class="line">                m_textures.push_back(canvas);</div>
<div class="line">                param.canvas_index = m_textures.size() - 1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> generate_glsl()</div>
<div class="line">    {</div>
<div class="line">        m_code +=</div>
<div class="line">            <span class="stringliteral">&quot;#version 330 core\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;struct State {\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    vec3 normal;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    vec3 geometry_normal;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    vec3 position;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    int texture_space_max;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    vec3[1] texture_coordinate;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    vec3[1] texture_tangent_u;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;    vec3[1] texture_tangent_v;\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;};\n\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (m_textures.size())</div>
<div class="line">        {</div>
<div class="line">            m_code += <span class="stringliteral">&quot;#define MAX_TEXTURES &quot;</span> + to_string(</div>
<div class="line">                m_textures.size()) + <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            m_code += <span class="stringliteral">&quot;uniform sampler2D mdl_textures_2d[MAX_TEXTURES];\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (Material_parameter_map::iterator it = m_material_parameters.begin();</div>
<div class="line">            it != m_material_parameters.end(); ++it)</div>
<div class="line">        {</div>
<div class="line">            Material_parameter&amp; param = it-&gt;second;</div>
<div class="line">            <span class="keywordflow">if</span> (param.canvas_index == ~0u)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a> v;</div>
<div class="line">                    <a class="code" href="group__mi__neuray__types.html#gad12309fee401d9d99e64470c6a3dcfb2" title="Simplifies reading the value of mi::IData into the corresponding classes from the base and math API...">mi::get_value</a>(param.value.get(), v);</div>
<div class="line">                    m_code += get_color_default(<span class="stringliteral">&quot;get_&quot;</span> + it-&gt;first, v);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> v;</div>
<div class="line">                    <a class="code" href="group__mi__neuray__types.html#gad12309fee401d9d99e64470c6a3dcfb2" title="Simplifies reading the value of mi::IData into the corresponding classes from the base and math API...">mi::get_value</a>(param.value.get(), v);</div>
<div class="line">                    m_code += get_float_default(<span class="stringliteral">&quot;get_&quot;</span> + it-&gt;first, v);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    m_code += get_normal_default(<span class="stringliteral">&quot;get_&quot;</span> + it-&gt;first);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    check_success(!<span class="stringliteral">&quot;unsupported pixel type&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    m_code += get_vector_texture_access(<span class="stringliteral">&quot;get_&quot;</span> + it-&gt;first, param.canvas_index);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    m_code += get_float_texture_access(<span class="stringliteral">&quot;get_&quot;</span> + it-&gt;first, param.canvas_index);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (param.pixel_type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">                {</div>
<div class="line">                    m_code += get_normal_texture_access(<span class="stringliteral">&quot;get_&quot;</span> + it-&gt;first, param.canvas_index);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    check_success(!<span class="stringliteral">&quot;unsupported pixel type&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        m_code += <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// OpenGL code</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Struct representing a vertex of a scene object.</span></div>
<div class="line"><span class="keyword">struct </span>Vertex {</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> position;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> normal;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tangent;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> binormal;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_2</a> tex_coord;</div>
<div class="line">    Vertex(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; p,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; n,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; t,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; b,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_2</a>&amp; uv)</div>
<div class="line">        : position(p), normal(n), tangent(t), binormal(b), tex_coord(uv)</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Initialize OpenGL and create a window with an associated OpenGL context.</span></div>
<div class="line"><span class="keyword">static</span> GLFWwindow *init_opengl(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> w, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h, <span class="keywordtype">bool</span> show_window)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Initialize GLFW</span></div>
<div class="line">    check_success(glfwInit());</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_SSBO</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">// SSBO requires GLSL 4.30</span></div>
<div class="line">    glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 4);</div>
<div class="line">    glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 3);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">// else GLSL 3.30 is sufficient</span></div>
<div class="line">    glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 3);</div>
<div class="line">    glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 3);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    glfwWindowHint(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);</div>
<div class="line">    glfwWindowHint(GLFW_OPENGL_FORWARD_COMPAT, GL_TRUE);</div>
<div class="line">    glfwWindowHint(GLFW_VISIBLE, show_window);</div>
<div class="line">    <span class="comment">// Create an OpenGL window and a context</span></div>
<div class="line">    GLFWwindow *window = glfwCreateWindow(</div>
<div class="line">        w, h, <span class="stringliteral">&quot;MDL Distilling Example&quot;</span>, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!window) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Error creating OpenGL window!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        terminate();</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Attach context to window</span></div>
<div class="line">    glfwMakeContextCurrent(window);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Initialize GLEW to get OpenGL extensions</span></div>
<div class="line">    GLenum res = glewInit();</div>
<div class="line">    <span class="keywordflow">if</span> (res != GLEW_OK) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;GLEW error: &quot;</span> &lt;&lt; glewGetErrorString(res) &lt;&lt; std::endl;</div>
<div class="line">        terminate();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    glEnable(GL_DEPTH_TEST);</div>
<div class="line">    glEnable(GL_TEXTURE_CUBE_MAP_SEAMLESS);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Enable VSync</span></div>
<div class="line">    glfwSwapInterval(1);</div>
<div class="line"></div>
<div class="line">    check_gl_success();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> window;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create a vertex array</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> create_vertex_array(</div>
<div class="line">    GLuint&amp; vao, GLuint&amp; vbo, <span class="keyword">const</span> GLvoid* vertices, GLsizei vertices_size)</div>
<div class="line">{</div>
<div class="line">    glGenVertexArrays(1, &amp;vao);</div>
<div class="line">    glBindVertexArray(vao);</div>
<div class="line"></div>
<div class="line">    glGenBuffers(1, &amp;vbo);</div>
<div class="line">    glBindBuffer(GL_ARRAY_BUFFER, vbo);</div>
<div class="line">    glBufferData(GL_ARRAY_BUFFER, vertices_size, vertices, GL_STATIC_DRAW);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create an index buffer</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> create_index_buffer(GLuint&amp; ebo, <span class="keyword">const</span> GLvoid* indices, GLsizei indices_size)</div>
<div class="line">{</div>
<div class="line">    glGenBuffers(1, &amp;ebo);</div>
<div class="line">    glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, ebo);</div>
<div class="line">    glBufferData(GL_ELEMENT_ARRAY_BUFFER, indices_size, indices, GL_STATIC_DRAW);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create an OpenGL texture</span></div>
<div class="line"><span class="keyword">static</span> GLuint create_gl_texture(GLenum target, GLsizei w, GLsizei h, GLenum format=GL_RGB,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span>* data=<span class="keyword">nullptr</span>,</div>
<div class="line">    GLenum min_filter = GL_LINEAR,</div>
<div class="line">    GLenum mag_filter = GL_LINEAR,</div>
<div class="line">    GLenum wrap_s = GL_CLAMP_TO_EDGE,</div>
<div class="line">    GLenum wrap_t = GL_CLAMP_TO_EDGE,</div>
<div class="line">    GLenum wrap_r = GL_CLAMP_TO_EDGE,</div>
<div class="line">    <span class="keywordtype">int</span> levels = 0)</div>
<div class="line">{</div>
<div class="line">    GLuint id;</div>
<div class="line">    glGenTextures(1, &amp;<span class="keywordtype">id</span>);</div>
<div class="line">    glBindTexture(target, <span class="keywordtype">id</span>);</div>
<div class="line"></div>
<div class="line">    GLenum int_format;</div>
<div class="line">    <span class="keywordflow">switch</span> (format) {</div>
<div class="line">        <span class="keywordflow">case</span> GL_RED:</div>
<div class="line">            int_format = GL_R32F;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> GL_RGB:</div>
<div class="line">            int_format = GL_RGB32F;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">case</span> GL_RGBA:</div>
<div class="line">            int_format = GL_RGBA32F;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(target == GL_TEXTURE_CUBE_MAP)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 6; ++i)</div>
<div class="line">        {</div>
<div class="line">            glTexImage2D(GL_TEXTURE_CUBE_MAP_POSITIVE_X + i, 0, int_format,</div>
<div class="line">                w, h, 0, format, GL_FLOAT, data);</div>
<div class="line">        }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">if</span> (levels)</div>
<div class="line">        {</div>
<div class="line">            glTexStorage2D(GL_TEXTURE_2D, levels, int_format, w, h);</div>
<div class="line">            glTexSubImage2D(GL_TEXTURE_2D, 0, 0, 0, w, h, format, GL_FLOAT, data);</div>
<div class="line">            glGenerateMipmap(GL_TEXTURE_2D);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            glTexImage2D(target, 0, int_format,</div>
<div class="line">                w, h, 0, format, GL_FLOAT, data);</div>
<div class="line">    }</div>
<div class="line">    glTexParameteri(target, GL_TEXTURE_WRAP_S, wrap_s);</div>
<div class="line">    glTexParameteri(target, GL_TEXTURE_WRAP_T, wrap_t);</div>
<div class="line">    <span class="keywordflow">if</span> (target == GL_TEXTURE_CUBE_MAP)</div>
<div class="line">        glTexParameteri(target, GL_TEXTURE_WRAP_R, wrap_r);</div>
<div class="line">    glTexParameteri(target, GL_TEXTURE_MIN_FILTER, min_filter);</div>
<div class="line">    glTexParameteri(target, GL_TEXTURE_MAG_FILTER, mag_filter);</div>
<div class="line"></div>
<div class="line">    check_gl_success();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> GLenum get_gl_format(<span class="keyword">const</span> <span class="keywordtype">char</span> *pixel_type)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(pixel_type, <span class="stringliteral">&quot;Float32&quot;</span>) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> GL_RED;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(pixel_type, <span class="stringliteral">&quot;Color&quot;</span>) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> GL_RGBA;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> GL_RGB;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert the given canvas to an OpenGL texture</span></div>
<div class="line"><span class="keyword">static</span> GLuint load_gl_texture(</div>
<div class="line">    GLenum target, <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> canvas, <span class="keywordtype">int</span> levels = 0)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!canvas)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>GLuint<span class="keyword">&gt;</span>(-1);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITile&gt;</a> tile(canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">    <span class="keyword">const</span> GLenum format = get_gl_format(canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#ab36d6bebb85da08e907eadbe7542c658" title="Returns the pixel type used by the canvas. ">get_type</a>());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> create_gl_texture(target, canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#acd28f45b9d22b1cd1e24043aeda5c065" title="Returns the resolution of the canvas in x direction. ">get_resolution_x</a>(), canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#a51874ccdb54f6e03ff325b01d98dfefb" title="Returns the resolution of the canvas in y direction. ">get_resolution_y</a>(),</div>
<div class="line">        format,</div>
<div class="line">        tile-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITile.html#a0c4de1ae0441a464da1fc605369469f5" title="Returns a pointer to the raw tile data according to the pixel type of the tile. ">get_data</a>(),</div>
<div class="line">        levels ? GL_LINEAR_MIPMAP_LINEAR : GL_LINEAR,</div>
<div class="line">        GL_LINEAR, GL_REPEAT, GL_REPEAT, GL_REPEAT, levels);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create the shader program with a fragment shader</span></div>
<div class="line"><span class="keyword">static</span> GLuint create_shader_program(</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; vertex_program,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; fragment_program)</div>
<div class="line">{</div>
<div class="line">    GLint success;</div>
<div class="line"></div>
<div class="line">    GLuint program = glCreateProgram();</div>
<div class="line"></div>
<div class="line">    add_shader(GL_VERTEX_SHADER, vertex_program, program);</div>
<div class="line">    add_shader(GL_FRAGMENT_SHADER, fragment_program, program);</div>
<div class="line"></div>
<div class="line">    glLinkProgram(program);</div>
<div class="line">    glGetProgramiv(program, GL_LINK_STATUS, &amp;success);</div>
<div class="line">    <span class="keywordflow">if</span> (!success) {</div>
<div class="line">        dump_program_info(program, <span class="stringliteral">&quot;Error linking the shader program: &quot;</span>);</div>
<div class="line">        terminate();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    check_gl_success();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> program;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Class wrapping an OpenGL shader program</span></div>
<div class="line"><span class="keyword">class </span>Shader_program</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">    Shader_program(<span class="keyword">const</span> std::string&amp; vertex_shader_file, <span class="keyword">const</span> std::string&amp; fragment_shader_file)</div>
<div class="line">    {</div>
<div class="line">        m_program = create_shader_program(</div>
<div class="line">            read_text_file(vertex_shader_file),</div>
<div class="line">            read_text_file(fragment_shader_file));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Shader_program() : m_program(-1) {</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> ~Shader_program()</div>
<div class="line">    {</div>
<div class="line">        glDeleteProgram(m_program);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> bind_textures()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> make_current()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        glUseProgram(m_program);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> set_float(<span class="keyword">const</span> <span class="keywordtype">char</span>* argument, <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> value)</div>
<div class="line">    {</div>
<div class="line">        GLint location = glGetUniformLocation(m_program, argument);</div>
<div class="line">        <span class="keywordflow">if</span> (location &gt;= 0)</div>
<div class="line">            glUniform1f(location, value);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> set_int(<span class="keyword">const</span> <span class="keywordtype">char</span>* argument, <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> value)</div>
<div class="line">    {</div>
<div class="line">        GLint location = glGetUniformLocation(m_program, argument);</div>
<div class="line">        <span class="keywordflow">if</span> (location &gt;= 0)</div>
<div class="line">            glUniform1i(location, value);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> set_vector3(<span class="keyword">const</span> <span class="keywordtype">char</span>* argument, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; value)</div>
<div class="line">    {</div>
<div class="line">        GLint location = glGetUniformLocation(m_program, argument);</div>
<div class="line">        <span class="keywordflow">if</span> (location &gt;= 0)</div>
<div class="line">            glUniform3fv(location, 1, value.<a class="code" href="classmi_1_1math_1_1Vector.html#a3bf09bd1ab4f6b1965bd0a3a4cf0eaa3" title="Returns the pointer to the first vector element. ">begin</a>());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> set_matrix(<span class="keyword">const</span> <span class="keywordtype">char</span>* argument, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a>&amp; value)</div>
<div class="line">    {</div>
<div class="line">        GLint location = glGetUniformLocation(m_program, argument);</div>
<div class="line">        <span class="keywordflow">if</span>(location &gt;= 0)</div>
<div class="line">            glUniformMatrix4fv(location, 1, GL_FALSE, value.<a class="code" href="classmi_1_1math_1_1Matrix.html#ad7d35176955ad51c89b8fea05d24b7b5" title="Returns the pointer to the first matrix element. ">begin</a>());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> set_vertex_attrib_float(<span class="keyword">const</span> <span class="keywordtype">char</span>* arg, GLsizei size, GLsizei stride, GLsizei offset)</div>
<div class="line">    {</div>
<div class="line">        GLint location = glGetAttribLocation(m_program, arg);</div>
<div class="line">        <span class="keywordflow">if</span> (location &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        glEnableVertexAttribArray(location);</div>
<div class="line">        glVertexAttribPointer(</div>
<div class="line">            location, size, GL_FLOAT, GL_FALSE, stride,</div>
<div class="line">            reinterpret_cast&lt;const void*&gt;(<span class="keywordtype">size_t</span>(offset)));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line"></div>
<div class="line">    GLuint m_program;</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    Shader_program(<span class="keyword">const</span> Shader_program&amp; other) = <span class="keyword">delete</span>;</div>
<div class="line"></div>
<div class="line">    Shader_program&amp; operator=(<span class="keyword">const</span> Shader_program&amp;) = <span class="keyword">delete</span>;</div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Our U4-like PBR shader</span></div>
<div class="line"><span class="keyword">class </span>Mdl_pbr_shader : <span class="keyword">public</span> Shader_program</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// Constructor</span></div>
<div class="line">    Mdl_pbr_shader(</div>
<div class="line">        <span class="keyword">const</span> Mdl_sdk_state&amp; state,</div>
<div class="line">        Mdl_ue4* mdl_ue4,</div>
<div class="line">        GLuint irradiance_map,</div>
<div class="line">        GLuint refl_map,</div>
<div class="line">        GLuint brdf_lut_map)</div>
<div class="line"></div>
<div class="line">        : m_irradiance_map(irradiance_map)</div>
<div class="line">        , m_refl_map(refl_map)</div>
<div class="line">        , m_brdf_lut_map(brdf_lut_map)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Setup GLSL programs</span></div>
<div class="line">        <span class="comment">// Get fragment code generated from MDL expressions</span></div>
<div class="line">        std::string fragment_code = mdl_ue4-&gt;get_code();</div>
<div class="line">        <span class="comment">// Add main fragment shader</span></div>
<div class="line">        fragment_code += read_text_file(</div>
<div class="line">            mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;example_distilling_glsl.frag&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DUMP_GLSL</span></div>
<div class="line"><span class="preprocessor"></span>        std::fstream file;</div>
<div class="line">        file.open(<span class="stringliteral">&quot;glsl_dump.frag&quot;</span>, std::fstream::out);</div>
<div class="line">        file &lt;&lt; fragment_code;</div>
<div class="line">        file.close();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// Compile and link shaders</span></div>
<div class="line">        m_program = create_shader_program(read_text_file(</div>
<div class="line">            mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;example_distilling_glsl.vert&quot;</span>),</div>
<div class="line">            fragment_code);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Assign texture slots for IBL maps</span></div>
<div class="line">        make_current();</div>
<div class="line">        set_int(<span class="stringliteral">&quot;irradiance_map&quot;</span>, 0);</div>
<div class="line">        set_int(<span class="stringliteral">&quot;refl_map&quot;</span>, 1);</div>
<div class="line">        set_int(<span class="stringliteral">&quot;brdf_lut&quot;</span>, 2);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Upload RO data</span></div>
<div class="line">        set_mdl_readonly_data(mdl_ue4);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Upload all textures referenced by the target code (the compiled material expressions)</span></div>
<div class="line">        <span class="comment">// to the gpu and store their handles</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Skip invalid texture (always at index 0)</span></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 1; i &lt; mdl_ue4-&gt;get_texture_count(); ++i)</div>
<div class="line">        {</div>
<div class="line">            m_mdl_textures.push_back(</div>
<div class="line">                load_gl_texture(GL_TEXTURE_2D,</div>
<div class="line">                    mi::base::make_handle&lt;const mi::neuraylib::ICanvas&gt;(mdl_ue4-&gt;get_texture(i))));</div>
<div class="line">            <span class="comment">// first 3 indices are reserved for IBL maps</span></div>
<div class="line">            std::string name = <span class="stringliteral">&quot;mdl_textures_2d[&quot;</span> + to_string(i-1) + <span class="stringliteral">&quot;]&quot;</span>;</div>
<div class="line">            set_int(name.c_str(), <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>(i + 2));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">delete</span> mdl_ue4;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Destructor</span></div>
<div class="line">    <span class="keyword">virtual</span> ~Mdl_pbr_shader()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (m_buffer_objects.size() &gt; 0)</div>
<div class="line">            glDeleteBuffers(GLsizei(m_buffer_objects.size()), &amp;m_buffer_objects[0]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (m_mdl_textures.size() &gt; 0)</div>
<div class="line">            glDeleteTextures(GLsizei(m_mdl_textures.size()), &amp;m_mdl_textures[0]);</div>
<div class="line"></div>
<div class="line">        check_gl_success();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> bind_textures()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        glActiveTexture(GL_TEXTURE0);</div>
<div class="line">        glBindTexture(GL_TEXTURE_CUBE_MAP, m_irradiance_map);</div>
<div class="line"></div>
<div class="line">        glActiveTexture(GL_TEXTURE1);</div>
<div class="line">        glBindTexture(GL_TEXTURE_CUBE_MAP, m_refl_map);</div>
<div class="line"></div>
<div class="line">        glActiveTexture(GL_TEXTURE2);</div>
<div class="line">        glBindTexture(GL_TEXTURE_2D, m_brdf_lut_map);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;m_mdl_textures.size(); ++i)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// first 3 indices are reserved for IBL maps</span></div>
<div class="line">            glActiveTexture(GLenum(GL_TEXTURE0 + i + 3));</div>
<div class="line">            glBindTexture(GL_TEXTURE_2D, m_mdl_textures[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// Sets the read-only data segments in the current OpenGL program object.</span></div>
<div class="line">    <span class="keywordtype">void</span> set_mdl_readonly_data(</div>
<div class="line">        <span class="keyword">const</span> Mdl_ue4* mdl_ue4)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> num_uniforms = mdl_ue4-&gt;get_ro_data_segment_count();</div>
<div class="line">        <span class="keywordflow">if</span> (num_uniforms == 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_SSBO</span></div>
<div class="line"><span class="preprocessor"></span>        GLuint next_storage_block_binding = 0u;</div>
<div class="line">        m_buffer_objects.resize(num_uniforms);</div>
<div class="line"></div>
<div class="line">        glGenBuffers(GLsizei(num_uniforms), &amp;m_buffer_objects[0]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; num_uniforms; ++i) {</div>
<div class="line">            <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> segment_size = mdl_ue4-&gt;get_ro_data_segment_size(i);</div>
<div class="line">            <span class="keywordtype">char</span> <span class="keyword">const</span>* segment_data = mdl_ue4-&gt;get_ro_data_segment_data(i);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DUMP_GLSL</span></div>
<div class="line"><span class="preprocessor"></span>            std::cout &lt;&lt; <span class="stringliteral">&quot;Dump ro segment data &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; \&quot;&quot;</span></div>
<div class="line">                &lt;&lt; mdl_ue4-&gt;get_ro_data_segment_name(i) &lt;&lt; <span class="stringliteral">&quot;\&quot; (size = &quot;</span></div>
<div class="line">                &lt;&lt; segment_size &lt;&lt; <span class="stringliteral">&quot;):\n&quot;</span> &lt;&lt; std::hex;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 16 &amp;&amp; j &lt; segment_size; ++j) {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;0x&quot;</span> &lt;&lt; (<span class="keywordtype">unsigned</span> int)(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) segment_data[j] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            std::cout &lt;&lt; std::dec &lt;&lt; std::endl;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            glBindBuffer(GL_SHADER_STORAGE_BUFFER, m_buffer_objects[i]);</div>
<div class="line">            glBufferData(</div>
<div class="line">                GL_SHADER_STORAGE_BUFFER, GLsizeiptr(segment_size), segment_data, GL_STATIC_DRAW);</div>
<div class="line"></div>
<div class="line">            GLuint block_index = glGetProgramResourceIndex(</div>
<div class="line">                m_program, GL_SHADER_STORAGE_BLOCK,</div>
<div class="line">                mdl_ue4-&gt;get_ro_data_segment_name(i));</div>
<div class="line">            glShaderStorageBlockBinding(m_program, block_index, next_storage_block_binding);</div>
<div class="line">            glBindBufferBase(</div>
<div class="line">                GL_SHADER_STORAGE_BUFFER,</div>
<div class="line">                next_storage_block_binding,</div>
<div class="line">                m_buffer_objects[i]);</div>
<div class="line"></div>
<div class="line">            ++next_storage_block_binding;</div>
<div class="line"></div>
<div class="line">            check_gl_success();</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>        std::vector&lt;char const*&gt; uniform_names;</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; num_uniforms; ++i) {</div>
<div class="line"><span class="preprocessor">#ifdef DUMP_GLSL</span></div>
<div class="line"><span class="preprocessor"></span>            <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> segment_size = mdl_ue4-&gt;get_ro_data_segment_size(i);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span>* segment_data = mdl_ue4-&gt;get_ro_data_segment_data(i);</div>
<div class="line"></div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Dump ro segment data &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; \&quot;&quot;</span></div>
<div class="line">                &lt;&lt; mdl_ue4-&gt;get_ro_data_segment_name(i) &lt;&lt; <span class="stringliteral">&quot;\&quot; (size = &quot;</span></div>
<div class="line">                &lt;&lt; segment_size &lt;&lt; <span class="stringliteral">&quot;):\n&quot;</span> &lt;&lt; std::hex;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16 &amp;&amp; i &lt; segment_size; ++i) {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;0x&quot;</span> &lt;&lt; (<span class="keywordtype">unsigned</span> int)(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)segment_data[i] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            std::cout &lt;&lt; std::dec &lt;&lt; std::endl;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            uniform_names.push_back(mdl_ue4-&gt;get_ro_data_segment_name(i));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        std::vector&lt;GLuint&gt; uniform_indices(num_uniforms, 0);</div>
<div class="line">        glGetUniformIndices(</div>
<div class="line">            m_program, GLsizei(num_uniforms), &amp;uniform_names[0], &amp;uniform_indices[0]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; num_uniforms; ++i) {</div>
<div class="line">            <span class="comment">// uniforms may have been removed, if they were not used</span></div>
<div class="line">            <span class="keywordflow">if</span> (uniform_indices[i] == GL_INVALID_INDEX)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            GLint uniform_type = 0;</div>
<div class="line">            GLuint index = GLuint(uniform_indices[i]);</div>
<div class="line">            glGetActiveUniformsiv(m_program, 1, &amp;index, GL_UNIFORM_TYPE, &amp;uniform_type);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DUMP_GLSL</span></div>
<div class="line"><span class="preprocessor"></span>            std::cout &lt;&lt; <span class="stringliteral">&quot;Uniform type of &quot;</span> &lt;&lt; uniform_names[i]</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; uniform_type &lt;&lt; std::dec &lt;&lt; std::endl;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> segment_size = mdl_ue4-&gt;get_ro_data_segment_size(i);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span>* segment_data = mdl_ue4-&gt;get_ro_data_segment_data(i);</div>
<div class="line"></div>
<div class="line">            GLint uniform_location = glGetUniformLocation(m_program, uniform_names[i]);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">switch</span> (uniform_type) {</div>
<div class="line"></div>
<div class="line">                <span class="comment">// For bool, the data has to be converted to int, first</span></div>
<div class="line"><span class="preprocessor">#define CASE_TYPE_BOOL(type, func, num)                            \</span></div>
<div class="line"><span class="preprocessor">    case type: {                                                   \</span></div>
<div class="line"><span class="preprocessor">        GLint *buf = new GLint[segment_size];                      \</span></div>
<div class="line"><span class="preprocessor">        for (mi::Size j = 0; j &lt; segment_size; ++j)                \</span></div>
<div class="line"><span class="preprocessor">            buf[j] = GLint(segment_data[j]);                       \</span></div>
<div class="line"><span class="preprocessor">        func(uniform_location, GLsizei(segment_size / num), buf);  \</span></div>
<div class="line"><span class="preprocessor">        delete[] buf;                                              \</span></div>
<div class="line"><span class="preprocessor">        break;                                                     \</span></div>
<div class="line"><span class="preprocessor">    }</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">                CASE_TYPE_BOOL(GL_BOOL, glUniform1iv, 1)</div>
<div class="line">                CASE_TYPE_BOOL(GL_BOOL_VEC2, glUniform2iv, 2)</div>
<div class="line">                CASE_TYPE_BOOL(GL_BOOL_VEC3, glUniform3iv, 3)</div>
<div class="line">                CASE_TYPE_BOOL(GL_BOOL_VEC4, glUniform4iv, 4)</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CASE_TYPE(type, func, num, elemtype)                                      \</span></div>
<div class="line"><span class="preprocessor">    case type:                                                                    \</span></div>
<div class="line"><span class="preprocessor">        func(uniform_location, GLsizei(segment_size / (num * sizeof(elemtype))),  \</span></div>
<div class="line"><span class="preprocessor">            (const elemtype*)segment_data);                                       \</span></div>
<div class="line"><span class="preprocessor">        break</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">                CASE_TYPE(GL_INT, glUniform1iv, 1, GLint);</div>
<div class="line">                CASE_TYPE(GL_INT_VEC2, glUniform2iv, 2, GLint);</div>
<div class="line">                CASE_TYPE(GL_INT_VEC3, glUniform3iv, 3, GLint);</div>
<div class="line">                CASE_TYPE(GL_INT_VEC4, glUniform4iv, 4, GLint);</div>
<div class="line">                CASE_TYPE(GL_FLOAT, glUniform1fv, 1, GLfloat);</div>
<div class="line">                CASE_TYPE(GL_FLOAT_VEC2, glUniform2fv, 2, GLfloat);</div>
<div class="line">                CASE_TYPE(GL_FLOAT_VEC3, glUniform3fv, 3, GLfloat);</div>
<div class="line">                CASE_TYPE(GL_FLOAT_VEC4, glUniform4fv, 4, GLfloat);</div>
<div class="line">                CASE_TYPE(GL_DOUBLE, glUniform1dv, 1, GLdouble);</div>
<div class="line">                CASE_TYPE(GL_DOUBLE_VEC2, glUniform2dv, 2, GLdouble);</div>
<div class="line">                CASE_TYPE(GL_DOUBLE_VEC3, glUniform3dv, 3, GLdouble);</div>
<div class="line">                CASE_TYPE(GL_DOUBLE_VEC4, glUniform4dv, 4, GLdouble);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CASE_TYPE_MAT(type, func, num, elemtype)                                  \</span></div>
<div class="line"><span class="preprocessor">    case type:                                                                    \</span></div>
<div class="line"><span class="preprocessor">        func(uniform_location, GLsizei(segment_size / (num * sizeof(elemtype))),  \</span></div>
<div class="line"><span class="preprocessor">            false, (const elemtype*)segment_data);                                \</span></div>
<div class="line"><span class="preprocessor">        break</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT2_ARB, glUniformMatrix2fv, 4, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT2x3, glUniformMatrix2x3fv, 6, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT3x2, glUniformMatrix3x2fv, 6, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT2x4, glUniformMatrix2x4fv, 8, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT4x2, glUniformMatrix4x2fv, 8, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT3_ARB, glUniformMatrix3fv, 9, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT3x4, glUniformMatrix3x4fv, 12, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT4x3, glUniformMatrix4x3fv, 12, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_FLOAT_MAT4_ARB, glUniformMatrix4fv, 16, GLfloat);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT2, glUniformMatrix2dv, 4, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT2x3, glUniformMatrix2x3dv, 6, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT3x2, glUniformMatrix3x2dv, 6, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT2x4, glUniformMatrix2x4dv, 8, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT4x2, glUniformMatrix4x2dv, 8, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT3, glUniformMatrix3dv, 9, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT3x4, glUniformMatrix3x4dv, 12, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT4x3, glUniformMatrix4x3dv, 12, GLdouble);</div>
<div class="line">                CASE_TYPE_MAT(GL_DOUBLE_MAT4, glUniformMatrix4dv, 16, GLdouble);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                std::cerr &lt;&lt; <span class="stringliteral">&quot;Unsupported uniform type: 0x&quot;</span></div>
<div class="line">                    &lt;&lt; std::hex &lt;&lt; uniform_type &lt;&lt; std::dec &lt;&lt; std::endl;</div>
<div class="line">                terminate();</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            check_gl_success();</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"></div>
<div class="line">    <span class="comment">// IBL maps</span></div>
<div class="line">    GLuint m_irradiance_map;</div>
<div class="line">    GLuint m_refl_map;</div>
<div class="line">    GLuint m_brdf_lut_map;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// mdl expression textures</span></div>
<div class="line">    std::vector&lt;GLuint&gt; m_mdl_textures;</div>
<div class="line"></div>
<div class="line">    std::vector&lt;GLuint&gt; m_buffer_objects;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Opengl Mesh base class</span></div>
<div class="line"><span class="keyword">class </span>Mesh</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> draw() = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> ~Mesh() {}</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> bind_shader(Shader_program*)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Simple sphere</span></div>
<div class="line"><span class="keyword">class </span>Sphere : <span class="keyword">public</span> Mesh</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"></div>
<div class="line">    Sphere(<span class="keyword">const</span> <span class="keywordtype">float</span> radius, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> slices, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stacks)</div>
<div class="line">    {</div>
<div class="line">        std::vector&lt;unsigned int&gt; indices;</div>
<div class="line">        std::vector&lt;Vertex&gt; vertices;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> step_phi = (float) (2.0 * M_PI / slices);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> step_theta = (float) (M_PI / stacks);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt;= stacks; ++i) {</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> theta = step_theta * float(i);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> sin_t = <a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(theta);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> cos_t = <a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(theta);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt;= slices; ++j) {</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> phi = step_phi * float(j);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> sin_p = <a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(phi);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> cos_p = <a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(phi);</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> p(sin_p * sin_t, cos_t, cos_p * sin_t);</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_2</a> uv(</div>
<div class="line">                    2.0f * <span class="keywordtype">float</span>(j) / <span class="keywordtype">float</span>(slices), 1.0f - <span class="keywordtype">float</span>(i) / <span class="keywordtype">float</span>(stacks));</div>
<div class="line"></div>
<div class="line">                <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tangent_u = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(cos_p, 0.0f, -sin_p);</div>
<div class="line">                <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tangent_v = <a class="code" href="group__mi__math__vector.html#ga2601053c0aee5b7c8eabbd62dcdab77f" title="Returns the two-times-two determinant result for the two vectors lhs and rhs. ">cross</a>(p, tangent_u);</div>
<div class="line"></div>
<div class="line">                vertices.push_back(Vertex(p * radius, p, tangent_u, tangent_v, uv));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; stacks; ++i) {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; slices; ++j) {</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p0 = i * (slices + 1) + j;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p1 = p0 + 1;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p2 = p0 + slices + 1;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p3 = p2 + 1;</div>
<div class="line"></div>
<div class="line">                indices.push_back(p0);</div>
<div class="line">                indices.push_back(p1);</div>
<div class="line">                indices.push_back(p2);</div>
<div class="line"></div>
<div class="line">                indices.push_back(p1);</div>
<div class="line">                indices.push_back(p3);</div>
<div class="line">                indices.push_back(p2);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        create_vertex_array(m_vao, m_vbo, vertices.data(),</div>
<div class="line">            (GLsizei) (vertices.size() * <span class="keyword">sizeof</span>(Vertex)));</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        create_index_buffer(m_ebo, indices.data(), (GLsizei) (</div>
<div class="line">            indices.size() * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int)));</div>
<div class="line"></div>
<div class="line">        m_nindices = (GLuint) indices.size();</div>
<div class="line"></div>
<div class="line">        check_gl_success();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> ~Sphere()</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// cleanup</span></div>
<div class="line">        glDeleteVertexArrays(1, &amp;m_vao);</div>
<div class="line">        glDeleteBuffers(1, &amp;m_vbo);</div>
<div class="line">        glDeleteBuffers(1, &amp;m_ebo);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> bind_shader(Shader_program* program)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// set locations of vertex shader inputs</span></div>
<div class="line"></div>
<div class="line">        glBindBuffer(GL_ARRAY_BUFFER, m_vbo);</div>
<div class="line"></div>
<div class="line">        program-&gt;make_current();</div>
<div class="line">        program-&gt;set_vertex_attrib_float(</div>
<div class="line">            <span class="stringliteral">&quot;Position&quot;</span>, 3, <span class="keyword">sizeof</span>(Vertex), 0);</div>
<div class="line">        program-&gt;set_vertex_attrib_float(</div>
<div class="line">            <span class="stringliteral">&quot;Normal&quot;</span>, 3, <span class="keyword">sizeof</span>(Vertex), <span class="keyword">sizeof</span>(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>));</div>
<div class="line">        program-&gt;set_vertex_attrib_float(</div>
<div class="line">            <span class="stringliteral">&quot;Tangent&quot;</span>, 3, <span class="keyword">sizeof</span>(Vertex), <span class="keyword">sizeof</span>(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>) * 2);</div>
<div class="line">        program-&gt;set_vertex_attrib_float(</div>
<div class="line">            <span class="stringliteral">&quot;Binormal&quot;</span>, 3, <span class="keyword">sizeof</span>(Vertex), <span class="keyword">sizeof</span>(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>) * 3);</div>
<div class="line">        program-&gt;set_vertex_attrib_float(</div>
<div class="line">            <span class="stringliteral">&quot;TexCoord&quot;</span>, 2, <span class="keyword">sizeof</span>(Vertex), <span class="keyword">sizeof</span>(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>) * 4);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> draw()</div>
<div class="line">    {</div>
<div class="line">        glBindVertexArray(m_vao);</div>
<div class="line">        glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, m_ebo);</div>
<div class="line"></div>
<div class="line">        glDrawElements(</div>
<div class="line">            GL_TRIANGLES,      <span class="comment">// mode</span></div>
<div class="line">            m_nindices,        <span class="comment">// count</span></div>
<div class="line">            GL_UNSIGNED_INT,   <span class="comment">// type</span></div>
<div class="line">            (<span class="keywordtype">void</span>*)0           <span class="comment">// element array buffer offset</span></div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"></div>
<div class="line">    GLuint m_vbo, m_vao, m_ebo;</div>
<div class="line">    GLuint m_nindices;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Screen aligned quad</span></div>
<div class="line"><span class="keyword">class </span>Screen_aligned_quad : <span class="keyword">public</span> Mesh</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Screen_aligned_quad()</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> vertices1[] =</div>
<div class="line">        {</div>
<div class="line">            -1.f, -1.f, 1.0f,</div>
<div class="line">             1.f, -1.f, 1.0f,</div>
<div class="line">            -1.f,  1.f, 1.0f,</div>
<div class="line">             1.f, -1.f, 1.0f,</div>
<div class="line">             1.f,  1.f, 1.0f,</div>
<div class="line">            -1.f,  1.f, 1.0f</div>
<div class="line">        };</div>
<div class="line">        create_vertex_array(m_vao, m_vbo, vertices1, <span class="keyword">sizeof</span>(vertices1));</div>
<div class="line"></div>
<div class="line">        check_gl_success();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> bind_shader(Shader_program* program)</div>
<div class="line">    {</div>
<div class="line">        program-&gt;make_current();</div>
<div class="line">        program-&gt;set_vertex_attrib_float(<span class="stringliteral">&quot;Position&quot;</span>, 3, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3, 0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> draw()</div>
<div class="line">    {</div>
<div class="line">        glDisable(GL_DEPTH_TEST);</div>
<div class="line">        glBindVertexArray(m_vao);</div>
<div class="line">        glDrawArrays(GL_TRIANGLES, 0, 36);</div>
<div class="line"></div>
<div class="line">        glEnable(GL_DEPTH_TEST);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">   <span class="keyword">virtual</span>  ~Screen_aligned_quad()</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// cleanup</span></div>
<div class="line">        glDeleteVertexArrays(1, &amp;m_vao);</div>
<div class="line">        glDeleteBuffers(1, &amp;m_vbo);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    GLuint m_vao;</div>
<div class="line">    GLuint m_vbo;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert degree to radians</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__mi__base__types.html#gabc106f17f02868f6e096a5004868fc07" title="64-bit float. ">mi::Float64</a> deg_to_rad(<a class="code" href="group__mi__base__types.html#gabc106f17f02868f6e096a5004868fc07" title="64-bit float. ">mi::Float64</a> v)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> v * 3.1415926 / 180.;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// returns a perspective projection matrix</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> projection(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> fovy,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> aspect_ratio,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> near_plane,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> far_plane</div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a></div>
<div class="line">        y_scale = (<a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>) (1.0 / <a class="code" href="group__mi__math__color.html#ga705dee35e7e239b8ea0cf7761fb0b123" title="Returns a color with the elementwise tangent of the color c. ">tan</a>(deg_to_rad(fovy * 0.5))),</div>
<div class="line">        x_scale = y_scale / aspect_ratio,</div>
<div class="line">        frustum_length = far_plane - near_plane;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> p(0.f);</div>
<div class="line">    p.xx = x_scale;</div>
<div class="line">    p.yy = y_scale;</div>
<div class="line">    p.zz = -((far_plane + near_plane) / frustum_length);</div>
<div class="line">    p.wz = -((2 * near_plane * far_plane) / frustum_length);</div>
<div class="line">    p.zw = -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> p;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Generates the prefiltered glossy map as a cubemap with mipmaps for increasing roughness, see</span></div>
<div class="line"><span class="comment">// http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf</span></div>
<div class="line"><span class="keyword">static</span> GLuint prefilter_glossy(GLsizei w, GLsizei h, GLuint env_tex_id, GLuint env_accel_tex_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fbo, rbo;</div>
<div class="line">    glGenFramebuffers(1, &amp;fbo);</div>
<div class="line">    glGenRenderbuffers(1, &amp;rbo);</div>
<div class="line"></div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, fbo);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cubemap_id = create_gl_texture(</div>
<div class="line">        GL_TEXTURE_CUBE_MAP, w, h, GL_RGB, <span class="keyword">nullptr</span>, GL_LINEAR_MIPMAP_LINEAR);</div>
<div class="line">    glGenerateMipmap(GL_TEXTURE_CUBE_MAP);</div>
<div class="line"></div>
<div class="line">    Shader_program program(</div>
<div class="line">        mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;screen_aligned_quad.vert&quot;</span>,</div>
<div class="line">        mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;prefilter_glossy.frag&quot;</span>);</div>
<div class="line">    Screen_aligned_quad quad;</div>
<div class="line">    quad.bind_shader(&amp;program);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> proj = projection(90.f, 1.0, 0.1f, 10.f);</div>
<div class="line">    proj.<a class="code" href="classmi_1_1math_1_1Matrix.html#a128b3ba86117ee576f10df4ee89480bf" title="Inverts this matrix and returns success or failure. ">invert</a>();</div>
<div class="line">    program.make_current();</div>
<div class="line">    program.set_matrix(<span class="stringliteral">&quot;inv_proj&quot;</span>, proj);</div>
<div class="line"></div>
<div class="line">    glActiveTexture(GL_TEXTURE0);</div>
<div class="line">    glBindTexture(GL_TEXTURE_2D, env_tex_id);</div>
<div class="line">    program.set_int(<span class="stringliteral">&quot;env_tex&quot;</span>, 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (env_accel_tex_id) {</div>
<div class="line">        glActiveTexture(GL_TEXTURE1);</div>
<div class="line">        glBindTexture(GL_TEXTURE_2D, env_accel_tex_id);</div>
<div class="line">        program.set_int(<span class="stringliteral">&quot;env_accel_tex&quot;</span>, 1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> mv[6];</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> pos(0.0f, 0.0f, 0.0f);</div>
<div class="line">    mv[0].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>( 1.0f,  0.0f,  0.0f),  <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f,  0.0f));</div>
<div class="line">    mv[1].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(-1.0f,  0.0f,  0.0f),  <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f,  0.0f));</div>
<div class="line">    mv[2].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>( 0.0f,  1.0f,  0.0f),  <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f,  0.0f,  1.0f));</div>
<div class="line">    mv[3].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>( 0.0f, -1.0f,  0.0f),  <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f,  0.0f, -1.0f));</div>
<div class="line">    mv[4].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>( 0.0f,  0.0f,  1.0f),  <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f,  0.0f));</div>
<div class="line">    mv[5].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>( 0.0f,  0.0f, -1.0f),  <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f,  0.0f));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 6; ++i)</div>
<div class="line">        mv[i].<a class="code" href="group__mi__math__matrix.html#ga323b1112f90d125bed53f5bd268a5467" title="Returns the transpose of the matrix mat by exchanging rows and columns. ">transpose</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> miplevel_count = 5;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mip = 0; mip &lt; miplevel_count; ++mip)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mip_w = (<span class="keywordtype">unsigned</span> int) (w * <a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">std::pow</a>(0.5, mip));</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mip_h = (<span class="keywordtype">unsigned</span> int) (h * <a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">std::pow</a>(0.5, mip));</div>
<div class="line"></div>
<div class="line">        glBindRenderbuffer(GL_RENDERBUFFER, rbo);</div>
<div class="line">        glRenderbufferStorage(GL_RENDERBUFFER, GL_DEPTH_COMPONENT24, mip_w, mip_h);</div>
<div class="line">        glViewport(0, 0, mip_w, mip_h);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">float</span> roughness = (float) mip / (<span class="keywordtype">float</span>) (miplevel_count - 1);</div>
<div class="line">        program.set_float(<span class="stringliteral">&quot;roughness&quot;</span>, roughness);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 6; ++i)</div>
<div class="line">        {</div>
<div class="line">            glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0,</div>
<div class="line">                GL_TEXTURE_CUBE_MAP_POSITIVE_X + i, cubemap_id, mip);</div>
<div class="line"></div>
<div class="line">            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div>
<div class="line"></div>
<div class="line">            program.set_matrix(<span class="stringliteral">&quot;inv_mv&quot;</span>, mv[i]);</div>
<div class="line">            quad.draw();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, 0);</div>
<div class="line">    <span class="keywordflow">return</span> cubemap_id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// generates a diffuse irradiance map</span></div>
<div class="line"><span class="keyword">static</span> GLuint prefilter_diffuse(GLsizei w, GLsizei h, GLuint env_tex_id, GLuint env_accel_tex_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fbo, rbo;</div>
<div class="line">    glGenFramebuffers(1, &amp;fbo);</div>
<div class="line">    glGenRenderbuffers(1, &amp;rbo);</div>
<div class="line"></div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, fbo);</div>
<div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, rbo);</div>
<div class="line">    glRenderbufferStorage(GL_RENDERBUFFER, GL_DEPTH_COMPONENT24, w, h);</div>
<div class="line">    glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_RENDERBUFFER, rbo);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cubemap_id = create_gl_texture(GL_TEXTURE_CUBE_MAP, w, h);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> mv[6], proj = projection(90.f, 1.0, 0.1f, 10.f);</div>
<div class="line">    proj.<a class="code" href="classmi_1_1math_1_1Matrix.html#a128b3ba86117ee576f10df4ee89480bf" title="Inverts this matrix and returns success or failure. ">invert</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> pos(0.0f, 0.0f, 0.0f);</div>
<div class="line">    mv[0].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(1.0f, 0.0f, 0.0f), <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f, 0.0f));</div>
<div class="line">    mv[1].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(-1.0f, 0.0f, 0.0f), <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f, 0.0f));</div>
<div class="line">    mv[2].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, 1.0f, 0.0f), <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, 0.0f, 1.0f));</div>
<div class="line">    mv[3].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f, 0.0f), <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, 0.0f, -1.0f));</div>
<div class="line">    mv[4].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, 0.0f, 1.0f), <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f, 0.0f));</div>
<div class="line">    mv[5].<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, 0.0f, -1.0f), <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(0.0f, -1.0f, 0.0f));</div>
<div class="line"></div>
<div class="line">    Shader_program program(</div>
<div class="line">        mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;screen_aligned_quad.vert&quot;</span>,</div>
<div class="line">        mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;prefilter_diffuse.frag&quot;</span>);</div>
<div class="line">    Screen_aligned_quad quad;</div>
<div class="line">    quad.bind_shader(&amp;program);</div>
<div class="line"></div>
<div class="line">    program.make_current();</div>
<div class="line">    program.set_matrix(<span class="stringliteral">&quot;inv_proj&quot;</span>, proj);</div>
<div class="line"></div>
<div class="line">    glActiveTexture(GL_TEXTURE0);</div>
<div class="line">    glBindTexture(GL_TEXTURE_2D, env_tex_id);</div>
<div class="line">    program.set_int(<span class="stringliteral">&quot;env_tex&quot;</span>, 0);</div>
<div class="line"></div>
<div class="line">    glActiveTexture(GL_TEXTURE1);</div>
<div class="line">    glBindTexture(GL_TEXTURE_2D, env_accel_tex_id);</div>
<div class="line">    program.set_int(<span class="stringliteral">&quot;env_accel_tex&quot;</span>, 1);</div>
<div class="line"></div>
<div class="line">    glViewport(0, 0, w, h);</div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, fbo);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 6; ++i)</div>
<div class="line">    {</div>
<div class="line">        glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0,</div>
<div class="line">               GL_TEXTURE_CUBE_MAP_POSITIVE_X + i, cubemap_id, 0);</div>
<div class="line">        GLenum DrawBuffers[1] = {GL_COLOR_ATTACHMENT0};</div>
<div class="line">        glDrawBuffers(1, DrawBuffers);</div>
<div class="line"></div>
<div class="line">        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div>
<div class="line">        mv[i].<a class="code" href="classmi_1_1math_1_1Matrix.html#a9a8f2a510a13772354cec7c691d36075" title="Transposes this matrix by exchanging rows and columns. ">transpose</a>();</div>
<div class="line">        program.set_matrix(<span class="stringliteral">&quot;inv_mv&quot;</span>, mv[i]);</div>
<div class="line">        quad.draw();</div>
<div class="line">    }</div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cubemap_id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create an off-screen render target</span></div>
<div class="line">GLuint create_offscreen_render_target(GLsizei w, GLsizei h, GLuint&amp; out_fb, GLuint&amp; out_rb)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create and setup texture</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tex_id = create_gl_texture(GL_TEXTURE_2D, w, h);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create and bind frame buffer and render buffer objects</span></div>
<div class="line">    glGenFramebuffers(1, &amp;out_fb);</div>
<div class="line">    glGenRenderbuffers(1, &amp;out_rb);</div>
<div class="line"></div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, out_fb);</div>
<div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, out_rb);</div>
<div class="line">    glRenderbufferStorage(GL_RENDERBUFFER, GL_DEPTH_COMPONENT24, w, h);</div>
<div class="line">    glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_RENDERBUFFER, out_rb);</div>
<div class="line">    glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, tex_id, 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> tex_id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Pre-integrate glossy brdf, see</span></div>
<div class="line"><span class="comment">// http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf</span></div>
<div class="line">GLuint integrate_brdf(GLsizei w, GLsizei h)</div>
<div class="line">{</div>
<div class="line">    Shader_program program(</div>
<div class="line">        mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;integrate_brdf.vert&quot;</span>,</div>
<div class="line">        mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;integrate_brdf.frag&quot;</span>);</div>
<div class="line">    Screen_aligned_quad quad;</div>
<div class="line">    GLuint fbo=0, rbo=0;</div>
<div class="line">    GLuint tex_id = create_offscreen_render_target(w, h, fbo, rbo);</div>
<div class="line">    <span class="comment">// Render screen aligned quad</span></div>
<div class="line">    glViewport(0, 0, w, h);</div>
<div class="line">    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div>
<div class="line">    quad.bind_shader(&amp;program);</div>
<div class="line">    quad.draw();</div>
<div class="line">    <span class="comment">// reset framebuffer</span></div>
<div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, 0);</div>
<div class="line"></div>
<div class="line">    glDeleteRenderbuffers(1, &amp;rbo);</div>
<div class="line">    glDeleteFramebuffers(1, &amp;fbo);</div>
<div class="line">    <span class="keywordflow">return</span> tex_id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Application logic</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Context structure for window callback functions.</span></div>
<div class="line"><span class="keyword">struct </span>Window_context</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, height;</div>
<div class="line">    <span class="keywordtype">bool</span>         moving;</div>
<div class="line">    <span class="keywordtype">double</span>       move_start_x, move_start_y;</div>
<div class="line">    <span class="keywordtype">double</span>       move_dx, move_dy;</div>
<div class="line">    <span class="keywordtype">int</span>          zoom;</div>
<div class="line">    <span class="keywordtype">int</span>          material;</div>
<div class="line">    <span class="keywordtype">bool</span>         bake;</div>
<div class="line">    <span class="keywordtype">float</span>        exposure;</div>
<div class="line">    <span class="keywordtype">bool</span>         event;</div>
<div class="line"></div>
<div class="line">    Window_context()</div>
<div class="line">        : width(1024), height(1024)</div>
<div class="line">        , moving(false)</div>
<div class="line">        , move_start_x(0.f), move_start_y(0.f)</div>
<div class="line">        , move_dx(0.f), move_dy(0.f)</div>
<div class="line">        , zoom(0)</div>
<div class="line">        , material(0)</div>
<div class="line">        , bake(true)</div>
<div class="line">        , exposure(0.0f)</div>
<div class="line">        , event(false)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// GLFW scroll callback</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_scroll(GLFWwindow *window, <span class="keywordtype">double</span> <span class="comment">/*xoffset*/</span>, <span class="keywordtype">double</span> yoffset)</div>
<div class="line">{</div>
<div class="line">    Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">    <span class="keywordflow">if</span> (yoffset &gt; 0.0) {</div>
<div class="line">        ctx-&gt;zoom++;</div>
<div class="line">        ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (yoffset &lt; 0.0) {</div>
<div class="line">        ctx-&gt;zoom--;</div>
<div class="line">        ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// GLFW callback handler for keyboard inputs.</span></div>
<div class="line"><span class="keywordtype">void</span> handle_key(GLFWwindow *window, <span class="keywordtype">int</span> key, <span class="keywordtype">int</span> <span class="comment">/*scancode*/</span>, <span class="keywordtype">int</span> action, <span class="keywordtype">int</span> <span class="comment">/*mods*/</span>)</div>
<div class="line">{</div>
<div class="line">    Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">    <span class="comment">// Handle key press events</span></div>
<div class="line">    <span class="keywordflow">if</span> (action == GLFW_PRESS) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (key) {</div>
<div class="line">            <span class="comment">// Escape closes the window</span></div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_ESCAPE:</div>
<div class="line">                glfwSetWindowShouldClose(window, GLFW_TRUE);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_RIGHT:</div>
<div class="line">                ++ctx-&gt;material;</div>
<div class="line">                ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_LEFT:</div>
<div class="line">                --ctx-&gt;material;</div>
<div class="line">                ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_UP:</div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_DOWN:</div>
<div class="line">                ctx-&gt;bake = !ctx-&gt;bake;</div>
<div class="line">                ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_KP_SUBTRACT:</div>
<div class="line">                ctx-&gt;exposure --;</div>
<div class="line">                ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> GLFW_KEY_KP_ADD:</div>
<div class="line">                ctx-&gt;exposure ++;</div>
<div class="line">                ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// GLFW mouse button callback</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_mouse_button(GLFWwindow *window, <span class="keywordtype">int</span> button, <span class="keywordtype">int</span> action, <span class="keywordtype">int</span> <span class="comment">/*mods*/</span>)</div>
<div class="line">{</div>
<div class="line">    Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">    <span class="keywordflow">if</span> (button == GLFW_MOUSE_BUTTON_LEFT) {</div>
<div class="line">        <span class="keywordflow">if</span> (action == GLFW_PRESS) {</div>
<div class="line">            ctx-&gt;moving = <span class="keyword">true</span>;</div>
<div class="line">            glfwGetCursorPos(window, &amp;ctx-&gt;move_start_x, &amp;ctx-&gt;move_start_y);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            ctx-&gt;moving = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// GLFW mouse position callback</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_mouse_pos(GLFWwindow *window, <span class="keywordtype">double</span> xpos, <span class="keywordtype">double</span> ypos)</div>
<div class="line">{</div>
<div class="line">    Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">    <span class="keywordflow">if</span> (ctx-&gt;moving)</div>
<div class="line">    {</div>
<div class="line">        ctx-&gt;move_dx += xpos - ctx-&gt;move_start_x;</div>
<div class="line">        ctx-&gt;move_dy += ypos - ctx-&gt;move_start_y;</div>
<div class="line">        ctx-&gt;move_start_x = xpos;</div>
<div class="line">        ctx-&gt;move_start_y = ypos;</div>
<div class="line">        ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// GLFW callback handler for framebuffer resize events (when window size or resolution changes).</span></div>
<div class="line"><span class="keywordtype">void</span> handle_framebuffer_size(GLFWwindow* window, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)</div>
<div class="line">{</div>
<div class="line">    Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(</div>
<div class="line">        glfwGetWindowUserPointer(window));</div>
<div class="line">    ctx-&gt;width = width;</div>
<div class="line">    ctx-&gt;height = height;</div>
<div class="line">    ctx-&gt;event = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">    glViewport(0, 0, width, height);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>Env_accel {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> alias;</div>
<div class="line">    <span class="keywordtype">float</span> q;</div>
<div class="line">    <span class="keywordtype">float</span> pdf;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Build alias map</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">float</span> build_alias_map(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> *data,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size,</div>
<div class="line">    Env_accel *accel)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// create qs (normalized)</span></div>
<div class="line">    <span class="keywordtype">float</span> sum = 0.0f;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; size; ++i)</div>
<div class="line">        sum += data[i];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; size; ++i)</div>
<div class="line">        accel[i].q = (static_cast&lt;float&gt;(size) * data[i] / sum);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create partition table</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *partition_table = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *<span class="keyword">&gt;</span>(</div>
<div class="line">        malloc(size * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)));</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s = 0u, large = size;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; size; ++i)</div>
<div class="line">        partition_table[(accel[i].q &lt; 1.0f) ? (s++) : (--large)] = accel[i].alias = i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create alias map</span></div>
<div class="line">    <span class="keywordflow">for</span> (s = 0; s &lt; large &amp;&amp; large &lt; size; ++s)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = partition_table[s], k = partition_table[large];</div>
<div class="line">        accel[j].alias = k;</div>
<div class="line">        accel[k].q += accel[j].q - 1.0f;</div>
<div class="line">        large = (accel[k].q &lt; 1.0f) ? (large + 1u) : large;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(partition_table);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> sum;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create environment map texture and acceleration data for importance sampling</span></div>
<div class="line"><span class="keyword">static</span> GLuint create_environment_accel_texture(</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> canvas)</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> rx = canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#acd28f45b9d22b1cd1e24043aeda5c065" title="Returns the resolution of the canvas in x direction. ">get_resolution_x</a>();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> ry = canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#a51874ccdb54f6e03ff325b01d98dfefb" title="Returns the resolution of the canvas in y direction. ">get_resolution_y</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITile&gt;</a> tile(canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> *pixels = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">float</span> *<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create importance sampling data</span></div>
<div class="line">    Env_accel *env_accel = <span class="keyword">static_cast&lt;</span>Env_accel *<span class="keyword">&gt;</span>(malloc(rx * ry * <span class="keyword">sizeof</span>(Env_accel)));</div>
<div class="line">    <span class="keywordtype">float</span> *importance_data = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span> *<span class="keyword">&gt;</span>(malloc(rx * ry * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)));</div>
<div class="line">    <span class="keywordtype">float</span> cos_theta0 = 1.0f;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> step_phi = float(2.0 * M_PI) / float(rx);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> step_theta = float(M_PI) / float(ry);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y = 0; y &lt; ry; ++y)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> theta1 = float(y + 1) * step_theta;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> cos_theta1 = <a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">std::cos</a>(theta1);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> area = (cos_theta0 - cos_theta1) * step_phi;</div>
<div class="line">        cos_theta0 = cos_theta1;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x = 0; x &lt; rx; ++x) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx = y * rx + x;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx3 =  idx * 3;</div>
<div class="line">            importance_data[idx] =</div>
<div class="line">                area * std::max(pixels[idx3], std::max(pixels[idx3 + 1], pixels[idx3 + 2]));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> inv_env_integral = 1.0f / build_alias_map(importance_data, rx * ry, env_accel);</div>
<div class="line">    free(importance_data);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; rx * ry; ++i) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx3 = i * 3;</div>
<div class="line">        env_accel[i].pdf =</div>
<div class="line">            std::max(pixels[idx3], std::max(pixels[idx3 + 1], pixels[idx3 + 2])) * inv_env_integral;</div>
<div class="line">    }</div>
<div class="line">    GLuint tex_id = create_gl_texture(GL_TEXTURE_2D, rx, ry,</div>
<div class="line">        GL_RGB, env_accel, GL_NEAREST, GL_NEAREST);</div>
<div class="line"></div>
<div class="line">    free(env_accel);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> tex_id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Initializes OpenGL, creates the shader program, sets up the scene</span></div>
<div class="line"><span class="comment">// and shows the window/renders to file.</span></div>
<div class="line"><span class="keywordtype">void</span> render_scene(</div>
<div class="line">    <span class="keyword">const</span> Mdl_sdk_state&amp; state,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;<a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> &gt;</div>
<div class="line">     &amp; distilled_materials,</div>
<div class="line">    <span class="keyword">const</span> Options&amp; options)</div>
<div class="line">{</div>
<div class="line">    check_success(distilled_materials.size());</div>
<div class="line"></div>
<div class="line">    Window_context window_context;</div>
<div class="line">    window_context.bake = options.bake;</div>
<div class="line">    window_context.exposure = options.exposure;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> exposure_scale = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(<a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(2.0, options.exposure));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Init OpenGL window and setup event callbacks</span></div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Initializing OpenGL ...\n&quot;</span>);</div>
<div class="line">    GLFWwindow *window = init_opengl(</div>
<div class="line">        window_context.width, window_context.height, options.show_window);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (options.show_window)</div>
<div class="line">    {</div>
<div class="line">        glfwSetWindowUserPointer(window, &amp;window_context);</div>
<div class="line">        glfwSetKeyCallback(window, handle_key);</div>
<div class="line">        glfwSetFramebufferSizeCallback(window, handle_framebuffer_size);</div>
<div class="line">        glfwSetScrollCallback(window, handle_scroll);</div>
<div class="line">        glfwSetCursorPosCallback(window, handle_mouse_pos);</div>
<div class="line">        glfwSetMouseButtonCallback(window, handle_mouse_button);</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Initializing OpenGL done.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get image API</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api(</div>
<div class="line">        state.mdl_sdk-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load environment texture and compute IBL maps</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;Generating maps ...\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> env_tex_canvas =</div>
<div class="line">        load_image_from_file(image_api.get(), state.transaction.get(), options.hdrfile.c_str());</div>
<div class="line"></div>
<div class="line">    GLuint env_accel_tex_id = create_environment_accel_texture(env_tex_canvas);</div>
<div class="line"></div>
<div class="line">    GLuint env_tex_id = load_gl_texture(GL_TEXTURE_2D, env_tex_canvas);</div>
<div class="line"></div>
<div class="line">    GLuint iblmap_id = prefilter_diffuse(128, 128, env_tex_id, env_accel_tex_id);</div>
<div class="line">    GLuint refmap_id = prefilter_glossy(512, 512, env_tex_id, env_accel_tex_id);</div>
<div class="line">    GLuint brdflutid = integrate_brdf(512, 512);</div>
<div class="line"></div>
<div class="line">    env_tex_canvas = 0;</div>
<div class="line">    glDeleteTextures(1, &amp;env_accel_tex_id);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Generating maps done.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    glViewport(0, 0, window_context.width, window_context.height);</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Create scene data</span></div>
<div class="line">        std::vector&lt;Mdl_pbr_shader*&gt; pbr_shaders(distilled_materials.size() * 2);</div>
<div class="line"></div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Generating shader &quot;</span> &lt;&lt; window_context.material &lt;&lt;</div>
<div class="line">            <span class="stringliteral">&quot; in &quot;</span> &lt;&lt; (window_context.bake ? <span class="stringliteral">&quot;baked&quot;</span> : <span class="stringliteral">&quot;GLSL&quot;</span>)</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; mode ...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> index = window_context.bake ? 0 : 1;</div>
<div class="line"></div>
<div class="line">        Mdl_ue4* mdl_ue4 = 0;</div>
<div class="line">        <span class="keywordflow">if</span> (window_context.bake)</div>
<div class="line">            mdl_ue4 = <span class="keyword">new</span> Mdl_ue4_baker(state, distilled_materials[0].<span class="keyword">get</span>(),</div>
<div class="line">                options.baking_resolution_x, options.baking_resolution_y);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            mdl_ue4 = <span class="keyword">new</span> Mdl_ue4_glsl(state, distilled_materials[0].<span class="keyword">get</span>());</div>
<div class="line"></div>
<div class="line">        Mdl_pbr_shader* sphere_shader = <span class="keyword">new</span> Mdl_pbr_shader(</div>
<div class="line">            state, mdl_ue4,</div>
<div class="line">            iblmap_id, refmap_id, brdflutid);</div>
<div class="line">        pbr_shaders[0+index] = sphere_shader;</div>
<div class="line"></div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Generating shader done.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">        Sphere sphere(1.f, 64, 64);</div>
<div class="line">        sphere.bind_shader(sphere_shader);</div>
<div class="line"></div>
<div class="line">        Shader_program env_shader(</div>
<div class="line">            mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;screen_aligned_quad.vert&quot;</span>,</div>
<div class="line">            mi::examples::io::get_executable_folder() + <span class="stringliteral">&quot;/&quot;</span> + <span class="stringliteral">&quot;environment_sphere.frag&quot;</span>);</div>
<div class="line">        Screen_aligned_quad quad;</div>
<div class="line">        quad.bind_shader(&amp;env_shader);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Camera position</span></div>
<div class="line">        <span class="keywordtype">float</span> cam_dist = 3.f;</div>
<div class="line">        <span class="keywordtype">double</span> phi = 0.0f, theta = (M_PI * 0.5);</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> cam_pos(0.f, 0.f, cam_dist);</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> cam_interest(0.f, 0.f, 0.f);</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> cam_up(0.f, 1.f, 0.f);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> mv(1.0f);</div>
<div class="line">        mv.<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(cam_pos, cam_interest, cam_up);</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> inv_mv(mv);</div>
<div class="line">        inv_mv.transpose();</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> proj =</div>
<div class="line">            projection(</div>
<div class="line">                45.f, <span class="keywordtype">float</span>(window_context.width) / <span class="keywordtype">float</span>(window_context.height), 1.f, 100.f);</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_4_4</a> inv_proj(proj);</div>
<div class="line">        inv_proj.invert();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Loop until the user closes the window</span></div>
<div class="line">        <span class="keywordflow">if</span>(options.show_window)</div>
<div class="line">            <span class="keywordflow">while</span> (!glfwWindowShouldClose(window))</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Render the scene</span></div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.event)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">int</span> num_materials = int(distilled_materials.size());</div>
<div class="line">                    window_context.material = window_context.material % num_materials;</div>
<div class="line">                    <span class="keywordflow">if</span> (window_context.material &lt; 0)</div>
<div class="line">                        window_context.material += num_materials;</div>
<div class="line"></div>
<div class="line">                    index = window_context.bake ? 0 : 1;</div>
<div class="line">                    sphere_shader =</div>
<div class="line">                        pbr_shaders[window_context.material * 2 + index];</div>
<div class="line">                    <span class="comment">// create, if it does not exist yet</span></div>
<div class="line">                    <span class="keywordflow">if</span> (!sphere_shader)</div>
<div class="line">                    {</div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Generating shader &quot;</span> &lt;&lt; window_context.material &lt;&lt;</div>
<div class="line">                            <span class="stringliteral">&quot; in &quot;</span> &lt;&lt; (index ? <span class="stringliteral">&quot;GLSL&quot;</span> : <span class="stringliteral">&quot;baked&quot;</span> )</div>
<div class="line">                            &lt;&lt; <span class="stringliteral">&quot; mode ...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">if</span> (window_context.bake)</div>
<div class="line">                            mdl_ue4 = <span class="keyword">new</span> Mdl_ue4_baker(</div>
<div class="line">                                state, distilled_materials[window_context.material].get(),</div>
<div class="line">                                options.baking_resolution_x, options.baking_resolution_y);</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                            mdl_ue4 = <span class="keyword">new</span> Mdl_ue4_glsl(</div>
<div class="line">                                state, distilled_materials[window_context.material].get());</div>
<div class="line"></div>
<div class="line">                        sphere_shader = <span class="keyword">new</span> Mdl_pbr_shader(</div>
<div class="line">                            state, mdl_ue4, iblmap_id, refmap_id, brdflutid);</div>
<div class="line"></div>
<div class="line">                        pbr_shaders[window_context.material * 2 + index] = sphere_shader;</div>
<div class="line"></div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Generating shader done.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                    }</div>
<div class="line">                    sphere.bind_shader(sphere_shader);</div>
<div class="line"></div>
<div class="line">                    exposure_scale = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(<a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(2.0, window_context.exposure));</div>
<div class="line"></div>
<div class="line">                    phi -= window_context.move_dx * 0.001 * M_PI;</div>
<div class="line">                    theta -= window_context.move_dy * 0.001 * M_PI;</div>
<div class="line">                    theta = std::max(theta, 0.05 * M_PI);</div>
<div class="line">                    theta = std::min(theta, 0.95 * M_PI);</div>
<div class="line">                    window_context.move_dx = window_context.move_dy = 0.0;</div>
<div class="line"></div>
<div class="line">                    cam_pos.x = float(<a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(phi) * <a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(theta));</div>
<div class="line">                    cam_pos.y = float(<a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(theta));</div>
<div class="line">                    cam_pos.z = float(<a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(phi) * <a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(theta));</div>
<div class="line"></div>
<div class="line">                    cam_up.x = float(-<a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(phi) * <a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(theta));</div>
<div class="line">                    cam_up.y = float(<a class="code" href="group__mi__math__color.html#ga78a748c2639c4c43df3e1085a0258891" title="Returns a color with the elementwise sine of the color c. ">sin</a>(theta));</div>
<div class="line">                    cam_up.z = float(-<a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(phi) * <a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">cos</a>(theta));</div>
<div class="line"></div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">float</span> dist = float(cam_dist * <a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(0.95, <span class="keywordtype">double</span>(window_context.zoom)));</div>
<div class="line">                    cam_pos *= dist;</div>
<div class="line">                    mv.<a class="code" href="classmi_1_1math_1_1Matrix.html#aa07584ffc3f1b5f7dd95f3a986feebe8" title="Sets a transformation matrix based on a given center, a reference point, and a direction. ">lookat</a>(cam_pos, cam_interest, cam_up);</div>
<div class="line">                    inv_mv = mv;</div>
<div class="line">                    inv_mv.<a class="code" href="classmi_1_1math_1_1Matrix.html#a9a8f2a510a13772354cec7c691d36075" title="Transposes this matrix by exchanging rows and columns. ">transpose</a>();</div>
<div class="line"></div>
<div class="line">                    proj = projection(45.f,</div>
<div class="line">                        <span class="keywordtype">float</span>(window_context.width) / <span class="keywordtype">float</span>(window_context.height), 1.f, 100.f);</div>
<div class="line">                    inv_proj = proj;</div>
<div class="line">                    inv_proj.<a class="code" href="classmi_1_1math_1_1Matrix.html#a128b3ba86117ee576f10df4ee89480bf" title="Inverts this matrix and returns success or failure. ">invert</a>();</div>
<div class="line"></div>
<div class="line">                    window_context.event = <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div>
<div class="line"></div>
<div class="line">                env_shader.make_current();</div>
<div class="line">                env_shader.set_float(<span class="stringliteral">&quot;exposure_scale&quot;</span>, exposure_scale);</div>
<div class="line">                env_shader.set_matrix(<span class="stringliteral">&quot;inv_mv&quot;</span>, inv_mv);</div>
<div class="line">                env_shader.set_matrix(<span class="stringliteral">&quot;inv_proj&quot;</span>, inv_proj);</div>
<div class="line"></div>
<div class="line">                glActiveTexture(GL_TEXTURE0);</div>
<div class="line">                glBindTexture(GL_TEXTURE_2D, env_tex_id);</div>
<div class="line"></div>
<div class="line">                quad.draw();</div>
<div class="line"></div>
<div class="line">                sphere_shader-&gt;make_current();</div>
<div class="line">                sphere_shader-&gt;set_float(<span class="stringliteral">&quot;exposure_scale&quot;</span>, exposure_scale);</div>
<div class="line">                sphere_shader-&gt;set_matrix(<span class="stringliteral">&quot;m_view&quot;</span>, mv);</div>
<div class="line">                sphere_shader-&gt;set_matrix(<span class="stringliteral">&quot;m_projection&quot;</span>, proj);</div>
<div class="line">                sphere_shader-&gt;set_vector3(<span class="stringliteral">&quot;cam_position&quot;</span>, cam_pos);</div>
<div class="line">                sphere_shader-&gt;bind_textures();</div>
<div class="line"></div>
<div class="line">                sphere.draw();</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Swap front and back buffers</span></div>
<div class="line">                glfwSwapBuffers(window);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Poll for events and process them</span></div>
<div class="line">                glfwPollEvents();</div>
<div class="line">            }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// render to texture</span></div>
<div class="line">            GLuint fbo = 0, rbo = 0;</div>
<div class="line">            GLuint fb = create_offscreen_render_target(</div>
<div class="line">                window_context.width, window_context.height, fbo, rbo);</div>
<div class="line">            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div>
<div class="line"></div>
<div class="line">            env_shader.make_current();</div>
<div class="line">            env_shader.set_float(<span class="stringliteral">&quot;exposure_scale&quot;</span>, exposure_scale);</div>
<div class="line">            env_shader.set_matrix(<span class="stringliteral">&quot;inv_mv&quot;</span>, inv_mv);</div>
<div class="line">            env_shader.set_matrix(<span class="stringliteral">&quot;inv_proj&quot;</span>, inv_proj);</div>
<div class="line"></div>
<div class="line">            glActiveTexture(GL_TEXTURE0);</div>
<div class="line">            glBindTexture(GL_TEXTURE_2D, env_tex_id);</div>
<div class="line"></div>
<div class="line">            quad.draw();</div>
<div class="line"></div>
<div class="line">            sphere_shader-&gt;make_current();</div>
<div class="line">            sphere_shader-&gt;set_float(<span class="stringliteral">&quot;exposure_scale&quot;</span>, exposure_scale);</div>
<div class="line">            sphere_shader-&gt;set_matrix(<span class="stringliteral">&quot;m_view&quot;</span>, mv);</div>
<div class="line">            sphere_shader-&gt;set_matrix(<span class="stringliteral">&quot;m_projection&quot;</span>, proj);</div>
<div class="line">            sphere_shader-&gt;set_vector3(<span class="stringliteral">&quot;cam_position&quot;</span>, cam_pos);</div>
<div class="line">            sphere_shader-&gt;bind_textures();</div>
<div class="line"></div>
<div class="line">            sphere.draw();</div>
<div class="line"></div>
<div class="line">            save_image(state, options.outputfile.c_str(), fb,</div>
<div class="line">                window_context.width, window_context.height);</div>
<div class="line"></div>
<div class="line">            glBindFramebuffer(GL_FRAMEBUFFER, 0);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; pbr_shaders.size(); ++i)</div>
<div class="line">            <span class="keyword">delete</span> pbr_shaders[i];</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    glDeleteTextures(1, &amp;env_tex_id);</div>
<div class="line">    glDeleteTextures(1, &amp;refmap_id);</div>
<div class="line">    glDeleteTextures(1, &amp;iblmap_id);</div>
<div class="line">    glDeleteTextures(1, &amp;brdflutid);</div>
<div class="line"></div>
<div class="line">    check_gl_success();</div>
<div class="line">    glfwDestroyWindow(window);</div>
<div class="line">    glfwTerminate();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Distill material to given target model</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* distill_material(</div>
<div class="line">    <span class="keyword">const</span> Mdl_sdk_state&amp; state,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; target_model,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_distiller_api&gt;</a> distiller_api(</div>
<div class="line">        state.mdl_sdk-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>&gt;());</div>
<div class="line">    check_success(distiller_api);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* dm =</div>
<div class="line">        distiller_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#aa36119af9e8090cc26b77816e0d2c335" title="Distills a material. ">distill_material</a>(cm, target_model.c_str());</div>
<div class="line">    check_success(dm);</div>
<div class="line">    <span class="keywordflow">return</span> dm;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Compile material</span></div>
<div class="line"><a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compile_material(</div>
<div class="line">    <span class="keyword">const</span> Mdl_sdk_state&amp; state,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; material_name)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create execution context</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> context(</div>
<div class="line">        state.mdl_factory-&gt;create_execution_context());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// split module and material name</span></div>
<div class="line">    std::string module_name, material_simple_name;</div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::parse_cmd_argument_material_name(</div>
<div class="line">        material_name, module_name, material_simple_name, <span class="keyword">true</span>))</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load the module.</span></div>
<div class="line">    state.mdl_impexp_api-&gt;load_module(state.transaction.get(), module_name.c_str(), context.get());</div>
<div class="line">    <span class="keywordflow">if</span> (!print_messages(context.get()))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the database name for the module we loaded</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::IString&gt;</a> module_db_name(</div>
<div class="line">        state.mdl_factory-&gt;get_db_module_name(module_name.c_str()));</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IModule&gt;</a> module(</div>
<div class="line">        state.transaction-&gt;access&lt;<a class="code" href="classmi_1_1neuraylib_1_1IModule.html" title="This interface represents an MDL module. ">mi::neuraylib::IModule</a>&gt;(module_db_name-&gt;get_c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!module)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to access the loaded module.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Attach the material name</span></div>
<div class="line">    std::string material_db_name</div>
<div class="line">        = std::string(module_db_name-&gt;get_c_str()) + <span class="stringliteral">&quot;::&quot;</span> + material_simple_name;</div>
<div class="line">    material_db_name = mi::examples::mdl::add_missing_material_signature(</div>
<div class="line">        module.get(), material_db_name);</div>
<div class="line">    <span class="keywordflow">if</span> (material_db_name.empty())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to find the material %s in the module %s.&quot;</span>,</div>
<div class="line">            material_simple_name.c_str(), module_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the material definition from the database</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IFunction_definition&gt;</a> material_definition(</div>
<div class="line">        state.transaction-&gt;access&lt;<a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html" title="This interface represents a function definition. ">mi::neuraylib::IFunction_definition</a>&gt;(material_db_name.c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!material_definition)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">   <span class="comment">// Create instance</span></div>
<div class="line">   <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IFunction_call&gt;</a> mat_inst(</div>
<div class="line">       material_definition-&gt;create_function_call(<span class="keyword">nullptr</span>));</div>
<div class="line">   <span class="keywordflow">if</span> (!mat_inst)</div>
<div class="line">       <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">   <span class="comment">// Compile</span></div>
<div class="line">   <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMaterial_instance&gt;</a> mat_inst2(</div>
<div class="line">       mat_inst-&gt;get_interface&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html" title="This interface represents a material instance. ">mi::neuraylib::IMaterial_instance</a>&gt;());</div>
<div class="line">   <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICompiled_material&gt;</a> cm(</div>
<div class="line">       mat_inst2-&gt;create_compiled_material(</div>
<div class="line">           <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959afdcc06252ec8a89909ddd69006031766" title="Default compilation options (e.g., instance compilation). ">mi::neuraylib::IMaterial_instance::DEFAULT_OPTIONS</a>, context.get()));</div>
<div class="line">   <span class="keywordflow">if</span> (!print_messages(context.get()))</div>
<div class="line">       <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (!cm)</div>
<div class="line">       <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">   cm-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#a2c52e362969ee0f56ab5f8655937402f" title="Increments the reference count. ">retain</a>();</div>
<div class="line">   <span class="keywordflow">return</span> cm.get();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Prints program usage</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    std::cout</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;usage: &quot;</span> &lt;&lt; name &lt;&lt; <span class="stringliteral">&quot; [options] [&lt;material_name1&gt; ...]\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;-h                       print this text\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--nowin                  don&#39;t open interactive display\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--hdr &lt;filename&gt;         HDR environment map (default: textures/environment.hdr)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;-o &lt;outputfile&gt;          image file to write result to (default: output.exr)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;-e &lt;exposure&gt;            exposure for interactive display (default: 0.0)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--no_baking              do not bake UE4 material parameters to textures but generate&quot;</span></div>
<div class="line">                                     <span class="stringliteral">&quot; GLSL code\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;-r &lt;w&gt; &lt;h&gt;               baking resolution (default: 2048x2048)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--mdl_path &lt;path&gt;        mdl search path, can occur multiple times.\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    exit(EXIT_FAILURE);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> MAIN_UTF8(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Parse command line</span></div>
<div class="line">    Options options;</div>
<div class="line">    mi::examples::mdl::Configure_options configure_options;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; argc; ++i) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *opt = argv[i];</div>
<div class="line">        <span class="keywordflow">if</span> (opt[0] == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">            <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--nowin&quot;</span>) == 0) {</div>
<div class="line">                options.show_window = <span class="keyword">false</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--mdl_path&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1) {</div>
<div class="line">                configure_options.additional_mdl_paths.push_back(argv[++i]);</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--hdr&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1) {</div>
<div class="line">                options.hdrfile = argv[++i];</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--no_baking&quot;</span>) == 0) {</div>
<div class="line">                options.bake = <span class="keyword">false</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-e&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1) {</div>
<div class="line">                options.exposure = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-o&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1) {</div>
<div class="line">                options.outputfile = argv[++i];</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-r&quot;</span>) == 0 &amp;&amp; i &lt; argc - 2) {</div>
<div class="line">                options.baking_resolution_x = atoi(argv[++i]);</div>
<div class="line">                options.baking_resolution_y = atoi(argv[++i]);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;Unknown option: \&quot;&quot;</span> &lt;&lt; opt &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            options.material_names.push_back(opt);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>(options.material_names.empty())</div>
<div class="line">        options.material_names.push_back(</div>
<div class="line">            <span class="stringliteral">&quot;::nvidia::sdk_examples::tutorials_distilling::example_distilling2&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Access the MDL SDK</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::INeuray&gt;</a> neuray(mi::examples::mdl::load_and_get_ineuray());</div>
<div class="line">    <span class="keywordflow">if</span> (!neuray.is_valid_interface())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::configure(neuray.get(), configure_options))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load the distilling plugin</span></div>
<div class="line">    <span class="keywordflow">if</span> (mi::examples::mdl::load_plugin(neuray.get(), <span class="stringliteral">&quot;mdl_distiller&quot;</span> <a class="code" href="group__mi__base__config.html#gad7232312ea690f7c9fd39ee34794d073" title="The operating system specific default filename extension for shared libraries (DLLs) ...">MI_BASE_DLL_FILE_EXT</a>) != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the mdl_distiller plugin.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Start the MDL SDK</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> ret = neuray-&gt;start();</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK. Result code: %d&quot;</span>, ret);</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//  Access required API components</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::IMdl_factory&gt;</a> mdl_factory(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_impexp_api&gt;</a> mdl_impexp_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend_api&gt;</a> mdl_backend_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        Mdl_sdk_state sdk_state;</div>
<div class="line">        sdk_state.mdl_sdk = neuray;</div>
<div class="line">        sdk_state.mdl_impexp_api = mdl_impexp_api;</div>
<div class="line">        sdk_state.mdl_backend_api = mdl_backend_api;</div>
<div class="line">        sdk_state.mdl_factory = mdl_factory;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Create a transaction</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IDatabase&gt;</a> database(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IDatabase.html" title="This interface is used to interact with the distributed database. ">mi::neuraylib::IDatabase</a>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IScope&gt;</a> scope(database-&gt;get_global_scope());</div>
<div class="line">        sdk_state.transaction = scope-&gt;create_transaction();</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            std::vector&lt;mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt; &gt;</div>
<div class="line">                distilled_materials;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; options.material_names.size(); ++i)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Load and compile material</span></div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICompiled_material&gt;</a> cm(</div>
<div class="line">                    compile_material(</div>
<div class="line">                        sdk_state,</div>
<div class="line">                        options.material_names[i]));</div>
<div class="line">                check_success(cm.is_valid_interface());</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Distill to UE4 target</span></div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> dm(</div>
<div class="line">                    distill_material(sdk_state, <span class="stringliteral">&quot;ue4&quot;</span>, cm.get()));</div>
<div class="line">                check_success(dm.is_valid_interface());</div>
<div class="line"></div>
<div class="line">                distilled_materials.push_back(dm);</div>
<div class="line">            }</div>
<div class="line">            render_scene(</div>
<div class="line">                sdk_state, distilled_materials, options);</div>
<div class="line">        }</div>
<div class="line">        sdk_state.transaction-&gt;commit();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Shut down the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (neuray-&gt;shutdown() != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to shutdown the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Unload the MDL SDK</span></div>
<div class="line">    neuray = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::unload())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to unload the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    exit_success();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert command line arguments to UTF8 on Windows</span></div>
<div class="line">COMMANDLINE_TO_UTF8</div>
</div><!-- fragment --><p><b>Source Code Location:</b> <code>examples/mdl_sdk/distilling_glsl/example_distilling_glsl.frag</code></p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment"> * Copyright 2022 NVIDIA Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *****************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// This shader is based on the Unreal 4 PBR shading model as described in</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// &quot;Real Shading in Unreal Engine 4&quot; by Brian Karis</span></div>
<div class="line"><span class="comment">// http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> ONE_OVER_PI = 0.3183099;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">float</span> rought_to_gloss(<span class="keywordtype">float</span> roughness)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> 1.0 - roughness;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">vec3 fresnel_schlick_roughness(vec3 F0, <span class="keywordtype">float</span> cos_theta, <span class="keywordtype">float</span> roughness)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> F0 + (max(vec3(rought_to_gloss(roughness)), F0) - F0) * <a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(1.0 - cos_theta, 5.0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//Varying inputs</span></div>
<div class="line">in vec3 texture_coordinate;</div>
<div class="line">in vec3 world_position;</div>
<div class="line">in vec3 world_normal;</div>
<div class="line">in vec3 world_tangent;</div>
<div class="line">in vec3 world_binormal;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Uniform inputs</span></div>
<div class="line">uniform samplerCube  irradiance_map;</div>
<div class="line">uniform samplerCube  refl_map;</div>
<div class="line">uniform sampler2D    brdf_lut;</div>
<div class="line"></div>
<div class="line">uniform vec3 cam_position = vec3(5.0, 0.0, 0.0);</div>
<div class="line"></div>
<div class="line">uniform <span class="keywordtype">float</span> exposure_scale = 0.0;</div>
<div class="line"></div>
<div class="line"><span class="comment">// The color output variable of this fragment shader.</span></div>
<div class="line">out vec4 FragColor;</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> MAX_REFLECTION_LOD = 4.0;</div>
<div class="line"></div>
<div class="line"><span class="comment">// A simple Reinhard tonemapper.</span></div>
<div class="line">vec3 display(vec3 val, <span class="keywordtype">float</span> tonemap_scale)</div>
<div class="line">{</div>
<div class="line">    val *= tonemap_scale;</div>
<div class="line"></div>
<div class="line">    val = max(val, vec3(0.0f));</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">float</span> burn_out = 0.1;</div>
<div class="line">    val.x *= (1.0 + val.x * burn_out) / (1.0 + val.x);</div>
<div class="line">    val.y *= (1.0 + val.y * burn_out) / (1.0 + val.y);</div>
<div class="line">    val.z *= (1.0 + val.z * burn_out) / (1.0 + val.z);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> gamma = 1.0/2.2;</div>
<div class="line">    <span class="keywordtype">float</span> r = min(<a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(val.x, gamma), 1.0);</div>
<div class="line">    <span class="keywordtype">float</span> g = min(<a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(val.y, gamma), 1.0);</div>
<div class="line">    <span class="keywordtype">float</span> b = min(<a class="code" href="group__mi__math__color.html#gacdaad24bbf75e76ff277a6c52adb4d8a" title="Returns the color a elementwise to the power of b. ">pow</a>(val.z, gamma), 1.0);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> vec3(r, g, b);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main() {</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Setup material state required for MDL expressions.</span></div>
<div class="line">    State state = State(</div>
<div class="line">        <span class="comment">/*normal=*/</span>              world_normal,</div>
<div class="line">        <span class="comment">/*geometry_normal=*/</span>     world_normal,</div>
<div class="line">        <span class="comment">/*position=*/</span>            world_position,</div>
<div class="line">        <span class="comment">/*texture_space_max=*/</span>   1,</div>
<div class="line">        <span class="comment">/*texture_coordinate=*/</span>  vec3[1](texture_coordinate),</div>
<div class="line">        <span class="comment">/*texture_tangent_u=*/</span>  vec3[1](world_tangent),</div>
<div class="line">        <span class="comment">/*texture_tangent_v=*/</span>  vec3[1](world_binormal)</div>
<div class="line">    );</div>
<div class="line">    <span class="comment">// get values from mdl material expressions</span></div>
<div class="line">    vec3 clearcoat_color = <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_clearcoat_color(state), vec3(0.0f), vec3(1.0f));</div>
<div class="line">    <span class="keywordtype">float</span> clearcoat_roughness = <a class="code" href="group__mi__math__color.html#ga1808c867ab42a518a11e11550f768223" title="Returns the square root of each element of c. ">sqrt</a>(<a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_clearcoat_roughness(state), 0.0f, 1.0f));</div>
<div class="line">    <span class="keywordtype">float</span> clearcoat_weight = <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_clearcoat_weight(state), 0.0f, 1.0f);</div>
<div class="line"></div>
<div class="line">    vec3 base_color = <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_base_color(state), vec3(0.0f), vec3(1.0f));</div>
<div class="line">    <span class="keywordtype">float</span> roughness = <a class="code" href="group__mi__math__color.html#ga1808c867ab42a518a11e11550f768223" title="Returns the square root of each element of c. ">sqrt</a>(<a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_roughness(state), 0.0f, 1.0f));</div>
<div class="line">    <span class="keywordtype">float</span> metallic = <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_metallic(state), 0.0f, 1.0f);</div>
<div class="line">    <span class="keywordtype">float</span> spec_weight = <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(get_specular(state), 0.0f, 1.0f);</div>
<div class="line"></div>
<div class="line">    vec3 V = normalize(cam_position - world_position);</div>
<div class="line">    vec3 N = get_normal(state);</div>
<div class="line">    vec3 R = reflect(-V, N);</div>
<div class="line">    <span class="keywordtype">float</span> cos_theta = max(<a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(N, V), 0.0);</div>
<div class="line">    </div>
<div class="line">    vec3 F0 = vec3(0.04);</div>
<div class="line">    vec3 clearcoat = vec3(0, 0, 0);</div>
<div class="line">    <span class="keywordflow">if</span>(clearcoat_weight &gt; 0.001)</div>
<div class="line">    {</div>
<div class="line">        vec3 CN = get_clearcoat_normal(state);</div>
<div class="line">        <span class="keywordtype">float</span> cos_theta0 = max(<a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(CN, V), 0.0);</div>
<div class="line">        </div>
<div class="line">        vec3 F_c = fresnel_schlick_roughness(F0, cos_theta0, clearcoat_roughness);</div>
<div class="line">        vec3 refl_color_c = textureLod(refl_map, reflect(-V, CN), clearcoat_roughness * MAX_REFLECTION_LOD).rgb;</div>
<div class="line">        vec2 brdf = texture(brdf_lut, vec2(cos_theta0, clearcoat_roughness)).rg;</div>
<div class="line">        clearcoat = clearcoat_weight * refl_color_c * clearcoat_color * (F_c * brdf.x + brdf.y);</div>
<div class="line">        </div>
<div class="line">        clearcoat_weight *= F_c.x;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    F0 = mix(F0, base_color, metallic);</div>
<div class="line">    spec_weight = mix(spec_weight, 1.0, metallic);</div>
<div class="line"></div>
<div class="line">    vec3 F = fresnel_schlick_roughness(F0, cos_theta, roughness);</div>
<div class="line">    vec3 kS = F * spec_weight;</div>
<div class="line">    vec3 kD = 1.0 - kS;</div>
<div class="line">    kD *= 1.0 - vec3(metallic);</div>
<div class="line">    kD = <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(kD, vec3(0.0f), vec3(1.0f));</div>
<div class="line"></div>
<div class="line">    vec3 diffuse = vec3(0.0);</div>
<div class="line">    vec3 black = vec3(0.0);</div>
<div class="line">    <span class="keywordflow">if</span>(kD != black)</div>
<div class="line">    {</div>
<div class="line">        vec3 irradiance = texture(irradiance_map, N).rgb;</div>
<div class="line">        diffuse = kD * irradiance * base_color * ONE_OVER_PI;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vec3 refl_color = textureLod(refl_map, R, roughness * MAX_REFLECTION_LOD).rgb;</div>
<div class="line">    vec2 brdf = texture(brdf_lut, vec2(cos_theta, roughness)).rg;</div>
<div class="line">    vec3 specular = spec_weight * refl_color * (F * brdf.x + brdf.y);</div>
<div class="line"></div>
<div class="line">    FragColor = vec4(display(clearcoat + (1.0 - clearcoat_weight) * (diffuse + specular), exposure_scale), 1);</div>
<div class="line">}</div>
</div><!-- fragment --><div align="right"> [<a class="el" href="mi_neuray_example_distilling.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_traversal.html">Next</a>] </div> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path">
<span class="footeritem">5&#160;April&#160;2022,&#160;20:40, rev.358266</span>
<span class="footeritem"><a href="https://www.nvidia.com/en-us/about-nvidia/legal-info/" target="_blank" shape="rect">&copy; 2022 NVIDIA&nbsp;Corporation.</a> All rights reserved.</span>
</div>
</body>
</html>
