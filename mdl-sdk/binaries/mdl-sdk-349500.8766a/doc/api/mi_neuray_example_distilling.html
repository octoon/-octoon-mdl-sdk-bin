<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Example for Material Distilling and Baking</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="images/arcicon.ico" rel="shortcut icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_custom_stylesheet_1_8_4.css" rel="stylesheet" type="text/css"/>
<link rel='stylesheet' href='webfonts/librebaskerville/stylesheet.css' type='text/css'/>
<link rel='stylesheet' href='webfonts/sourcesanspro/stylesheet.css' type='text/css'/>
<!--ARC-->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="blackheader">
<span id="blackheader_title">MDL SDK API</span>
<span>
<img src="images/nvidia_logo_transpbg.gif" alt="nvidia_logo_transpbg.gif" style=" height:1.25em; width:6.806em;"/></span>
<span id="blackheader_uplink">
<a href='../index.html' class='top_page_nav'>Up</a>
</span>
</div>
<!--
<div id="titlearea">
   <span id="projectname">
     <a id="titlelink" href="../../index.html">
       MDL SDK API
     </a>
   </span>
     <a id="projectlogo" href="http://www.nvidia-arc.com">
       <img alt="NVIDIA logo" src="images/nvidia_logo.png" style="height:2em;">
       </a>
     <a href='../index.html' class='top_page_nav'>Up</a>
</div>
-->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mi_neuray_example_distilling.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example for Material Distilling and Baking </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div align="right"> [<a class="el" href="mi_neuray_example_derivatives.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_distilling_unity.html">Next</a>] </div><p>This example introduces the distillation of mdl materials to a fixed target model and showcases how to bake material sub-expressions to a texture.</p>
<h1><a class="anchor" id="example_distilling_new"></a>
New Topics</h1>
<ul>
<li>Material Distilling</li>
<li>Baking material sub-expressions</li>
</ul>
<h1><a class="anchor" id="example_distilling_descr"></a>
Detailed Description</h1>
<dl>
<dt><b> Material Distilling </b> </dt>
<dd><p class="startdd"><br/>
 MDL materials can be of arbitrary complexity. In some contexts like realtime environments it may however be desirable to deal with a fixed material model instead. The <a class="el" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a> provides a mechanism to transform MDL materials to a number of predefined target material models. <br/>
<br/>
 In this example we will show how to distill a material to a specific target model, how to extract sub-expressions from the resulting material and how to bake those sub-expressions into textures and constant values.<br/>
 In <code>create_material_instance</code> we first load an mdl module and create a material instance. The material distilling requires our source material to be compiled, therefore we call <code>compile_material_instance</code> to build a compiled representation of it. We then acquire a pointer to the <a class="el" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a> interface. In <code>create_distilled_material</code> we call <code><a class="el" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#aa36119af9e8090cc26b77816e0d2c335" title="Distills a material. ">mi::neuraylib::IMdl_distiller_api::distill_material()</a></code>, passing in the compiled material and the desired target model. The function returns the distilled material in compiled form. Now we need to investigate the distilled material and extract the information we need for further processing. This is done in setup_target_material. Here, we first lookup a pointer to the call expression associated with the <code>surface.scattering</code> sub-expression of the distilled material and extract the semantic of that function for later use. Depending of the target model, we set up a simple container storing material parameter names and associated parameter values. We then analyze the distilled material and extract material sub-expressions that match our parameters and collect them for later baking.</p>
<p class="enddd"></p>
</dd>
<dt><b> Baking material subexpressions </b> </dt>
<dd><p class="startdd"><br/>
 The function <code>bake_target_material_inputs</code> contains the code needed to bake the extracted sub-expressions to textures and constants. Here, we loop over the material container and check for each parameter if a bake path has been found. If so, we acquire a pointer to an <a class="el" href="classmi_1_1neuraylib_1_1IBaker.html" title="Allows to bake a varying or uniform expression of a compiled material into a texture or constant...">mi::neuraylib::IBaker</a> instance by calling <a class="el" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#af2405d4d9a184d64ccabf81ff4a5e06e" title="Creates a baker for texture baking. ">mi::neuraylib::IMdl_distiller_api::create_baker()</a> for the given bake-path. If the function <a class="el" href="classmi_1_1neuraylib_1_1IBaker.html#a054cc2c0c52ef0ea5f1a670906108978" title="Indicates whether the expression to be baked is uniform or varying. ">mi::neuraylib::IBaker::is_uniform</a> returns <code>true</code> the expression attached to the path is constant in the sense that it does not depend on texture coordinates. Therefore, it is sufficient to bake a constant value. We call <a class="el" href="classmi_1_1neuraylib_1_1IBaker.html#ae65f5cc1f43ff47c1d9178ab56bca625" title="Bakes the expression as constant. ">mi::neuraylib::IBaker::bake_constant()</a> and store the computed value in the material parameter struct.<br/>
 In case of a varying bake path, we use the <a class="el" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a> to create a canvas of the appropriate type, pass it to <a class="el" href="classmi_1_1neuraylib_1_1IBaker.html#a8460f0cd1eea98dae31a1ff67c6ea041" title="Bakes the expression as texture. ">mi::neuraylib::IBaker::bake_texture()</a> and store it in the material parameter structure. Back in main we call <code>process_target_material</code>. In this simple example we loop over all material parameters again, print some information to stdout and save the baked textures.</p>
<p class="enddd"></p>
</dd>
</dl>
<h1><a class="anchor" id="example_distilling"></a>
Example Source</h1>
<p><b>Source Code Location:</b> <code>examples/mdl_sdk/distilling/example_distilling.cpp</code></p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment"> * Copyright 2022 NVIDIA Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *****************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// examples/mdl_sdk/distilling/example_distilling.cpp</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Introduces the distillation of mdl materials to a fixed target model</span></div>
<div class="line"><span class="comment">// and showcases how to bake material paths to a texture</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;example_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;example_distilling_shared.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Custom timing output </span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="keyword">struct </span>Timing</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">explicit</span> Timing(std::string operation)</div>
<div class="line">        : m_operation(operation)</div>
<div class="line">    {</div>
<div class="line">        m_start = std::chrono::steady_clock::now();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ~Timing()</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> stop = std::chrono::steady_clock::now();</div>
<div class="line">        std::chrono::duration&lt;double&gt; elapsed_seconds = stop - m_start;</div>
<div class="line">        printf(<span class="stringliteral">&quot;info:  %s time: %.2f ms.\n&quot;</span>, m_operation.c_str(), elapsed_seconds.count() * 1000);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::string m_operation;</div>
<div class="line">    std::chrono::steady_clock::time_point m_start;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Small struct used to store the result of a texture baking process</span></div>
<div class="line"><span class="comment">// of a material sub expression</span></div>
<div class="line"><span class="keyword">struct </span>Material_parameter</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> void (Remap_func(<a class="code" href="classmi_1_1base_1_1IInterface.html" title="The basic extensible interface. ">mi::base::IInterface</a>*));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IData&gt;</a>                 value;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a>    texture;</div>
<div class="line"></div>
<div class="line">    std::string                                 value_type;</div>
<div class="line">    std::string                                 bake_path;</div>
<div class="line"></div>
<div class="line">    Remap_func*                                 remap_func;</div>
<div class="line"></div>
<div class="line">    Material_parameter() : remap_func(nullptr)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Material_parameter(</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; value_type,</div>
<div class="line">        Remap_func* func = <span class="keyword">nullptr</span>)</div>
<div class="line">        : value_type(value_type)</div>
<div class="line">        , remap_func(func)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> std::map&lt;std::string, Material_parameter&gt; Material;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Creates an instance of the given material.</span></div>
<div class="line"><a class="code" href="classmi_1_1neuraylib_1_1IFunction__call.html" title="This interface represents a function call. ">mi::neuraylib::IFunction_call</a>* create_material_instance(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>* mdl_factory,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>* mdl_impexp_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; module_qualified_name,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; material_simple_name)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Load the module.</span></div>
<div class="line">    mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a5e195d80915190eb40c5995ccfeaa4c9" title="Loads an MDL module from disk (or a builtin module) into the database. ">load_module</a>(transaction, module_qualified_name.c_str(), context);</div>
<div class="line">    <span class="keywordflow">if</span> (!print_messages(context))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Loading module &#39;%s&#39; failed.&quot;</span>, module_qualified_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the database name for the module we loaded</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::IString&gt;</a> module_db_name(</div>
<div class="line">        mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a72a27c9e0d66e79391ff9a8e3ce4a119" title="Returns the DB name for the MDL name of a module (or file path for MDLE modules). ...">get_db_module_name</a>(module_qualified_name.c_str()));</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IModule&gt;</a> module(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IModule.html" title="This interface represents an MDL module. ">mi::neuraylib::IModule</a>&gt;(module_db_name-&gt;get_c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!module)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to access the loaded module.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Attach the material name</span></div>
<div class="line">    std::string material_db_name</div>
<div class="line">        = std::string(module_db_name-&gt;get_c_str()) + <span class="stringliteral">&quot;::&quot;</span> + material_simple_name;</div>
<div class="line">    material_db_name = mi::examples::mdl::add_missing_material_signature(</div>
<div class="line">        module.get(), material_db_name);</div>
<div class="line">    <span class="keywordflow">if</span> (material_db_name.empty())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to find the material %s in the module %s.&quot;</span>,</div>
<div class="line">            material_simple_name.c_str(), module_qualified_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the material definition from the database</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IFunction_definition&gt;</a> material_definition(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html" title="This interface represents a function definition. ">mi::neuraylib::IFunction_definition</a>&gt;(material_db_name.c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!material_definition)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Accessing definition &#39;%s&#39; failed.&quot;</span>, material_db_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a material instance from the material definition with the default arguments.</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result;</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IFunction__call.html" title="This interface represents a function call. ">mi::neuraylib::IFunction_call</a>* material_instance =</div>
<div class="line">        material_definition-&gt;create_function_call(0, &amp;result);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Instantiating &#39;%s&#39; failed.&quot;</span>, material_db_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> material_instance;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Compiles the given material instance in the given compilation modes and stores</span></div>
<div class="line"><span class="comment">// it in the DB.</span></div>
<div class="line"><a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compile_material_instance(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__call.html" title="This interface represents a function call. ">mi::neuraylib::IFunction_call</a>* material_instance,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keywordtype">bool</span> class_compilation)</div>
<div class="line">{</div>
<div class="line">    Timing timing(<span class="stringliteral">&quot;Compiling&quot;</span>);</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> flags = class_compilation</div>
<div class="line">        ? <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959a7474d76ee055edda39a494edf06cfc36" title="Selects class compilation instead of instance compilation. ">mi::neuraylib::IMaterial_instance::CLASS_COMPILATION</a></div>
<div class="line">        : <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959afdcc06252ec8a89909ddd69006031766" title="Default compilation options (e.g., instance compilation). ">mi::neuraylib::IMaterial_instance::DEFAULT_OPTIONS</a>;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IMaterial_instance&gt;</a> material_instance2(</div>
<div class="line">        material_instance-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html" title="This interface represents a material instance. ">mi::neuraylib::IMaterial_instance</a>&gt;());</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compiled_material =</div>
<div class="line">        material_instance2-&gt;create_compiled_material(flags, context);</div>
<div class="line">    check_success(print_messages(context));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> compiled_material;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Distills the given compiled material to the requested target model, </span></div>
<div class="line"><span class="comment">// and returns it</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* create_distilled_material(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>* distiller_api,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* compiled_material,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* target_model)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = 0;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> distilled_material(</div>
<div class="line">        distiller_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#aa36119af9e8090cc26b77816e0d2c335" title="Distills a material. ">distill_material</a>(compiled_material, target_model, <span class="keyword">nullptr</span>, &amp;result));</div>
<div class="line">    check_success(result == 0);</div>
<div class="line"></div>
<div class="line">    distilled_material-&gt;retain();</div>
<div class="line">    <span class="keywordflow">return</span> distilled_material.get();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// remap normal </span></div>
<div class="line"><span class="keywordtype">void</span> remap_normal(<a class="code" href="classmi_1_1base_1_1IInterface.html" title="The basic extensible interface. ">mi::base::IInterface</a>* icanvas)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> canvas(</div>
<div class="line">        icanvas-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>&gt;());</div>
<div class="line">    <span class="keywordflow">if</span>(!canvas)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    <span class="comment">// Convert normal values from the interval [-1.0,1.0] to [0.0, 1.0]</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile (canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* data = <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> n = canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#acd28f45b9d22b1cd1e24043aeda5c065" title="Returns the resolution of the canvas in x direction. ">get_resolution_x</a>() * canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#a51874ccdb54f6e03ff325b01d98dfefb" title="Returns the resolution of the canvas in y direction. ">get_resolution_y</a>() * 3;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> i=0; i&lt;n; ++i)</div>
<div class="line">    {</div>
<div class="line">        data[i] = (data[i] + 1.f) * 0.5f;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// simple roughness to glossiness conversion</span></div>
<div class="line"><span class="keywordtype">void</span> rough_to_gloss(<a class="code" href="classmi_1_1base_1_1IInterface.html" title="The basic extensible interface. ">mi::base::IInterface</a>* ii)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> canvas(</div>
<div class="line">        ii-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>&gt;());</div>
<div class="line">    <span class="keywordflow">if</span>(canvas)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile (canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* data = <span class="keyword">static_cast&lt;</span><a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>*<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> n = canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#acd28f45b9d22b1cd1e24043aeda5c065" title="Returns the resolution of the canvas in x direction. ">get_resolution_x</a>() * canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#a51874ccdb54f6e03ff325b01d98dfefb" title="Returns the resolution of the canvas in y direction. ">get_resolution_y</a>();</div>
<div class="line">        <span class="keywordflow">for</span>(<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> i=0; i&lt;n; ++i)</div>
<div class="line">        {</div>
<div class="line">            data[i] = 1.0f - data[i];</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32&gt;</a> value(</div>
<div class="line">        ii-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1IFloat32.html" title="This interface represents mi::Float32. ">mi::IFloat32</a>&gt;());</div>
<div class="line">    <span class="keywordflow">if</span>(value)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> f;</div>
<div class="line">        <a class="code" href="group__mi__neuray__types.html#gad12309fee401d9d99e64470c6a3dcfb2" title="Simplifies reading the value of mi::IData into the corresponding classes from the base and math API...">mi::get_value</a>(value.get(), f);</div>
<div class="line">        value-&gt;set_value(1.0f - f);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Setup material parameters according to target model and</span></div>
<div class="line"><span class="comment">// collect relevant bake paths</span></div>
<div class="line"><span class="keywordtype">void</span> setup_target_material(</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; target_model,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm,</div>
<div class="line">    Material&amp; out_material)</div>
<div class="line">{</div>
<div class="line">    Timing timing(<span class="stringliteral">&quot;Setup&quot;</span>);</div>
<div class="line">    <span class="comment">// Access surface.scattering function</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IExpression_direct_call&gt;</a> parent_call(</div>
<div class="line">        lookup_call(<span class="stringliteral">&quot;surface.scattering&quot;</span>, cm));</div>
<div class="line">    <span class="comment">// ... and get its semantic</span></div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51" title="All known semantics of functions definitions. ">mi::neuraylib::IFunction_definition::Semantics</a> semantic(</div>
<div class="line">        get_call_semantic(transaction, parent_call.get()));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(target_model == <span class="stringliteral">&quot;diffuse&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// The target model is supposed to be a diffuse reflection bsdf</span></div>
<div class="line">        check_success(semantic == </div>
<div class="line">            <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a9ef0cefaf54499616b41d73482ed47b3" title="The df::diffuse_reflection_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_DIFFUSE_REFLECTION_BSDF</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Setup diffuse material parameters</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;roughness&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Specify bake paths</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;color&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.tint&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.roughness&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal&quot;</span>].bake_path = <span class="stringliteral">&quot;geometry.normal&quot;</span>;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(target_model == <span class="stringliteral">&quot;diffuse_glossy&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Setup parameters for a simple diffuse - glossy material model</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;diffuse_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;glossy_color&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;glossy_roughness&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;glossy_weight&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;ior&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Diffuse-glossy distillation can result in a diffuse bsdf, a glossy bsdf </span></div>
<div class="line">        <span class="comment">// or a fresnel weighted combination of both. Explicitly check the cases</span></div>
<div class="line">        <span class="comment">// and save the corresponding bake paths.</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span>(semantic)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a9ef0cefaf54499616b41d73482ed47b3" title="The df::diffuse_reflection_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_DIFFUSE_REFLECTION_BSDF</a>:</div>
<div class="line">            out_material[<span class="stringliteral">&quot;diffuse_color&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.tint&quot;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a5cc1f55dbefc1f19189c909582ecd93b" title="The df::simple_glossy_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_SIMPLE_GLOSSY_BSDF</a>:</div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossy_color&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.tint&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossy_roughness&quot;</span>].bake_path =  <span class="stringliteral">&quot;surface.scattering.roughness_u&quot;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a7183dfc19e6fa86415bad6b5fb504c67" title="The df::fresnel_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_FRESNEL_LAYER</a>:</div>
<div class="line">            out_material[<span class="stringliteral">&quot;diffuse_color&quot;</span>].bake_path =<span class="stringliteral">&quot;surface.scattering.base.tint&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossy_color&quot;</span>].bake_path =  <span class="stringliteral">&quot;surface.scattering.layer.tint&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossy_roughness&quot;</span>].bake_path =  <span class="stringliteral">&quot;surface.scattering.layer.roughness_u&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossy_weight&quot;</span>].bake_path =  <span class="stringliteral">&quot;surface.scattering.weight&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;ior&quot;</span>].bake_path =  <span class="stringliteral">&quot;surface.scattering.ior&quot;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="comment">// unknown function, nothing to bake</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal&quot;</span>].bake_path = <span class="stringliteral">&quot;geometry.normal&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (target_model == <span class="stringliteral">&quot;ue4&quot;</span> || target_model == <span class="stringliteral">&quot;transmissive_pbr&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Setup some UE4 material parameters</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;base_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;metallic&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;specular&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;roughness&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">        out_material[<span class="stringliteral">&quot;clearcoat_weight&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;clearcoat_normal&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">        out_material[<span class="stringliteral">&quot;opacity&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line"></div>
<div class="line">        std::string path_prefix = <span class="stringliteral">&quot;surface.scattering.&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> is_transmissive_pbr = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (target_model == <span class="stringliteral">&quot;transmissive_pbr&quot;</span>)</div>
<div class="line">        {</div>
<div class="line">            is_transmissive_pbr = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// insert parameters that only apply to transmissive_pbr</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;anisotropy&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;anisotropy_rotation&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;transparency&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;transmission_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// uniform</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;attenuation_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;attenuation_distance&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;subsurface_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;volume_ior&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// collect volume properties, they are guaranteed to exist</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;attenuation_color&quot;</span>].bake_path = <span class="stringliteral">&quot;volume.absorption_coefficient.s.v.attenuation&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;subsurface_color&quot;</span>].bake_path = <span class="stringliteral">&quot;volume.absorption_coefficient.s.v.subsurface&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;attenuation_distance&quot;</span>].bake_path = <span class="stringliteral">&quot;volume.scattering_coefficient.s.v.distance&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;volume_ior&quot;</span>].bake_path = <span class="stringliteral">&quot;ior&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Check for a clearcoat layer, first. If present, it is the outermost layer</span></div>
<div class="line">        <span class="keywordflow">if</span>(semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Setup clearcoat bake paths</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;clearcoat_weight&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;weight&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;clearcoat_roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;clearcoat_normal&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;normal&quot;</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Get clear-coat base layer</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;base&quot;</span>, cm, parent_call.get());</div>
<div class="line">            <span class="comment">// Get clear-coat base layer semantic</span></div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            <span class="comment">// Extend path prefix</span></div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;base.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Check for a weighted layer. Sole purpose of this layer is the transportation of  </span></div>
<div class="line">        <span class="comment">// the under-clearcoat-normal. It contains an empty base and a layer with the</span></div>
<div class="line">        <span class="comment">// actual material body</span></div>
<div class="line">        <span class="keywordflow">if</span>(semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51af0d7095ab62fadc99f6da2f081635491" title="The df::weighted_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_WEIGHTED_LAYER</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Collect under-clearcoat normal</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;normal&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;normal&quot;</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;layer&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;layer.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// Check for a normalized mix. This mix combines the metallic and dielectric parts</span></div>
<div class="line">        <span class="comment">// of the material</span></div>
<div class="line">        <span class="keywordflow">if</span>(semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51aaadb2dea7ed283a586f5f996928a850e" title="The df::normalized_mix() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_NORMALIZED_MIX</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// The top-mix component is supposed to be a glossy bsdf</span></div>
<div class="line">            <span class="comment">// Collect metallic weight</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;metallic&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.weight&quot;</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// And other metallic parameters</span></div>
<div class="line">            <span class="keywordflow">if</span> (is_transmissive_pbr) {</div>
<div class="line">                out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u.s.r.roughness&quot;</span>;</div>
<div class="line">                out_material[<span class="stringliteral">&quot;anisotropy&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u.s.r.anisotropy&quot;</span>;</div>
<div class="line">                out_material[<span class="stringliteral">&quot;anisotropy_rotation&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u.s.r.rotation&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.roughness_u&quot;</span>;</div>
<div class="line">            <span class="comment">// Base_color can be taken from any of the leaf-bsdfs. It is supposed to</span></div>
<div class="line">            <span class="comment">// be the same.</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.tint&quot;</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(</div>
<div class="line">                <span class="stringliteral">&quot;components.0.component&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;components.0.component.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Collect specular parameters</span></div>
<div class="line">            out_material[<span class="stringliteral">&quot;specular&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;weight&quot;</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (is_transmissive_pbr)</div>
<div class="line">            {</div>
<div class="line">                out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u.s.r.roughness&quot;</span>;</div>
<div class="line">                out_material[<span class="stringliteral">&quot;anisotropy&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u.s.r.anisotropy&quot;</span>;</div>
<div class="line">                out_material[<span class="stringliteral">&quot;anisotropy_rotation&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u.s.r.rotation&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;layer.roughness_u&quot;</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;base&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;base.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (semantic == <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51aaadb2dea7ed283a586f5f996928a850e" title="The df::normalized_mix() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_NORMALIZED_MIX</a>)</div>
<div class="line">        {</div>
<div class="line">            check_success(is_transmissive_pbr);</div>
<div class="line"></div>
<div class="line">            out_material[<span class="stringliteral">&quot;transparency&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.weight&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;transmission_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;components.1.component.tint&quot;</span>;</div>
<div class="line">            <span class="comment">// Chain further</span></div>
<div class="line">            parent_call = lookup_call(<span class="stringliteral">&quot;components.0.component&quot;</span>, cm, parent_call.get());</div>
<div class="line">            semantic = get_call_semantic(transaction, parent_call.get());</div>
<div class="line">            path_prefix += <span class="stringliteral">&quot;components.0.component.&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(semantic ==</div>
<div class="line">            <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a995acaeccbd4d42866de0e3fdf020ed3" title="The df::microfacet_ggx_vcavities() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_MICROFACET_GGX_VCAVITIES_BSDF</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(out_material[<span class="stringliteral">&quot;metallic&quot;</span>].bake_path.empty())</div>
<div class="line">                out_material[<span class="stringliteral">&quot;metallic&quot;</span>].value = create_value(transaction, <span class="stringliteral">&quot;Float32&quot;</span>, 1.0f);</div>
<div class="line">            <span class="keywordflow">if</span>(out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path.empty())</div>
<div class="line">                out_material[<span class="stringliteral">&quot;roughness&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;roughness_u&quot;</span>; </div>
<div class="line">            <span class="keywordflow">if</span>(out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path.empty())</div>
<div class="line">                out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;tint&quot;</span>; </div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(semantic ==</div>
<div class="line">            <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a9ef0cefaf54499616b41d73482ed47b3" title="The df::diffuse_reflection_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_DIFFUSE_REFLECTION_BSDF</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path.empty())</div>
<div class="line">                out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = path_prefix + <span class="stringliteral">&quot;tint&quot;</span>; </div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Check for cutout-opacity</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IExpression&gt;</a> cutout(</div>
<div class="line">            cm-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#a873ecce34f04444dc3e0989526f3bd46" title="Looks up a sub-expression of the compiled material. ">lookup_sub_expression</a>(<span class="stringliteral">&quot;geometry.cutout_opacity&quot;</span>));</div>
<div class="line">        <span class="keywordflow">if</span>(cutout.is_valid_interface())</div>
<div class="line">            out_material[<span class="stringliteral">&quot;opacity&quot;</span>].bake_path = <span class="stringliteral">&quot;geometry.cutout_opacity&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (target_model == <span class="stringliteral">&quot;specular_glossy&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Setup parameters for the specular - glossy material model</span></div>
<div class="line">        out_material[<span class="stringliteral">&quot;base_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>); </div>
<div class="line">        out_material[<span class="stringliteral">&quot;f0&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;f0_color&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Rgb_fp&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;f0_refl&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;f0_weight&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;glossiness&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>, rough_to_gloss);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;opacity&quot;</span>]  = Material_parameter(<span class="stringliteral">&quot;Float32&quot;</span>);</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal_map&quot;</span>] = Material_parameter(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, remap_normal);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Specular-glossy distillation can result in a diffuse bsdf, a glossy bsdf </span></div>
<div class="line">        <span class="comment">// or a curve-weighted combination of both. Explicitly check the cases</span></div>
<div class="line">        <span class="comment">// and save the corresponding bake paths.</span></div>
<div class="line">        <span class="keywordflow">switch</span>(semantic)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a9ef0cefaf54499616b41d73482ed47b3" title="The df::diffuse_reflection_bsdf() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_DIFFUSE_REFLECTION_BSDF</a>:</div>
<div class="line">            out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.tint&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_weight&quot;</span>].value =  create_value(transaction, <span class="stringliteral">&quot;Float32&quot;</span>, 0.0f);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_color&quot;</span>].value = create_value(transaction, <span class="stringliteral">&quot;Color&quot;</span>, <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>(0.0f));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51a995acaeccbd4d42866de0e3fdf020ed3" title="The df::microfacet_ggx_vcavities() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_MICROFACET_GGX_VCAVITIES_BSDF</a>:</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_color&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.tint&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_refl&quot;</span>].value = create_value(transaction, <span class="stringliteral">&quot;Float32&quot;</span>, 1.0f);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_weight&quot;</span>].value = create_value(transaction, <span class="stringliteral">&quot;Float32&quot;</span>, 1.0f);</div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossiness&quot;</span>].bake_path = </div>
<div class="line">                <span class="stringliteral">&quot;surface.scattering.roughness_u&quot;</span>; <span class="comment">// needs inversion</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html#a31eb719644d42372c0612ec0a4dc5e51ada9130f13e75345dc9d93a4fb78a22bc" title="The df::custom_curve_layer() function. ">mi::neuraylib::IFunction_definition::DS_INTRINSIC_DF_CUSTOM_CURVE_LAYER</a>:</div>
<div class="line">            out_material[<span class="stringliteral">&quot;base_color&quot;</span>].bake_path =<span class="stringliteral">&quot;surface.scattering.base.tint&quot;</span>;</div>
<div class="line"></div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_color&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.layer.tint&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_refl&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.normal_reflectivity&quot;</span>;</div>
<div class="line">            out_material[<span class="stringliteral">&quot;f0_weight&quot;</span>].bake_path = <span class="stringliteral">&quot;surface.scattering.weight&quot;</span>;</div>
<div class="line"></div>
<div class="line">            out_material[<span class="stringliteral">&quot;glossiness&quot;</span>].bake_path = </div>
<div class="line">                <span class="stringliteral">&quot;surface.scattering.layer.roughness_u&quot;</span>; <span class="comment">// needs inversion</span></div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="comment">// unknown function, nothing to bake</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        out_material[<span class="stringliteral">&quot;normal_map&quot;</span>].bake_path = <span class="stringliteral">&quot;geometry.normal&quot;</span>;</div>
<div class="line">        out_material[<span class="stringliteral">&quot;opacity&quot;</span>].bake_path = <span class="stringliteral">&quot;geometry.cutout_opacity&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Constructs a material for the target model, extracts the bake paths relevant for this</span></div>
<div class="line"><span class="comment">// model from the compiled material and bakes those paths into textures or constant values</span></div>
<div class="line"><span class="keywordtype">void</span> bake_target_material_inputs(</div>
<div class="line">    <a class="code" href="group__mi__neuray__mdl__misc.html#ga89a2ac433f88dff3f1a280612cdf1086" title="Identifies the resource(s) to be used by a baker. ">mi::neuraylib::Baker_resource</a> baker_resource,</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> baking_samples,</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> baking_resolution,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>* cm,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>* distiller_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api,</div>
<div class="line">    Material&amp; out_material)</div>
<div class="line">{</div>
<div class="line">    Timing timing(<span class="stringliteral">&quot;Baking&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span>(Material::iterator it = out_material.begin();</div>
<div class="line">        it != out_material.end(); ++it)</div>
<div class="line">    {</div>
<div class="line">        Material_parameter&amp; param =  it-&gt;second;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Do not attempt to bake empty paths</span></div>
<div class="line">        <span class="keywordflow">if</span>(param.bake_path.empty())</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Create baker for current path</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IBaker&gt;</a> baker(distiller_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html#af2405d4d9a184d64ccabf81ff4a5e06e" title="Creates a baker for texture baking. ">create_baker</a>(</div>
<div class="line">            cm, param.bake_path.c_str(), baker_resource));</div>
<div class="line">        check_success(baker.is_valid_interface());</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(baker-&gt;is_uniform())</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IData&gt;</a> value;</div>
<div class="line">            <span class="keywordflow">if</span>(param.value_type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IColor&gt;</a> v(</div>
<div class="line">                    transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ad1b8ce71d7a6fea1f59573325dba126c" title="Creates an object of the type type_name. ">create</a>&lt;<a class="code" href="classmi_1_1IColor.html" title="This interface represents RGBA colors. ">mi::IColor</a>&gt;());</div>
<div class="line">                value = v-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1IData.html" title="This interface is the base interface of all types. ">mi::IData</a>&gt;();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(param.value_type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32_3&gt;</a> v(</div>
<div class="line">                    transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ad1b8ce71d7a6fea1f59573325dba126c" title="Creates an object of the type type_name. ">create</a>&lt;<a class="code" href="classmi_1_1IFloat32__3.html" title="This interface represents a vector of three Float32. ">mi::IFloat32_3</a>&gt;());</div>
<div class="line">                value = v-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1IData.html" title="This interface is the base interface of all types. ">mi::IData</a>&gt;();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(param.value_type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32&gt;</a> v(</div>
<div class="line">                    transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ad1b8ce71d7a6fea1f59573325dba126c" title="Creates an object of the type type_name. ">create</a>&lt;<a class="code" href="classmi_1_1IFloat32.html" title="This interface represents mi::Float32. ">mi::IFloat32</a>&gt;());</div>
<div class="line">                value = v-&gt;<a class="code" href="classmi_1_1base_1_1IInterface.html#aa24ef1b57dcff38f9abafc420978df5c" title="Acquires a const interface from another. ">get_interface</a>&lt;<a class="code" href="classmi_1_1IData.html" title="This interface is the base interface of all types. ">mi::IData</a>&gt;();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;Ignoring unsupported value type &#39;&quot;</span> &lt;&lt; param.value_type</div>
<div class="line">                    &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Bake constant value</span></div>
<div class="line">            <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = baker-&gt;bake_constant(value.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>());</div>
<div class="line">            check_success(result == 0);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(param.remap_func)</div>
<div class="line">                param.remap_func(value.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>());</div>
<div class="line"></div>
<div class="line">            param.value = value;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Create a canvas</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> canvas(</div>
<div class="line">                image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(param.value_type.c_str(), baking_resolution, baking_resolution));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Bake texture</span></div>
<div class="line">            <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result = baker-&gt;bake_texture(canvas.get(), baking_samples);</div>
<div class="line">            check_success(result == 0);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(param.remap_func)</div>
<div class="line">                param.remap_func(canvas.get());</div>
<div class="line"></div>
<div class="line">            param.texture = canvas;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</div>
<div class="line"><span class="keywordtype">void</span> init_value(<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas, <a class="code" href="classmi_1_1IData.html" title="This interface is the base interface of all types. ">mi::IData</a>* value, T*&amp; out_array, U&amp; out_value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>(canvas)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile(canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">        out_array =<span class="keyword">static_cast&lt;</span>T*<span class="keyword">&gt;</span>(tile-&gt;get_data());</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(value)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group__mi__neuray__types.html#gad12309fee401d9d99e64470c6a3dcfb2" title="Simplifies reading the value of mi::IData into the corresponding classes from the base and math API...">mi::get_value</a>(value, out_value);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> calculate_f0(<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* trans, Material&amp; material)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// if refl_weight value exists and is zero, set f0 to zero, too</span></div>
<div class="line">    <span class="keywordflow">if</span>(material[<span class="stringliteral">&quot;f0_weight&quot;</span>].value)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> v;</div>
<div class="line">        <a class="code" href="group__mi__neuray__types.html#gad12309fee401d9d99e64470c6a3dcfb2" title="Simplifies reading the value of mi::IData into the corresponding classes from the base and math API...">mi::get_value</a>(material[<span class="stringliteral">&quot;f0_weight&quot;</span>].value.get(), v);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(v==0.0f)</div>
<div class="line">        {</div>
<div class="line">            material[<span class="stringliteral">&quot;f0&quot;</span>].value = create_value(trans, <span class="stringliteral">&quot;Color&quot;</span>, <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>(0.0f));</div>
<div class="line">            material[<span class="stringliteral">&quot;f0&quot;</span>].texture = 0;</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> rx = material[<span class="stringliteral">&quot;f0&quot;</span>].texture-&gt;get_resolution_x();</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> ry = material[<span class="stringliteral">&quot;f0&quot;</span>].texture-&gt;get_resolution_y();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a>   f0_color_value(0.0f);</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> f0_weight_value = 0.0f;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> f0_refl_value = 0.0f;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>* f0 = <span class="keyword">nullptr</span>;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>* f0_color = <span class="keyword">nullptr</span>;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* f0_weight = <span class="keyword">nullptr</span>;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a>* f0_refl = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">    init_value(material[<span class="stringliteral">&quot;f0&quot;</span>].texture.get(), <span class="keyword">nullptr</span>, </div>
<div class="line">        f0, <span class="comment">/* dummy */</span> f0_color_value);</div>
<div class="line"></div>
<div class="line">    init_value(material[<span class="stringliteral">&quot;f0_color&quot;</span>].texture.get(), material[<span class="stringliteral">&quot;f0_color&quot;</span>].value.get(), </div>
<div class="line">        f0_color, f0_color_value);</div>
<div class="line">    init_value(material[<span class="stringliteral">&quot;f0_weight&quot;</span>].texture.get(), material[<span class="stringliteral">&quot;f0_weight&quot;</span>].value.get(), </div>
<div class="line">        f0_weight, f0_weight_value);</div>
<div class="line">    init_value(material[<span class="stringliteral">&quot;f0_refl&quot;</span>].texture.get(), material[<span class="stringliteral">&quot;f0_refl&quot;</span>].value.get(), </div>
<div class="line">        f0_refl, f0_refl_value);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> n =rx * ry;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> i=0; i&lt;n; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> t = (f0_weight ? f0_weight[i] : f0_weight_value) *</div>
<div class="line">            (f0_refl ? f0_refl[i] : f0_refl_value);</div>
<div class="line"></div>
<div class="line">        f0[i][0] = (f0_color ? f0_color[i][0] : f0_color_value[0]) * t;</div>
<div class="line">        f0[i][1] = (f0_color ? f0_color[i][1] : f0_color_value[1]) * t;</div>
<div class="line">        f0[i][2] = (f0_color ? f0_color[i][2] : f0_color_value[2]) * t;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Helper class to export canvases either sequentially or in parallel threads</span></div>
<div class="line"><span class="keyword">class </span>Canvas_exporter</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> m_in_parallel = <span class="keyword">true</span>;</div>
<div class="line">    std::map&lt;std::string<span class="comment">/*filename*/</span>, <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a>&gt; m_canvases;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Canvas_exporter(<span class="keywordtype">bool</span> parallel)</div>
<div class="line">        : m_in_parallel(parallel)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">void</span> add_canvas(<span class="keyword">const</span> std::string&amp; filename, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas)</div>
<div class="line">    {</div>
<div class="line">        m_canvases[filename] = <a class="code" href="group__mi__base__iinterface.html#gae266c35f2b70c271606d56840eca7b96" title="Converts passed-in interface pointer to a handle, without taking interface over. ">mi::base::make_handle_dup</a>(canvas);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> do_export(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a> * mdl_impexp_api)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> export_canvas = [mdl_impexp_api](<span class="keyword">const</span> <span class="keywordtype">char</span>* filename, <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas)</div>
<div class="line">        {</div>
<div class="line">            check_success(mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a1b544c77874b97eae0003c39e27e2103" title="Exports a canvas to a file on disk. ">export_canvas</a>(filename, canvas) == 0);</div>
<div class="line">        };</div>
<div class="line">        std::vector&lt;std::thread&gt; threads;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; canvas_file : m_canvases)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> * filename(canvas_file.first.c_str());</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html" title="Abstract interface for a canvas represented by a rectangular array of tiles. ">mi::neuraylib::ICanvas</a>* canvas(canvas_file.second.get());</div>
<div class="line">            <span class="keywordflow">if</span> (m_in_parallel)</div>
<div class="line">            {</div>
<div class="line">                threads.emplace_back(</div>
<div class="line">                    std::thread(export_canvas, filename, canvas)</div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                export_canvas(filename, canvas);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp; t : threads)</div>
<div class="line">        {</div>
<div class="line">            t.join();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Print some information about baked material parameters to the console and</span></div>
<div class="line"><span class="comment">// save the baked textures to disk</span></div>
<div class="line"><span class="keywordtype">void</span> process_target_material(</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; target_model,</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; material_name,</div>
<div class="line">    <span class="keyword">const</span> Material&amp; material,</div>
<div class="line">    <span class="keywordtype">bool</span> save_baked_textures,</div>
<div class="line">    <span class="keywordtype">bool</span> parallel,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>* mdl_impexp_api)</div>
<div class="line">{</div>
<div class="line">    Timing timing(<span class="stringliteral">&quot;Saving&quot;</span>);</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;--------------------------------------------------------------------------------&quot;</span></div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Material model: &quot;</span> &lt;&lt; target_model &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;--------------------------------------------------------------------------------&quot;</span></div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    Canvas_exporter canvas_exporter(parallel);</div>
<div class="line">    <span class="keywordflow">for</span>(Material::const_iterator it = material.begin();</div>
<div class="line">        it != material.end(); ++it)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> std::string&amp; param_name = it-&gt;first;</div>
<div class="line">        <span class="keyword">const</span> Material_parameter&amp; param = it-&gt;second;</div>
<div class="line"></div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Parameter: &#39;&quot;</span> &lt;&lt; param_name &lt;&lt; <span class="stringliteral">&quot;&#39;: &quot;</span>;</div>
<div class="line">        <span class="keywordflow">if</span>(param.bake_path.empty())</div>
<div class="line">        {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot; no matching bake path found in target material.&quot;</span> </div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(param.value)</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;--&gt; value set to &quot;</span>;</div>
<div class="line">            <span class="keywordflow">if</span>(param.texture)</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;--&gt; calculated &quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> </div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;path &#39;&quot;</span>&lt;&lt; param.bake_path &lt;&lt; <span class="stringliteral">&quot;&#39; baked to &quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(param.texture)</div>
<div class="line">        {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;texture.&quot;</span> &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// write texture to disc</span></div>
<div class="line">            std::stringstream file_name;</div>
<div class="line">            file_name &lt;&lt; material_name &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; param_name &lt;&lt; <span class="stringliteral">&quot;.png&quot;</span>;</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span>(save_baked_textures)</div>
<div class="line">                canvas_exporter.add_canvas(file_name.str(), param.texture.get());</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(param.value)</div>
<div class="line">        {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;constant &quot;</span>;</div>
<div class="line">            <span class="keywordflow">if</span>(param.value_type == <span class="stringliteral">&quot;Rgb_fp&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IColor&gt;</a> color(</div>
<div class="line">                    param.value-&gt;get_interface&lt;<a class="code" href="classmi_1_1IColor.html" title="This interface represents RGBA colors. ">mi::IColor</a>&gt;());</div>
<div class="line">                <a class="code" href="classmi_1_1math_1_1Color.html" title="Standard RGBA color class with floating point elements and operations. ">mi::Color</a> c;</div>
<div class="line">                color-&gt;get_value(c);</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;color (&quot;</span> </div>
<div class="line">                    &lt;&lt; c.<a class="code" href="structmi_1_1math_1_1Color__struct.html#acad44ab0bca0c4c83fb76084d5b50ef4" title="Red color component. ">r</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; c.<a class="code" href="structmi_1_1math_1_1Color__struct.html#a478d47744d183c1f986350e72ffee9b2" title="Green color component. ">g</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; c.<a class="code" href="structmi_1_1math_1_1Color__struct.html#addbb32d56e78607046cb175d076e604f" title="Blue color component. ">b</a> &lt;&lt; <span class="stringliteral">&quot;).&quot;</span>&lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(param.value_type == <span class="stringliteral">&quot;Float32&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32&gt;</a> value(</div>
<div class="line">                    param.value-&gt;get_interface&lt;<a class="code" href="classmi_1_1IFloat32.html" title="This interface represents mi::Float32. ">mi::IFloat32</a>&gt;());</div>
<div class="line">                <a class="code" href="group__mi__base__types.html#gac1b8c06a073706523d7a054c6e2a89c7" title="32-bit float. ">mi::Float32</a> v;</div>
<div class="line">                value-&gt;get_value(v);</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;float &quot;</span>  &lt;&lt; v &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(param.value_type == <span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::IFloat32_3&gt;</a> value(</div>
<div class="line">                    param.value-&gt;get_interface&lt;<a class="code" href="classmi_1_1IFloat32__3.html" title="This interface represents a vector of three Float32. ">mi::IFloat32_3</a>&gt;());</div>
<div class="line">                <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> v;</div>
<div class="line">                value-&gt;get_value(v);</div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;vector (&quot;</span> </div>
<div class="line">                    &lt;&lt; v.x &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; v.y &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; v.z &lt;&lt; <span class="stringliteral">&quot;).&quot;</span>&lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        std::cout </div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;--------------------------------------------------------------------------------&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Export canvases</span></div>
<div class="line">    canvas_exporter.do_export(mdl_impexp_api);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Prints program usage</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    std::cout</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;usage: &quot;</span> &lt;&lt; name &lt;&lt; <span class="stringliteral">&quot; [options] [&lt;material_name1&gt; ...]\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;-h                      print this text\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--target                distilling target:diffuse|diffuse_glossy|ue4|transmissive_pbr|\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;                        specular_glossy (default: ue4)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--baker_resource        baking device: gpu|cpu|gpu_with_cpu_fallback (default: cpu)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--samples               baking samples (default: 4)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--resolution            baking resolution (default: 1024)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--material_file &lt;file&gt;  file containing fully qualified names of materials to distill\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--do_not_save_textures  if set, avoid saving baked textures to file\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--module &lt;module_name&gt;  distill all materials from the module, can occur multiple times\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--no_parallel           do not save texture files in parallel threads\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;--mdl_path &lt;path&gt;       mdl search path, can occur multiple times.\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    exit(EXIT_FAILURE);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> load_materials_from_file(<span class="keyword">const</span> std::string &amp; material_file, std::vector&lt;std::string&gt; &amp; material_names)</div>
<div class="line">{</div>
<div class="line">    std::fstream file;</div>
<div class="line">    file.open(material_file, std::fstream::in);</div>
<div class="line">    <span class="keywordflow">if</span> (!file)</div>
<div class="line">    {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid file: &quot;</span> + material_file;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    std::string fn;</div>
<div class="line">    <span class="keywordflow">while</span> (getline(file, fn))</div>
<div class="line">    {</div>
<div class="line">        material_names.emplace_back(fn);</div>
<div class="line">    }</div>
<div class="line">    file.close();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> load_materials_from_modules(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a> * mdl_factory</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a> * transaction</div>
<div class="line">    , <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a> * mdl_impexp_api</div>
<div class="line">    , <span class="keyword">const</span> std::vector&lt;std::string&gt; &amp; module_names</div>
<div class="line">    , std::vector&lt;std::string&gt; &amp; material_names)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> context(</div>
<div class="line">        mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a78a9a6489592c90ea49e0fe0ac8be235" title="Creates an execution context. ">create_execution_context</a>());</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> module_name : module_names)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Sanity check</span></div>
<div class="line">        <span class="keywordflow">if</span> (module_name.find(<span class="stringliteral">&quot;::&quot;</span>) != 0)</div>
<div class="line">        {</div>
<div class="line">            module_name = std::string(<span class="stringliteral">&quot;::&quot;</span>) + module_name;</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> rtn(mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a5e195d80915190eb40c5995ccfeaa4c9" title="Loads an MDL module from disk (or a builtin module) into the database. ">load_module</a>(transaction, module_name.c_str(), context.get()));</div>
<div class="line">        check_success(rtn == 0 || rtn == 1);</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::IString&gt;</a> db_module_name(</div>
<div class="line">            mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a72a27c9e0d66e79391ff9a8e3ce4a119" title="Returns the DB name for the MDL name of a module (or file path for MDLE modules). ...">get_db_module_name</a>(module_name.c_str()));</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IModule&gt;</a> module(</div>
<div class="line">            transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IModule.html" title="This interface represents an MDL module. ">mi::neuraylib::IModule</a>&gt;(db_module_name-&gt;get_c_str()));</div>
<div class="line">        check_success(module.is_valid_interface());</div>
<div class="line">        <a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> material_count = module-&gt;get_material_count();</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 0; i &lt; material_count; i++)</div>
<div class="line">        {</div>
<div class="line">            std::string mname(module-&gt;get_material(i));</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IFunction_definition&gt;</a> material(</div>
<div class="line">                transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html" title="This interface represents a function definition. ">mi::neuraylib::IFunction_definition</a>&gt;(mname.c_str()));</div>
<div class="line">            material_names.push_back(material-&gt;get_mdl_name());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> MAIN_UTF8(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    std::string                     target_model = <span class="stringliteral">&quot;ue4&quot;</span>;</div>
<div class="line">    <a class="code" href="group__mi__neuray__mdl__misc.html#ga89a2ac433f88dff3f1a280612cdf1086" title="Identifies the resource(s) to be used by a baker. ">mi::neuraylib::Baker_resource</a>   baker_resource = <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086a145f36f183764f4e8ac8a83c3f9f8022" title="Use only the CPU for texture baking. ">mi::neuraylib::BAKE_ON_CPU</a>;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>                      baking_samples = 4;</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a>                      baking_resolution = 1024;</div>
<div class="line">    <span class="keywordtype">bool</span>                            parallel = <span class="keyword">true</span>;</div>
<div class="line">    std::vector&lt;std::string&gt;        material_names;</div>
<div class="line">    std::vector&lt;std::string&gt;        module_names;</div>
<div class="line">    std::string material_file;</div>
<div class="line">    <span class="keywordtype">bool</span> save_baked_textures(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    Timing timing(<span class="stringliteral">&quot;Elapsed&quot;</span>);</div>
<div class="line">    mi::examples::mdl::Configure_options configure_options;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Collect command line arguments, if any</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; argc; ++i) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *opt = argv[i];</div>
<div class="line">        <span class="keywordflow">if</span> (opt[0] == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">            <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--mdl_path&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    configure_options.additional_mdl_paths.push_back(argv[++i]);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--target&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    target_model = argv[++i];</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--baker_resource&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1) {</div>
<div class="line">                    std::string res = argv[++i];</div>
<div class="line">                    <span class="keywordflow">if</span> (res == <span class="stringliteral">&quot;gpu&quot;</span>)</div>
<div class="line">                        baker_resource = <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086af15d69862ab55cad12d75dc4974faab8" title="Use only the GPU for texture baking. ">mi::neuraylib::BAKE_ON_GPU</a>;</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <span class="stringliteral">&quot;gpu_with_cpu_fallback&quot;</span>)</div>
<div class="line">                        baker_resource = <a class="code" href="group__mi__neuray__mdl__misc.html#gga89a2ac433f88dff3f1a280612cdf1086a5fbec67c9f064e81aa346eb35a90757e" title="Prefer using the GPU for texture baking, use the CPU as fallback. ">mi::neuraylib::BAKE_ON_GPU_WITH_CPU_FALLBACK</a>;</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res != <span class="stringliteral">&quot;cpu&quot;</span>)</div>
<div class="line">                        usage(argv[0]);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--samples&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> val(atoi(argv[++i]));</div>
<div class="line">                    <span class="keywordflow">if</span> (val &gt; 0)</div>
<div class="line">                        baking_samples = val;</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid number of samples ignored\n&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--resolution&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> val(atoi(argv[++i]));</div>
<div class="line">                    <span class="keywordflow">if</span> (val &gt; 0)</div>
<div class="line">                        baking_resolution = val;</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid resolution ignored\n&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--material_file&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    material_file = argv[++i];</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--do_not_save_textures&quot;</span>) == 0) {</div>
<div class="line">                save_baked_textures = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--no_parallel&quot;</span>) == 0) {</div>
<div class="line">                parallel = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--module&quot;</span>) == 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt; argc - 1)</div>
<div class="line">                    module_names.emplace_back(argv[++i]);</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                usage(argv[0]);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            material_names.push_back(opt);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!material_file.empty())</div>
<div class="line">        load_materials_from_file(material_file, material_names);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Access the MDL SDK</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::INeuray&gt;</a> neuray(mi::examples::mdl::load_and_get_ineuray());</div>
<div class="line">    <span class="keywordflow">if</span> (!neuray.is_valid_interface())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::configure(neuray.get(), configure_options))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load the distilling plugin</span></div>
<div class="line">    <span class="keywordflow">if</span> (mi::examples::mdl::load_plugin(neuray.get(), <span class="stringliteral">&quot;mdl_distiller&quot;</span> <a class="code" href="group__mi__base__config.html#gad7232312ea690f7c9fd39ee34794d073" title="The operating system specific default filename extension for shared libraries (DLLs) ...">MI_BASE_DLL_FILE_EXT</a>) != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the mdl_distiller plugin.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Start the MDL SDK</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> ret = neuray-&gt;start();</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK. Result code: %d&quot;</span>, ret);</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_impexp_api&gt;</a> mdl_impexp_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get MDL factory</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::IMdl_factory&gt;</a> mdl_factory(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Create a transaction</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IDatabase&gt;</a> database(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IDatabase.html" title="This interface is used to interact with the distributed database. ">mi::neuraylib::IDatabase</a>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IScope&gt;</a> scope(database-&gt;get_global_scope());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::ITransaction&gt;</a> transaction(scope-&gt;create_transaction());</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!module_names.empty())</div>
<div class="line">        {</div>
<div class="line">            load_materials_from_modules(mdl_factory.get(), transaction.get(), mdl_impexp_api.get(), module_names, material_names);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (material_names.empty())</div>
<div class="line">        {</div>
<div class="line">            material_names.push_back(</div>
<div class="line">                <span class="stringliteral">&quot;::nvidia::sdk_examples::tutorials_distilling::example_distilling1&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; m : material_names)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// split module and material name</span></div>
<div class="line">            std::string module_qualified_name, material_simple_name;</div>
<div class="line">            <span class="keywordflow">if</span> (!mi::examples::mdl::parse_cmd_argument_material_name(</div>
<div class="line">                m, module_qualified_name, material_simple_name, <span class="keyword">true</span>))</div>
<div class="line">                exit_failure();</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Create an execution context</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> context(</div>
<div class="line">                mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a78a9a6489592c90ea49e0fe0ac8be235" title="Creates an execution context. ">create_execution_context</a>());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Load mdl module and create a material instance</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IFunction_call&gt;</a> instance(</div>
<div class="line">                create_material_instance(</div>
<div class="line">                    mdl_factory.get(),</div>
<div class="line">                    transaction.get(),</div>
<div class="line">                    mdl_impexp_api.get(),</div>
<div class="line">                    context.get(),</div>
<div class="line">                    module_qualified_name,</div>
<div class="line">                    material_simple_name));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Compile the material instance</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> compiled_material(</div>
<div class="line">                compile_material_instance(instance.get(), context.get(), <span class="keyword">false</span>));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Acquire distilling API used for material distilling and baking</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_distiller_api&gt;</a> distilling_api(</div>
<div class="line">                neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__distiller__api.html" title="Provides access to various functionality related to MDL distilling. ">mi::neuraylib::IMdl_distiller_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Distill compiled material to diffuse/glossy material model</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> distilled_material(</div>
<div class="line">                create_distilled_material(</div>
<div class="line">                    distilling_api.get(),</div>
<div class="line">                    compiled_material.get(),</div>
<div class="line">                    target_model.c_str()));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Acquire image API needed to create a canvas for baking</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api(</div>
<div class="line">                neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">            Material out_material;</div>
<div class="line">            <span class="comment">// Setup result material parameters relevant for target_model</span></div>
<div class="line">            <span class="comment">// and collect bake paths</span></div>
<div class="line">            setup_target_material(</div>
<div class="line">                target_model,</div>
<div class="line">                transaction.get(),</div>
<div class="line">                distilled_material.get(),</div>
<div class="line">                out_material);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Bake material inputs</span></div>
<div class="line">            bake_target_material_inputs(</div>
<div class="line">                baker_resource,</div>
<div class="line">                baking_samples,</div>
<div class="line">                baking_resolution,</div>
<div class="line">                transaction.get(),</div>
<div class="line">                distilled_material.get(),</div>
<div class="line">                distilling_api.get(),</div>
<div class="line">                image_api.get(),</div>
<div class="line">                out_material);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (target_model == <span class="stringliteral">&quot;specular_glossy&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// the specular glossy models f0 parameter cannot</span></div>
<div class="line">                <span class="comment">// be directly taken from the distilling result but</span></div>
<div class="line">                <span class="comment">// needs to be calculated</span></div>
<div class="line"></div>
<div class="line">                <span class="comment">// Create f0 canvas</span></div>
<div class="line">                out_material[<span class="stringliteral">&quot;f0&quot;</span>].texture =</div>
<div class="line">                    image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(<span class="stringliteral">&quot;Rgb_fp&quot;</span>, baking_resolution, baking_resolution);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// fill it</span></div>
<div class="line">                calculate_f0(transaction.get(), out_material);</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">// Process resulting material, in this case we simply</span></div>
<div class="line">            <span class="comment">// print some information about the baked parameters</span></div>
<div class="line">            <span class="comment">// and save the textures to disk, if any</span></div>
<div class="line">            process_target_material(</div>
<div class="line">                target_model,</div>
<div class="line">                material_simple_name,</div>
<div class="line">                out_material,</div>
<div class="line">                save_baked_textures,</div>
<div class="line">                parallel,</div>
<div class="line">                mdl_impexp_api.get());</div>
<div class="line">        }</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#aa4ff8152107db238986b364273bceb0c" title="Commits the transaction. ">commit</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Shut down the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (neuray-&gt;shutdown() != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to shutdown the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Unload the MDL SDK</span></div>
<div class="line">    neuray = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::unload())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to unload the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    exit_success();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert command line arguments to UTF8 on Windows</span></div>
<div class="line">COMMANDLINE_TO_UTF8</div>
</div><!-- fragment --><div align="right"> [<a class="el" href="mi_neuray_example_derivatives.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_distilling_unity.html">Next</a>] </div> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path">
<span class="footeritem">5&#160;April&#160;2022,&#160;20:40, rev.358266</span>
<span class="footeritem"><a href="https://www.nvidia.com/en-us/about-nvidia/legal-info/" target="_blank" shape="rect">&copy; 2022 NVIDIA&nbsp;Corporation.</a> All rights reserved.</span>
</div>
</body>
</html>
