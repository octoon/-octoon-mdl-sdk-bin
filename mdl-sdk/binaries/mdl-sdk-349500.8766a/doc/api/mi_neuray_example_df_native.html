<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Example for Integrating MDL into a Renderer by Using the Native Backend (CPU)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="images/arcicon.ico" rel="shortcut icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_custom_stylesheet_1_8_4.css" rel="stylesheet" type="text/css"/>
<link rel='stylesheet' href='webfonts/librebaskerville/stylesheet.css' type='text/css'/>
<link rel='stylesheet' href='webfonts/sourcesanspro/stylesheet.css' type='text/css'/>
<!--ARC-->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="blackheader">
<span id="blackheader_title">MDL SDK API</span>
<span>
<img src="images/nvidia_logo_transpbg.gif" alt="nvidia_logo_transpbg.gif" style=" height:1.25em; width:6.806em;"/></span>
<span id="blackheader_uplink">
<a href='../index.html' class='top_page_nav'>Up</a>
</span>
</div>
<!--
<div id="titlearea">
   <span id="projectname">
     <a id="titlelink" href="../../index.html">
       MDL SDK API
     </a>
   </span>
     <a id="projectlogo" href="http://www.nvidia-arc.com">
       <img alt="NVIDIA logo" src="images/nvidia_logo.png" style="height:2em;">
       </a>
     <a href='../index.html' class='top_page_nav'>Up</a>
</div>
-->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mi_neuray_example_df_native.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example for Integrating MDL into a Renderer by Using the Native Backend (CPU) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div align="right"> [<a class="el" href="mi_neuray_example_df_cuda.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_derivatives.html">Next</a>] </div><p>This example demonstrates how to generate target code for the native backend (CPU) from an MDL material and use the generated BSDF functions in a CPU based renderer to account for the <code>surface.scattering</code>, <code>emission</code>, <code>thin_walled</code> and <code>geometry.cutout_opacity</code> expressions of the material. The example implements a physically based path-tracer technique for rendering a single sphere with MDL materials. The sphere is illuminated by a point light and/or an HDR environment map as seen from a perspective camera. The MDL material is loaded from a module and compiled for native backend (CPU) in order to execute different BSDF target functions during renderings. The renderer takes advantage of multi-threading by assigning different spans of the framebuffer to the available logical cores.</p>
<h1><a class="anchor" id="example_df_native_new"></a>
New Topics</h1>
<ul>
<li>Generating target code for BSDF functions (CPU).</li>
<li>Using generated BSDF functions (CPU). </li>
</ul>
<h1><a class="anchor" id="example_df_native_descr"></a>
Detailed Description</h1>
<dl>
<dt><b>Generating target code for BSDF functions (CPU)</b> </dt>
<dd><p class="startdd"><br/>
 The whole target code generation process for this example can be divided in 3 steps:</p>
<ul>
<li>Create the material instance: Here an MDL material is loaded from a module and instantiated. For further information about material instantiation, please check <a class="el" href="mi_neuray_example_instantiation.html">Example for Instantiation of MDL Definitions</a>. In the example, this is performed by the method:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> create_material_instance(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>*            mdl_factory,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>*            transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>*         mdl_impexp_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>*  context,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>*                             material_name,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>*                             instance_name,</div>
<div class="line">    <span class="keywordtype">bool</span>                                    encoded_names_enabled);</div>
</div><!-- fragment --><ul>
<li>Compile the material instance: The material instance is not only required to generate target code for a given backend but also to inspect the material properties and collect the required material sub-expressions to be translated by the link unit. For example, if a material is thin walled, it may be required to translate also sub-expressions of <code>backface</code>. Please check <a class="el" href="mi_neuray_compiler.html#mi_neuray_compilation_modes">Instance-compilation and class-compilation</a> for further information about the material compilation. In the example, this is performed by the method:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> compile_material_instance(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>*            transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>*  context,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>*                             instance_name,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>*                             compiled_material_name,</div>
<div class="line">    <span class="keywordtype">bool</span>                                    class_compilation);</div>
</div><!-- fragment --><ul>
<li>Generate the target code: Here, depending on the compiled material, different sub-expressions are selected and translated by the link unit for the native backend (CPU). In the example, this is performed by the method:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> generate_native(</div>
<div class="line">    Render_context&amp;                         render_context,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>*            transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>*        mdl_backend_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>*  context,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>*                             compiled_material_name,</div>
<div class="line">    <span class="keywordtype">bool</span>                                    use_custom_tex_runtime,</div>
<div class="line">    <span class="keywordtype">bool</span>                                    enable_derivatives);</div>
</div><!-- fragment --><p>Let's have a more detailed look at the last step. First, the native backend is obtained through the MDL backend API <code>mdl_backend_api</code> and the link unit is created:</p>
<div class="fragment"><div class="line"><a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend&gt;</a> be_native(</div>
<div class="line">    mdl_backend_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a74baca56433d61f89de6b68019b6beb5" title="Returns an MDL backend generator. ">get_backend</a>(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a28a914c7c51dd45974b16fa189a77b46a353b866fa7aac285667aded4b8dba94b" title="Generate native code. ">mi::neuraylib::IMdl_backend_api::MB_NATIVE</a>));</div>
<div class="line">...</div>
<div class="line"> <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ILink_unit&gt;</a> link_unit(</div>
<div class="line">    be_native-&gt;create_link_unit(transaction, context));</div>
</div><!-- fragment --><p>Next, the material sub-expressions are collected and passed to the link unit along the compiled material:</p>
<div class="fragment"><div class="line">std::vector&lt;mi::neuraylib::Target_function_description&gt; descs;</div>
<div class="line">descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;surface.scattering&quot;</span>));</div>
<div class="line">descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;surface.emission.emission&quot;</span>));</div>
<div class="line">descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;surface.emission.intensity&quot;</span>));</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">bool need_backface_bsdf = is_thing_walled &amp;&amp; </div>
<div class="line">    compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162a95356115b56fa4672f7e57a887261186" title="Slot surface.scattering. ">mi::neuraylib::SLOT_SURFACE_SCATTERING</a>) !=</div>
<div class="line">    compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162a1ef3c4a0f4a892679f761d38aa0853d9" title="Slot backface.scattering. ">mi::neuraylib::SLOT_BACKFACE_SCATTERING</a>);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (need_backface_bsdf)</div>
<div class="line">{</div>
<div class="line">    backface_scattering_index = descs.size();</div>
<div class="line">    descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;backface.scattering&quot;</span>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">link_unit-&gt;add_material(</div>
<div class="line">    compiled_material.get(),</div>
<div class="line">    descs.data(),</div>
<div class="line">    descs.size(),</div>
<div class="line">    context);</div>
</div><!-- fragment --><p>where <code>descs</code>, of type <a class="el" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>, serves to collect the sub-expressions required later during rendering. Some sub-expressions are known to be required while others are added dynamically by inspecting different elements of the compiled material:</p>
<p>Note that the renderer has to keep track of the indices of the sub-expressions in the array <code>descs</code> in order to lookup the functions later during rendering when executing any function of <a class="el" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a>. In the example, the struct <code>render_context</code> is used for that:</p>
<div class="fragment"><div class="line">render_context.surface_bsdf_function_index =                descs[0].function_index;</div>
<div class="line">render_context.surface_edf_function_index =                 descs[1].function_index;</div>
<div class="line">render_context.surface_emission_intensity_function_index =  descs[2].function_index;</div>
<div class="line">...</div>
</div><!-- fragment --><p>Finally, the target code for the native backend (CPU) is generated:</p>
<div class="fragment"><div class="line"><a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;</a> code_native(</div>
<div class="line">    be_native-&gt;translate_link_unit(link_unit.get(), context));</div>
</div><!-- fragment --><p>In the example the struct <code>render_context</code> is used to take ownership of <code>code_native</code> in order to extend its scope to the renderer application scope, otherwise it would be freed by the end of <code>generate_native()</code> :</p>
<div class="fragment"><div class="line">render_context.target_code = code_native;</div>
</div><!-- fragment --><p class="enddd"></p>
</dd>
</dl>
<dl>
<dt><b>Using generated BSDF functions (CPU)</b> </dt>
<dd><p class="startdd"><br/>
 At this point the target code for the native backend is available for the renderer and it can be used to query material properties and evaluate material distribution functions. Here for example, the renderer uses <code>target_code</code> to obtain the <code>cutout_opacity</code> and <code>thin_walled</code> material properties for the current <code>shading_state:</code> </p>
<div class="fragment"><div class="line"><span class="comment">// evaluate material cutout opacity state</span></div>
<div class="line"><span class="keywordtype">float</span> cutout_opacity = rc.cutout.constant_opacity;</div>
<div class="line"><span class="keywordflow">if</span> (!rc.cutout.is_constant)</div>
<div class="line">{</div>
<div class="line">    rc.target_code-&gt;execute(</div>
<div class="line">        rc.cutout_opacity_function_index,</div>
<div class="line">        reinterpret_cast&lt;mi::neuraylib::Shading_state_material&amp;&gt;(rc.shading_state),</div>
<div class="line">        <span class="comment">/*texture_handler=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">        <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">        &amp;cutout_opacity);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line"><span class="comment">// evaluate thin_walled state</span></div>
<div class="line">bool is_thin_walled = rc.thin_walled.is_thin_walled;</div>
<div class="line"><span class="keywordflow">if</span> (!rc.thin_walled.is_constant)</div>
<div class="line">{</div>
<div class="line">    rc.target_code-&gt;execute(</div>
<div class="line">        rc.thin_walled_function_index,</div>
<div class="line">        reinterpret_cast&lt;mi::neuraylib::Shading_state_material&amp;&gt;(rc.shading_state),</div>
<div class="line">        <span class="comment">/*texture_handler=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">        <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">        &amp;is_thin_walled);</div>
<div class="line">}    </div>
</div><!-- fragment --><p>and here, the renderer uses three <code>target_code</code> functions to evaluate the material emission contribution for the current <code>shading_state</code>.</p>
<ul>
<li><code>target_code-&gt;execute_bsdf_init()</code> to initialize the emission distribution function for the current <code>shading_state</code> and function index <code>edf_function_index</code>.</li>
<li><code>target_code-&gt;execute_edf_evaluate()</code> to evaluate material emission distribution function for the current view direction <code>eval_data.k1</code> and function index <code>edf_function_index</code>.</li>
<li><code>target_code-&gt;execute()</code> to obtain the emission <code>intensity</code> for the function index <code>surface_emission_intensity_function_index</code>.</li>
</ul>
<div class="fragment"><div class="line">uint64_t edf_function_index = ray.is_inside ? rc.backface_edf_function_index : rc.surface_edf_function_index;</div>
<div class="line"><span class="comment">// shader initialization for the current hit point</span></div>
<div class="line">rc.target_code-&gt;execute_bsdf_init(</div>
<div class="line">    edf_function_index,</div>
<div class="line">    rc.shading_state,</div>
<div class="line">    <span class="keyword">nullptr</span>,</div>
<div class="line">    <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">mi::neuraylib::Edf_evaluate_data&lt;mi::neuraylib::DF_HSM_NONE&gt; eval_data;</div>
<div class="line">eval_data.k1 = -ray.dir;</div>
<div class="line"></div>
<div class="line"><span class="comment">// evaluate material surface edf</span></div>
<div class="line">rc.target_code-&gt;execute_edf_evaluate(</div>
<div class="line">    edf_function_index + 2,     <span class="comment">// edf_function_index corresponds to &#39;init&#39;</span></div>
<div class="line">                                <span class="comment">// edf_function_index + 2 to &#39;evaluate&#39;</span></div>
<div class="line">    &amp;eval_data,</div>
<div class="line">    rc.shading_state,</div>
<div class="line">    <span class="comment">/*texture_handler=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">    <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (eval_data.pdf &gt; 1.e-6f)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> intensity(1.f);</div>
<div class="line">    rc.target_code-&gt;execute(</div>
<div class="line">        rc.surface_emission_intensity_function_index,</div>
<div class="line">        reinterpret_cast&lt;mi::neuraylib::Shading_state_material&amp;&gt;(rc.shading_state),</div>
<div class="line">        <span class="comment">/*texture_handler=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">        <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">        &amp;intensity);</div>
<div class="line"></div>
<div class="line">    vp_sample[VPCH_ILLUM] += <span class="keyword">static_cast&lt;</span><a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a><span class="keyword">&gt;</span>(eval_data.edf)*intensity*ray.weight;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="enddd"></p>
</dd>
</dl>
<h1><a class="anchor" id="example_df_native"></a>
Example Source</h1>
<p>To compile the source code, GLFW and GLEW are required. For detailed instructions, please refer to the <a class="el" href="mi_neuray_getting_started.html">Getting Started </a> section.</p>
<p><b>Source Code Location:</b> <code>examples/mdl_sdk/df_native/example_df_native.cpp</code></p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment"> * Copyright 2022 NVIDIA Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *****************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// examples/mdl_sdk/df_native/example_df_native.cpp</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Simple CPU renderer using compiled BSDFs with a material parameter editor GUI.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#define _USE_MATH_DEFINES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="math_8h.html" title="Math API. ">math.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;example_shared.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;texture_support_native.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;GL/glew.h&gt;</span></div>
<div class="line"><span class="preprocessor">#define GLFW_INCLUDE_NONE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;GLFW/glfw3.h&gt;</span></div>
<div class="line"><span class="preprocessor">#define GL_DISPLAY_NATIVE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;utils/gl_display.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if MI_PLATFORM_MACOSX</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/sysctl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;utils/profiling.h&quot;</span></div>
<div class="line"><span class="keyword">using namespace </span>mi::examples::profiling;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define USE_PARALLEL_RENDERING</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Global Constants</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> DIRAC = -1.f;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> PI = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(M_PI);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmi_1_1math_1_1Vector__struct.html" title="Generic storage class template for math vector representations storing DIM elements of type T...">mi::Float32_3_struct</a> tangent_u[1] = { {1.0f, 0.0f, 0.0f} };</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmi_1_1math_1_1Vector__struct.html" title="Generic storage class template for math vector representations storing DIM elements of type T...">mi::Float32_3_struct</a> tangent_v[1] = { { 0.0f, 1.0f, 0.0f} };</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Matrix.html" title="NxM-dimensional matrix class template of fixed dimensions. ">mi::Float32_3_4</a> identity = <a class="code" href="namespacemi.html#a028c4496d732c9aeffbd6e6e998404ca" title="3 x 4 matrix of Float32. ">mi::Float32_3_4</a>(</div>
<div class="line">        1.0f, 0.0f, 0.0f, 0.0f,</div>
<div class="line">        0.0f, 1.0f, 0.0f, 0.0f,</div>
<div class="line">        0.0f, 0.0f, 1.0f, 0.0f);</div>
<div class="line">} Constants;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Random Number Generator</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">unsigned</span> tea(<span class="keywordtype">unsigned</span> N, <span class="keywordtype">unsigned</span> val0, <span class="keywordtype">unsigned</span> val1)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> v0 = val0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> v1 = val1;</div>
<div class="line">    <span class="keywordtype">unsigned</span> s0 = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> n = 0; n &lt; N; n++)</div>
<div class="line">    {</div>
<div class="line">        s0 += 0x9e3779b9;</div>
<div class="line">        v0 += ((v1 &lt;&lt; 4) + 0xa341316c) ^ (v1 + s0) ^ ((v1 &gt;&gt; 5) + 0xc8013ea4);</div>
<div class="line">        v1 += ((v0 &lt;&lt; 4) + 0xad90777d) ^ (v0 + s0) ^ ((v0 &gt;&gt; 5) + 0x7e95761e);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> v0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Generate random uint in [0, 2^24)</span></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">unsigned</span> lcg(<span class="keywordtype">unsigned</span> &amp;prev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> LCG_A = 1664525u;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> LCG_C = 1013904223u;</div>
<div class="line">    prev = (LCG_A * prev + LCG_C);</div>
<div class="line">    <span class="keywordflow">return</span> prev &amp; 0x00FFFFFF;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Generate random float in [0, 1)</span></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">float</span> rnd(<span class="keywordtype">unsigned</span> &amp;prev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> next = lcg(prev);</div>
<div class="line">    <span class="keywordflow">return</span> ((<span class="keywordtype">float</span>)next / (<span class="keywordtype">float</span>)0x01000000);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Window Handling</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Window context structure for window keys/mouse event callback functions.</span></div>
<div class="line"><span class="keyword">struct </span>Window_context</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> mouse_event, key_event;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// for environment</span></div>
<div class="line">    <span class="keywordtype">float</span> env_intensity;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// for omni light movement</span></div>
<div class="line">    <span class="keywordtype">float</span> omni_theta;</div>
<div class="line">    <span class="keywordtype">float</span> omni_phi;</div>
<div class="line">    <span class="keywordtype">float</span> omni_intensity;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// for camera movement</span></div>
<div class="line">    <span class="keywordtype">int</span> mouse_button;            <span class="comment">// button from callback event plus one (0 = no event)</span></div>
<div class="line">    <span class="keywordtype">int</span> mouse_button_action;     <span class="comment">// action from mouse button callback event</span></div>
<div class="line">    <span class="keywordtype">int</span> mouse_wheel_delta;</div>
<div class="line">    <span class="keywordtype">bool</span> moving;</div>
<div class="line">    <span class="keywordtype">double</span> move_start_x, move_start_y;</div>
<div class="line">    <span class="keywordtype">double</span> move_dx, move_dy;</div>
<div class="line">    <span class="keywordtype">int</span> zoom;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// image output</span></div>
<div class="line">    <span class="keywordtype">bool</span> save_sreenshot;</div>
<div class="line"></div>
<div class="line">    Window_context()</div>
<div class="line">        : mouse_event(false)</div>
<div class="line">        , key_event(false)</div>
<div class="line">        , env_intensity(0.0f)</div>
<div class="line">        , omni_theta(0.0f)</div>
<div class="line">        , omni_phi(0.0f)</div>
<div class="line">        , omni_intensity(0.0f)</div>
<div class="line">        , mouse_button(0)</div>
<div class="line">        , mouse_button_action(0)</div>
<div class="line">        , mouse_wheel_delta(0)</div>
<div class="line">        , moving(false)</div>
<div class="line">        , move_start_x(0.0)</div>
<div class="line">        , move_start_y(0.0)</div>
<div class="line">        , move_dx(0.0)</div>
<div class="line">        , move_dy(0.0)</div>
<div class="line">        , zoom(0)</div>
<div class="line">        , save_sreenshot(false)</div>
<div class="line">    {}</div>
<div class="line"></div>
<div class="line">    <span class="comment">// GLFW keyboard callback</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> handle_key(GLFWwindow *window, <span class="keywordtype">int</span> key, <span class="keywordtype">int</span> scancode, <span class="keywordtype">int</span> action, <span class="keywordtype">int</span> mods)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Handle key press events</span></div>
<div class="line">        <span class="keywordflow">if</span> (action == GLFW_PRESS)</div>
<div class="line">        {</div>
<div class="line">            Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (mods&amp;GLFW_MOD_CONTROL)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">switch</span> (key)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_MINUS:</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_KP_SUBTRACT:</div>
<div class="line">                    ctx-&gt;env_intensity -= 0.05f;</div>
<div class="line">                    <span class="keywordflow">if</span> (ctx-&gt;env_intensity &lt; 0.f) ctx-&gt;env_intensity = 0.f;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_KP_ADD:</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_EQUAL:</div>
<div class="line">                    ctx-&gt;env_intensity += 0.05f;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">switch</span> (key)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Escape closes the window</span></div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_ESCAPE:</div>
<div class="line">                    glfwSetWindowShouldClose(window, GLFW_TRUE);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_DOWN:</div>
<div class="line">                    ctx-&gt;omni_theta += 0.05f*Constants.PI;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_UP:</div>
<div class="line">                    ctx-&gt;omni_theta -= 0.05f*Constants.PI;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_LEFT:</div>
<div class="line">                    ctx-&gt;omni_phi -= 0.05f*Constants.PI;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_RIGHT:</div>
<div class="line">                    ctx-&gt;omni_phi += 0.05f*Constants.PI;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_MINUS:</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_KP_SUBTRACT:</div>
<div class="line">                    ctx-&gt;omni_intensity -= 1000.f;</div>
<div class="line">                    <span class="keywordflow">if</span> (ctx-&gt;omni_intensity &lt; 0.f) ctx-&gt;omni_intensity = 0.f;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_KP_ADD:</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_EQUAL:</div>
<div class="line">                    ctx-&gt;omni_intensity += 1000.f;</div>
<div class="line">                    ctx-&gt;key_event = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> GLFW_KEY_ENTER:</div>
<div class="line">                    ctx-&gt;save_sreenshot = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ImGui_ImplGlfw_KeyCallback(window, key, scancode, action, mods);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// GLFW mouse button callback</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> handle_mouse_button(GLFWwindow *window, <span class="keywordtype">int</span> button, <span class="keywordtype">int</span> action, <span class="keywordtype">int</span> mods)</div>
<div class="line">    {</div>
<div class="line">        Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">        ctx-&gt;mouse_button = button + 1;</div>
<div class="line">        ctx-&gt;mouse_button_action = action;</div>
<div class="line"></div>
<div class="line">        ImGui_ImplGlfw_MouseButtonCallback(window, button, action, mods);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// GLFW mouse position callback</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> handle_mouse_pos(GLFWwindow *window, <span class="keywordtype">double</span> xpos, <span class="keywordtype">double</span> ypos)</div>
<div class="line">    {</div>
<div class="line">        Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">        <span class="keywordflow">if</span> (ctx-&gt;moving)</div>
<div class="line">        {</div>
<div class="line">            ctx-&gt;move_dx += xpos - ctx-&gt;move_start_x;</div>
<div class="line">            ctx-&gt;move_dy += ypos - ctx-&gt;move_start_y;</div>
<div class="line">            ctx-&gt;move_start_x = xpos;</div>
<div class="line">            ctx-&gt;move_start_y = ypos;</div>
<div class="line">            ctx-&gt;mouse_event = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// GLFW scroll callback</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> handle_scroll(GLFWwindow *window, <span class="keywordtype">double</span> xoffset, <span class="keywordtype">double</span> yoffset)</div>
<div class="line">    {</div>
<div class="line">        Window_context *ctx = <span class="keyword">static_cast&lt;</span>Window_context*<span class="keyword">&gt;</span>(glfwGetWindowUserPointer(window));</div>
<div class="line">        <span class="keywordflow">if</span> (yoffset &gt; 0.0)</div>
<div class="line">        {</div>
<div class="line">            ctx-&gt;mouse_wheel_delta = 1;</div>
<div class="line">            ctx-&gt;mouse_event = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (yoffset &lt; 0.0)</div>
<div class="line">        {</div>
<div class="line">            ctx-&gt;mouse_wheel_delta = -1;</div>
<div class="line">            ctx-&gt;mouse_event = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ImGui_ImplGlfw_ScrollCallback(window, xoffset, yoffset);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Vector Helper Functions</span></div>
<div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> int_as_float(uint32_t v)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">union</span></div>
<div class="line">    {</div>
<div class="line">        uint32_t bit;</div>
<div class="line">        <span class="keywordtype">float</span>    value;</div>
<div class="line">    } temp;</div>
<div class="line"></div>
<div class="line">    temp.bit = v;</div>
<div class="line">    <span class="keywordflow">return</span> temp.value;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t float_as_int(<span class="keywordtype">float</span> v)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">union</span></div>
<div class="line">    {</div>
<div class="line">        uint32_t bit;</div>
<div class="line">        <span class="keywordtype">float</span>    value;</div>
<div class="line">    } temp;</div>
<div class="line"></div>
<div class="line">    temp.value = v;</div>
<div class="line">    <span class="keywordflow">return</span> temp.bit;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;d, <span class="keywordtype">float</span> min = 0.f, <span class="keywordtype">float</span> max = 1.f)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (d[i] &lt; min)</div>
<div class="line">            d[i] = min;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d[i] &gt; max)</div>
<div class="line">            d[i] = max;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__mi__math__function.html#gaab1f278e40b1524c2c83b33e05fee81f" title="Returns the Euclidean norm of the scalar a (its absolute value). ">length</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;d)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> sqrtf(d.x * d.x + d.y * d.y + d.z * d.z);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;a, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> (a.x * b.x + a.y * b.y + a.z * b.z);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> normalize(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;d)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> inv_len = 1.0f / <a class="code" href="group__mi__math__function.html#gaab1f278e40b1524c2c83b33e05fee81f" title="Returns the Euclidean norm of the scalar a (its absolute value). ">length</a>(d);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(d.x * inv_len, d.y * inv_len, d.z * inv_len);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> <a class="code" href="group__mi__math__bbox.html#gaf040cc4c039ba166c59300683dca980a" title="Returns a bounding box that is the bbox increased by a constant value at each face, i.e., value is added to bbox.max and subtracted from bbox.min. ">operator+</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; a, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(a.x + b.x, a.y + b.y, a.z + b.z);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> <a class="code" href="group__mi__base__types.html#gaa99b8610590fe17df980d8587e1af81d" title="Reverses the sign of a three valued enum. ">operator-</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; a, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(a.x - b.x, a.y - b.y, a.z - b.z);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> <a class="code" href="group__mi__math__bbox.html#ga66a9bcc85c6e0bd89112445d3b16d655" title="Returns a bounding box that is a version of bbox scaled by factor, i.e., bbox.max and bbox...">operator*</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; a, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(a.x * b.x, a.y * b.y, a.z * b.z);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> <a class="code" href="group__mi__math__bbox.html#ga66a9bcc85c6e0bd89112445d3b16d655" title="Returns a bounding box that is a version of bbox scaled by factor, i.e., bbox.max and bbox...">operator*</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; d, <span class="keywordtype">float</span> s)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(d.x * s, d.y * s, d.z * s);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> <a class="code" href="group__mi__math__bbox.html#ga27657e606d65aa9dee41e1246542ab5c" title="Returns a bounding box that is a version of bbox divided by divisor, i.e., bbox.max and bbox...">operator/</a>(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; d, <span class="keywordtype">float</span> s)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> inv_s = 1.0f / s;</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(d.x * inv_s, d.y * inv_s, d.z * inv_s);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Command Line Options</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Command line options structure.</span></div>
<div class="line"><span class="keyword">struct </span>Options</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Don&#39;t open OpenGL GUI</span></div>
<div class="line">    <span class="keywordtype">bool</span> no_gui;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Number of iterations for output images</span></div>
<div class="line">    <span class="keywordtype">size_t</span> iterations;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// A result output file name.</span></div>
<div class="line">    std::string outputfile;</div>
<div class="line">    <span class="keywordtype">bool</span> output_auxiliary; <span class="comment">// output albedo and normal auxiliary buffers.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// The resolution of the display / image.</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> res_x, res_y;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Path-tracer max ray-length</span></div>
<div class="line">    <span class="keywordtype">int</span> max_ray_length;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Environment map filename and scale</span></div>
<div class="line">    std::string env_map;</div>
<div class="line">    <span class="keywordtype">float</span> env_scale;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Camera position and FOV</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> cam_pos;</div>
<div class="line">    <span class="keywordtype">float</span> cam_fov;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Light position and intensity</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> light_pos;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> light_intensity;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Whether class compilation should be used for the materials.</span></div>
<div class="line">    <span class="keywordtype">bool</span> use_class_compilation;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Whether the custom texture runtime should be used.</span></div>
<div class="line">    <span class="keywordtype">bool</span> use_custom_tex_runtime;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Whether normals should be adapted.</span></div>
<div class="line">    <span class="keywordtype">bool</span> use_adapt_normal;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Whether derivative support should be enabled.</span></div>
<div class="line">    <span class="comment">// This example does not support derivatives in combination with the custom texture runtime.</span></div>
<div class="line">    <span class="keywordtype">bool</span> enable_derivatives;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Material to use.</span></div>
<div class="line">    std::string material_name;</div>
<div class="line"></div>
<div class="line">    Options()</div>
<div class="line">        : no_gui(false)</div>
<div class="line">        , iterations(100)</div>
<div class="line">        , outputfile(<span class="stringliteral">&quot;example_df_native.png&quot;</span>)</div>
<div class="line">        , output_auxiliary(false)</div>
<div class="line">        , res_x(700)</div>
<div class="line">        , res_y(520)</div>
<div class="line">        , max_ray_length(6)</div>
<div class="line">        , env_map(<span class="stringliteral">&quot;nvidia/sdk_examples/resources/environment.hdr&quot;</span>)</div>
<div class="line">        , env_scale(1.f)</div>
<div class="line">        , cam_pos(0.f, 0.f, 3.f)</div>
<div class="line">        , cam_fov(86.f)</div>
<div class="line">        , light_pos(10.f, 5.f, 0.f)</div>
<div class="line">        , light_intensity(1.0f, 0.902f, 0.502f)</div>
<div class="line">        , use_class_compilation(false)</div>
<div class="line">        , use_custom_tex_runtime(false)</div>
<div class="line">        , use_adapt_normal(false)</div>
<div class="line">        , enable_derivatives(false)</div>
<div class="line">    {}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Scene Render Context</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Viewport buffers for progressive rendering</span></div>
<div class="line"><span class="keyword">enum</span> VP_channel</div>
<div class="line">{</div>
<div class="line">    VPCH_ILLUM = 0,</div>
<div class="line">    VPCH_ALBEDO,</div>
<div class="line">    VPCH_NORMAL,</div>
<div class="line">    VPCH_NB_CHANNELS</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>VP_buffers</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> *accum_buffer;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> *albedo_buffer;</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> *normal_buffer;</div>
<div class="line"></div>
<div class="line">    VP_buffers()</div>
<div class="line">        : accum_buffer(nullptr)</div>
<div class="line">        , albedo_buffer(nullptr)</div>
<div class="line">        , normal_buffer(nullptr)</div>
<div class="line">    {}</div>
<div class="line"></div>
<div class="line">    ~VP_buffers()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (accum_buffer)</div>
<div class="line">            <span class="keyword">delete</span>[] accum_buffer;</div>
<div class="line">        <span class="keywordflow">if</span> (albedo_buffer)</div>
<div class="line">            <span class="keyword">delete</span>[] albedo_buffer;</div>
<div class="line">        <span class="keywordflow">if</span> (normal_buffer)</div>
<div class="line">            <span class="keyword">delete</span>[] normal_buffer;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Surface intersection info</span></div>
<div class="line"><span class="keyword">struct </span>Isect_info</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> pos;    <span class="comment">// surface position</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> normal; <span class="comment">// surface normal</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> uvw;    <span class="comment">// uvw coordinates</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tan_u;  <span class="comment">// tangent vector in u direction</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> tan_v;  <span class="comment">// tangent vector in u direction</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Render context</span></div>
<div class="line"><span class="keyword">struct </span>Render_context</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// render options</span></div>
<div class="line">    <span class="keywordtype">int</span> max_ray_length;</div>
<div class="line">    <span class="keywordtype">bool</span> render_auxiliary;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// scene data</span></div>
<div class="line">    <span class="comment">// environment color</span></div>
<div class="line">    <span class="keyword">struct </span>Environment</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> color; <span class="comment">// used when no environment map is set</span></div>
<div class="line">        <span class="keywordtype">float</span> intensity;</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> map;</div>
<div class="line">        <span class="keyword">struct </span>Alias_map</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> alias;</div>
<div class="line">            <span class="keywordtype">float</span>        q;</div>
<div class="line">        } *alias_map;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">float</span> inv_integral;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Uint32_2</a> map_size;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> *map_pixels;</div>
<div class="line">    }env;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Perspective camera</span></div>
<div class="line">    <span class="keyword">struct </span>Camera</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> focal;</div>
<div class="line">        <span class="keywordtype">float</span> aspect;</div>
<div class="line">        <span class="keywordtype">float</span> zoom;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_2</a> inv_res;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> pos;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> dir;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> right;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> up;</div>
<div class="line">    } cam;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Omni light</span></div>
<div class="line">    <span class="keyword">struct </span>Omni</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> color;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> dir;</div>
<div class="line">        <span class="keywordtype">float</span> distance;</div>
<div class="line">        <span class="keywordtype">float</span> intensity;</div>
<div class="line">    } omni_light;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// sphere object</span></div>
<div class="line">    <span class="keyword">struct </span>Sphere</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> center;</div>
<div class="line">        <span class="keywordtype">float</span>   radius;</div>
<div class="line">    } sphere;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// MDL cutout opacity</span></div>
<div class="line">    <span class="keyword">struct </span>Cutout</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">bool</span> is_constant;</div>
<div class="line">        <span class="keywordtype">float</span> constant_opacity;</div>
<div class="line">    } cutout;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// MDL thin_walled</span></div>
<div class="line">    <span class="keyword">struct </span>Thin_walled</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">bool</span> is_constant;</div>
<div class="line">        <span class="keywordtype">bool</span> is_thin_walled;</div>
<div class="line">    } thin_walled;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">// single raytracing ray</span></div>
<div class="line">    <span class="keyword">struct </span>Ray</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> p0;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> dir;</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> weight;</div>
<div class="line">        <span class="keywordtype">int</span> level;</div>
<div class="line">        <span class="keywordtype">float</span> last_pdf;</div>
<div class="line">        <span class="keywordtype">bool</span> is_inside;</div>
<div class="line"></div>
<div class="line">        Ray()</div>
<div class="line">            : weight(1.f)</div>
<div class="line">            , level(0)</div>
<div class="line">            , last_pdf(-1.f)</div>
<div class="line">            , is_inside(false)</div>
<div class="line">        {};</div>
<div class="line"></div>
<div class="line">        <span class="comment">//-------------------------------------------------------------------------------------------------</span></div>
<div class="line">        <span class="comment">// Avoiding self intersections (see Ray Tracing Gems, Ch. 6)</span></div>
<div class="line">        <span class="comment">//-------------------------------------------------------------------------------------------------</span></div>
<div class="line">        <span class="keyword">inline</span> <span class="keywordtype">void</span> offset_ray(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;n)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> origin = 1.0f / 32.0f;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> float_scale = 1.0f / 65536.0f;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> int_scale = 256.0f;</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Sint32_3</a> of_i(</div>
<div class="line">                static_cast&lt;int&gt;(int_scale * n.x),</div>
<div class="line">                static_cast&lt;int&gt;(int_scale * n.y),</div>
<div class="line">                static_cast&lt;int&gt;(int_scale * n.z));</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> p_i(</div>
<div class="line">                int_as_float(float_as_int(p0.x) + ((p0.x &lt; 0.0f) ? -of_i.x : of_i.x)),</div>
<div class="line">                int_as_float(float_as_int(p0.y) + ((p0.y &lt; 0.0f) ? -of_i.y : of_i.y)),</div>
<div class="line">                int_as_float(float_as_int(p0.z) + ((p0.z &lt; 0.0f) ? -of_i.z : of_i.z)));</div>
<div class="line"></div>
<div class="line">            p0.x = <a class="code" href="group__mi__math__color.html#ga4023f06f06d1ad0e71f74aba882f24fb" title="Returns a color with the elementwise absolute values of the color c. ">abs</a>(p0.x) &lt; origin ? p0.x + float_scale * n.x : p_i.x;</div>
<div class="line">            p0.y = <a class="code" href="group__mi__math__color.html#ga4023f06f06d1ad0e71f74aba882f24fb" title="Returns a color with the elementwise absolute values of the color c. ">abs</a>(p0.y) &lt; origin ? p0.y + float_scale * n.y : p_i.y;</div>
<div class="line">            p0.z = <a class="code" href="group__mi__math__color.html#ga4023f06f06d1ad0e71f74aba882f24fb" title="Returns a color with the elementwise absolute values of the color c. ">abs</a>(p0.z) &lt; origin ? p0.z + float_scale * n.z : p_i.z;</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// MDL Backend execution</span></div>
<div class="line">    <a class="code" href="structmi_1_1neuraylib_1_1Shading__state__material__impl.html" title="The MDL material state structure inside the MDL SDK is a representation of the renderer state as defi...">mi::neuraylib::Shading_state_material</a> shading_state;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;</a> target_code;</div>
<div class="line">    Texture_handler *tex_handler;</div>
<div class="line">    uint64_t surface_bsdf_function_index;</div>
<div class="line">    uint64_t surface_edf_function_index;</div>
<div class="line">    uint64_t surface_emission_intensity_function_index;</div>
<div class="line">    uint64_t backface_bsdf_function_index;</div>
<div class="line">    uint64_t backface_edf_function_index;</div>
<div class="line">    uint64_t backface_emission_intensity_function_index;</div>
<div class="line">    uint64_t cutout_opacity_function_index;</div>
<div class="line">    uint64_t thin_walled_function_index;</div>
<div class="line"></div>
<div class="line">    Render_context()</div>
<div class="line">        : target_code(nullptr)</div>
<div class="line">        , tex_handler(nullptr)</div>
<div class="line">    {</div>
<div class="line">        max_ray_length = 6;</div>
<div class="line">        render_auxiliary = <span class="keyword">false</span>;</div>
<div class="line">        env.color = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.53f, 0.81f, 0.92f);</div>
<div class="line">        env.intensity = 1.0f;</div>
<div class="line">        env.alias_map = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">        omni_light.color = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f, 0.902f, 0.502f);</div>
<div class="line">        omni_light.dir = normalize(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(1.f, 1.f, 1.f));</div>
<div class="line">        omni_light.distance = 11.18f;</div>
<div class="line">        omni_light.intensity = 0.0f;</div>
<div class="line"></div>
<div class="line">        sphere.center = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f); <span class="comment">// sphere in the origin</span></div>
<div class="line">        sphere.radius = 1.f;</div>
<div class="line"></div>
<div class="line">        cutout.is_constant = <span class="keyword">false</span>;</div>
<div class="line">        cutout.constant_opacity = 1.f;</div>
<div class="line"></div>
<div class="line">        thin_walled.is_constant = <span class="keyword">true</span>;</div>
<div class="line">        thin_walled.is_thin_walled = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// init constant parameters of material shader state</span></div>
<div class="line">        shading_state.animation_time = 0.f;</div>
<div class="line">        shading_state.tangent_u = Constants.tangent_u;</div>
<div class="line">        shading_state.tangent_v = Constants.tangent_v;</div>
<div class="line">        shading_state.text_results = <span class="keyword">nullptr</span>;</div>
<div class="line">        shading_state.ro_data_segment = <span class="keyword">nullptr</span>;</div>
<div class="line">        shading_state.world_to_object = &amp;Constants.identity[0];</div>
<div class="line">        shading_state.object_to_world = &amp;Constants.identity[0];</div>
<div class="line">        shading_state.object_id = 0;</div>
<div class="line">        shading_state.meters_per_scene_unit = 1.f;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Free resources owned by the render context.</span></div>
<div class="line">    <span class="keywordtype">void</span> uninit()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (env.alias_map) {</div>
<div class="line">            free(env.alias_map);</div>
<div class="line">            env.alias_map = <span class="keyword">nullptr</span>;</div>
<div class="line">        }</div>
<div class="line">        target_code = <span class="keyword">nullptr</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">void</span> update_light(</div>
<div class="line">        <span class="keywordtype">float</span> phi,</div>
<div class="line">        <span class="keywordtype">float</span> theta,</div>
<div class="line">        <span class="keywordtype">float</span> intensity)</div>
<div class="line">    {</div>
<div class="line">        omni_light.dir.x = sinf(theta) * sinf(phi);</div>
<div class="line">        omni_light.dir.y = cosf(theta);</div>
<div class="line">        omni_light.dir.z = sinf(theta) * cosf(phi);</div>
<div class="line"></div>
<div class="line">        omni_light.intensity = intensity;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">void</span> update_camera(</div>
<div class="line">        <span class="keywordtype">float</span> phi,</div>
<div class="line">        <span class="keywordtype">float</span> theta,</div>
<div class="line">        <span class="keywordtype">float</span> base_dist,</div>
<div class="line">        <span class="keywordtype">int</span> zoom)</div>
<div class="line">    {</div>
<div class="line">        cam.dir.x = -sinf(phi) * sinf(theta);</div>
<div class="line">        cam.dir.y = -cosf(theta);</div>
<div class="line">        cam.dir.z = -cosf(phi) * sinf(theta);</div>
<div class="line"></div>
<div class="line">        cam.right.x = cosf(phi);</div>
<div class="line">        cam.right.y = 0.0f;</div>
<div class="line">        cam.right.z = -sinf(phi);</div>
<div class="line"></div>
<div class="line">        cam.up.x = -sinf(phi) * cosf(theta);</div>
<div class="line">        cam.up.y = sinf(theta);</div>
<div class="line">        cam.up.z = -cosf(phi) * cosf(theta);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dist = base_dist * powf(0.95f, static_cast&lt;float&gt;(zoom));</div>
<div class="line">        cam.pos.x = -cam.dir.x * dist;</div>
<div class="line">        cam.pos.y = -cam.dir.y * dist;</div>
<div class="line">        cam.pos.z = -cam.dir.z * dist;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Ray to sphere intersection</span></div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">bool</span> isect(<span class="keyword">const</span> Ray &amp;ray, <span class="keyword">const</span> Sphere &amp;sphere, Isect_info&amp; isect_info)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> oc = ray.p0 - sphere.center;</div>
<div class="line">        <span class="keywordtype">float</span> b = 2.f * <a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(oc, ray.dir);</div>
<div class="line">        <span class="keywordtype">float</span> c = <a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(oc, oc) - sphere.radius * sphere.radius;</div>
<div class="line">        <span class="keywordtype">float</span> disc = b * b - 4.f * c;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// no intersection</span></div>
<div class="line">        <span class="keywordflow">if</span> (disc &lt;= 0.f)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        disc = sqrtf(disc);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//first hit</span></div>
<div class="line">        <span class="keywordtype">float</span> t = (-b - disc) * 0.5f;</div>
<div class="line">        <span class="keywordflow">if</span> (t &lt;= 0.f)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">//try second hit</span></div>
<div class="line">            t = (-b + disc) * 0.5f;</div>
<div class="line">            <span class="comment">//sphere behind ray?</span></div>
<div class="line">            <span class="keywordflow">if</span> (t &lt;= 0.f)</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        isect_info.pos = ray.p0 + ray.dir*t;</div>
<div class="line">        isect_info.normal = normalize(isect_info.pos - sphere.center);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// compute uvw coordinates</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> phi = atan2f(isect_info.normal.x, isect_info.normal.z);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> theta = acosf(isect_info.normal.y);</div>
<div class="line"></div>
<div class="line">        isect_info.uvw.x = phi / Constants.PI + 1.f;</div>
<div class="line">        isect_info.uvw.y = 1.f - theta / Constants.PI;</div>
<div class="line">        isect_info.uvw.z = 0.f;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// compute surface derivatives</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> pi_rad = Constants.PI*sphere.radius;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> sp = sinf(phi);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> cp = cosf(phi);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> st = sinf(theta);</div>
<div class="line"></div>
<div class="line">        isect_info.tan_u.x = cp * st * pi_rad;</div>
<div class="line">        isect_info.tan_u.y = 0.f;</div>
<div class="line">        isect_info.tan_u.z = -sp * st * pi_rad;</div>
<div class="line">        isect_info.tan_u = normalize(isect_info.tan_u);</div>
<div class="line"></div>
<div class="line">        isect_info.tan_v.x = -sp * isect_info.normal.y * pi_rad;</div>
<div class="line">        isect_info.tan_v.y = st * pi_rad;</div>
<div class="line">        isect_info.tan_v.z = -cp * isect_info.normal.y * pi_rad;</div>
<div class="line">        isect_info.tan_v = normalize(isect_info.tan_v);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// build environment importance sampling data</span></div>
<div class="line">    <span class="keywordtype">void</span> build_alias_map()</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> rx = env.map_size.x;</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> ry = env.map_size.y;</div>
<div class="line">        env.alias_map = <span class="keyword">static_cast&lt;</span>Render_context::Environment::Alias_map *<span class="keyword">&gt;</span>(</div>
<div class="line">            malloc(rx * ry * <span class="keyword">sizeof</span>(Render_context::Environment::Alias_map)));</div>
<div class="line">        <span class="keywordtype">float</span> *importance_data = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span> *<span class="keyword">&gt;</span>(malloc(rx * ry * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)));</div>
<div class="line">        <span class="keywordtype">float</span> cos_theta0 = 1.0f;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> step_phi = 2.f * Constants.PI / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(rx);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> step_theta = Constants.PI / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(ry);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y = 0; y &lt; ry; ++y)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> theta1 = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(y + 1) * step_theta;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> cos_theta1 = <a class="code" href="group__mi__math__color.html#gabc5aea22823783b69d311547daddadf2" title="Returns a color with the elementwise cosine of the color c. ">std::cos</a>(theta1);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> area = (cos_theta0 - cos_theta1) * step_phi;</div>
<div class="line">            cos_theta0 = cos_theta1;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x = 0; x &lt; rx; ++x)</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx = y * rx + x;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx4 = idx * 4;</div>
<div class="line">                importance_data[idx] =</div>
<div class="line">                    area * std::max(env.map_pixels[idx4], std::max(env.map_pixels[idx4 + 1], env.map_pixels[idx4 + 2]));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// build alias map</span></div>
<div class="line">        <span class="comment">// create qs (normalized)</span></div>
<div class="line">        <span class="keywordtype">size_t</span> size = rx * ry;</div>
<div class="line">        <span class="keywordtype">float</span> sum = 0.0f;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; size; ++i)</div>
<div class="line">            sum += importance_data[i];</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; size; ++i)</div>
<div class="line">            env.alias_map[i].q = (static_cast&lt;float&gt;(size) * importance_data[i] / sum);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create partition table</span></div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *partition_table = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *<span class="keyword">&gt;</span>(</div>
<div class="line">            malloc(size * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)));</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s = 0u, large = size;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; size; ++i)</div>
<div class="line">            partition_table[(env.alias_map[i].q &lt; 1.0f) ? (s++) : (--large)] = env.alias_map[i].alias = i;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create alias map</span></div>
<div class="line">        <span class="keywordflow">for</span> (s = 0; s &lt; large &amp;&amp; large &lt; size; ++s)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = partition_table[s], k = partition_table[large];</div>
<div class="line">            env.alias_map[j].alias = k;</div>
<div class="line">            env.alias_map[k].q += env.alias_map[j].q - 1.0f;</div>
<div class="line">            large = (env.alias_map[k].q &lt; 1.0f) ? (large + 1u) : large;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        free(partition_table);</div>
<div class="line"></div>
<div class="line">        env.inv_integral = 1.0f / sum;</div>
<div class="line">        free(importance_data);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// evaluate the environment map for a given ray direction</span></div>
<div class="line">    <span class="keyword">inline</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> evaluate_environment(<span class="keywordtype">float</span>&amp; pdf, <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; dir)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// use environment map?</span></div>
<div class="line">        <span class="keywordflow">if</span> (env.map.is_valid_interface())</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> u = atan2f(dir.z, dir.x) * (0.5f / Constants.PI) + 0.5f;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> v = acosf(fmax(fminf(-dir.y, 1.0f), -1.0f)) / Constants.PI;</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">size_t</span> x = mi::math::min(static_cast&lt;mi::Uint32&gt;(u * env.map_size.x), env.map_size.x - 1u);</div>
<div class="line">            <span class="keywordtype">size_t</span> y = mi::math::min(static_cast&lt;mi::Uint32&gt;(v * env.map_size.y), env.map_size.y - 1u);</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">float</span> *pixel = env.map_pixels + ((y*env.map_size.x + x) * 4);</div>
<div class="line"></div>
<div class="line">            pdf = std::max(pixel[0], std::max(pixel[1], pixel[2])) * env.inv_integral;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(pixel[0], pixel[1], pixel[2])*env.intensity;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            pdf = 1.f;</div>
<div class="line">            <span class="keywordflow">return</span> env.color*env.intensity;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// importance sampling the environment map</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> sample_environment(<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; light_dir, <span class="keywordtype">float</span> &amp;light_pdf, <span class="keywordtype">unsigned</span> &amp;seed)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> xi;</div>
<div class="line">        xi.x = rnd(seed);</div>
<div class="line">        xi.y = rnd(seed);</div>
<div class="line">        xi.z = rnd(seed);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// importance sample the environment using an alias map</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = env.map_size.x * env.map_size.y;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx =</div>
<div class="line">            mi::math::min(static_cast&lt;unsigned&gt;(xi.x * static_cast&lt;float&gt;(size)), size - 1);</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> env_idx;</div>
<div class="line">        <span class="keywordtype">float</span> xi_y = xi.y;</div>
<div class="line">        <span class="keywordflow">if</span> (xi_y &lt; env.alias_map[idx].q)</div>
<div class="line">        {</div>
<div class="line">            env_idx = idx;</div>
<div class="line">            xi_y /= env.alias_map[idx].q;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            env_idx = env.alias_map[idx].alias;</div>
<div class="line">            xi_y = (xi_y - env.alias_map[idx].q) / (1.0f - env.alias_map[idx].q);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> py = env_idx / env.map_size.x;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> px = env_idx % env.map_size.x;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// uniformly sample spherical area of pixel</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> u = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(px + xi_y) / static_cast&lt;float&gt;(env.map_size.x);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> phi = u * 2.0f * Constants.PI - Constants.PI;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> sin_phi = sinf(phi);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> cos_phi = cosf(phi);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> step_theta = Constants.PI / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(env.map_size.y);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> theta0 = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(py)* step_theta;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> cos_theta = cosf(theta0) * (1.0f - xi.z) + cosf(theta0 + step_theta) * xi.z;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> theta = acosf(cos_theta);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> sin_theta = sinf(theta);</div>
<div class="line">        light_dir = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(cos_phi * sin_theta, -cos_theta, sin_phi * sin_theta);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// lookup filtered beauty</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> v = theta / Constants.PI;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">size_t</span> x = mi::math::min(static_cast&lt;mi::Uint32&gt;(u * env.map_size.x), env.map_size.x - 1u);</div>
<div class="line">        <span class="keywordtype">size_t</span> y = mi::math::min(static_cast&lt;mi::Uint32&gt;(v * env.map_size.y), env.map_size.y - 1u);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> *pix = env.map_pixels + ((y*env.map_size.x + x) * 4);</div>
<div class="line">        light_pdf = mi::math::max(pix[0], mi::math::max(pix[1], pix[2])) * env.inv_integral;</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(pix[0], pix[1], pix[2])*env.intensity;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// sample scene lights (omni + environment map)</span></div>
<div class="line">    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> sample_lights(<span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> &amp;pos, <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>&amp; light_dir, <span class="keywordtype">float</span>&amp; light_pdf, <span class="keywordtype">unsigned</span> &amp;seed)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> p_select_light = 1.0f;</div>
<div class="line">        <span class="keywordflow">if</span> (omni_light.intensity &gt; 0.f)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// keep it simple and use either point light or environment light, each with the same</span></div>
<div class="line">            <span class="comment">// probability. If the environment factor is zero, we always use the point light</span></div>
<div class="line">            <span class="comment">// Note: see also miss shader</span></div>
<div class="line">            p_select_light = env.intensity &gt; 0.0f ? 0.5f : 1.0f;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// in general, you would select the light depending on the importance of it</span></div>
<div class="line">            <span class="comment">// e.g. by incorporating their luminance</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">// randomly select one of the lights</span></div>
<div class="line">            <span class="keywordflow">if</span> (rnd(seed) &lt;= p_select_light)</div>
<div class="line">            {</div>
<div class="line">                light_pdf = Constants.DIRAC; <span class="comment">// infinity</span></div>
<div class="line"></div>
<div class="line">                <span class="comment">// compute light direction and distance</span></div>
<div class="line">                light_dir = omni_light.dir*omni_light.distance - pos;</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> inv_distance2 = 1.0f / <a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(light_dir, light_dir);</div>
<div class="line">                light_dir *= sqrtf(inv_distance2);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">return</span> omni_light.color *</div>
<div class="line">                    (omni_light.intensity * inv_distance2 * 0.25f / (Constants.PI * p_select_light));</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// probability to select the environment instead</span></div>
<div class="line">            p_select_light = (1.0f - p_select_light);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// light from the environment map</span></div>
<div class="line">        <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> radiance = sample_environment(light_dir, light_pdf, seed);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// return radiance over pdf</span></div>
<div class="line">        light_pdf *= p_select_light;</div>
<div class="line">        <span class="keywordflow">return</span> radiance / light_pdf;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// MDL Material Helper Functions</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Creates an instance of the given material.</span></div>
<div class="line"><span class="keywordtype">void</span> create_material_instance(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>* mdl_factory,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>* mdl_impexp_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* material_name,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* instance_name)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// split module and material name</span></div>
<div class="line">    std::string module_name, material_simple_name;</div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::parse_cmd_argument_material_name(</div>
<div class="line">        material_name, module_name, material_simple_name, <span class="keyword">true</span>))</div>
<div class="line">        exit_failure();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Load the module.</span></div>
<div class="line">    mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a5e195d80915190eb40c5995ccfeaa4c9" title="Loads an MDL module from disk (or a builtin module) into the database. ">load_module</a>(transaction, module_name.c_str(), context);</div>
<div class="line">    <span class="keywordflow">if</span> (!print_messages(context))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Loading module &#39;%s&#39; failed.&quot;</span>, module_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the database name for the module we loaded</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::IString&gt;</a> module_db_name(</div>
<div class="line">        mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a72a27c9e0d66e79391ff9a8e3ce4a119" title="Returns the DB name for the MDL name of a module (or file path for MDLE modules). ...">get_db_module_name</a>(module_name.c_str()));</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IModule&gt;</a> module(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IModule.html" title="This interface represents an MDL module. ">mi::neuraylib::IModule</a>&gt;(module_db_name-&gt;get_c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!module)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to access the loaded module.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Attach the material name</span></div>
<div class="line">    std::string material_db_name</div>
<div class="line">        = std::string(module_db_name-&gt;get_c_str()) + <span class="stringliteral">&quot;::&quot;</span> + material_simple_name;</div>
<div class="line">    material_db_name = mi::examples::mdl::add_missing_material_signature(</div>
<div class="line">        module.get(), material_db_name);</div>
<div class="line">    <span class="keywordflow">if</span> (material_db_name.empty())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to find the material %s in the module %s.&quot;</span>,</div>
<div class="line">            material_simple_name.c_str(), module_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the material definition from the database</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IFunction_definition&gt;</a> material_definition(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IFunction__definition.html" title="This interface represents a function definition. ">mi::neuraylib::IFunction_definition</a>&gt;(material_db_name.c_str()));</div>
<div class="line">    <span class="keywordflow">if</span> (!material_definition)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Accessing definition &#39;%s&#39; failed.&quot;</span>, material_db_name.c_str());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a material instance from the material definition with the default arguments.</span></div>
<div class="line">    <span class="comment">// Assuming the material has defaults for all parameters.</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> result;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IFunction_call&gt;</a> material_instance(</div>
<div class="line">        material_definition-&gt;create_function_call(0, &amp;result));</div>
<div class="line">    <span class="keywordflow">if</span> (result != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Instantiating &#39;%s&#39; failed.&quot;</span>, material_db_name.c_str());</div>
<div class="line"></div>
<div class="line">    transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ae1c0cccf93ff990b7af8d0d0379f7c09" title="Stores the element db_element in the database under the name name and with the privacy level privacy...">store</a>(material_instance.get(), instance_name);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Compiles the given material instance in the given compilation modes and stores it in the DB.</span></div>
<div class="line"><span class="keywordtype">void</span> compile_material_instance(</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* instance_name,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* compiled_material_name,</div>
<div class="line">    <span class="keywordtype">bool</span> class_compilation)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IMaterial_instance&gt;</a> material_instance(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html" title="This interface represents a material instance. ">mi::neuraylib::IMaterial_instance</a>&gt;(instance_name));</div>
<div class="line">    <a class="code" href="group__mi__base__types.html#ga607bb87332bf166dbd67cb30ca30da3a" title="32-bit unsigned integer. ">mi::Uint32</a> flags = class_compilation</div>
<div class="line">        ? <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959a7474d76ee055edda39a494edf06cfc36" title="Selects class compilation instead of instance compilation. ">mi::neuraylib::IMaterial_instance::CLASS_COMPILATION</a></div>
<div class="line">        : <a class="code" href="classmi_1_1neuraylib_1_1IMaterial__instance.html#ab0b7608e59f1ad96b00a2fbb5cc2d959afdcc06252ec8a89909ddd69006031766" title="Default compilation options (e.g., instance compilation). ">mi::neuraylib::IMaterial_instance::DEFAULT_OPTIONS</a>;</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICompiled_material&gt;</a> compiled_material(</div>
<div class="line">        material_instance-&gt;create_compiled_material(flags, context));</div>
<div class="line">    check_success(print_messages(context));</div>
<div class="line"></div>
<div class="line">    transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ae1c0cccf93ff990b7af8d0d0379f7c09" title="Stores the element db_element in the database under the name name and with the privacy level privacy...">store</a>(compiled_material.get(), compiled_material_name);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Generate and execute native CPU code for a subexpression of a given compiled material.</span></div>
<div class="line"><span class="keywordtype">void</span> generate_native(</div>
<div class="line">    Render_context&amp; render_context,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>* mdl_backend_api,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IMdl__execution__context.html" title="The execution context can be used to query status information like error and warning messages concern...">mi::neuraylib::IMdl_execution_context</a>* context,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* compiled_material_name,</div>
<div class="line">    <span class="keywordtype">bool</span> use_custom_tex_runtime,</div>
<div class="line">    <span class="keywordtype">bool</span> use_adapt_normal,</div>
<div class="line">    <span class="keywordtype">bool</span> enable_derivatives)</div>
<div class="line">{</div>
<div class="line">    Timing timing(<span class="stringliteral">&quot;generate target code&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t1 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICompiled_material&gt;</a> compiled_material(</div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html" title="This interface represents a compiled material. ">mi::neuraylib::ICompiled_material</a>&gt;(compiled_material_name));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t2 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">// has material a constant cutout opacity?</span></div>
<div class="line">    render_context.cutout.is_constant =</div>
<div class="line">        compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#a6f3d049e327a910742c36eb329dd1b4c" title="Returns the cutout opacity of the material if it is constant. ">get_cutout_opacity</a>(&amp;render_context.cutout.constant_opacity);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// has material a constant thin_walled property?</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IExpression const&gt;</a> thin_walled(</div>
<div class="line">        compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#a873ecce34f04444dc3e0989526f3bd46" title="Looks up a sub-expression of the compiled material. ">lookup_sub_expression</a>(<span class="stringliteral">&quot;thin_walled&quot;</span>));</div>
<div class="line"></div>
<div class="line">    render_context.thin_walled.is_constant = <span class="keyword">false</span>;</div>
<div class="line">    render_context.thin_walled.is_thin_walled = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (thin_walled-&gt;get_kind() == <a class="code" href="classmi_1_1neuraylib_1_1IExpression.html#a7ebbfc1f9ceee07cd8721b3cb6e20032ab563823691ce8b3c99a9a58bde726cef" title="A constant expression. See mi::neuraylib::IExpression_constant. ">mi::neuraylib::IExpression::EK_CONSTANT</a>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IExpression_constant const&gt;</a> thin_walled_const(</div>
<div class="line">            thin_walled-&gt;get_interface&lt;<a class="code" href="classmi_1_1neuraylib_1_1IExpression__constant.html" title="A constant expression. ">mi::neuraylib::IExpression_constant</a> <span class="keyword">const</span>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IValue_bool const&gt;</a> thin_walled_bool(</div>
<div class="line">            thin_walled_const-&gt;get_value&lt;<a class="code" href="classmi_1_1neuraylib_1_1IValue__bool.html" title="A value of type boolean. ">mi::neuraylib::IValue_bool</a>&gt;());</div>
<div class="line"></div>
<div class="line">        render_context.thin_walled.is_constant = <span class="keyword">true</span>;</div>
<div class="line">        render_context.thin_walled.is_thin_walled = thin_walled_bool-&gt;get_value();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// back faces could be different for thin walled materials</span></div>
<div class="line">    <span class="keywordtype">bool</span> need_backface_bsdf = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> need_backface_edf = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> need_backface_emission_intensity = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (!render_context.thin_walled.is_constant || render_context.thin_walled.is_thin_walled)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// first, backfaces dfs are only considered for thin_walled materials</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// second, we only need to generate new code if surface and backface are different</span></div>
<div class="line">        need_backface_bsdf =</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162a95356115b56fa4672f7e57a887261186" title="Slot surface.scattering. ">mi::neuraylib::SLOT_SURFACE_SCATTERING</a>) !=</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162a1ef3c4a0f4a892679f761d38aa0853d9" title="Slot backface.scattering. ">mi::neuraylib::SLOT_BACKFACE_SCATTERING</a>);</div>
<div class="line">        need_backface_edf =</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162addda6e4a2a88fcd9c9606685e891f2e5" title="Slot surface.emission.emission. ">mi::neuraylib::SLOT_SURFACE_EMISSION_EDF_EMISSION</a>) !=</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162abb84473e252871614ad2aba0103a884f" title="Slot backface.emission.emission. ">mi::neuraylib::SLOT_BACKFACE_EMISSION_EDF_EMISSION</a>);</div>
<div class="line">        need_backface_emission_intensity =</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162a3f0b5973556604e36dcfd9addbc8f7a0" title="Slot surface.emission.intensity. ">mi::neuraylib::SLOT_SURFACE_EMISSION_INTENSITY</a>) !=</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#add323fa76aa11b71829ebfc0ada40f1b" title="Returns the hash of a particular material slot. ">get_slot_hash</a>(<a class="code" href="group__mi__neuray__mdl__elements.html#gga4e2cebe47d60cf89b56196471b9ec162a022577607f0a7d10583a937637448d0a" title="Slot backface.emission.intensity. ">mi::neuraylib::SLOT_BACKFACE_EMISSION_INTENSITY</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// third, either the bsdf or the edf need to be non-default (black)</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IExpression const&gt;</a> scattering_expr(</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#a873ecce34f04444dc3e0989526f3bd46" title="Looks up a sub-expression of the compiled material. ">lookup_sub_expression</a>(<span class="stringliteral">&quot;backface.scattering&quot;</span>));</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IExpression const&gt;</a> emission_expr(</div>
<div class="line">            compiled_material-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICompiled__material.html#a873ecce34f04444dc3e0989526f3bd46" title="Looks up a sub-expression of the compiled material. ">lookup_sub_expression</a>(<span class="stringliteral">&quot;backface.emission.emission&quot;</span>));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (scattering_expr-&gt;get_kind() == <a class="code" href="classmi_1_1neuraylib_1_1IExpression.html#a7ebbfc1f9ceee07cd8721b3cb6e20032ab563823691ce8b3c99a9a58bde726cef" title="A constant expression. See mi::neuraylib::IExpression_constant. ">mi::neuraylib::IExpression::EK_CONSTANT</a> &amp;&amp;</div>
<div class="line">            emission_expr-&gt;get_kind() == <a class="code" href="classmi_1_1neuraylib_1_1IExpression.html#a7ebbfc1f9ceee07cd8721b3cb6e20032ab563823691ce8b3c99a9a58bde726cef" title="A constant expression. See mi::neuraylib::IExpression_constant. ">mi::neuraylib::IExpression::EK_CONSTANT</a>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IExpression_constant const&gt;</a> scattering_expr_constant(</div>
<div class="line">                scattering_expr-&gt;get_interface&lt;<a class="code" href="classmi_1_1neuraylib_1_1IExpression__constant.html" title="A constant expression. ">mi::neuraylib::IExpression_constant</a>&gt;());</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IValue const&gt;</a> scattering_value(</div>
<div class="line">                scattering_expr_constant-&gt;get_value());</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IExpression_constant const&gt;</a> emission_expr_constant(</div>
<div class="line">                emission_expr-&gt;get_interface&lt;<a class="code" href="classmi_1_1neuraylib_1_1IExpression__constant.html" title="A constant expression. ">mi::neuraylib::IExpression_constant</a>&gt;());</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IValue const&gt;</a> emission_value(</div>
<div class="line">                emission_expr_constant-&gt;get_value());</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (scattering_value-&gt;get_kind() == <a class="code" href="classmi_1_1neuraylib_1_1IValue.html#af6acadbbd8941fc571234560178d1f49aba28f3daeca795fd8b60317637fb2e6a" title="An invalid distribution function value. See mi::neuraylib::IValue_invalid_df. ">mi::neuraylib::IValue::VK_INVALID_DF</a> &amp;&amp;</div>
<div class="line">                emission_value-&gt;get_kind() == <a class="code" href="classmi_1_1neuraylib_1_1IValue.html#af6acadbbd8941fc571234560178d1f49aba28f3daeca795fd8b60317637fb2e6a" title="An invalid distribution function value. See mi::neuraylib::IValue_invalid_df. ">mi::neuraylib::IValue::VK_INVALID_DF</a>)</div>
<div class="line">            {</div>
<div class="line">                need_backface_bsdf = <span class="keyword">false</span>;</div>
<div class="line">                need_backface_edf = <span class="keyword">false</span>;</div>
<div class="line">                need_backface_emission_intensity = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t3 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend&gt;</a> be_native(</div>
<div class="line">        mdl_backend_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a74baca56433d61f89de6b68019b6beb5" title="Returns an MDL backend generator. ">get_backend</a>(<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html#a28a914c7c51dd45974b16fa189a77b46a353b866fa7aac285667aded4b8dba94b" title="Generate native code. ">mi::neuraylib::IMdl_backend_api::MB_NATIVE</a>));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t4 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    check_success(be_native-&gt;set_option(<span class="stringliteral">&quot;num_texture_spaces&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (render_context.render_auxiliary)</div>
<div class="line">        check_success(be_native-&gt;set_option(<span class="stringliteral">&quot;enable_auxiliary&quot;</span>, <span class="stringliteral">&quot;on&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (use_custom_tex_runtime)</div>
<div class="line">        check_success(be_native-&gt;set_option(<span class="stringliteral">&quot;use_builtin_resource_handler&quot;</span>, <span class="stringliteral">&quot;off&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (enable_derivatives)</div>
<div class="line">        check_success(be_native-&gt;set_option(<span class="stringliteral">&quot;texture_runtime_with_derivs&quot;</span>, <span class="stringliteral">&quot;on&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (use_adapt_normal)</div>
<div class="line">        check_success(be_native-&gt;set_option(<span class="stringliteral">&quot;use_renderer_adapt_normal&quot;</span>, <span class="stringliteral">&quot;on&quot;</span>) == 0);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t5 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ILink_unit&gt;</a> link_unit(</div>
<div class="line">        be_native-&gt;create_link_unit(transaction, context));</div>
<div class="line">    check_success(print_messages(context));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t6 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">// select expressions to generate code for</span></div>
<div class="line">    std::vector&lt;mi::neuraylib::Target_function_description&gt; descs;</div>
<div class="line">    descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;surface.scattering&quot;</span>));</div>
<div class="line">    descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;surface.emission.emission&quot;</span>));</div>
<div class="line">    descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;surface.emission.intensity&quot;</span>));</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> backface_scattering_index = ~0;</div>
<div class="line">    <span class="keywordflow">if</span> (need_backface_bsdf)</div>
<div class="line">    {</div>
<div class="line">        backface_scattering_index = descs.size();</div>
<div class="line">        descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;backface.scattering&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> backface_edf_index = ~0;</div>
<div class="line">    <span class="keywordflow">if</span> (need_backface_edf)</div>
<div class="line">    {</div>
<div class="line">        backface_edf_index = descs.size();</div>
<div class="line">        descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;backface.emission.emission&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> backface_emission_intensity_index = ~0;</div>
<div class="line">    <span class="keywordflow">if</span> (need_backface_emission_intensity)</div>
<div class="line">    {</div>
<div class="line">        backface_emission_intensity_index = descs.size();</div>
<div class="line">        descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;backface.emission.intensity&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> cutout_opacity_desc_index = ~0;</div>
<div class="line">    <span class="keywordflow">if</span> (!render_context.cutout.is_constant)</div>
<div class="line">    {</div>
<div class="line">        cutout_opacity_desc_index = descs.size();</div>
<div class="line">        descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;geometry.cutout_opacity&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> thin_walled_desc_index = ~0;</div>
<div class="line">    <span class="keywordflow">if</span> (!render_context.thin_walled.is_constant)</div>
<div class="line">    {</div>
<div class="line">        thin_walled_desc_index = descs.size();</div>
<div class="line">        descs.push_back(<a class="code" href="structmi_1_1neuraylib_1_1Target__function__description.html" title="Description of target function. ">mi::neuraylib::Target_function_description</a>(<span class="stringliteral">&quot;thin_walled&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t7 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">// add the material to the link unit</span></div>
<div class="line">    link_unit-&gt;add_material(</div>
<div class="line">        compiled_material.get(),</div>
<div class="line">        descs.data(), descs.size(),</div>
<div class="line">        context);</div>
<div class="line">    check_success(print_messages(context));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t8 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">// translate link unit</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITarget_code&gt;</a> code_native(</div>
<div class="line">        be_native-&gt;translate_link_unit(link_unit.get(), context));</div>
<div class="line">    check_success(print_messages(context));</div>
<div class="line">    check_success(code_native);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t9 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">// update render context</span></div>
<div class="line">    render_context.target_code = code_native;</div>
<div class="line">    render_context.surface_bsdf_function_index = descs[0].function_index;</div>
<div class="line">    render_context.surface_edf_function_index = descs[1].function_index;</div>
<div class="line">    render_context.surface_emission_intensity_function_index = descs[2].function_index;</div>
<div class="line"></div>
<div class="line">    render_context.backface_bsdf_function_index = need_backface_bsdf</div>
<div class="line">        ? descs[backface_scattering_index].function_index : descs[0].function_index;</div>
<div class="line"></div>
<div class="line">    render_context.backface_edf_function_index = need_backface_edf</div>
<div class="line">        ? descs[backface_edf_index].function_index : descs[1].function_index;</div>
<div class="line"></div>
<div class="line">    render_context.backface_emission_intensity_function_index = need_backface_emission_intensity</div>
<div class="line">        ? descs[backface_emission_intensity_index].function_index : descs[2].function_index;</div>
<div class="line"></div>
<div class="line">    render_context.cutout_opacity_function_index = !render_context.cutout.is_constant</div>
<div class="line">        ? descs[cutout_opacity_desc_index].function_index : ~0;</div>
<div class="line"></div>
<div class="line">    render_context.thin_walled_function_index = !render_context.thin_walled.is_constant</div>
<div class="line">        ? descs[thin_walled_desc_index].function_index : ~0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::steady_clock::time_point t10 = std::chrono::steady_clock::now();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef ADD_EXTRA_TIMERS</span></div>
<div class="line"><span class="preprocessor"></span>    std::chrono::duration&lt;double&gt; et = t10 - t1;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC |||| Total time                 : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t2 - t1;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Compiled material DB          : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t3 - t2;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Mateial properties inspection : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t4 - t3;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Native backend                : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t5 - t4;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Material flags                : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t6 - t5;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Create link unit              : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t7 - t6;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Material expressions selection: %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t8 - t7;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Add material to link unit     : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t9 - t8;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | Translate link unit           : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"></div>
<div class="line">    et = t10 - t9;</div>
<div class="line">    printf(<span class="stringliteral">&quot;GTC | RC update                     : %f seconds.\n&quot;</span>, et.count());</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Prepare the textures for our own texture runtime.</span></div>
<div class="line"><span class="keywordtype">bool</span> prepare_textures(</div>
<div class="line">    std::vector&lt;Texture&gt;&amp; textures,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html" title="A transaction provides a consistent view on the database. ">mi::neuraylib::ITransaction</a>* transaction,</div>
<div class="line">    <a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>* image_api,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITarget__code.html" title="Represents target code of an MDL backend. ">mi::neuraylib::ITarget_code</a>* target_code)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="group__mi__base__types.html#gaa8e6476e3c0fc948ef75264572568791" title="Unsigned integral type that is large enough to hold the size of all types. ">mi::Size</a> i = 1 <span class="comment">/*skip invalid texture*/</span>; i &lt; target_code-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga5d379f3e8619bd43bfbe569c0490949a" title="Returns the number of texture resources used by the target code. ">get_texture_count</a>(); ++i)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ITexture&gt;</a> texture(</div>
<div class="line">            transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1ITexture.html" title="Textures add image processing options to images. ">mi::neuraylib::ITexture</a>&gt;(</div>
<div class="line">                target_code-&gt;<a class="code" href="group__mi__neuray__mdl__compiler.html#ga9981716cff2ab0dada7d3b5288c9afb4" title="Returns the name of a texture resource used by the target code. ">get_texture</a>(i)));</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IImage&gt;</a> image(</div>
<div class="line">            transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#adafe2621ae719c43076b79a5677b4934" title="Retrieves an element from the database. ">access</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage.html" title="This interface represents a pixel image file. ">mi::neuraylib::IImage</a>&gt;(texture-&gt;get_image()));</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::ICanvas&gt;</a> canvas(image-&gt;get_canvas(0, 0, 0));</div>
<div class="line">        <span class="keywordtype">char</span> <span class="keyword">const</span>* image_type = image-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#ab36d6bebb85da08e907eadbe7542c658" title="Returns the pixel type used by the canvas. ">get_type</a>(0, 0);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (image-&gt;is_uvtile() || image-&gt;is_animated()) {</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;The example does not support uvtile and/or animated textures!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// For simplicity, the texture access functions are only implemented for float4 and gamma</span></div>
<div class="line">        <span class="comment">// is pre-applied here (all images are converted to linear space).</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Convert to linear color space if necessary</span></div>
<div class="line">        <span class="keywordflow">if</span> (texture-&gt;get_effective_gamma(0, 0) != 1.0f) {</div>
<div class="line">            <span class="comment">// Copy/convert to float4 canvas and adjust gamma from &quot;effective gamma&quot; to 1.</span></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> gamma_canvas(</div>
<div class="line">                image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a70bb55d4f633151d12664b078ddd6ebb" title="Converts a canvas to a different pixel type. ">convert</a>(canvas.get(), <span class="stringliteral">&quot;Color&quot;</span>));</div>
<div class="line">            gamma_canvas-&gt;set_gamma(texture-&gt;get_effective_gamma(0, 0));</div>
<div class="line">            image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#aef6f6c7994c60410b14d45a6cd0af7ce" title="Sets the gamma value of a canvas and adjusts the pixel data accordingly. ">adjust_gamma</a>(gamma_canvas.get(), 1.0f);</div>
<div class="line">            canvas = gamma_canvas;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(image_type, <span class="stringliteral">&quot;Color&quot;</span>) != 0 &amp;&amp; strcmp(image_type, <span class="stringliteral">&quot;Float32&lt;4&gt;&quot;</span>) != 0) {</div>
<div class="line">            <span class="comment">// Convert to expected format</span></div>
<div class="line">            canvas = image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a70bb55d4f633151d12664b078ddd6ebb" title="Converts a canvas to a different pixel type. ">convert</a>(canvas.get(), <span class="stringliteral">&quot;Color&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        textures.push_back(Texture(canvas));</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Recursive raytracing</span></div>
<div class="line"><span class="comment"></span><span class="keywordtype">void</span> trace_ray(std::vector&lt;mi::Float32_3&gt; &amp;vp_sample, Render_context &amp;rc, Render_context::Ray &amp;ray, <span class="keywordtype">unsigned</span> seed)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ray.level &gt;= rc.max_ray_length)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    ray.level++;</div>
<div class="line"></div>
<div class="line">    Isect_info isect_info;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ray hits sphere?</span></div>
<div class="line">    <span class="keywordflow">if</span> (rc.isect(ray, rc.sphere, isect_info))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// update material shader state</span></div>
<div class="line">        rc.shading_state.position = isect_info.pos;</div>
<div class="line">        rc.shading_state.normal = ray.is_inside ? -isect_info.normal : isect_info.normal;</div>
<div class="line">        rc.shading_state.geom_normal = rc.shading_state.normal;</div>
<div class="line">        rc.shading_state.text_coords = &amp;isect_info.uvw;</div>
<div class="line">        rc.shading_state.tangent_u = &amp;isect_info.tan_u;</div>
<div class="line">        rc.shading_state.tangent_v = &amp;isect_info.tan_v;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// evaluate material cutout opacity</span></div>
<div class="line">        <span class="keywordtype">float</span> cutout_opacity = rc.cutout.constant_opacity;</div>
<div class="line">        <span class="keywordflow">if</span> (!rc.cutout.is_constant)</div>
<div class="line">        {</div>
<div class="line">            rc.target_code-&gt;execute(</div>
<div class="line">                rc.cutout_opacity_function_index,</div>
<div class="line">                reinterpret_cast&lt;mi::neuraylib::Shading_state_material&amp;&gt;(rc.shading_state),</div>
<div class="line">                rc.tex_handler,</div>
<div class="line">                <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">                &amp;cutout_opacity);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// it&#39;s the surface cutted out?. Then skip the surface and send a ray through</span></div>
<div class="line">        <span class="keywordflow">if</span> (cutout_opacity &lt; rnd(seed))</div>
<div class="line">        {</div>
<div class="line">            ray.p0 = isect_info.pos;</div>
<div class="line">            ray.offset_ray(ray.is_inside ? isect_info.normal : -isect_info.normal);</div>
<div class="line">            ray.is_inside = !ray.is_inside;</div>
<div class="line">            ray.level--;</div>
<div class="line">            trace_ray(vp_sample, rc, ray, seed);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// evaluate thin_walled state</span></div>
<div class="line">            <span class="keywordtype">bool</span> is_thin_walled = rc.thin_walled.is_thin_walled;</div>
<div class="line">            <span class="keywordflow">if</span> (!rc.thin_walled.is_constant)</div>
<div class="line">            {</div>
<div class="line">                rc.target_code-&gt;execute(</div>
<div class="line">                    rc.thin_walled_function_index,</div>
<div class="line">                    reinterpret_cast&lt;mi::neuraylib::Shading_state_material&amp;&gt;(rc.shading_state),</div>
<div class="line">                    rc.tex_handler,</div>
<div class="line">                    <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">                    &amp;is_thin_walled);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// evaluate material surface emission contribution</span></div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// restore material shader state normal</span></div>
<div class="line">                rc.shading_state.normal = ray.is_inside ?</div>
<div class="line">                    -isect_info.normal : isect_info.normal;</div>
<div class="line"></div>
<div class="line">                uint64_t edf_function_index = ray.is_inside ? rc.backface_edf_function_index : rc.surface_edf_function_index;</div>
<div class="line">                <span class="comment">// shader initialization for the current hit point</span></div>
<div class="line">                rc.target_code-&gt;execute_bsdf_init(</div>
<div class="line">                    edf_function_index,</div>
<div class="line">                    rc.shading_state,</div>
<div class="line">                    rc.tex_handler,</div>
<div class="line">                    <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">                mi::neuraylib::Edf_evaluate_data&lt;mi::neuraylib::DF_HSM_NONE&gt; eval_data;</div>
<div class="line">                eval_data.k1 = -ray.dir;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// evaluate material surface edf</span></div>
<div class="line">                rc.target_code-&gt;execute_edf_evaluate(</div>
<div class="line">                    edf_function_index + 2, <span class="comment">// edf_function_index corresponds to &#39;init&#39;</span></div>
<div class="line">                                                       <span class="comment">// edf_function_index+2 to &#39;evaluate&#39;</span></div>
<div class="line">                    &amp;eval_data,</div>
<div class="line">                    rc.shading_state,</div>
<div class="line">                    rc.tex_handler,</div>
<div class="line">                    <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// emission contribution is only valid for positive pdf</span></div>
<div class="line">                <span class="keywordflow">if</span> (eval_data.pdf &gt; 1.e-6f)</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> intensity(1.f);</div>
<div class="line">                    rc.target_code-&gt;execute(</div>
<div class="line">                        rc.surface_emission_intensity_function_index,</div>
<div class="line">                        reinterpret_cast&lt;mi::neuraylib::Shading_state_material&amp;&gt;(rc.shading_state),</div>
<div class="line">                        rc.tex_handler,</div>
<div class="line">                        <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>,</div>
<div class="line">                        &amp;intensity);</div>
<div class="line"></div>
<div class="line">                    vp_sample[VPCH_ILLUM] += <span class="keyword">static_cast&lt;</span><a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a><span class="keyword">&gt;</span>(eval_data.edf)*intensity*ray.weight;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// restore material shader state normal</span></div>
<div class="line">            rc.shading_state.normal = ray.is_inside ?</div>
<div class="line">                -isect_info.normal : isect_info.normal;</div>
<div class="line"></div>
<div class="line">            uint64_t surface_bsdf_function_index =</div>
<div class="line">                ray.is_inside ? rc.backface_bsdf_function_index : rc.surface_bsdf_function_index;</div>
<div class="line"></div>
<div class="line">            <span class="comment">// shader initialization for the current hit point</span></div>
<div class="line">            rc.target_code-&gt;execute_bsdf_init(</div>
<div class="line">                surface_bsdf_function_index,</div>
<div class="line">                rc.shading_state,</div>
<div class="line">                rc.tex_handler,</div>
<div class="line">                <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// get auxiliarity data</span></div>
<div class="line">            <span class="keywordflow">if</span> (rc.render_auxiliary &amp;&amp; ray.level == 1)</div>
<div class="line">            {</div>
<div class="line">                mi::neuraylib::Bsdf_auxiliary_data&lt;mi::neuraylib::DF_HSM_NONE&gt; aux_data;</div>
<div class="line">                <span class="keywordflow">if</span> (ray.is_inside &amp;&amp; !is_thin_walled)</div>
<div class="line">                {</div>
<div class="line">                    aux_data.ior1 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(<a class="code" href="group__mi__neuray__mdl__compiler.html#ga87d7af42876fddcc0ba3b640a82b006c" title="The calling code can mark the x component of an IOR field in *_data with MI_NEURAYLIB_BSDF_USE_MATERI...">MI_NEURAYLIB_BSDF_USE_MATERIAL_IOR</a>);</div>
<div class="line">                    aux_data.ior2 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    aux_data.ior1 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f);</div>
<div class="line">                    aux_data.ior2 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(<a class="code" href="group__mi__neuray__mdl__compiler.html#ga87d7af42876fddcc0ba3b640a82b006c" title="The calling code can mark the x component of an IOR field in *_data with MI_NEURAYLIB_BSDF_USE_MATERI...">MI_NEURAYLIB_BSDF_USE_MATERIAL_IOR</a>);</div>
<div class="line">                }</div>
<div class="line">                aux_data.k1 = -ray.dir;</div>
<div class="line"></div>
<div class="line">                rc.target_code-&gt;execute_bsdf_auxiliary(</div>
<div class="line">                    surface_bsdf_function_index + 4,    <span class="comment">// bsdf_function_index corresponds to &#39;init&#39;</span></div>
<div class="line">                                                        <span class="comment">// bsdf_function_index+4 to &#39;auxiliary&#39;</span></div>
<div class="line">                    &amp;aux_data,</div>
<div class="line">                    rc.shading_state,</div>
<div class="line">                    rc.tex_handler,</div>
<div class="line">                    <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">                vp_sample[VPCH_ALBEDO] = aux_data.albedo;</div>
<div class="line">                vp_sample[VPCH_NORMAL] = aux_data.normal;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// evaluate scene lights contribution</span></div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> light_dir;</div>
<div class="line">            <span class="keywordtype">float</span> light_pdf = 0.f;</div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> radiance_over_pdf = rc.sample_lights(isect_info.pos, light_dir, light_pdf, seed);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (ray.level &lt; rc.max_ray_length &amp;&amp; light_pdf != 0.0f &amp;&amp; ((<a class="code" href="group__mi__math__function.html#ga407d21f3ae47abb81a502ecd23b905b8" title="Returns the inner product (a.k.a. dot or scalar product) of two integers. ">dot</a>(rc.shading_state.normal, light_dir) &gt; 0.f) != ray.is_inside))</div>
<div class="line">            {</div>
<div class="line">                mi::neuraylib::Bsdf_evaluate_data&lt;mi::neuraylib::DF_HSM_NONE&gt; eval_data;</div>
<div class="line">                <span class="keywordflow">if</span> (ray.is_inside &amp;&amp; !is_thin_walled)</div>
<div class="line">                {</div>
<div class="line">                    eval_data.ior1 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(<a class="code" href="group__mi__neuray__mdl__compiler.html#ga87d7af42876fddcc0ba3b640a82b006c" title="The calling code can mark the x component of an IOR field in *_data with MI_NEURAYLIB_BSDF_USE_MATERI...">MI_NEURAYLIB_BSDF_USE_MATERIAL_IOR</a>);</div>
<div class="line">                    eval_data.ior2 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    eval_data.ior1 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f);</div>
<div class="line">                    eval_data.ior2 = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(<a class="code" href="group__mi__neuray__mdl__compiler.html#ga87d7af42876fddcc0ba3b640a82b006c" title="The calling code can mark the x component of an IOR field in *_data with MI_NEURAYLIB_BSDF_USE_MATERI...">MI_NEURAYLIB_BSDF_USE_MATERIAL_IOR</a>);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                eval_data.k1 = -ray.dir;</div>
<div class="line">                eval_data.k2 = light_dir;</div>
<div class="line">                eval_data.bsdf_diffuse = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f);</div>
<div class="line">                eval_data.bsdf_glossy = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// evaluate material surface bsdf</span></div>
<div class="line">                rc.target_code-&gt;execute_bsdf_evaluate(</div>
<div class="line">                    surface_bsdf_function_index + 2,    <span class="comment">// bsdf_function_index corresponds to &#39;init&#39;</span></div>
<div class="line">                                                        <span class="comment">// bsdf_function_index+2 to &#39;evaluate&#39;</span></div>
<div class="line">                    &amp;eval_data,</div>
<div class="line">                    rc.shading_state,</div>
<div class="line">                    rc.tex_handler,</div>
<div class="line">                    <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (eval_data.pdf &gt; 1.e-6f)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">float</span> mis_weight = (light_pdf == Constants.DIRAC)</div>
<div class="line">                        ? 1.0f : light_pdf / (light_pdf + eval_data.pdf);</div>
<div class="line"></div>
<div class="line">                    vp_sample[VPCH_ILLUM] += (eval_data.bsdf_diffuse + eval_data.bsdf_glossy)*(radiance_over_pdf*ray.weight)*mis_weight;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// sample material bsdf contribution</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html" title="Input and output structure for BSDF sampling data. ">mi::neuraylib::Bsdf_sample_data</a> sample_data;  <span class="comment">// input/output data for sample</span></div>
<div class="line">                <span class="keywordflow">if</span> (ray.is_inside &amp;&amp; !is_thin_walled)</div>
<div class="line">                {</div>
<div class="line">                    sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#aee5169066f6b2c28f27123bdf97892a7" title="mutual input: IOR current medium ">ior1</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(<a class="code" href="group__mi__neuray__mdl__compiler.html#ga87d7af42876fddcc0ba3b640a82b006c" title="The calling code can mark the x component of an IOR field in *_data with MI_NEURAYLIB_BSDF_USE_MATERI...">MI_NEURAYLIB_BSDF_USE_MATERIAL_IOR</a>);</div>
<div class="line">                    sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a807bad627d7d8792f86711bbaf9315ca" title="mutual input: IOR other side ">ior2</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#aee5169066f6b2c28f27123bdf97892a7" title="mutual input: IOR current medium ">ior1</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(1.0f);</div>
<div class="line">                    sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a807bad627d7d8792f86711bbaf9315ca" title="mutual input: IOR other side ">ior2</a> = <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(<a class="code" href="group__mi__neuray__mdl__compiler.html#ga87d7af42876fddcc0ba3b640a82b006c" title="The calling code can mark the x component of an IOR field in *_data with MI_NEURAYLIB_BSDF_USE_MATERI...">MI_NEURAYLIB_BSDF_USE_MATERIAL_IOR</a>);</div>
<div class="line">                }</div>
<div class="line">                sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a86dcd9bb2e10d8ee80977d4589af0322" title="mutual input: outgoing direction ">k1</a> = -ray.dir;                    <span class="comment">// outgoing direction</span></div>
<div class="line">                sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a0bebbb9fe6dd51d70acfc67392b86bef" title="input: pseudo-random sample numbers ">xi</a>.x = rnd(seed);</div>
<div class="line">                sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a0bebbb9fe6dd51d70acfc67392b86bef" title="input: pseudo-random sample numbers ">xi</a>.y = rnd(seed);</div>
<div class="line">                sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a0bebbb9fe6dd51d70acfc67392b86bef" title="input: pseudo-random sample numbers ">xi</a>.z = rnd(seed);</div>
<div class="line">                sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a0bebbb9fe6dd51d70acfc67392b86bef" title="input: pseudo-random sample numbers ">xi</a>.w = rnd(seed);</div>
<div class="line"></div>
<div class="line">                rc.target_code-&gt;execute_bsdf_sample(</div>
<div class="line">                    surface_bsdf_function_index + 1,         <span class="comment">// bsdf_function_index corresponds to &#39;init&#39;</span></div>
<div class="line">                                                             <span class="comment">// bsdf_function_index+1 to &#39;sample&#39;</span></div>
<div class="line">                    &amp;sample_data,   <span class="comment">// input/output</span></div>
<div class="line">                    rc.shading_state,</div>
<div class="line">                    rc.tex_handler,</div>
<div class="line">                    <span class="comment">/*arg_block_data=*/</span> <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#aec50db857caeb03a9b7b7f47d35d39f9" title="output: the type of event for the generated sample ">event_type</a> != mi::neuraylib::BSDF_EVENT_ABSORB)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> ((sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#aec50db857caeb03a9b7b7f47d35d39f9" title="output: the type of event for the generated sample ">event_type</a> &amp; mi::neuraylib::BSDF_EVENT_SPECULAR) != 0)</div>
<div class="line">                        ray.last_pdf = -1.0f;</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        ray.last_pdf = sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#a3e5fd926e872e70aeab0bc78f908843f" title="output: pdf (non-projected hemisphere) ">pdf</a>;</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// there is a scattering event, trace either the reflection or transmision ray</span></div>
<div class="line">                    ray.weight *= <span class="keyword">static_cast&lt;</span><a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a><span class="keyword">&gt;</span>(sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#aef87fdcb9856d2a3fab9a33a27e5ba21" title="output: bsdf * dot(normal, k2) / pdf ">bsdf_over_pdf</a>);</div>
<div class="line">                    ray.p0 = isect_info.pos;</div>
<div class="line">                    ray.dir = normalize(sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#ac3c523eddfd0f76bf98557c8a97eb030" title="output: incoming direction ">k2</a>);</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// medium change?</span></div>
<div class="line">                    <span class="keywordflow">if</span> (sample_data.<a class="code" href="structmi_1_1neuraylib_1_1Bsdf__sample__data.html#aec50db857caeb03a9b7b7f47d35d39f9" title="output: the type of event for the generated sample ">event_type</a>&amp;mi::neuraylib::BSDF_EVENT_TRANSMISSION)</div>
<div class="line">                    {</div>
<div class="line">                        ray.offset_ray(-<a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>(rc.shading_state.geom_normal));</div>
<div class="line">                        ray.is_inside = !ray.is_inside;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        ray.offset_ray(rc.shading_state.geom_normal);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    std::vector&lt;mi::Float32_3&gt; scat_color = {<a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f)};</div>
<div class="line">                    trace_ray(scat_color, rc, ray, seed);</div>
<div class="line">                    vp_sample[VPCH_ILLUM] += scat_color[VPCH_ILLUM];</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// ray hits environment</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> pdf;</div>
<div class="line">        vp_sample[VPCH_ILLUM] = rc.evaluate_environment(pdf, ray.dir)*ray.weight;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// account multi importance sampling for environment</span></div>
<div class="line">        <span class="keywordflow">if</span> (ray.level &gt; 1 &amp;&amp; ray.last_pdf &gt; 0.f)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// point light selection probability</span></div>
<div class="line">            <span class="keywordflow">if</span> (rc.omni_light.intensity &gt; 0.f)</div>
<div class="line">                pdf *= 0.5f;</div>
<div class="line"></div>
<div class="line">            vp_sample[VPCH_ILLUM] *= ray.last_pdf / (ray.last_pdf + pdf);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Scene Rendering</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="keywordtype">void</span> render_scene(</div>
<div class="line">    Render_context rc,</div>
<div class="line">    <span class="keywordtype">size_t</span> frame_nb,</div>
<div class="line">    VP_buffers *vp_buffers,</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* dst,</div>
<div class="line">    <span class="keywordtype">size_t</span> ymin,</div>
<div class="line">    <span class="keywordtype">size_t</span> ymax,</div>
<div class="line">    <span class="keywordtype">size_t</span> width,</div>
<div class="line">    <span class="keywordtype">size_t</span> height,</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> channels)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ymax &gt; height)</div>
<div class="line">        ymax = height;</div>
<div class="line"></div>
<div class="line">    Render_context::Ray ray;</div>
<div class="line">    <span class="keywordtype">size_t</span> pixel_offset = ymin * width * channels;</div>
<div class="line">    <span class="keywordtype">size_t</span> vp_idx = ymin * width;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> y = ymin; y &lt; ymax; ++y)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// random sequence initialization</span></div>
<div class="line">        <span class="keywordtype">unsigned</span> seed = tea(16, y*width, frame_nb);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> x = 0; x &lt; width; ++x, ++vp_idx)</div>
<div class="line">        {</div>
<div class="line">            std::vector&lt;mi::Float32_3&gt; vp_sample =</div>
<div class="line">                { <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f), <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f), <a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>(0.f) };</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span> x_rnd = rnd(seed);</div>
<div class="line">            <span class="keywordtype">float</span> y_rnd = rnd(seed);</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_2</a> screen_pos(</div>
<div class="line">                (x + x_rnd)*rc.cam.inv_res.x,</div>
<div class="line">                (y + y_rnd)*rc.cam.inv_res.y);</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span> r = (2.0f * screen_pos.x - 1.0f);</div>
<div class="line">            <span class="keywordtype">float</span> u = (2.0f * screen_pos.y - 1.0f);</div>
<div class="line"></div>
<div class="line">            ray.p0 = rc.cam.pos;</div>
<div class="line">            ray.dir = normalize(rc.cam.dir * rc.cam.focal +</div>
<div class="line">                rc.cam.right * r + rc.cam.up * (rc.cam.aspect * u));</div>
<div class="line">            ray.weight = 1.f;</div>
<div class="line">            ray.is_inside = <span class="keyword">false</span>;</div>
<div class="line">            ray.level = 0;</div>
<div class="line">            ray.last_pdf = -1.f;</div>
<div class="line"></div>
<div class="line">            <span class="comment">//trace camera ray</span></div>
<div class="line">            trace_ray(vp_sample, rc, ray, seed);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// update progressive rendering viewport buffer</span></div>
<div class="line">            <span class="keywordflow">if</span> (frame_nb == 1)</div>
<div class="line">            {</div>
<div class="line">                vp_buffers-&gt;accum_buffer[vp_idx] = vp_sample[VPCH_ILLUM];</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span>(rc.render_auxiliary)</div>
<div class="line">                {</div>
<div class="line">                    vp_buffers-&gt;albedo_buffer[vp_idx] = vp_sample[VPCH_ALBEDO];</div>
<div class="line">                    vp_buffers-&gt;normal_buffer[vp_idx] = vp_sample[VPCH_NORMAL];</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                vp_buffers-&gt;accum_buffer[vp_idx] =</div>
<div class="line">                    (vp_buffers-&gt;accum_buffer[vp_idx] * <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(frame_nb - 1) + vp_sample[VPCH_ILLUM]) * (1.f / frame_nb);</div>
<div class="line">                vp_sample[VPCH_ILLUM] = vp_buffers-&gt;accum_buffer[vp_idx];</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (rc.render_auxiliary)</div>
<div class="line">                {</div>
<div class="line">                    vp_buffers-&gt;albedo_buffer[vp_idx] =</div>
<div class="line">                        (vp_buffers-&gt;albedo_buffer[vp_idx] * <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(frame_nb - 1) + vp_sample[VPCH_ALBEDO]) * (1.f / frame_nb);</div>
<div class="line">                    vp_sample[VPCH_ALBEDO] = vp_buffers-&gt;albedo_buffer[vp_idx];</div>
<div class="line"></div>
<div class="line">                    vp_buffers-&gt;normal_buffer[vp_idx] =</div>
<div class="line">                        (vp_buffers-&gt;normal_buffer[vp_idx] * <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(frame_nb - 1) + vp_sample[VPCH_NORMAL]) * (1.f / frame_nb);</div>
<div class="line">                    vp_sample[VPCH_NORMAL] = vp_buffers-&gt;normal_buffer[vp_idx];</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (dst)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// apply gamma correction</span></div>
<div class="line">                vp_sample[VPCH_ILLUM].x = powf(vp_sample[VPCH_ILLUM].x, 1.f / 2.2f);</div>
<div class="line">                vp_sample[VPCH_ILLUM].y = powf(vp_sample[VPCH_ILLUM].y, 1.f / 2.2f);</div>
<div class="line">                vp_sample[VPCH_ILLUM].z = powf(vp_sample[VPCH_ILLUM].z, 1.f / 2.2f);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// write final pixel</span></div>
<div class="line">                vp_sample[VPCH_ILLUM] *= 255.f;</div>
<div class="line">                <a class="code" href="group__mi__math__color.html#ga3d330fb2bac60aa326ef42d1e2b42040" title="Returns the color c elementwise clamped to the range [low, high]. ">clamp</a>(vp_sample[VPCH_ILLUM], 0.f, 255.f);</div>
<div class="line">                dst[pixel_offset++] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span><span class="keyword">&gt;</span>(vp_sample[VPCH_ILLUM].x);</div>
<div class="line">                dst[pixel_offset++] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span><span class="keyword">&gt;</span>(vp_sample[VPCH_ILLUM].y);</div>
<div class="line">                dst[pixel_offset++] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span><span class="keyword">&gt;</span>(vp_sample[VPCH_ILLUM].z);</div>
<div class="line">                dst[pixel_offset++] = 255u;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Save current result image to disk</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> save_screenshot(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>* image_buffer,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height,</div>
<div class="line">    <span class="keyword">const</span> std::string &amp;filename,</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api,</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_impexp_api&gt;</a> mdl_impexp_api)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ICanvas&gt;</a> canvas(</div>
<div class="line">        image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a4f776e1c0271e6898a3585c0bf8099cd" title="Creates a canvas with given pixel type, resolution, and layers. ">create_canvas</a>(<span class="stringliteral">&quot;Float32&lt;3&gt;&quot;</span>, width, height));</div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::ITile&gt;</a> tile(canvas-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas.html#a2498f17d35d4e888a76bdc077df1a406" title="Returns the tile for the given layer. ">get_tile</a>());</div>
<div class="line">    memcpy(tile-&gt;get_data(), image_buffer, width*height * <span class="keyword">sizeof</span>(<a class="code" href="group__mi__neuray__compounds.html#gaa062a695371761834d46c56562cf3329" title="Vector of three Float32. ">mi::Float32_3</a>));</div>
<div class="line">    mdl_impexp_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html#a1b544c77874b97eae0003c39e27e2103" title="Exports a canvas to a file on disk. ">export_canvas</a>(filename.c_str(), canvas.get(), 100U, <span class="keyword">true</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Main Function</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">// Print command line usage to console and terminate the application.</span></div>
<div class="line"><span class="keywordtype">void</span> usage(<span class="keywordtype">char</span> <span class="keyword">const</span> *prog_name)</div>
<div class="line">{</div>
<div class="line">    std::cout</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; prog_name &lt;&lt; <span class="stringliteral">&quot; [options] [&lt;material_name&gt;]\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;Options:\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  -h|--help              print this text and exit\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  -v|--version           print the MDL SDK version string and exit\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --res &lt;x&gt; &lt;y&gt;          resolution (default: 700x520)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --hdr &lt;filename&gt;       environment map\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;                         (default: nvidia/sdk_examples/resources/environment.hdr)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --cc                   use class compilation\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --cr                   use custom texture runtime\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --an                   use adapt normal function\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --nogui                don&#39;t open interactive display\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  --spp                  samples per pixel (default: 100) for output image when nogui\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  -o &lt;outputfile&gt;        image file to write result to\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;                         (default: example_native.png)\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  -oaux                  output albedo and normal auxiliary buffers.\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  -p|--mdl_path &lt;path&gt;   mdl search path, can occur multiple times\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;Viewport controls:\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  Mouse               Camera rotation, zoom\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  Arrow keys, (+/-)   Omni-light rotation, intensity\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  CTRL + (+/-)        Environment intensity\n&quot;</span></div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;  ENTER               Screenshot\n&quot;</span></div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    exit_failure();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> MAIN_UTF8(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Parse command line options</span></div>
<div class="line">    Render_context rc;</div>
<div class="line">    Options options;</div>
<div class="line">    mi::examples::mdl::Configure_options configure_options;</div>
<div class="line">    configure_options.add_example_search_path = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> print_version_and_exit = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; argc; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> <span class="keyword">const</span> *opt = argv[i];</div>
<div class="line">        <span class="keywordflow">if</span> (opt[0] == <span class="charliteral">&#39;-&#39;</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--nogui&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                options.no_gui = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--spp&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                options.iterations = std::max(atoi(argv[++i]), 1);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-o&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                options.outputfile = argv[++i];</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-oaux&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                options.output_auxiliary = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--res&quot;</span>) == 0 &amp;&amp; i &lt; argc - 2)</div>
<div class="line">            {</div>
<div class="line">                options.res_x = std::max(atoi(argv[++i]), 1);</div>
<div class="line">                options.res_y = std::max(atoi(argv[++i]), 1);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--max_path_length&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                options.max_ray_length = std::max(atoi(argv[++i]), 0);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--hdr&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                options.env_map = argv[++i];</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--hdr_scale&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                options.env_scale = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-f&quot;</span>) == 0 &amp;&amp; i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                options.cam_fov = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-p&quot;</span>) == 0 &amp;&amp; i &lt; argc - 3)</div>
<div class="line">            {</div>
<div class="line">                options.cam_pos.x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.cam_pos.y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.cam_pos.z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-l&quot;</span>) == 0 &amp;&amp; i &lt; argc - 6)</div>
<div class="line">            {</div>
<div class="line">                options.light_pos.x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.light_pos.y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.light_pos.z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.light_intensity.x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.light_intensity.y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">                options.light_intensity.z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(atof(argv[++i]));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--cc&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                options.use_class_compilation = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--cr&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                options.use_custom_tex_runtime = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;--an&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                options.use_adapt_normal = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((strcmp(opt, <span class="stringliteral">&quot;--mdl_path&quot;</span>) == 0 || strcmp(opt, <span class="stringliteral">&quot;-p&quot;</span>) == 0) &amp;&amp;</div>
<div class="line">                i &lt; argc - 1)</div>
<div class="line">            {</div>
<div class="line">                configure_options.additional_mdl_paths.push_back(argv[++i]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-v&quot;</span>) == 0 || strcmp(opt, <span class="stringliteral">&quot;--version&quot;</span>) == 0)</div>
<div class="line">            {</div>
<div class="line">                print_version_and_exit = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (strcmp(opt, <span class="stringliteral">&quot;-h&quot;</span>) != 0 &amp;&amp; strcmp(opt, <span class="stringliteral">&quot;--help&quot;</span>) != 0)</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;Unknown option: \&quot;&quot;</span> &lt;&lt; opt &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                usage(argv[0]);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            options.material_name = opt;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Use default material, if none was provided via command line</span></div>
<div class="line">    configure_options.add_example_search_path = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (options.material_name.empty())</div>
<div class="line">        options.material_name = <span class="stringliteral">&quot;::nvidia::sdk_examples::tutorials::example_df&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Access the MDL SDK</span></div>
<div class="line">    <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::INeuray&gt;</a> neuray(mi::examples::mdl::load_and_get_ineuray());</div>
<div class="line">    <span class="keywordflow">if</span> (!neuray.is_valid_interface())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to load the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Handle the --version flag</span></div>
<div class="line">    <span class="keywordflow">if</span> (print_version_and_exit)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// print library version information.</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;const mi::neuraylib::IVersion&gt;</a> version(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<span class="keyword">const</span> <a class="code" href="classmi_1_1neuraylib_1_1IVersion.html" title="Abstract interface for accessing version information. ">mi::neuraylib::IVersion</a>&gt;());</div>
<div class="line">        fprintf(stdout, <span class="stringliteral">&quot;%s\n&quot;</span>, version-&gt;get_string());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// free the handles and unload the MDL SDK</span></div>
<div class="line">        version = <span class="keyword">nullptr</span>;</div>
<div class="line">        neuray = <span class="keyword">nullptr</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (!mi::examples::mdl::unload())</div>
<div class="line">            exit_failure(<span class="stringliteral">&quot;Failed to unload the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">        exit_success();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::configure(neuray.get(), configure_options))</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Start the MDL SDK</span></div>
<div class="line">    <a class="code" href="group__mi__base__types.html#gafcdcb44319b0596ee8a9a44fddaec8c6" title="32-bit signed integer. ">mi::Sint32</a> ret = neuray-&gt;start();</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to initialize the SDK. Result code: %d&quot;</span>, ret);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Enable/Disable auxiliary buffers</span></div>
<div class="line">    rc.render_auxiliary = options.output_auxiliary;</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Create a transaction</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IDatabase&gt;</a> database(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IDatabase.html" title="This interface is used to interact with the distributed database. ">mi::neuraylib::IDatabase</a>&gt;());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IScope&gt;</a> scope(database-&gt;get_global_scope());</div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::ITransaction&gt;</a> transaction(scope-&gt;create_transaction());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Acquire image API needed to prepare the textures</span></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage_api&gt;</a> image_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html" title="This interface provides various utilities related to canvases and buffers. ">mi::neuraylib::IImage_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_impexp_api&gt;</a> mdl_impexp_api(</div>
<div class="line">            neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__impexp__api.html" title="API component for MDL related import and export operations. ">mi::neuraylib::IMdl_impexp_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html">mi::base::Handle&lt;mi::neuraylib::IMdl_factory&gt;</a> mdl_factory(</div>
<div class="line">                neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html" title="Factory for various MDL interfaces and functions. ">mi::neuraylib::IMdl_factory</a>&gt;());</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_backend_api&gt;</a> mdl_backend_api(</div>
<div class="line">                neuray-&gt;get_api_component&lt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__backend__api.html" title="This interface can be used to obtain the MDL backends. ">mi::neuraylib::IMdl_backend_api</a>&gt;());</div>
<div class="line"></div>
<div class="line">            <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IMdl_execution_context&gt;</a> context(</div>
<div class="line">                mdl_factory-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IMdl__factory.html#a78a9a6489592c90ea49e0fe0ac8be235" title="Creates an execution context. ">create_execution_context</a>());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Load the MDL module and create a material instance</span></div>
<div class="line">            std::string instance_name = <span class="stringliteral">&quot;material instance&quot;</span>;</div>
<div class="line">            create_material_instance(</div>
<div class="line">                mdl_factory.get(),</div>
<div class="line">                transaction.get(),</div>
<div class="line">                mdl_impexp_api.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>(),</div>
<div class="line">                context.get(),</div>
<div class="line">                options.material_name.c_str(),</div>
<div class="line">                instance_name.c_str());</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Compile the material instance in instance compilation mode</span></div>
<div class="line">            std::string instance_compilation_name</div>
<div class="line">                = std::string(<span class="stringliteral">&quot;instance compilation of &quot;</span>) + instance_name;</div>
<div class="line">            <span class="comment">// Compile the material instance</span></div>
<div class="line">            std::string compilation_name</div>
<div class="line">                = std::string(<span class="stringliteral">&quot;compilation of &quot;</span>) + instance_name;</div>
<div class="line">            compile_material_instance(</div>
<div class="line">                transaction.get(),</div>
<div class="line">                context.get(),</div>
<div class="line">                instance_name.c_str(),</div>
<div class="line">                compilation_name.c_str(),</div>
<div class="line">                options.use_class_compilation);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Generate target code for some material expression and update render context</span></div>
<div class="line">            generate_native(</div>
<div class="line">                rc,</div>
<div class="line">                transaction.get(),</div>
<div class="line">                mdl_backend_api.get(),</div>
<div class="line">                context.get(),</div>
<div class="line">                compilation_name.c_str(),</div>
<div class="line">                options.use_custom_tex_runtime,</div>
<div class="line">                options.use_adapt_normal,</div>
<div class="line">                options.enable_derivatives);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Setup custom texture handler, if requested</span></div>
<div class="line">        std::vector&lt;Texture&gt;                  textures;</div>
<div class="line">        Texture_handler                       tex_handler = { 0 };</div>
<div class="line">        <a class="code" href="structmi_1_1neuraylib_1_1Texture__handler__vtable__impl.html" title="The runtime for bitmap texture access for the generated target code can optionally be implemented in ...">mi::neuraylib::Texture_handler_vtable</a> tex_only_adapt_normal_vtable = { 0 };</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (options.use_custom_tex_runtime)</div>
<div class="line">        {</div>
<div class="line">            check_success(prepare_textures(</div>
<div class="line">                textures, transaction.get(), image_api.<a class="code" href="classmi_1_1base_1_1Handle.html#ab28423d4121459d4026449e4991f5486" title="Access to the interface. Returns 0 for an invalid interface. ">get</a>(), rc.target_code.get()));</div>
<div class="line"></div>
<div class="line">            tex_handler.vtable = &amp;tex_vtable;</div>
<div class="line">            tex_handler.num_textures = rc.target_code-&gt;get_texture_count() - 1;</div>
<div class="line">            tex_handler.textures = textures.data();</div>
<div class="line"></div>
<div class="line">            rc.tex_handler = &amp;tex_handler;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (options.use_adapt_normal)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// only set the m_adapt_normal entry in the vtable of the texture handler object</span></div>
<div class="line"></div>
<div class="line">            tex_only_adapt_normal_vtable.<a class="code" href="structmi_1_1neuraylib_1_1Texture__handler__vtable__impl.html#adee6420183db13316d4ac4d06ad6682f" title="Implementation of adapt_normal(). ">m_adapt_normal</a> = adapt_normal;</div>
<div class="line"></div>
<div class="line">            tex_handler.vtable = &amp;tex_only_adapt_normal_vtable;</div>
<div class="line"></div>
<div class="line">            rc.tex_handler = &amp;tex_handler;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create window context</span></div>
<div class="line">        Window_context window_context;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// setup render data</span></div>
<div class="line">        <span class="comment">// ------------------------------------------------------------------------</span></div>
<div class="line">        <span class="keywordtype">size_t</span> window_width = 0, window_height = 0;</div>
<div class="line">        <span class="keywordtype">size_t</span> frame_nb = 0; <span class="comment">// frame counter</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Viewport buffers for progressive rendering</span></div>
<div class="line">        VP_buffers vp_buffers;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Setup file name for nogl mode</span></div>
<div class="line">        std::string filename_base, filename_ext;</div>
<div class="line">        <span class="keywordtype">size_t</span> dot_pos = options.outputfile.rfind(<span class="charliteral">&#39;.&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (dot_pos == std::string::npos)</div>
<div class="line">        {</div>
<div class="line">            filename_base = options.outputfile;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            filename_base = options.outputfile.substr(0, dot_pos);</div>
<div class="line">            filename_ext = options.outputfile.substr(dot_pos);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_PARALLEL_RENDERING</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// get number of physical/virtual threads available.</span></div>
<div class="line"><span class="preprocessor">#ifdef MI_PLATFORM_WINDOWS</span></div>
<div class="line"><span class="preprocessor"></span>        SYSTEM_INFO sysinfo;</div>
<div class="line">        GetSystemInfo(&amp;sysinfo);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> num_threads = sysinfo.dwNumberOfProcessors;</div>
<div class="line"><span class="preprocessor">#elif MI_PLATFORM_MACOSX</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordtype">int</span> num_threads;</div>
<div class="line">        <span class="keywordtype">size_t</span> len = <span class="keyword">sizeof</span>(num_threads);</div>
<div class="line">        sysctlbyname(<span class="stringliteral">&quot;hw.logicalcpu&quot;</span>, &amp;num_threads, &amp;len, NULL, 0);</div>
<div class="line"><span class="preprocessor">#else // LINUX // ARCH_64BIT</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keyword">const</span> <span class="keywordtype">int</span> num_threads = sysconf(_SC_NPROCESSORS_ONLN);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        std::cout &lt;&lt; <span class="stringliteral">&quot;Rendering on &quot;</span> &lt;&lt; num_threads &lt;&lt; <span class="stringliteral">&quot; threads.\n&quot;</span>;</div>
<div class="line"><span class="preprocessor">#endif // USE_PARALLEL_RENDERING</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        <span class="comment">// render options</span></div>
<div class="line">        rc.max_ray_length = options.max_ray_length;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// load/setup environment map</span></div>
<div class="line">        window_context.env_intensity = rc.env.intensity = options.env_scale;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classmi_1_1base_1_1Handle.html" title="Handle class template for interfaces, automatizing the lifetime control via reference counting...">mi::base::Handle&lt;mi::neuraylib::IImage&gt;</a> image(</div>
<div class="line">            transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#ad1b8ce71d7a6fea1f59573325dba126c" title="Creates an object of the type type_name. ">create</a>&lt;<a class="code" href="classmi_1_1neuraylib_1_1IImage.html" title="This interface represents a pixel image file. ">mi::neuraylib::IImage</a>&gt;(<span class="stringliteral">&quot;Image&quot;</span>));</div>
<div class="line">        check_success(image-&gt;reset_file(options.env_map.c_str()) == 0);</div>
<div class="line"></div>
<div class="line">        rc.env.map = image-&gt;get_canvas(0, 0, 0);</div>
<div class="line">        rc.env.map_size.x = rc.env.map-&gt;get_resolution_x();</div>
<div class="line">        rc.env.map_size.y = rc.env.map-&gt;get_resolution_y();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Check, whether we need to convert the image</span></div>
<div class="line">        <span class="keywordtype">char</span> <span class="keyword">const</span> *image_type = image-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ICanvas__base.html#ab36d6bebb85da08e907eadbe7542c658" title="Returns the pixel type used by the canvas. ">get_type</a>(0, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(image_type, <span class="stringliteral">&quot;Color&quot;</span>) != 0 &amp;&amp; strcmp(image_type, <span class="stringliteral">&quot;Float32&lt;4&gt;&quot;</span>) != 0)</div>
<div class="line">            rc.env.map = image_api-&gt;<a class="code" href="classmi_1_1neuraylib_1_1IImage__api.html#a70bb55d4f633151d12664b078ddd6ebb" title="Converts a canvas to a different pixel type. ">convert</a>(rc.env.map.get(), <span class="stringliteral">&quot;Color&quot;</span>);</div>
<div class="line"></div>
<div class="line">        rc.env.map_pixels = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">float</span>*<span class="keyword">&gt;</span>(</div>
<div class="line">                <a class="code" href="group__mi__base__iinterface.html#ga18f61a252409bb61d7b686868aebfef9" title="Returns a handle that holds the interface pointer passed in as argument. ">mi::base::make_handle</a>(rc.env.map-&gt;get_tile())-&gt;get_data());</div>
<div class="line">        rc.build_alias_map();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// setup omni light</span></div>
<div class="line">        rc.omni_light.intensity = std::max(std::max(options.light_intensity.x, options.light_intensity.y), options.light_intensity.y);</div>
<div class="line">        <span class="keywordflow">if</span> (rc.omni_light.intensity &gt; 0.f)</div>
<div class="line">            rc.omni_light.color = options.light_intensity / rc.omni_light.intensity;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            rc.omni_light.color = options.light_intensity;</div>
<div class="line">        rc.omni_light.distance = <a class="code" href="group__mi__math__function.html#gaab1f278e40b1524c2c83b33e05fee81f" title="Returns the Euclidean norm of the scalar a (its absolute value). ">length</a>(options.light_pos);</div>
<div class="line">        rc.omni_light.dir = normalize(options.light_pos);</div>
<div class="line"></div>
<div class="line">        window_context.omni_phi = atan2f(rc.omni_light.dir.x, rc.omni_light.dir.z);</div>
<div class="line">        window_context.omni_theta = acosf(rc.omni_light.dir.y);</div>
<div class="line">        window_context.omni_intensity = rc.omni_light.intensity;</div>
<div class="line"></div>
<div class="line">        rc.update_light(window_context.omni_phi, window_context.omni_theta, window_context.omni_intensity);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// setup initial camera</span></div>
<div class="line">        <span class="keywordtype">float</span> base_dist = <a class="code" href="group__mi__math__function.html#gaab1f278e40b1524c2c83b33e05fee81f" title="Returns the Euclidean norm of the scalar a (its absolute value). ">length</a>(options.cam_pos);</div>
<div class="line">        <span class="keywordtype">float</span> theta, phi;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a> inv_dir = normalize(options.cam_pos);</div>
<div class="line">        phi = atan2f(inv_dir.x, inv_dir.z);</div>
<div class="line">        theta = acosf(inv_dir.y);</div>
<div class="line"></div>
<div class="line">        rc.cam.focal = 1.0f / tanf(options.cam_fov * Constants.PI / 360.f);</div>
<div class="line">        rc.update_camera(phi, theta, base_dist, window_context.zoom);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// render to image?</span></div>
<div class="line">        <span class="keywordflow">if</span> (options.no_gui)</div>
<div class="line">        {</div>
<div class="line">            window_width = options.res_x;</div>
<div class="line">            window_height = options.res_y;</div>
<div class="line"></div>
<div class="line">            frame_nb = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (vp_buffers.accum_buffer)</div>
<div class="line">                <span class="keyword">delete</span>[] vp_buffers.accum_buffer;</div>
<div class="line"></div>
<div class="line">            vp_buffers.accum_buffer = <span class="keyword">new</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>[window_width*window_height];</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(options.output_auxiliary)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (vp_buffers.albedo_buffer)</div>
<div class="line">                    <span class="keyword">delete</span>[] vp_buffers.albedo_buffer;</div>
<div class="line">                <span class="keywordflow">if</span> (vp_buffers.normal_buffer)</div>
<div class="line">                    <span class="keyword">delete</span>[] vp_buffers.normal_buffer;</div>
<div class="line"></div>
<div class="line">                vp_buffers.albedo_buffer = <span class="keyword">new</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>[window_width*window_height];</div>
<div class="line">                vp_buffers.normal_buffer = <span class="keyword">new</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>[window_width*window_height];</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// update camera parameters</span></div>
<div class="line">            rc.cam.inv_res.x = 1.0f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_width);</div>
<div class="line">            rc.cam.inv_res.y = 1.0f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_height);</div>
<div class="line">            rc.cam.aspect = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_height)</div>
<div class="line">                / static_cast&lt;float&gt;(window_width);</div>
<div class="line"></div>
<div class="line">            {</div>
<div class="line">                Timing timing(<span class="stringliteral">&quot;rendering&quot;</span>);</div>
<div class="line"></div>
<div class="line">                <span class="comment">//render loop</span></div>
<div class="line">                <span class="keywordflow">while</span> (frame_nb &lt; options.iterations)</div>
<div class="line">                {</div>
<div class="line">                    frame_nb++;</div>
<div class="line"><span class="preprocessor">#ifdef USE_PARALLEL_RENDERING</span></div>
<div class="line"><span class="preprocessor"></span>                    <span class="comment">// preparing render threads</span></div>
<div class="line">                    std::vector&lt;std::thread&gt; threads;</div>
<div class="line">                    <span class="keywordtype">size_t</span> lpt = window_height / num_threads +</div>
<div class="line">                        (window_height % num_threads != 0 ? 1 : 0); <span class="comment">// lines per thread</span></div>
<div class="line"></div>
<div class="line">                    <span class="comment">// Launch render threads</span></div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_threads; ++i)</div>
<div class="line">                        threads.push_back(std::thread(render_scene, rc, frame_nb, &amp;vp_buffers,</div>
<div class="line">                            <span class="keyword">nullptr</span>, lpt * i, lpt * (i + 1), window_width, window_height, 4));</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// wait for threads to finish</span></div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_threads; ++i)</div>
<div class="line">                        threads[i].join();</div>
<div class="line"></div>
<div class="line">                    threads.clear();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>                    render_scene(rc, frame_nb, &amp;vp_buffers,</div>
<div class="line">                        <span class="keyword">nullptr</span>, 0, window_height, window_width, window_height, 4);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// save screenshot</span></div>
<div class="line">            save_screenshot(vp_buffers.accum_buffer, window_width, window_height,</div>
<div class="line">                filename_base + filename_ext, image_api, mdl_impexp_api);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (options.output_auxiliary)</div>
<div class="line">            {</div>
<div class="line">                save_screenshot(vp_buffers.albedo_buffer, window_width, window_height,</div>
<div class="line">                    filename_base + <span class="stringliteral">&quot;_albedo&quot;</span> + filename_ext, image_api, mdl_impexp_api);</div>
<div class="line">                save_screenshot(vp_buffers.normal_buffer, window_width, window_height,</div>
<div class="line">                    filename_base + <span class="stringliteral">&quot;_normal&quot;</span> + filename_ext, image_api, mdl_impexp_api);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// interactive renderer</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// create the main window</span></div>
<div class="line">            <span class="keywordflow">if</span> (!glfwInit())</div>
<div class="line">                exit(EXIT_FAILURE);</div>
<div class="line"></div>
<div class="line">            glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 3);</div>
<div class="line">            glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 3);</div>
<div class="line">            glfwWindowHint(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);</div>
<div class="line">            glfwWindowHint(GLFW_OPENGL_FORWARD_COMPAT, GL_TRUE);</div>
<div class="line"></div>
<div class="line">            mi::examples::mdl::GL_window::Description window_desc;</div>
<div class="line">            window_desc.width = options.res_x;</div>
<div class="line">            window_desc.height = options.res_y;</div>
<div class="line">            window_desc.title = <span class="stringliteral">&quot;MDL Native Rendering&quot;</span>;</div>
<div class="line">            window_desc.no_gui = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">            mi::examples::mdl::GL_window gl_window(window_desc);</div>
<div class="line"></div>
<div class="line">            gl_window.set_window_user_pointer(&amp;window_context);</div>
<div class="line">            gl_window.set_key_callback(Window_context::handle_key);</div>
<div class="line">            gl_window.set_mouse_button_callback(Window_context::handle_mouse_button);</div>
<div class="line">            gl_window.set_cursor_pos_callback(Window_context::handle_mouse_pos);</div>
<div class="line">            gl_window.set_scroll_callback(Window_context::handle_scroll);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (GLEW_OK != glewInit())</div>
<div class="line">                exit(EXIT_FAILURE);</div>
<div class="line"></div>
<div class="line">            glfwSwapInterval(1);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// create a display, this allows to render a buffer to screen</span></div>
<div class="line">            mi::examples::mdl::GL_display gl_display(window_desc.width, window_desc.height);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// setup GUI</span></div>
<div class="line">            <span class="comment">// ------------------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">// init the GUI system in terms of styles and fonts</span></div>
<div class="line">            mi::examples::gui::Root* gui = window_desc.no_gui ? <span class="keyword">nullptr</span> : gl_window.get_gui();</div>
<div class="line">            <span class="keywordflow">if</span> (gui)</div>
<div class="line">            {</div>
<div class="line">                gui-&gt;initialize();</div>
<div class="line">                <span class="comment">// add panels and other controls here</span></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// render loop</span></div>
<div class="line">            <span class="keywordflow">while</span> (gl_window.update())</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// get the window size and resize the image if necessary</span></div>
<div class="line">                <span class="keywordflow">if</span> (window_width != gl_window.get_width() || window_height != gl_window.get_height())</div>
<div class="line">                {</div>
<div class="line">                    window_width = gl_window.get_width();</div>
<div class="line">                    window_height = gl_window.get_height();</div>
<div class="line"></div>
<div class="line">                    frame_nb = 0;</div>
<div class="line">                    <span class="keywordflow">if</span> (vp_buffers.accum_buffer)</div>
<div class="line">                        <span class="keyword">delete</span>[] vp_buffers.accum_buffer;</div>
<div class="line"></div>
<div class="line">                    vp_buffers.accum_buffer = <span class="keyword">new</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>[window_width*window_height];</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (options.output_auxiliary)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span> (vp_buffers.albedo_buffer)</div>
<div class="line">                            <span class="keyword">delete</span>[] vp_buffers.albedo_buffer;</div>
<div class="line">                        <span class="keywordflow">if</span> (vp_buffers.normal_buffer)</div>
<div class="line">                            <span class="keyword">delete</span>[] vp_buffers.normal_buffer;</div>
<div class="line"></div>
<div class="line">                        vp_buffers.albedo_buffer = <span class="keyword">new</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>[window_width*window_height];</div>
<div class="line">                        vp_buffers.normal_buffer = <span class="keyword">new</span> <a class="code" href="classmi_1_1math_1_1Vector.html" title="Fixed-size math vector class template with generic operations. ">mi::Float32_3</a>[window_width*window_height];</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// update camera parameters</span></div>
<div class="line">                    rc.cam.inv_res.x = 1.0f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_width);</div>
<div class="line">                    rc.cam.inv_res.y = 1.0f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_height);</div>
<div class="line">                    rc.cam.aspect = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_height)</div>
<div class="line">                        / static_cast&lt;float&gt;(window_width);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// handle key input events</span></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.key_event &amp;&amp; !ImGui::GetIO().WantCaptureMouse)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// update environment</span></div>
<div class="line">                    rc.env.intensity = window_context.env_intensity;</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// Update light</span></div>
<div class="line">                    rc.update_light(window_context.omni_phi, window_context.omni_theta, window_context.omni_intensity);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// handle save screenshot event</span></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.save_sreenshot &amp;&amp; !ImGui::GetIO().WantCaptureMouse)</div>
<div class="line">                {</div>
<div class="line">                    save_screenshot(vp_buffers.accum_buffer, window_width, window_height,</div>
<div class="line">                        filename_base + filename_ext, image_api, mdl_impexp_api);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (options.output_auxiliary)</div>
<div class="line">                    {</div>
<div class="line">                        save_screenshot(vp_buffers.albedo_buffer, window_width, window_height,</div>
<div class="line">                            filename_base + <span class="stringliteral">&quot;_albedo&quot;</span> + filename_ext, image_api, mdl_impexp_api);</div>
<div class="line">                        save_screenshot(vp_buffers.normal_buffer, window_width, window_height,</div>
<div class="line">                            filename_base + <span class="stringliteral">&quot;_normal&quot;</span> + filename_ext, image_api, mdl_impexp_api);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// handle mouse input events</span></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.mouse_button - 1 == GLFW_MOUSE_BUTTON_LEFT)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Only accept button press when not hovering GUI window</span></div>
<div class="line">                    <span class="keywordflow">if</span> (window_context.mouse_button_action == GLFW_PRESS &amp;&amp;</div>
<div class="line">                        !ImGui::GetIO().WantCaptureMouse)</div>
<div class="line">                    {</div>
<div class="line">                        window_context.moving = <span class="keyword">true</span>;</div>
<div class="line">                        glfwGetCursorPos(gl_window.get_window(), &amp;window_context.move_start_x, &amp;window_context.move_start_y);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        window_context.moving = <span class="keyword">false</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.mouse_wheel_delta &amp;&amp; !ImGui::GetIO().WantCaptureMouse)</div>
<div class="line">                {</div>
<div class="line">                    window_context.zoom += window_context.mouse_wheel_delta;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.mouse_event &amp;&amp; !ImGui::GetIO().WantCaptureMouse)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Update camera</span></div>
<div class="line">                    phi -= <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(window_context.move_dx) * 0.001f * Constants.PI;</div>
<div class="line">                    theta -= static_cast&lt;float&gt;(window_context.move_dy) * 0.001f * Constants.PI;</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (theta &lt; 0.f)</div>
<div class="line">                        theta = 0.f;</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theta &gt; Constants.PI)</div>
<div class="line">                        theta = Constants.PI;</div>
<div class="line"></div>
<div class="line">                    window_context.move_dx = window_context.move_dy = 0.0;</div>
<div class="line"></div>
<div class="line">                    rc.update_camera(phi, theta, base_dist, window_context.zoom);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (window_context.key_event || window_context.mouse_event)</div>
<div class="line">                    frame_nb = 0;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Clear all events</span></div>
<div class="line">                window_context.key_event = <span class="keyword">false</span>;</div>
<div class="line">                window_context.mouse_event = <span class="keyword">false</span>;</div>
<div class="line">                window_context.mouse_wheel_delta = 0;</div>
<div class="line">                window_context.mouse_button = 0;</div>
<div class="line">                window_context.save_sreenshot = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">                ++frame_nb;</div>
<div class="line">                gl_display.resize(window_width, window_height);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// handle resize on the application side (resize rendering buffer, restart)</span></div>
<div class="line">                <span class="keywordflow">if</span> (gui)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// begin a new frame for the GUI and update the controls</span></div>
<div class="line">                    gui-&gt;new_frame();   <span class="comment">// required even when the main GUI is not rendered</span></div>
<div class="line">                    gui-&gt;update(<span class="comment">/*transaction*/</span> <span class="keyword">nullptr</span>);    <span class="comment">// update GUI elements</span></div>
<div class="line"></div>
<div class="line">                    <span class="comment">// process events</span></div>
<div class="line">                    mi::examples::gui::Event e = gui-&gt;process_event();</div>
<div class="line">                    <span class="keywordflow">while</span> (e.is_valid())</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">/* handle custom application events here */</span></div>
<div class="line">                        e = gui-&gt;process_event();</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// map the buffer, update the image data and un-map afterwards</span></div>
<div class="line">                <span class="comment">// make sure this is as fast as possible</span></div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* dst_image_data = gl_display.map();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_PARALLEL_RENDERING</span></div>
<div class="line"><span class="preprocessor"></span>                <span class="comment">// preparing render threads</span></div>
<div class="line">                std::vector&lt;std::thread&gt; threads;</div>
<div class="line">                <span class="keywordtype">size_t</span> lpt = window_height / num_threads +</div>
<div class="line">                    (window_height % num_threads != 0 ? 1 : 0); <span class="comment">// lines per thread</span></div>
<div class="line"></div>
<div class="line">                  <span class="comment">//Launch render threads</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_threads; ++i)</div>
<div class="line">                    threads.push_back(std::thread(render_scene, rc, frame_nb, &amp;vp_buffers,</div>
<div class="line">                        dst_image_data, lpt*i, lpt*(i + 1), window_width, window_height, 4));</div>
<div class="line"></div>
<div class="line">                <span class="comment">// wait for threads to finish</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_threads; ++i)</div>
<div class="line">                    threads[i].join();</div>
<div class="line"></div>
<div class="line">                threads.clear();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>                render_scene(rc, frame_nb, &amp;vp_buffers,</div>
<div class="line">                    dst_image_data, 0, window_height, window_width, window_height, 4);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">                gl_display.unmap();</div>
<div class="line"></div>
<div class="line">                <span class="comment">// render the updated image to screen</span></div>
<div class="line">                gl_display.update_display();</div>
<div class="line"></div>
<div class="line">                <span class="comment">// render GUI on top</span></div>
<div class="line">                <span class="keywordflow">if</span> (gui)</div>
<div class="line">                    gui-&gt;render(<span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// finish the frame</span></div>
<div class="line">                gl_window.present_back_buffer();</div>
<div class="line">            }</div>
<div class="line">            glfwTerminate();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">// free environment image</span></div>
<div class="line">        image = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">        transaction-&gt;<a class="code" href="classmi_1_1neuraylib_1_1ITransaction.html#aa4ff8152107db238986b364273bceb0c" title="Commits the transaction. ">commit</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Uninitialize the render context</span></div>
<div class="line">    rc.uninit();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Shut down the MDL SDK</span></div>
<div class="line">    <span class="keywordflow">if</span> (neuray-&gt;shutdown() != 0)</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to shutdown the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Unload the MDL SDK</span></div>
<div class="line">    neuray = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (!mi::examples::mdl::unload())</div>
<div class="line">        exit_failure(<span class="stringliteral">&quot;Failed to unload the SDK.&quot;</span>);</div>
<div class="line"></div>
<div class="line">    exit_success();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Convert command line arguments to UTF8 on Windows</span></div>
<div class="line">COMMANDLINE_TO_UTF8</div>
</div><!-- fragment --><div align="right"> [<a class="el" href="mi_neuray_example_df_cuda.html">Previous</a>] [<a class="el" href="mi_neuray_examples.html">Up</a>] [<a class="el" href="mi_neuray_example_derivatives.html">Next</a>] </div> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path">
<span class="footeritem">5&#160;April&#160;2022,&#160;20:40, rev.358266</span>
<span class="footeritem"><a href="https://www.nvidia.com/en-us/about-nvidia/legal-info/" target="_blank" shape="rect">&copy; 2022 NVIDIA&nbsp;Corporation.</a> All rights reserved.</span>
</div>
</body>
</html>
